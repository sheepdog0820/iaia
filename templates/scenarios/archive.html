{% extends 'base.html' %}
{% load static %}

{% block title %}Mythos Archive - シナリオアーカイブ{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4 eldritch-font text-center">
                <i class="fas fa-book-dead"></i> Mythos Archive
                <small class="d-block text-muted fs-6 mt-2">禁断の知識が眠る、シナリオの書庫</small>
            </h1>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> フィルター</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">ゲームシステム</label>
                        <select class="form-select" id="systemFilter">
                            <option value="">すべて</option>
                            <option value="coc">Call of Cthulhu</option>
                            <option value="dnd">D&D</option>
                            <option value="sw">ソード・ワールド</option>
                            <option value="insane">インセイン</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">難易度</label>
                        <select class="form-select" id="difficultyFilter">
                            <option value="">すべて</option>
                            <option value="beginner">初心者向け</option>
                            <option value="intermediate">中級者向け</option>
                            <option value="advanced">上級者向け</option>
                            <option value="expert">エキスパート</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">プレイ時間</label>
                        <select class="form-select" id="durationFilter">
                            <option value="">すべて</option>
                            <option value="short">短編（〜3時間）</option>
                            <option value="medium">中編（3〜6時間）</option>
                            <option value="long">長編（6時間〜）</option>
                            <option value="campaign">キャンペーン</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">プレイ状況</label>
                        <select class="form-select" id="playedFilter">
                            <option value="">すべて</option>
                            <option value="played">プレイ済み</option>
                            <option value="not_played">未プレイ</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary w-100" id="applyFilter">
                        <i class="fas fa-search"></i> フィルター適用
                    </button>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-plus"></i> シナリオ追加</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#addScenarioModal">
                        <i class="fas fa-book-medical"></i> 新規シナリオ登録
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">シナリオ一覧</h4>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="viewMode" id="gridView" checked>
                    <label class="btn btn-outline-secondary" for="gridView">
                        <i class="fas fa-th"></i>
                    </label>
                    <input type="radio" class="btn-check" name="viewMode" id="listView">
                    <label class="btn btn-outline-secondary" for="listView">
                        <i class="fas fa-list"></i>
                    </label>
                </div>
            </div>

            <div id="scenariosList" class="row">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- シナリオ追加モーダル -->
<div class="modal fade" id="addScenarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title eldritch-font">
                    <i class="fas fa-book-medical"></i> 新たなる知識の記録
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addScenarioForm">
                    <div class="mb-3">
                        <label for="scenarioTitle" class="form-label">シナリオタイトル</label>
                        <input type="text" class="form-control" id="scenarioTitle" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="scenarioSystem" class="form-label">ゲームシステム</label>
                            <select class="form-select" id="scenarioSystem" required>
                                <option value="">選択してください</option>
                                <option value="coc">Call of Cthulhu</option>
                                <option value="dnd">D&D</option>
                                <option value="sw">ソード・ワールド</option>
                                <option value="insane">インセイン</option>
                                <option value="other">その他</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="scenarioAuthor" class="form-label">作者</label>
                            <input type="text" class="form-control" id="scenarioAuthor">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="scenarioDifficulty" class="form-label">難易度</label>
                            <select class="form-select" id="scenarioDifficulty">
                                <option value="beginner">初心者向け</option>
                                <option value="intermediate">中級者向け</option>
                                <option value="advanced">上級者向け</option>
                                <option value="expert">エキスパート</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="scenarioDuration" class="form-label">想定プレイ時間</label>
                            <select class="form-select" id="scenarioDuration">
                                <option value="short">短編（〜3時間）</option>
                                <option value="medium">中編（3〜6時間）</option>
                                <option value="long">長編（6時間〜）</option>
                                <option value="campaign">キャンペーン</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="scenarioPlayers" class="form-label">推奨人数</label>
                            <input type="text" class="form-control" id="scenarioPlayers" placeholder="例: 3-4人">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="scenarioRecommendedSkills" class="form-label">推奨技能</label>
                        <input type="text" class="form-control" id="scenarioRecommendedSkills" placeholder="例: 目星, 聞き耳" list="scenarioSkillOptions">
                        <datalist id="scenarioSkillOptions"></datalist>
                        <small class="text-muted">カンマ区切りで入力してください</small>
                        <small class="text-warning d-block mt-1 d-none" id="scenarioRecommendedSkillsWarning"></small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scenarioSummary" class="form-label">あらすじ</label>
                        <textarea class="form-control" id="scenarioSummary" rows="4" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scenarioUrl" class="form-label">参照URL（任意）</label>
                        <input type="url" class="form-control" id="scenarioUrl" placeholder="https://...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="saveScenarioBtn">
                    <i class="fas fa-save"></i> シナリオを登録
                </button>
            </div>
        </div>
    </div>
</div>

<!-- シナリオ詳細モーダル -->
<div class="modal fade" id="scenarioDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scenarioDetailTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="scenarioDetailBody">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.scenario-card {
    height: 100%;
    transition: all 0.3s ease;
    cursor: pointer;
}

.scenario-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(220, 38, 127, 0.3);
}

.scenario-card .card-img-top {
    height: 200px;
    object-fit: cover;
    background: linear-gradient(135deg, #0d1117 0%, #21262d 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    color: #30363d;
}

.scenario-list-item {
    transition: all 0.3s ease;
    cursor: pointer;
}

.scenario-list-item:hover {
    background-color: rgba(220, 38, 127, 0.1);
    transform: translateX(5px);
}

.system-badge {
    font-size: 0.75rem;
    text-transform: uppercase;
}

.difficulty-badge {
    font-size: 0.75rem;
}

.difficulty-beginner { background-color: #3fb950; }
.difficulty-intermediate { background-color: #58a6ff; }
.difficulty-advanced { background-color: #ffc107; }
.difficulty-expert { background-color: #f85149; }

.play-history {
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 10px;
}

.notes-section {
    background-color: rgba(255, 255, 255, 0.03);
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #dc2670;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let viewMode = 'grid';
    let scenarios = [];
    let currentFilters = {};
    let scenarioEditId = null;
    const addScenarioModalEl = document.getElementById('addScenarioModal');
    const addScenarioModal = addScenarioModalEl ? new bootstrap.Modal(addScenarioModalEl) : null;
    const addScenarioForm = document.getElementById('addScenarioForm');
    const addScenarioTitle = addScenarioModalEl ? addScenarioModalEl.querySelector('.modal-title') : null;
    const saveScenarioBtn = document.getElementById('saveScenarioBtn');
    const defaultScenarioTitle = addScenarioTitle ? addScenarioTitle.innerHTML : '';
    const defaultScenarioSaveLabel = saveScenarioBtn ? saveScenarioBtn.innerHTML : '';
    const COC6TH_SKILLS = {
        dodge: '回避',
        martial_arts: 'マーシャルアーツ',
        throw: '投擲',
        first_aid: '応急手当',
        fist_punch: 'こぶし（パンチ）',
        head_butt: '頭突き',
        kick: 'キック',
        grapple: '組み付き',
        knife: 'ナイフ',
        club: 'こん棒',
        handgun: '拳銃',
        rifle: 'ライフル',
        shotgun: 'ショットガン',
        submachine_gun: 'サブマシンガン',
        machine_gun: 'マシンガン',
        bow: '弓',
        sword: '剣',
        spear: '槍',
        whip: '鞭',
        spot_hidden: '目星',
        listen: '聞き耳',
        library_use: '図書館',
        track: '追跡',
        navigate: 'ナビゲート',
        photography: '写真術',
        climb: '登攀',
        jump: '跳躍',
        swim: '水泳',
        sneak: '忍び歩き',
        hide: '隠れる',
        conceal: '隠す',
        locksmith: '鍵開け',
        drive_auto: '運転',
        pilot: '操縦',
        ride: '乗馬',
        electrical_repair: '電気修理',
        electronics: '電子工学',
        mechanical_repair: '機械修理',
        operate_heavy_machine: '重機械操作',
        disguise: '変装',
        sleight_of_hand: '手さばき',
        persuade: '説得',
        fast_talk: '言いくるめ',
        bargain: '値切り',
        psychology: '心理学',
        psychoanalysis: '精神分析',
        credit_rating: '信用',
        language_own: '母国語',
        language_other: '他国語',
        intimidate: '威嚇',
        charm: '魅惑',
        occult: 'オカルト',
        cthulhu_mythos: 'クトゥルフ神話',
        archaeology: '考古学',
        anthropology: '人類学',
        history: '歴史',
        natural_world: '博物学',
        geology: '地質学',
        astronomy: '天文学',
        biology: '生物学',
        chemistry: '化学',
        physics: '物理学',
        pharmacy: '薬学',
        medicine: '医学',
        law: '法律',
        accounting: '経理',
        computer_use: 'コンピューター',
        appraise: '鑑定',
        cryptography: '暗号',
        forensics: '法医学',
        art: '芸術',
        craft: '工芸',
        sing: '歌唱',
        play_instrument: '楽器演奏',
        dance: 'ダンス',
        acting: '演技',
        teach: '教育',
        perform: '芸能',
        animal_handling: '動物使い',
        survival: 'サバイバル',
        hypnosis: '催眠術',
        occult_folklore: '民俗学',
        gaming: 'ギャンブル'
    };
    const COC6TH_SKILL_NAMES = Object.values(COC6TH_SKILLS);
    const COC6TH_SKILL_KEYS = Object.keys(COC6TH_SKILLS);
    const COC6TH_SKILL_KEY_SET = new Set(COC6TH_SKILL_KEYS.map(key => key.toLowerCase()));
    const COC6TH_SKILL_NAME_SET = new Set(COC6TH_SKILL_NAMES);
    const COC6TH_SKILL_SIMPLIFIED = new Map();
    const COC6TH_SKILL_ALIASES = {
        '他の言語': '他国語'
    };

    function simplifySkillToken(value) {
        if (!value) return '';
        return value
            .replace(/\u3000/g, ' ')
            .replace(/[（(].*?[）)]/g, '')
            .replace(/\s+/g, '')
            .trim();
    }

    COC6TH_SKILL_NAMES.forEach(name => {
        const simplified = simplifySkillToken(name);
        if (simplified && simplified !== name && !COC6TH_SKILL_SIMPLIFIED.has(simplified)) {
            COC6TH_SKILL_SIMPLIFIED.set(simplified, name);
        }
    });

    function parseSkillList(raw) {
        if (!raw) return [];
        if (Array.isArray(raw)) return raw;
        if (typeof raw !== 'string') return [];
        const trimmed = raw.trim();
        if (!trimmed) return [];
        try {
            const parsed = JSON.parse(trimmed);
            if (Array.isArray(parsed)) return parsed;
        } catch (_) {
            // fall through to delimiter parsing
        }
        return trimmed.split(/[\n,、，]+/).map(item => item.trim()).filter(Boolean);
    }

    function resolveCocSkillName(value) {
        const cleaned = (value || '').replace(/\u3000/g, ' ').trim();
        if (!cleaned) return null;
        if (COC6TH_SKILL_NAME_SET.has(cleaned)) return cleaned;
        const lower = cleaned.toLowerCase();
        if (COC6TH_SKILL_KEY_SET.has(lower)) return COC6TH_SKILLS[lower];
        const alias = COC6TH_SKILL_ALIASES[cleaned];
        if (alias && COC6TH_SKILL_NAME_SET.has(alias)) return alias;
        const simplified = simplifySkillToken(cleaned);
        if (COC6TH_SKILL_NAME_SET.has(simplified)) return simplified;
        const simplifiedAlias = COC6TH_SKILL_SIMPLIFIED.get(simplified);
        if (simplifiedAlias) return simplifiedAlias;
        return null;
    }

    function normalizeScenarioSkills(raw, system) {
        const systemKey = (system || '').toLowerCase();
        const isCoc = systemKey === 'coc';
        const tokens = parseSkillList(raw);
        const normalized = [];
        const unknownSet = new Set();
        const seen = new Set();

        tokens.forEach(token => {
            const cleaned = (token || '').replace(/\u3000/g, ' ').trim();
            if (!cleaned) return;
            let canonical = cleaned;
            if (isCoc) {
                const resolved = resolveCocSkillName(cleaned);
                if (resolved) {
                    canonical = resolved;
                } else {
                    unknownSet.add(cleaned);
                }
            }
            if (!seen.has(canonical)) {
                normalized.push(canonical);
                seen.add(canonical);
            }
        });

        return { normalized, unknown: Array.from(unknownSet) };
    }

    function updateScenarioSkillFeedback(input, warningEl, system, options = {}) {
        if (!input) return { normalized: [], unknown: [] };
        const { normalized, unknown } = normalizeScenarioSkills(input.value, system);
        if (normalized.length === 0) {
            if (warningEl) {
                warningEl.textContent = '';
                warningEl.classList.add('d-none');
            }
            input.classList.remove('is-invalid');
            if (options.applyValue) {
                input.value = '';
            }
            return { normalized: [], unknown: [] };
        }
        if (options.applyValue) {
            input.value = normalized.join(', ');
        }
        const isCoc = (system || '').toLowerCase() === 'coc';
        if (warningEl) {
            if (isCoc && unknown.length > 0) {
                warningEl.textContent = `未対応技能: ${unknown.join(', ')}`;
                warningEl.classList.remove('d-none');
                input.classList.add('is-invalid');
            } else {
                warningEl.textContent = '';
                warningEl.classList.add('d-none');
                input.classList.remove('is-invalid');
            }
        }
        return { normalized, unknown };
    }

    function attachScenarioSkillInput(input, warningEl, systemGetter) {
        if (!input) return;
        const getSystem = typeof systemGetter === 'function' ? systemGetter : () => systemGetter;
        input.addEventListener('input', () => {
            updateScenarioSkillFeedback(input, warningEl, getSystem());
        });
        input.addEventListener('blur', () => {
            updateScenarioSkillFeedback(input, warningEl, getSystem(), { applyValue: true });
        });
        updateScenarioSkillFeedback(input, warningEl, getSystem());
    }

    function initScenarioSkillInputs() {
        const datalist = document.getElementById('scenarioSkillOptions');
        if (datalist) {
            datalist.innerHTML = '';
            COC6TH_SKILL_NAMES.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                datalist.appendChild(option);
            });
        }
        const skillsInput = document.getElementById('scenarioRecommendedSkills');
        const warningEl = document.getElementById('scenarioRecommendedSkillsWarning');
        const systemSelect = document.getElementById('scenarioSystem');
        const getSystem = () => systemSelect?.value || '';
        attachScenarioSkillInput(skillsInput, warningEl, getSystem);
        systemSelect?.addEventListener('change', () => {
            updateScenarioSkillFeedback(skillsInput, warningEl, getSystem());
        });
    }

    // シナリオ一覧読み込み
    async function loadScenarios() {
        try {
            const response = await axios.get('/api/scenarios/scenarios/');
            scenarios = response.data;
            renderScenarios();
        } catch (error) {
            console.error('Error loading scenarios:', error);
            document.getElementById('scenariosList').innerHTML = 
                '<div class="col-12"><div class="alert alert-danger">シナリオの読み込みに失敗しました</div></div>';
        }
    }

    // シナリオ表示
    function renderScenarios() {
        const filtered = filterScenarios(scenarios);
        const container = document.getElementById('scenariosList');
        
        if (filtered.length === 0) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-info">シナリオが見つかりませんでした</div></div>';
            return;
        }
        
        if (viewMode === 'grid') {
            container.className = 'row';
            container.innerHTML = filtered.map(scenario => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card scenario-card h-100" onclick="showScenarioDetail(${scenario.id})">
                        <div class="card-img-top">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${scenario.title}</h5>
                            <div class="mb-2">
                                <span class="badge bg-secondary system-badge">${getSystemLabel(scenario.game_system)}</span>
                                <span class="badge difficulty-badge difficulty-${scenario.difficulty}">${getDifficultyLabel(scenario.difficulty)}</span>
                            </div>
                            <p class="card-text text-muted small">${scenario.summary || 'あらすじなし'}</p>
                            <div class="mt-auto">
                                <small class="text-muted">
                                    <i class="fas fa-user"></i> ${scenario.author || '不明'}
                                    ${scenario.play_count > 0 ? `<span class="ms-2"><i class="fas fa-dice"></i> ${scenario.play_count}回プレイ</span>` : ''}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.className = '';
            container.innerHTML = filtered.map(scenario => `
                <div class="card scenario-list-item mb-2" onclick="showScenarioDetail(${scenario.id})">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-1">${scenario.title}</h5>
                                <span class="badge bg-secondary system-badge">${getSystemLabel(scenario.game_system)}</span>
                                <span class="badge difficulty-badge difficulty-${scenario.difficulty}">${getDifficultyLabel(scenario.difficulty)}</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> ${getDurationLabel(scenario.estimated_duration)}<br>
                                    <i class="fas fa-users"></i> ${scenario.recommended_players || '指定なし'}
                                </small>
                            </div>
                            <div class="col-md-3 text-end">
                                ${scenario.play_count > 0 ? `<span class="badge bg-success"><i class="fas fa-dice"></i> ${scenario.play_count}回プレイ</span>` : '<span class="badge bg-secondary">未プレイ</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    // フィルター処理
    function filterScenarios(scenarios) {
        return scenarios.filter(scenario => {
            if (currentFilters.system && scenario.game_system !== currentFilters.system) return false;
            if (currentFilters.difficulty && scenario.difficulty !== currentFilters.difficulty) return false;
            if (currentFilters.duration && scenario.estimated_duration !== currentFilters.duration) return false;
            if (currentFilters.played === 'played' && scenario.play_count === 0) return false;
            if (currentFilters.played === 'not_played' && scenario.play_count > 0) return false;
            return true;
        });
    }

    // システムラベル取得
    function getSystemLabel(system) {
        const labels = {
            coc: 'CoC',
            dnd: 'D&D',
            sw: 'SW',
            insane: 'インセイン',
            other: 'その他'
        };
        return labels[system] || system;
    }

    // 難易度ラベル取得
    function getDifficultyLabel(difficulty) {
        const labels = {
            beginner: '初心者',
            intermediate: '中級',
            advanced: '上級',
            expert: 'エキスパート'
        };
        return labels[difficulty] || difficulty;
    }

    // プレイ時間ラベル取得
    function getDurationLabel(duration) {
        const labels = {
            short: '短編',
            medium: '中編',
            long: '長編',
            campaign: 'キャンペーン'
        };
        return labels[duration] || duration;
    }

    function fillScenarioForm(scenario) {
        if (!scenario) return;
        const recommendedSkillsValue = (scenario.recommended_skills || '').trim();
        document.getElementById('scenarioTitle').value = scenario.title || '';
        document.getElementById('scenarioSystem').value = scenario.game_system || '';
        document.getElementById('scenarioAuthor').value = scenario.author || '';
        document.getElementById('scenarioDifficulty').value = scenario.difficulty || 'beginner';
        document.getElementById('scenarioDuration').value = scenario.estimated_duration || 'short';
        document.getElementById('scenarioPlayers').value = scenario.recommended_players || '';
        document.getElementById('scenarioRecommendedSkills').value = recommendedSkillsValue;
        document.getElementById('scenarioSummary').value = scenario.summary || '';
        document.getElementById('scenarioUrl').value = scenario.url || '';
        updateScenarioSkillFeedback(
            document.getElementById('scenarioRecommendedSkills'),
            document.getElementById('scenarioRecommendedSkillsWarning'),
            document.getElementById('scenarioSystem')?.value || ''
        );
    }

    function setScenarioFormMode(isEdit, scenario) {
        scenarioEditId = isEdit && scenario ? scenario.id : null;
        if (addScenarioTitle) {
            addScenarioTitle.innerHTML = isEdit
                ? '<i class="fas fa-edit"></i> シナリオを編集'
                : defaultScenarioTitle;
        }
        if (saveScenarioBtn) {
            saveScenarioBtn.innerHTML = isEdit
                ? '<i class="fas fa-save"></i> 変更を保存'
                : defaultScenarioSaveLabel;
        }
        if (isEdit) {
            fillScenarioForm(scenario);
        } else if (addScenarioForm) {
            addScenarioForm.reset();
            const warningEl = document.getElementById('scenarioRecommendedSkillsWarning');
            warningEl?.classList.add('d-none');
            if (warningEl) warningEl.textContent = '';
            document.getElementById('scenarioRecommendedSkills')?.classList.remove('is-invalid');
        }
    }

    // シナリオ詳細表示
    window.showScenarioDetail = async function(scenarioId) {
        const modal = new bootstrap.Modal(document.getElementById('scenarioDetailModal'));
        const titleEl = document.getElementById('scenarioDetailTitle');
        const bodyEl = document.getElementById('scenarioDetailBody');
        
        try {
            const response = await axios.get(`/api/scenarios/scenarios/${scenarioId}/`);
            const scenario = response.data;
            window.currentScenario = scenario;
            
            titleEl.textContent = scenario.title;
            bodyEl.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>基本情報</h6>
                        <table class="table table-sm">
                            <tr>
                                <th style="width: 30%;">システム</th>
                                <td>${getSystemLabel(scenario.game_system)}</td>
                            </tr>
                            <tr>
                                <th>作者</th>
                                <td>${scenario.author || '不明'}</td>
                            </tr>
                            <tr>
                                <th>難易度</th>
                                <td><span class="badge difficulty-badge difficulty-${scenario.difficulty}">${getDifficultyLabel(scenario.difficulty)}</span></td>
                            </tr>
                            <tr>
                                <th>推奨人数</th>
                                <td>${scenario.recommended_players || '指定なし'}</td>
                            </tr>
                            <tr>
                                <th>推奨技能</th>
                                <td id="scenarioRecommendedSkillsValue"></td>
                            </tr>
                            <tr>
                                <th>想定時間</th>
                                <td>${getDurationLabel(scenario.estimated_duration)}</td>
                            </tr>
                        </table>
                        
                        <div class="mt-3">
                            <label class="form-label small text-muted">推奨技能を編集</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="scenarioRecommendedSkillsEdit" placeholder="例: 目星, 図書館" list="scenarioSkillOptions">
                                <button class="btn btn-outline-primary" type="button" onclick="saveScenarioRecommendedSkills(${scenario.id})">
                                    <i class="fas fa-save"></i> 保存
                                </button>
                            </div>
                            <div class="form-text">カンマ区切りで入力できます。</div>
                            <small class="text-warning d-block mt-1 d-none" id="scenarioRecommendedSkillsEditWarning"></small>
                        </div>
                        
                        <h6 class="mt-4">あらすじ</h6>
                        <p>${scenario.summary || 'なし'}</p>
                        
                        ${scenario.url ? `<p><a href="${scenario.url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt"></i> 参照URLを開く</a></p>` : ''}
                    </div>
                    <div class="col-md-4">
                        <h6>プレイ履歴</h6>
                        ${scenario.play_history && scenario.play_history.length > 0 ? 
                            scenario.play_history.map(play => `
                                <div class="play-history">
                                    <strong>${new Date(play.play_date).toLocaleDateString('ja-JP')}</strong><br>
                                    GM: ${play.gm_detail.nickname}<br>
                                    ${play.player_count}人参加
                                </div>
                            `).join('') : 
                            '<p class="text-muted">まだプレイされていません</p>'
                        }
                        
                        ${scenario.notes && scenario.notes.length > 0 ? `
                            <h6 class="mt-4">GMメモ</h6>
                            <div class="notes-section">
                                ${scenario.notes.map(note => `
                                    <div class="mb-2">
                                        <small class="text-muted">${new Date(note.created_at).toLocaleDateString('ja-JP')}</small><br>
                                        ${note.content}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="mt-4">
                            <button class="btn btn-primary btn-sm w-100" onclick="createSessionFromScenario(${scenario.id})">
                                <i class="fas fa-calendar-plus"></i> このシナリオでセッションを計画
                            </button>
                            <button class="btn btn-outline-primary btn-sm w-100 mt-2" onclick="applyScenarioRecommendedSkills()">
                                <i class="fas fa-star"></i> 推奨技能で探索者作成
                            </button>
                            <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="openScenarioEditModal(${scenario.id})">
                                <i class="fas fa-edit"></i> シナリオを編集
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const recommendedValue = (scenario.recommended_skills || '').trim();
            const recommendedDisplay = document.getElementById('scenarioRecommendedSkillsValue');
            if (recommendedDisplay) {
                recommendedDisplay.textContent = recommendedValue || '未設定';
            }
            const recommendedInput = document.getElementById('scenarioRecommendedSkillsEdit');
            const recommendedWarning = document.getElementById('scenarioRecommendedSkillsEditWarning');
            if (recommendedInput) {
                recommendedInput.value = recommendedValue;
                attachScenarioSkillInput(recommendedInput, recommendedWarning, () => scenario.game_system);
            }

            modal.show();
        } catch (error) {
            console.error('Error loading scenario details:', error);
            alert('シナリオ詳細の読み込みに失敗しました');
        }
    };

    // シナリオからセッション作成
    window.createSessionFromScenario = async function(scenarioId) {
        let scenario = null;
        if (window.currentScenario && window.currentScenario.id === scenarioId) {
            scenario = window.currentScenario;
        } else {
            try {
                const response = await axios.get(`/api/scenarios/scenarios/${scenarioId}/`);
                scenario = response.data;
            } catch (error) {
                alert('シナリオ情報の取得に失敗しました。');
                return;
            }
        }

        if (!scenario) {
            alert('シナリオ情報の取得に失敗しました。');
            return;
        }

        try {
            localStorage.setItem('session_scenario_id', scenario.id ? String(scenario.id) : '');
            localStorage.setItem('session_scenario_title', scenario.title || '');
            localStorage.setItem('session_scenario_game_system', scenario.game_system || '');
        } catch (_) {
            // ignore storage errors
        }

        const params = new URLSearchParams({
            scenario_id: scenario.id ? String(scenario.id) : '',
            scenario_title: scenario.title || '',
            game_system: scenario.game_system || ''
        });
        window.location.href = `/api/schedules/calendar/view/?${params.toString()}`;
    };

    window.openScenarioEditModal = async function(scenarioId) {
        if (!addScenarioModal) {
            alert('編集フォームを開けませんでした。');
            return;
        }
        let scenario = null;
        if (window.currentScenario && window.currentScenario.id === scenarioId) {
            scenario = window.currentScenario;
        } else {
            try {
                const response = await axios.get(`/api/scenarios/scenarios/${scenarioId}/`);
                scenario = response.data;
            } catch (error) {
                alert('シナリオ情報の取得に失敗しました。');
                return;
            }
        }

        setScenarioFormMode(true, scenario);

        const detailModalEl = document.getElementById('scenarioDetailModal');
        const detailModal = detailModalEl ? bootstrap.Modal.getInstance(detailModalEl) : null;
        detailModal?.hide();
        addScenarioModal.show();
    };

    // 推奨技能の編集/適用
    window.saveScenarioRecommendedSkills = async function(scenarioId) {
        const input = document.getElementById('scenarioRecommendedSkillsEdit');
        if (!input) {
            alert('推奨技能の入力欄が見つかりませんでした。');
            return;
        }
        const warningEl = document.getElementById('scenarioRecommendedSkillsEditWarning');
        const system = window.currentScenario?.game_system || '';
        const { normalized, unknown } = updateScenarioSkillFeedback(input, warningEl, system, { applyValue: true });
        if (system === 'coc' && unknown.length > 0) {
            const proceed = confirm(`未対応技能: ${unknown.join(', ')}\nこのまま保存しますか？`);
            if (!proceed) return;
        }
        const value = normalized.join(', ');

        try {
            await axios.patch(`/api/scenarios/scenarios/${scenarioId}/`, {
                recommended_skills: value
            });

            const display = document.getElementById('scenarioRecommendedSkillsValue');
            if (display) {
                display.textContent = value || '未設定';
            }
            if (window.currentScenario && window.currentScenario.id === scenarioId) {
                window.currentScenario.recommended_skills = value;
            }
            alert('推奨技能を更新しました。');
        } catch (error) {
            alert('推奨技能の更新に失敗しました: ' + (error.response?.data?.detail || error.message));
        }
    };

    window.applyScenarioRecommendedSkills = function() {
        const scenario = window.currentScenario;
        if (!scenario) {
            alert('シナリオ情報が取得できませんでした。');
            return;
        }
        const skills = (scenario.recommended_skills || '').trim();
        try {
            localStorage.setItem('scenario_recommended_skills', skills);
            localStorage.setItem('scenario_recommended_skills_title', scenario.title);
            localStorage.setItem('scenario_recommended_skills_id', scenario.id ? String(scenario.id) : '');
            localStorage.setItem('scenario_recommended_skills_system', scenario.game_system || '');
        } catch (_) {
            // ignore storage errors
        }

        const params = new URLSearchParams({
            recommended_skills: skills,
            scenario_title: scenario.title,
            scenario_id: scenario.id ? String(scenario.id) : '',
            game_system: scenario.game_system || ''
        });
        window.location.href = `/accounts/character/create/6th/?${params.toString()}`;
    };

    // 新規/編集シナリオ保存
    saveScenarioBtn?.addEventListener('click', async function() {
        if (!addScenarioForm) return;
        if (!addScenarioForm.checkValidity()) {
            addScenarioForm.reportValidity();
            return;
        }

        const recommendedInput = document.getElementById('scenarioRecommendedSkills');
        const warningEl = document.getElementById('scenarioRecommendedSkillsWarning');
        const systemValue = document.getElementById('scenarioSystem')?.value || '';
        const { normalized, unknown } = updateScenarioSkillFeedback(recommendedInput, warningEl, systemValue, { applyValue: true });
        if (systemValue === 'coc' && unknown.length > 0) {
            const proceed = confirm(`未対応技能: ${unknown.join(', ')}\nこのまま保存しますか？`);
            if (!proceed) return;
        }
        const recommendedSkillsValue = normalized.join(', ');

        const data = {
            title: document.getElementById('scenarioTitle').value,
            game_system: document.getElementById('scenarioSystem').value,
            author: document.getElementById('scenarioAuthor').value,
            difficulty: document.getElementById('scenarioDifficulty').value,
            estimated_duration: document.getElementById('scenarioDuration').value,
            recommended_players: document.getElementById('scenarioPlayers').value,
            recommended_skills: recommendedSkillsValue,
            summary: document.getElementById('scenarioSummary').value,
            url: document.getElementById('scenarioUrl').value
        };

        const isEdit = scenarioEditId !== null;
        const targetScenarioId = scenarioEditId;

        try {
            let response = null;
            if (isEdit && targetScenarioId) {
                response = await axios.patch(`/api/scenarios/scenarios/${targetScenarioId}/`, data);
                window.currentScenario = response.data;
            } else {
                response = await axios.post('/api/scenarios/scenarios/', data);
            }

            alert(isEdit ? 'シナリオを更新しました！' : 'シナリオを登録しました！');
            addScenarioModal?.hide();
            addScenarioForm.reset();
            loadScenarios();
            if (isEdit && targetScenarioId) {
                showScenarioDetail(targetScenarioId);
            }
        } catch (error) {
            const actionLabel = isEdit ? 'シナリオ更新' : 'シナリオ登録';
            alert(`${actionLabel}に失敗しました: ` + (error.response?.data?.detail || error.message));
        }
    });

    addScenarioModalEl?.addEventListener('hidden.bs.modal', () => {
        setScenarioFormMode(false);
    });

    // ビューモード切替
    document.getElementById('gridView').addEventListener('change', function() {
        if (this.checked) {
            viewMode = 'grid';
            renderScenarios();
        }
    });

    document.getElementById('listView').addEventListener('change', function() {
        if (this.checked) {
            viewMode = 'list';
            renderScenarios();
        }
    });

    // フィルター適用
    document.getElementById('applyFilter').addEventListener('click', function() {
        currentFilters = {
            system: document.getElementById('systemFilter').value,
            difficulty: document.getElementById('difficultyFilter').value,
            duration: document.getElementById('durationFilter').value,
            played: document.getElementById('playedFilter').value
        };
        renderScenarios();
    });

    // 初期化
    initScenarioSkillInputs();
    loadScenarios();
});
</script>
{% endblock %}

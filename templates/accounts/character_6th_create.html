{% extends 'base.html' %}
{% load static %}

{% block title %}クトゥルフ神話TRPG 6版探索者作成 - Arkham Nexus{% endblock %}

{% block content %}
<div class="container">
    <!-- ヘッダー -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="eldritch-font">
                        <i class="fas fa-user-ninja text-primary"></i> クトゥルフ神話TRPG 6版探索者作成
                    </h1>
                    <p class="text-muted lead">
                        新たなる探索者を創造し、深淵の謎に立ち向かいましょう。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- フォーム -->
    <div class="row">
        <div class="col-12">
            <form method="post" id="character-sheet-form" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- システム情報フィールド(非表示) -->
                <input type="hidden" id="system" name="system" value="cthulhu_6th">
                <!-- 自動計算されるフィールド(非表示) -->
                <input type="hidden" id="sanity_max" name="sanity_max">
                
                <!-- メインタブナビゲーション -->
                <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab">
                            <i class="fas fa-user"></i> 基本情報
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="abilities-tab" data-bs-toggle="tab" data-bs-target="#abilities" type="button" role="tab">
                            <i class="fas fa-dice"></i> 能力値
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="skills-tab" data-bs-toggle="tab" data-bs-target="#skills" type="button" role="tab">
                            <i class="fas fa-graduation-cap"></i> 技能
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="combat-equipment-tab" data-bs-toggle="tab" data-bs-target="#combat-equipment" type="button" role="tab">
                            <i class="fas fa-shield-alt"></i> 戦闘・装備
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="background-tab" data-bs-toggle="tab" data-bs-target="#background" type="button" role="tab">
                            <i class="fas fa-book"></i> 背景情報
                        </button>
                    </li>
                </ul>
                
                <!-- タブコンテンツ -->
                <div class="tab-content" id="mainTabContent">
                    <!-- 基本情報タブ -->
                    <div class="tab-pane fade show active" id="basic-info" role="tabpanel">
                        <!-- 探索者情報 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-id-card"></i> 探索者情報
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6 mb-3">
                                <label for="character-name" class="form-label">探索者名 *</label>
                                <input type="text" class="form-control form-control-lg" id="character-name" name="name" 
                                       placeholder="例: 高島 静雄" required>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <label for="player-name" class="form-label">プレイヤー名</label>
                                <input type="text" class="form-control" id="player-name" name="player_name" 
                                       placeholder="あなたの名前">
                            </div>
                            <div class="col-lg-3 mb-3">
                                <label for="age" class="form-label">年齢</label>
                                <input type="number" class="form-control" id="age" name="age" min="15" max="90" placeholder="28">
                            </div>
                            <div class="col-lg-3 mb-3">
                                <label for="gender" class="form-label">性別</label>
                                <select class="form-select" id="gender" name="gender">
                                    <option value="">選択してください</option>
                                    <option value="男性">男性</option>
                                    <option value="女性">女性</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            <div class="col-lg-3 mb-3">
                                <label for="occupation" class="form-label">職業</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="occupation" name="occupation" 
                                           placeholder="例: 私立探偵">
                                    <button class="btn btn-outline-secondary" type="button" id="occupationTemplateBtn" 
                                            data-bs-toggle="modal" data-bs-target="#occupationTemplateModal">
                                        <i class="fas fa-list"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-lg-3 mb-3">
                                <label for="birthplace" class="form-label">出身地</label>
                                <input type="text" class="form-control" id="birthplace" name="birthplace" 
                                       placeholder="例: 東京">
                            </div>
                            <div class="col-lg-3 mb-3">
                                <label for="residence" class="form-label">現住所</label>
                                <input type="text" class="form-control" id="residence" name="residence" 
                                       placeholder="例: 大阪">
                            </div>
                            <div class="col-12 mb-3">
                                <label for="notes" class="form-label">背景・特徴</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" 
                                          placeholder="探索者の背景、性格、特徴、動機などを記入してください..."></textarea>
                            </div>
                            <div class="col-12">
                                <label for="character-image" class="form-label">キャラクター画像</label>
                                <div class="row">
                                    <div class="col-md-8">
                                        <input type="file" class="form-control" id="character-image" name="character_image" 
                                               accept="image/jpeg,image/jpg,image/png,image/gif">
                                        <small class="text-muted">対応形式: JPG, PNG, GIF (最大5MB)</small>
                                    </div>
                                    <div class="col-md-4">
                                        <div id="image-preview" class="text-center" style="display: none;">
                                            <img id="preview-img" src="" alt="プレビュー" class="img-fluid rounded" 
                                                 style="max-height: 150px;">
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-danger" id="remove-image">
                                                    <i class="fas fa-trash"></i> 削除
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div> <!-- 基本情報タブ終了 -->

                    <!-- 能力値タブ -->
                    <div class="tab-pane fade" id="abilities" role="tabpanel">
                        <!-- 全能力値ダイスロール設定 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-dice-d20"></i> 全能力値ダイスロール設定
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center g-3">
                                    <div class="col-md-2">
                                        <label for="globalDiceCount" class="form-label small">個数</label>
                                        <input type="number" class="form-control" id="globalDiceCount" min="1" max="10" value="3">
                                    </div>
                                    <div class="col-md-2">
                                        <label for="globalDiceSides" class="form-label small">面数</label>
                                        <input type="number" class="form-control" id="globalDiceSides" min="2" max="100" value="6">
                                    </div>
                                    <div class="col-md-2">
                                        <label for="globalDiceBonus" class="form-label small">ボーナス</label>
                                        <input type="number" class="form-control" id="globalDiceBonus" min="-50" max="50" value="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">ダイス式</label>
                                        <div class="text-center p-2 bg-light rounded">
                                            <span id="globalDiceFormula" class="fw-bold text-primary">3d6+0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">&nbsp;</label>
                                        <div class="d-grid">
                                            <button type="button" class="btn btn-primary" id="rollAllAbilities">
                                                <i class="fas fa-dice-d20"></i> 全能力値ロール
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            全ての基本能力値を一括でダイスロールします。設定したダイス式が全能力値に適用されます。
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ステータス（能力値と副次ステータス） -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar"></i> ステータス
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6 class="text-primary border-bottom pb-2 mb-3">基本能力値</h6>
                        <!-- 能力値入力エリア -->
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="str" class="form-label">STR (筋力)</label>
                                <input type="number" class="form-control ability-score" id="str" name="str_value" min="1" max="999" placeholder="1-999" required>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="con" class="form-label">CON (体力)</label>
                                <input type="number" class="form-control ability-score" id="con" name="con_value" min="1" max="999" placeholder="1-999" required>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="pow" class="form-label">POW (精神力)</label>
                                <input type="number" class="form-control ability-score" id="pow" name="pow_value" min="1" max="999" placeholder="1-999" required>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="dex" class="form-label">DEX (敏捷性)</label>
                                <input type="number" class="form-control ability-score" id="dex" name="dex_value" min="1" max="999" placeholder="1-999" required>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="app" class="form-label">APP (外見)</label>
                                <input type="number" class="form-control ability-score" id="app" name="app_value" min="1" max="999" placeholder="1-999" required>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="siz" class="form-label">SIZ (体格)</label>
                                <input type="number" class="form-control ability-score" id="siz" name="siz_value" min="1" max="999" placeholder="1-999" required>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="int" class="form-label">INT (知性)</label>
                                <input type="number" class="form-control ability-score" id="int" name="int_value" min="1" max="999" placeholder="1-999" required>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="edu" class="form-label">EDU (教育)</label>
                                <input type="number" class="form-control ability-score" id="edu" name="edu_value" min="1" max="999" placeholder="1-999" required>
                            </div>
                        </div>
                        
                        <h6 class="text-info border-bottom pb-2 mb-3 mt-4">副次ステータス（6版ルール）</h6>
                        <div class="row">
                            <div class="col-md-2 col-sm-4 mb-3">
                                <label for="hp" class="form-label">HP (耐久力)</label>
                                <input type="number" class="form-control" id="hp" name="hit_points_max" readonly>
                                <small class="text-muted">(CON+SIZ)/2</small>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <label for="mp" class="form-label">MP</label>
                                <input type="number" class="form-control" id="mp" name="magic_points_max" readonly>
                                <small class="text-muted">POW</small>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <label for="san" class="form-label">SAN (正気度)</label>
                                <input type="number" class="form-control" id="san" name="sanity_starting" readonly>
                                <small class="text-muted">POW×5</small>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <label for="idea" class="form-label">アイデア</label>
                                <input type="number" class="form-control" id="idea" name="idea" readonly>
                                <small class="text-muted">INT×5</small>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <label for="luck" class="form-label">幸運</label>
                                <input type="number" class="form-control" id="luck" name="luck" readonly>
                                <small class="text-muted">POW×5</small>
                            </div>
                            <div class="col-md-2 col-sm-4 mb-3">
                                <label for="know" class="form-label">知識</label>
                                <input type="number" class="form-control" id="know" name="know" readonly>
                                <small class="text-muted">EDU×5</small>
                            </div>
                            <div class="col-12 mt-2">
                                <label for="damage-bonus" class="form-label">ダメージボーナス</label>
                                <input type="text" class="form-control" id="damage-bonus" name="damage_bonus" readonly>
                                <small class="text-muted">STR+SIZの合計により決定</small>
                            </div>
                        </div>
                    </div>
                </div>
                    </div> <!-- 能力値タブ終了 -->

                    <!-- 技能タブ -->
                    <div class="tab-pane fade" id="skills" role="tabpanel">
                        <!-- 技能システム -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-tools"></i> 技能システム（6版）
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- ポイント管理 -->
                        <div class="row mb-3 g-3">
                            <div class="col-lg-5">
                                <div class="bg-light p-3 rounded h-100">
                                    <h6 class="text-primary">職業技能ポイント</h6>
                                    <div class="row g-2 mb-2">
                                        <div class="col-12">
                                            <small class="text-muted">計算方式</small>
                                            <select class="form-select form-select-sm" id="occupationMethod">
                                                <option value="edu20">EDU×20</option>
                                                <option value="edu10app10">EDU×10＋APP×10</option>
                                                <option value="edu10dex10">EDU×10＋DEX×10</option>
                                                <option value="edu10pow10">EDU×10＋POW×10</option>
                                                <option value="edu10str10">EDU×10＋STR×10</option>
                                                <option value="edu10con10">EDU×10＋CON×10</option>
                                                <option value="edu10siz10">EDU×10＋SIZ×10</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted">総ポイント</small>
                                            <input type="number" class="form-control form-control-sm" id="occupationTotal" readonly>
                                        </div>
                                        <div class="col-3">
                                            <small class="text-muted">使用</small>
                                            <div><span id="occupationUsed" class="badge bg-primary fs-6">0</span></div>
                                        </div>
                                        <div class="col-3">
                                            <small class="text-muted">残り</small>
                                            <div><span id="occupationRemaining" class="badge bg-success fs-6">0</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-5">
                                <div class="bg-light p-3 rounded h-100">
                                    <h6 class="text-info">趣味技能ポイント</h6>
                                    <div class="row g-2 mb-2">
                                        <div class="col-12">
                                            <small class="text-muted">計算方式: <strong>INT×10</strong></small>
                                        </div>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted">総ポイント</small>
                                            <input type="number" class="form-control form-control-sm" id="interestTotal" readonly>
                                        </div>
                                        <div class="col-3">
                                            <small class="text-muted">使用</small>
                                            <div><span id="interestUsed" class="badge bg-primary fs-6">0</span></div>
                                        </div>
                                        <div class="col-3">
                                            <small class="text-muted">残り</small>
                                            <div><span id="interestRemaining" class="badge bg-success fs-6">0</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <div class="d-grid gap-2 h-100">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="resetSkillPoints">
                                        <i class="fas fa-undo"></i><br><small>リセット</small>
                                    </button>
                                    <button type="button" class="btn btn-primary btn-sm" id="calculateSkills">
                                        <i class="fas fa-calculator"></i><br><small>計算</small>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 技能タブとコンテンツ -->
                        <div id="skillsContainer">
                            <!-- 基本値編集の説明 -->
                            <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                                <i class="fas fa-info-circle"></i>
                                <strong>技能の基本値は編集可能です！</strong>
                                <ul class="mb-0 mt-2">
                                    <li>基本値（青色の入力欄）をクリックして、カスタム値を入力できます</li>
                                    <li>右クリックすると、デフォルト値にリセットされます</li>
                                    <li>DEX×2やEDU×5などの動的な基本値も、カスタム値で上書き可能です</li>
                                </ul>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            
                            <!-- タブナビゲーション -->
                            <ul class="nav nav-tabs" id="skillTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="combat-tab" data-bs-toggle="tab" data-bs-target="#combat" type="button" role="tab">
                                        <i class="fas fa-sword"></i> 戦闘系
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="exploration-tab" data-bs-toggle="tab" data-bs-target="#exploration" type="button" role="tab">
                                        <i class="fas fa-search"></i> 探索技能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="action-tab" data-bs-toggle="tab" data-bs-target="#action" type="button" role="tab">
                                        <i class="fas fa-running"></i> 行動技能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="social-tab" data-bs-toggle="tab" data-bs-target="#social" type="button" role="tab">
                                        <i class="fas fa-comments"></i> 交渉技能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="knowledge-tab" data-bs-toggle="tab" data-bs-target="#knowledge" type="button" role="tab">
                                        <i class="fas fa-book"></i> 知識技能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                                        <i class="fas fa-list"></i> 全表示
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="allocated-tab" data-bs-toggle="tab" data-bs-target="#allocated" type="button" role="tab">
                                        <i class="fas fa-check-circle"></i> 振り分け済み
                                        <span class="badge bg-success ms-1" id="allocatedCount">0</span>
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- タブコンテンツ -->
                            <div class="tab-content" id="skillTabContent">
                                <!-- 戦闘系技能 -->
                                <div class="tab-pane fade show active" id="combat" role="tabpanel">
                                    <div class="row g-2 mt-2" id="combatSkills">
                                        <!-- 戦闘系技能がここに動的生成される -->
                                    </div>
                                </div>
                                
                                <!-- 探索技能 -->
                                <div class="tab-pane fade" id="exploration" role="tabpanel">
                                    <div class="row g-2 mt-2" id="explorationSkills">
                                        <!-- 探索技能がここに動的生成される -->
                                    </div>
                                </div>
                                
                                <!-- 行動技能 -->
                                <div class="tab-pane fade" id="action" role="tabpanel">
                                    <div class="row g-2 mt-2" id="actionSkills">
                                        <!-- 行動技能がここに動的生成される -->
                                    </div>
                                </div>
                                
                                <!-- 交渉技能 -->
                                <div class="tab-pane fade" id="social" role="tabpanel">
                                    <div class="row g-2 mt-2" id="socialSkills">
                                        <!-- 交渉技能がここに動的生成される -->
                                    </div>
                                </div>
                                
                                <!-- 知識技能 -->
                                <div class="tab-pane fade" id="knowledge" role="tabpanel">
                                    <div class="row g-2 mt-2" id="knowledgeSkills">
                                        <!-- 知識技能がここに動的生成される -->
                                    </div>
                                </div>
                                
                                <!-- 全表示 -->
                                <div class="tab-pane fade" id="all" role="tabpanel">
                                    <div class="row g-2 mt-2" id="allSkills">
                                        <!-- 全技能がここに動的生成される -->
                                    </div>
                                </div>
                                
                                <!-- 振り分け済み -->
                                <div class="tab-pane fade" id="allocated" role="tabpanel">
                                    <div class="row g-2 mt-2" id="allocatedSkills">
                                        <div class="col-12 text-center text-muted p-4" id="noAllocatedMessage">
                                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                                            <p>まだポイントを振り分けた技能がありません。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div> <!-- 技能タブ終了 -->

                    <!-- 戦闘・装備タブ -->
                    <div class="tab-pane fade" id="combat-equipment" role="tabpanel">
                        <!-- 戦闘・装備 -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-shield-alt"></i> 戦闘・装備
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="current_hp" class="form-label">現在HP</label>
                                <input type="number" class="form-control" id="current_hp" name="hit_points_current" 
                                       min="0" max="99" readonly>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="current_mp" class="form-label">現在MP</label>
                                <input type="number" class="form-control" id="current_mp" name="magic_points_current" 
                                       min="0" max="99" readonly>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="current_san" class="form-label">現在SAN</label>
                                <input type="number" class="form-control" id="current_san" name="sanity_current" 
                                       min="0" max="99" readonly>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="armor" class="form-label">装甲値</label>
                                <input type="number" class="form-control" id="armor" name="armor" 
                                       min="0" max="50" value="0">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 武器・防具の詳細は作成後に編集画面で設定できます。
                        </div>
                    </div>
                </div>

                <!-- インベントリ・財産 -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-coins"></i> インベントリ・財産
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="money" class="form-label">所持金</label>
                                <input type="number" class="form-control" id="money" name="money" 
                                       min="0" placeholder="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="assets" class="form-label">総資産</label>
                                <input type="number" class="form-control" id="assets" name="assets" 
                                       min="0" placeholder="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="income" class="form-label">年収</label>
                                <input type="number" class="form-control" id="income" name="income" 
                                       min="0" placeholder="0">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label for="items" class="form-label">所持品メモ</label>
                                <textarea class="form-control" id="items" name="items" rows="3" 
                                          placeholder="主要な所持品を記入してください..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                    </div> <!-- 戦闘・装備タブ終了 -->

                    <!-- 背景情報タブ -->
                    <div class="tab-pane fade" id="background" role="tabpanel">
                        <!-- 背景情報 -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-clock"></i> 背景情報
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="appearance" class="form-label">外見の描写</label>
                                <textarea class="form-control" id="appearance" name="appearance" rows="2" 
                                          placeholder="身長、体型、髪の色、特徴的な外見など..."></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ideals" class="form-label">信念・信条</label>
                                <textarea class="form-control" id="ideals" name="ideals" rows="2" 
                                          placeholder="キャラクターが大切にしている価値観や信念..."></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="bonds" class="form-label">重要な人物</label>
                                <textarea class="form-control" id="bonds" name="bonds" rows="2" 
                                          placeholder="家族、友人、恩人など..."></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="flaws" class="form-label">弱点・恐怖症</label>
                                <textarea class="form-control" id="flaws" name="flaws" rows="2" 
                                          placeholder="性格的な弱点、恐怖症、トラウマなど..."></textarea>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="backstory" class="form-label">背景ストーリー</label>
                                <textarea class="form-control" id="backstory" name="backstory" rows="4" 
                                          placeholder="探索者の生い立ち、経歴、現在に至るまでの物語..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                    </div> <!-- 背景情報タブ終了 -->
                </div> <!-- タブコンテンツ終了 -->

                <!-- 送信ボタン -->
                <div class="row mb-5">
                    <div class="col-12 text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> 探索者を作成
                        </button>
                        <a href="/accounts/character/list/" class="btn btn-secondary btn-lg ms-2">
                            <i class="fas fa-times"></i> キャンセル
                        </a>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- 職業テンプレートモーダル -->
<div class="modal fade" id="occupationTemplateModal" tabindex="-1" aria-labelledby="occupationTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="occupationTemplateModalLabel">
                    <i class="fas fa-briefcase"></i> 職業テンプレート選択
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="list-group" id="occupationCategories">
                            <a href="#" class="list-group-item list-group-item-action active" data-category="academic">
                                <i class="fas fa-graduation-cap"></i> 学術系
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-category="investigation">
                                <i class="fas fa-search"></i> 調査系
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-category="combat">
                                <i class="fas fa-shield-alt"></i> 戦闘系
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-category="medical">
                                <i class="fas fa-heartbeat"></i> 医療系
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-category="arts">
                                <i class="fas fa-palette"></i> 芸術系
                            </a>
                            <a href="#" class="list-group-item list-group-item-action" data-category="others">
                                <i class="fas fa-users"></i> その他
                            </a>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="occupationList">
                            <!-- 職業リストがここに動的生成される -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            </div>
        </div>
    </div>
</div>

<!-- 固定フッター -->
<div class="character-footer fixed-bottom bg-dark text-light py-3">
    <div class="container">
        <div class="row align-items-center">
            <!-- 職業技能ポイント -->
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <span class="me-2">職業技能:</span>
                    <span class="badge bg-success me-1" id="occupationUsedFooter">0</span>
                    <span>/</span>
                    <span class="badge bg-primary ms-1" id="occupationTotalFooter">0</span>
                </div>
            </div>
            
            <!-- 趣味技能ポイント -->
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <span class="me-2">趣味技能:</span>
                    <span class="badge bg-warning text-dark me-1" id="interestUsedFooter">0</span>
                    <span>/</span>
                    <span class="badge bg-info ms-1" id="interestTotalFooter">0</span>
                </div>
            </div>
            
            <!-- ダイスボット実行 -->
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-light btn-sm" id="footerRollDice">
                    <i class="fas fa-dice"></i> ダイスロール
                </button>
            </div>
            
            <!-- 探索者保存 -->
            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-success" id="footerSaveCharacter">
                    <i class="fas fa-save"></i> 探索者保存
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // 6版基本技能データ（カテゴリ分け）
    const SKILLS_6TH = {
        // 戦闘系技能
        "combat": {
            "dodge": { base: "DEX×2", name: "回避" },
            "martial_arts": { base: 1, name: "マーシャルアーツ" },
            "throw": { base: 25, name: "投擲" },
            "first_aid": { base: 30, name: "応急手当" },
            "fist_punch": { base: 50, name: "こぶし（パンチ）" },
            "head_butt": { base: 10, name: "頭突き" },
            "kick": { base: 25, name: "キック" },
            "grapple": { base: 25, name: "組み付き" },
            "knife": { base: 20, name: "ナイフ" },
            "club": { base: 25, name: "こん棒" },
            "handgun": { base: 20, name: "拳銃" },
            "rifle": { base: 25, name: "ライフル" },
            "shotgun": { base: 30, name: "ショットガン" },
            "submachine_gun": { base: 15, name: "サブマシンガン" },
            "machine_gun": { base: 15, name: "マシンガン" },
            "bow": { base: 15, name: "弓" },
            "sword": { base: 20, name: "剣" },
            "spear": { base: 20, name: "槍" },
            "whip": { base: 5, name: "鞭" }
        },
        // 探索技能
        "exploration": {
            "spot_hidden": { base: 25, name: "目星" },
            "listen": { base: 25, name: "聞き耳" },
            "library_use": { base: 25, name: "図書館" },
            "track": { base: 10, name: "追跡" },
            "navigate": { base: 10, name: "ナビゲート" },
            "photography": { base: 10, name: "写真術" }
        },
        // 行動技能
        "action": {
            "climb": { base: 40, name: "登攀" },
            "jump": { base: 25, name: "跳躍" },
            "swim": { base: 25, name: "水泳" },
            "sneak": { base: 10, name: "忍び歩き" },
            "hide": { base: 10, name: "隠れる" },
            "conceal": { base: 15, name: "隠す" },
            "locksmith": { base: 1, name: "鍵開け" },
            "drive_auto": { base: 20, name: "運転" },
            "pilot": { base: 1, name: "操縦" },
            "ride": { base: 5, name: "乗馬" },
            "electrical_repair": { base: 10, name: "電気修理" },
            "electronics": { base: 1, name: "電子工学" },
            "mechanical_repair": { base: 20, name: "機械修理" },
            "operate_heavy_machine": { base: 1, name: "重機械操作" },
            "disguise": { base: 1, name: "変装" },
            "sleight_of_hand": { base: 10, name: "手さばき" }
        },
        // 交渉技能
        "social": {
            "persuade": { base: 15, name: "説得" },
            "fast_talk": { base: 5, name: "言いくるめ" },
            "bargain": { base: 5, name: "値切り" },
            "psychology": { base: 5, name: "心理学" },
            "psychoanalysis": { base: 1, name: "精神分析" },
            "credit_rating": { base: 0, name: "信用" },
            "language_own": { base: "EDU×5", name: "母国語" },
            "language_other": { base: 1, name: "他国語" },
            "intimidate": { base: 15, name: "威嚇" },
            "charm": { base: 15, name: "魅惑" }
        },
        // 知識技能
        "knowledge": {
            "occult": { base: 5, name: "オカルト" },
            "cthulhu_mythos": { base: 0, name: "クトゥルフ神話" },
            "archaeology": { base: 1, name: "考古学" },
            "anthropology": { base: 1, name: "人類学" },
            "history": { base: 20, name: "歴史" },
            "natural_world": { base: 10, name: "博物学" },
            "geology": { base: 1, name: "地質学" },
            "astronomy": { base: 1, name: "天文学" },
            "biology": { base: 1, name: "生物学" },
            "chemistry": { base: 1, name: "化学" },
            "physics": { base: 1, name: "物理学" },
            "pharmacy": { base: 1, name: "薬学" },
            "medicine": { base: 5, name: "医学" },
            "law": { base: 5, name: "法律" },
            "accounting": { base: 10, name: "経理" },
            "computer_use": { base: 1, name: "コンピューター" },
            "appraise": { base: 5, name: "鑑定" },
            "cryptography": { base: 1, name: "暗号" },
            "forensics": { base: 1, name: "鑑識" }
        },
        // その他技能
        "other": {
            "art": { base: 5, name: "芸術" },
            "craft": { base: 5, name: "工芸" },
            "sing": { base: 5, name: "歌唱" },
            "play_instrument": { base: 5, name: "楽器演奏" },
            "dance": { base: 5, name: "ダンス" },
            "acting": { base: 5, name: "演技" },
            "teach": { base: 10, name: "教育" },
            "perform": { base: 5, name: "芸能" },
            "animal_handling": { base: 5, name: "動物使い" },
            "survival": { base: 10, name: "サバイバル" },
            "hypnosis": { base: 1, name: "催眠術" },
            "occult_folklore": { base: 5, name: "民俗学" },
            "gaming": { base: 5, name: "ギャンブル" }
        }
    };
    
    // 全技能の統合オブジェクト（後方互換性のため）
    const ALL_SKILLS_6TH = {
        ...SKILLS_6TH.combat,
        ...SKILLS_6TH.exploration,
        ...SKILLS_6TH.action,
        ...SKILLS_6TH.social,
        ...SKILLS_6TH.knowledge,
        ...SKILLS_6TH.other
    };

    // 全能力値ダイス設定の更新
    function updateGlobalDiceFormula() {
        const count = parseInt(document.getElementById('globalDiceCount')?.value) || 3;
        const sides = parseInt(document.getElementById('globalDiceSides')?.value) || 6;
        const bonus = parseInt(document.getElementById('globalDiceBonus')?.value) || 0;
        
        const formula = `${count}d${sides}${bonus >= 0 ? '+' : ''}${bonus}`;
        const formulaSpan = document.getElementById('globalDiceFormula');
        if (formulaSpan) {
            formulaSpan.textContent = formula;
        }
        
        return { count, sides, bonus };
    }

    // ダイスロール関数
    function rollDice(count, sides, bonus) {
        let total = 0;
        for (let i = 0; i < count; i++) {
            total += Math.floor(Math.random() * sides) + 1;
        }
        return total + bonus;
    }

    // 全能力値ロール
    function rollAllAbilities() {
        const { count, sides, bonus } = updateGlobalDiceFormula();
        const abilities = ['str', 'con', 'pow', 'dex', 'app', 'siz', 'int', 'edu'];
        
        abilities.forEach(abilityName => {
            let total = 0;
            for (let i = 0; i < count; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            total += bonus;
            
            const input = document.getElementById(abilityName);
            if (input) {
                input.value = total;
                
                // エフェクト追加
                input.classList.add('dice-rolled');
                setTimeout(() => input.classList.remove('dice-rolled'), 1000);
            }
        });
        
        // 自動計算実行
        calculateDerivedStats();
    }

    // 副次ステータス自動計算
    function calculateDerivedStats() {
        const str = parseInt(document.getElementById('str')?.value) || 0;
        const con = parseInt(document.getElementById('con')?.value) || 0;
        const pow = parseInt(document.getElementById('pow')?.value) || 0;
        const dex = parseInt(document.getElementById('dex')?.value) || 0;
        const int = parseInt(document.getElementById('int')?.value) || 0;
        const edu = parseInt(document.getElementById('edu')?.value) || 0;
        const siz = parseInt(document.getElementById('siz')?.value) || 0;
        
        // 6版計算式に基づく（端数切り上げ）
        const hp = Math.ceil((con + siz) / 2);
        const mp = pow;  // MP = POW
        const san = pow * 5;  // SAN = POW × 5
        
        if (document.getElementById('hp')) document.getElementById('hp').value = hp;
        if (document.getElementById('mp')) document.getElementById('mp').value = mp;
        if (document.getElementById('san')) document.getElementById('san').value = san;
        
        // 現在値も初期値として設定
        if (document.getElementById('current_hp')) document.getElementById('current_hp').value = hp;
        if (document.getElementById('current_mp')) document.getElementById('current_mp').value = mp;
        if (document.getElementById('current_san')) document.getElementById('current_san').value = san;
        
        // 最大SANも設定（6版では初期値と同じ）
        if (document.getElementById('sanity_max')) document.getElementById('sanity_max').value = san;
        
        // 6版固有の計算
        calculateDerivedStats6th(str, con, pow, dex, int, edu, siz);
        
        // 技能ポイント計算
        calculateSkillPoints();
        
        // 動的基本値の技能を更新（DEXやEDUの変更時）
        updateDynamicSkillBases();
    }
    
    function calculateDerivedStats6th(str, con, pow, dex, int, edu, siz) {
        // アイデア = INT × 5
        if (document.getElementById('idea')) {
            document.getElementById('idea').value = int * 5;
        }
        
        // 幸運 = POW × 5
        if (document.getElementById('luck')) {
            document.getElementById('luck').value = pow * 5;
        }
        
        // 知識 = EDU × 5
        if (document.getElementById('know')) {
            document.getElementById('know').value = edu * 5;
        }
        
        // ダメージボーナス計算（6版）
        const total = str + siz;
        let damageBonus;
        
        if (total <= 12) damageBonus = "-1d4";
        else if (total <= 16) damageBonus = "-1d2";
        else if (total <= 24) damageBonus = "+0";
        else if (total <= 32) damageBonus = "+1d4";
        else if (total <= 40) damageBonus = "+1d6";
        else damageBonus = "+2d6";
        
        if (document.getElementById('damage-bonus')) {
            document.getElementById('damage-bonus').value = damageBonus;
        }
    }

    // 職業技能ポイント計算方式
    function calculateOccupationSkillPoints(method) {
        const str = parseInt(document.getElementById('str')?.value) || 0;
        const con = parseInt(document.getElementById('con')?.value) || 0;
        const pow = parseInt(document.getElementById('pow')?.value) || 0;
        const dex = parseInt(document.getElementById('dex')?.value) || 0;
        const app = parseInt(document.getElementById('app')?.value) || 0;
        const siz = parseInt(document.getElementById('siz')?.value) || 0;
        const edu = parseInt(document.getElementById('edu')?.value) || 0;
        
        const calculationMethods = {
            'edu20': edu * 20,
            'edu10app10': edu * 10 + app * 10,
            'edu10dex10': edu * 10 + dex * 10,
            'edu10pow10': edu * 10 + pow * 10,
            'edu10str10': edu * 10 + str * 10,
            'edu10con10': edu * 10 + con * 10,
            'edu10siz10': edu * 10 + siz * 10
        };
        
        return calculationMethods[method] || edu * 20;
    }
    
    // 技能ポイント計算
    function calculateSkillPoints() {
        const int = parseInt(document.getElementById('int')?.value) || 0;
        const method = document.getElementById('occupationMethod')?.value || 'edu20';
        
        // 職業技能ポイント: 選択された計算方式による
        const occupationPoints = calculateOccupationSkillPoints(method);
        
        // 趣味技能ポイント: INT × 10
        const interestPoints = int * 10;
        
        if (document.getElementById('occupationTotal')) {
            document.getElementById('occupationTotal').value = occupationPoints;
        }
        if (document.getElementById('interestTotal')) {
            document.getElementById('interestTotal').value = interestPoints;
        }
    }



    // 技能アイテムHTML生成
    function createSkillItemHTML(key, skill, category = 'all') {
        let baseValue = skill.base;
        if (typeof baseValue === 'string') {
            // 動的基本値計算
            if (baseValue === 'DEX×2') {
                const dex = parseInt(document.getElementById('dex')?.value) || 0;
                baseValue = dex * 2;
            } else if (baseValue === 'EDU×5') {
                const edu = parseInt(document.getElementById('edu')?.value) || 0;
                baseValue = edu * 5;
            }
        }
        
        return `
            <div class="col-xl-3 col-lg-4 col-md-6 mb-3">
                <div class="skill-item border rounded p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <label for="skill_${key}" class="form-label small fw-bold mb-0">${skill.name}</label>
                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                onclick="toggleSkillDiceSettings('${key}')" 
                                title="ダイス設定">
                            <i class="fas fa-dice-d6"></i>
                        </button>
                    </div>
                    
                    <!-- ダイス設定エリア（初期非表示） -->
                    <div id="diceSettings_${key}" class="skill-dice-settings mt-2" style="display: none;">
                        <div class="bg-light p-2 rounded">
                            <div class="row g-1">
                                <div class="col-4">
                                    <label class="form-label small">個数</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="skillDiceCount_${key}" min="1" max="10" value="3" 
                                           onchange="updateSkillDiceFormula('${key}')">
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">面数</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="skillDiceSides_${key}" min="2" max="100" value="6" 
                                           onchange="updateSkillDiceFormula('${key}')">
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">ボーナス</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="skillDiceBonus_${key}" min="-50" max="50" value="0" 
                                           onchange="updateSkillDiceFormula('${key}')">
                                </div>
                            </div>
                            <div class="row g-1 mt-1">
                                <div class="col-8">
                                    <span class="small text-muted">式: <span id="skillDiceFormula_${key}">3d6+0</span></span>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-primary btn-sm w-100" 
                                            onclick="rollSkillValue('${key}')">
                                        <i class="fas fa-dice"></i> ロール
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-1 mt-2">
                        <div class="col-4">
                            <input type="number" class="form-control form-control-sm text-center skill-base" 
                                   id="base_${key}" value="${baseValue}" min="0" max="100" 
                                   data-skill="${key}" data-default="${skill.base}" 
                                   title="基本値（クリックで編集、右クリックでリセット）"
                                   data-bs-toggle="tooltip"
                                   data-bs-placement="top">
                        </div>
                        <div class="col-4">
                            <input type="number" class="form-control form-control-sm occupation-skill text-center" 
                                   id="occ_${key}" min="0" max="90" value="0" placeholder="職" 
                                   data-skill="${key}" title="職業技能">
                        </div>
                        <div class="col-4">
                            <input type="number" class="form-control form-control-sm interest-skill text-center" 
                                   id="int_${key}" min="0" max="90" value="0" placeholder="趣" 
                                   data-skill="${key}" title="趣味技能">
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-12">
                            <div class="skill-total fw-bold text-center" id="total_${key}">${baseValue}%</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 技能リスト生成（カテゴリ別）
    function generateSkillsList() {
        // 各カテゴリのコンテナを取得
        const combatContainer = document.getElementById('combatSkills');
        const explorationContainer = document.getElementById('explorationSkills');
        const actionContainer = document.getElementById('actionSkills');
        const socialContainer = document.getElementById('socialSkills');
        const knowledgeContainer = document.getElementById('knowledgeSkills');
        const allContainer = document.getElementById('allSkills');
        
        // 各カテゴリの技能を生成
        if (combatContainer) {
            combatContainer.innerHTML = '';
            Object.entries(SKILLS_6TH.combat).forEach(([key, skill]) => {
                combatContainer.innerHTML += createSkillItemHTML(key, skill, 'combat');
            });
        }
        
        if (explorationContainer) {
            explorationContainer.innerHTML = '';
            Object.entries(SKILLS_6TH.exploration).forEach(([key, skill]) => {
                explorationContainer.innerHTML += createSkillItemHTML(key, skill, 'exploration');
            });
        }
        
        if (actionContainer) {
            actionContainer.innerHTML = '';
            Object.entries(SKILLS_6TH.action).forEach(([key, skill]) => {
                actionContainer.innerHTML += createSkillItemHTML(key, skill, 'action');
            });
        }
        
        if (socialContainer) {
            socialContainer.innerHTML = '';
            Object.entries(SKILLS_6TH.social).forEach(([key, skill]) => {
                socialContainer.innerHTML += createSkillItemHTML(key, skill, 'social');
            });
        }
        
        if (knowledgeContainer) {
            knowledgeContainer.innerHTML = '';
            Object.entries(SKILLS_6TH.knowledge).forEach(([key, skill]) => {
                knowledgeContainer.innerHTML += createSkillItemHTML(key, skill, 'knowledge');
            });
        }
        
        if (allContainer) {
            allContainer.innerHTML = '';
            Object.entries(ALL_SKILLS_6TH).forEach(([key, skill]) => {
                allContainer.innerHTML += createSkillItemHTML(key, skill, 'all');
            });
        }
        
        // 技能入力イベント追加
        addSkillInputEvents();
        
        // ツールチップの初期化
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }

    // 技能入力イベント
    function addSkillInputEvents() {
        try {
            document.querySelectorAll('.occupation-skill, .interest-skill').forEach(input => {
                input.addEventListener('input', updateSkillTotals);
            });
            
            // 基本値入力イベントを追加
            document.querySelectorAll('.skill-base').forEach(input => {
                input.addEventListener('input', function() {
                    try {
                        const skillKey = this.dataset.skill;
                        const value = parseInt(this.value) || 0;
                        
                        // カスタム基本値を保存
                        if (!window.customBaseValues) {
                            window.customBaseValues = {};
                        }
                        window.customBaseValues[skillKey] = value;
                        
                        // カスタマイズされたことを示すクラスを追加
                        this.classList.add('customized');
                        
                        // 技能合計を更新
                        updateSkillTotals();
                    } catch (error) {
                        console.error('Error in skill base input handler:', error);
                    }
                });
            
            // 右クリックでデフォルト値にリセット
            input.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                try {
                    const skillKey = this.dataset.skill;
                    const defaultValue = this.dataset.default;
                    
                    // カスタム基本値をクリア
                    if (window.customBaseValues && window.customBaseValues[skillKey]) {
                        delete window.customBaseValues[skillKey];
                    }
                    
                    // カスタマイズクラスを削除
                    this.classList.remove('customized');
                    
                    // デフォルト値に戻す
                    const skill = ALL_SKILLS_6TH[skillKey];
                    if (!skill) {
                        console.warn(`Skill ${skillKey} not found in ALL_SKILLS_6TH`);
                        return;
                    }
                    let baseValue = skill.base;
                    if (typeof baseValue === 'string') {
                        if (baseValue === 'DEX×2') {
                            const dex = parseInt(document.getElementById('dex')?.value) || 0;
                            baseValue = dex * 2;
                        } else if (baseValue === 'EDU×5') {
                            const edu = parseInt(document.getElementById('edu')?.value) || 0;
                            baseValue = edu * 5;
                        }
                    }
                    this.value = baseValue;
                    
                    // 技能合計を更新
                    updateSkillTotals();
                    
                    // フィードバック表示
                    this.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 300);
                } catch (error) {
                    console.error('Error in skill base reset handler:', error);
                }
            });
        });
        } catch (error) {
            console.error('Error in addSkillInputEvents:', error);
        }
    }
    
    // 技能別ダイス設定の表示/非表示切り替え
    function toggleSkillDiceSettings(skillKey) {
        const settingsDiv = document.getElementById(`diceSettings_${skillKey}`);
        if (settingsDiv) {
            if (settingsDiv.style.display === 'none') {
                settingsDiv.style.display = 'block';
                updateSkillDiceFormula(skillKey);
            } else {
                settingsDiv.style.display = 'none';
            }
        }
    }
    
    // 技能別ダイス式の更新
    function updateSkillDiceFormula(skillKey) {
        const count = parseInt(document.getElementById(`skillDiceCount_${skillKey}`)?.value) || 3;
        const sides = parseInt(document.getElementById(`skillDiceSides_${skillKey}`)?.value) || 6;
        const bonus = parseInt(document.getElementById(`skillDiceBonus_${skillKey}`)?.value) || 0;
        
        const formula = `${count}d${sides}${bonus >= 0 ? '+' : ''}${bonus}`;
        const formulaSpan = document.getElementById(`skillDiceFormula_${skillKey}`);
        if (formulaSpan) {
            formulaSpan.textContent = formula;
        }
        
        return { count, sides, bonus };
    }
    
    // 技能値のダイスロール
    function rollSkillValue(skillKey) {
        const { count, sides, bonus } = updateSkillDiceFormula(skillKey);
        
        let total = 0;
        for (let i = 0; i < count; i++) {
            total += Math.floor(Math.random() * sides) + 1;
        }
        total += bonus;
        
        // 職業技能と趣味技能の入力欄に値を設定
        const occInput = document.getElementById(`occ_${skillKey}`);
        const intInput = document.getElementById(`int_${skillKey}`);
        
        // 技能名を取得
        const skillName = ALL_SKILLS_6TH[skillKey]?.name || skillKey;
        
        // ダイアログで振り分けを選択
        const choice = confirm(
            `${skillName}のダイスロール結果: ${total}\n\n` +
            'OK: 職業技能に設定\n' +
            'キャンセル: 趣味技能に設定'
        );
        
        if (choice && occInput) {
            occInput.value = Math.min(total, 90);
            occInput.classList.add('dice-rolled');
            setTimeout(() => occInput.classList.remove('dice-rolled'), 1000);
        } else if (!choice && intInput) {
            intInput.value = Math.min(total, 90);
            intInput.classList.add('dice-rolled');
            setTimeout(() => intInput.classList.remove('dice-rolled'), 1000);
        }
        
        // 技能合計を更新
        updateSkillTotals();
    }
    
    // 動的基本値を持つ技能の更新
    function updateDynamicSkillBases() {
        try {
            // 回避（DEX×2）
            const dexEl = document.getElementById('dex');
            if (!dexEl) {
                console.warn('DEX element not found');
                return;
            }
            const dex = parseInt(dexEl.value) || 0;
            const dodgeBaseEl = document.getElementById('base_dodge');
            if (dodgeBaseEl && (!window.customBaseValues || window.customBaseValues['dodge'] === undefined)) {
                dodgeBaseEl.value = dex * 2;
            }
            
            // 母国語（EDU×5）
            const eduEl = document.getElementById('edu');
            if (!eduEl) {
                console.warn('EDU element not found');
                return;
            }
            const edu = parseInt(eduEl.value) || 0;
            const languageOwnBaseEl = document.getElementById('base_language_own');
            if (languageOwnBaseEl && (!window.customBaseValues || window.customBaseValues['language_own'] === undefined)) {
                languageOwnBaseEl.value = edu * 5;
            }
            
            // 技能合計も更新
            updateSkillTotals();
        } catch (error) {
            console.error('Error in updateDynamicSkillBases:', error);
        }
    }
    
    // グローバル関数として定義（HTMLから呼び出すため）
    window.toggleSkillDiceSettings = toggleSkillDiceSettings;
    window.updateSkillDiceFormula = updateSkillDiceFormula;
    window.rollSkillValue = rollSkillValue;

    // 技能合計更新
    function updateSkillTotals() {
        // console.log('updateSkillTotals called');
        let occupationUsed = 0;
        let interestUsed = 0;
        let allocatedCount = 0;
        const allocatedSkills = [];
        
        Object.keys(ALL_SKILLS_6TH).forEach(key => {
            const occEl = document.getElementById(`occ_${key}`);
            const intEl = document.getElementById(`int_${key}`);
            const totalEl = document.getElementById(`total_${key}`);
            
            if (occEl && intEl && totalEl) {
                // 基本値を取得（カスタム値がある場合はそれを使用）
                let base = 0;
                if (window.customBaseValues && window.customBaseValues[key] !== undefined) {
                    base = window.customBaseValues[key];
                } else {
                    // デフォルトの基本値を動的に計算
                    const skill = ALL_SKILLS_6TH[key];
                    let baseValue = skill.base;
                    if (typeof baseValue === 'string') {
                        if (baseValue === 'DEX×2') {
                            const dex = parseInt(document.getElementById('dex')?.value) || 0;
                            baseValue = dex * 2;
                        } else if (baseValue === 'EDU×5') {
                            const edu = parseInt(document.getElementById('edu')?.value) || 0;
                            baseValue = edu * 5;
                        }
                    }
                    base = parseInt(baseValue) || 0;
                }
                const occ = parseInt(occEl.value) || 0;
                const int = parseInt(intEl.value) || 0;
                
                const total = Math.min(base + occ + int, 90);
                totalEl.textContent = total + '%';
                
                // ポイントが振り分けられている技能を記録
                if (occ > 0 || int > 0) {
                    allocatedCount++;
                    allocatedSkills.push({
                        key: key,
                        skill: skill,
                        base: base,
                        occ: occ,
                        int: int,
                        total: total
                    });
                }
                
                occupationUsed += occ;
                interestUsed += int;
            }
        });
        
        // 振り分け済み技能タブの更新
        updateAllocatedSkillsTab(allocatedSkills);
        
        // 振り分け済み技能数のバッジ更新
        const allocatedCountBadge = document.getElementById('allocatedCount');
        if (allocatedCountBadge) {
            allocatedCountBadge.textContent = allocatedCount;
        }
        
        // ポイント使用状況更新
        const occupationTotal = parseInt(document.getElementById('occupationTotal')?.value) || 0;
        const interestTotal = parseInt(document.getElementById('interestTotal')?.value) || 0;
        
        if (document.getElementById('occupationUsed')) {
            document.getElementById('occupationUsed').textContent = occupationUsed;
        }
        if (document.getElementById('occupationRemaining')) {
            document.getElementById('occupationRemaining').textContent = Math.max(0, occupationTotal - occupationUsed);
        }
        if (document.getElementById('interestUsed')) {
            document.getElementById('interestUsed').textContent = interestUsed;
        }
        if (document.getElementById('interestRemaining')) {
            document.getElementById('interestRemaining').textContent = Math.max(0, interestTotal - interestUsed);
        }
        
        // フッターの技能ポイント表示も更新
        if (document.getElementById('occupationUsedFooter')) {
            document.getElementById('occupationUsedFooter').textContent = occupationUsed;
        }
        if (document.getElementById('occupationTotalFooter')) {
            document.getElementById('occupationTotalFooter').textContent = occupationTotal;
        }
        if (document.getElementById('interestUsedFooter')) {
            document.getElementById('interestUsedFooter').textContent = interestUsed;
        }
        if (document.getElementById('interestTotalFooter')) {
            document.getElementById('interestTotalFooter').textContent = interestTotal;
        }
    }
    
    // 振り分け済み技能タブの更新
    function updateAllocatedSkillsTab(allocatedSkills) {
        const allocatedContainer = document.getElementById('allocatedSkills');
        const noAllocatedMessage = document.getElementById('noAllocatedMessage');
        
        if (!allocatedContainer) return;
        
        if (allocatedSkills.length === 0) {
            // 振り分けられた技能がない場合
            allocatedContainer.innerHTML = `
                <div class="col-12 text-center text-muted p-4" id="noAllocatedMessage">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>まだポイントを振り分けた技能がありません。</p>
                </div>
            `;
        } else {
            // 振り分けられた技能を表示
            allocatedContainer.innerHTML = '';
            allocatedSkills.forEach(item => {
                allocatedContainer.innerHTML += createSkillItemHTML(item.key, ALL_SKILLS_6TH[item.key], 'allocated');
            });
        }
    }


    // イベントリスナー設定
    document.getElementById('rollAllAbilities')?.addEventListener('click', rollAllAbilities);
    
    // 全能力値ダイス設定の変更時にフォーミュラを更新
    document.getElementById('globalDiceCount')?.addEventListener('input', updateGlobalDiceFormula);
    document.getElementById('globalDiceSides')?.addEventListener('input', updateGlobalDiceFormula);
    document.getElementById('globalDiceBonus')?.addEventListener('input', updateGlobalDiceFormula);
    
    // 職業技能ポイント計算方式変更時のイベント
    document.getElementById('occupationMethod')?.addEventListener('change', function() {
        calculateSkillPoints();
        updateSkillTotals();
    });
    
    
    // フッターボタンのイベントリスナー
    document.getElementById('footerRollDice')?.addEventListener('click', function() {
        document.getElementById('rollAllAbilities')?.click();
    });
    
    document.getElementById('footerSaveCharacter')?.addEventListener('click', function() {
        document.getElementById('character-sheet-form')?.dispatchEvent(new Event('submit'));
    });
    
    // 能力値変更時に副次ステータスを更新
    document.querySelectorAll('.ability-score').forEach(input => {
        input.addEventListener('input', calculateDerivedStats);
    });

    // リセット・計算ボタン
    document.getElementById('resetSkillPoints')?.addEventListener('click', function() {
        document.querySelectorAll('.occupation-skill, .interest-skill').forEach(input => {
            input.value = 0;
        });
        updateSkillTotals();
    });

    document.getElementById('calculateSkills')?.addEventListener('click', function() {
        calculateSkillPoints();
        updateSkillTotals();
    });

    // 職業テンプレートデータ
    const OCCUPATION_TEMPLATES = {
        academic: [
            {
                name: "教授",
                skills: ["図書館", "心理学", "説得", "信用", "歴史", "博物学", "他国語", "オカルト"],
                multiplier: 20,
                description: "大学教授や研究者"
            },
            {
                name: "考古学者", 
                skills: ["考古学", "図書館", "歴史", "目星", "ナビゲート", "写真術", "他国語", "鑑定"],
                multiplier: 20,
                description: "遺跡や古代文明の研究者"
            },
            {
                name: "図書館司書",
                skills: ["図書館", "経理", "コンピューター", "歴史", "心理学", "他国語", "目星", "説得"],
                multiplier: 20,
                description: "図書館や資料館の管理者"
            }
        ],
        investigation: [
            {
                name: "私立探偵",
                skills: ["目星", "聞き耳", "追跡", "心理学", "説得", "写真術", "隠れる", "法律"],
                multiplier: 20,
                description: "民間の調査員"
            },
            {
                name: "ジャーナリスト",
                skills: ["説得", "心理学", "目星", "聞き耳", "写真術", "言いくるめ", "図書館", "他国語"],
                multiplier: 20,
                description: "新聞記者や報道関係者"
            },
            {
                name: "警察官",
                skills: ["法律", "目星", "聞き耳", "威嚇", "拳銃", "組み付き", "運転", "応急手当"],
                multiplier: 20,
                description: "法執行官"
            }
        ],
        combat: [
            {
                name: "軍人",
                skills: ["ライフル", "拳銃", "回避", "応急手当", "威嚇", "サバイバル", "ナビゲート", "運転"],
                multiplier: 20,
                description: "現役または退役軍人"
            },
            {
                name: "格闘家",
                skills: ["マーシャルアーツ", "回避", "キック", "組み付き", "心理学", "威嚇", "跳躍", "応急手当"],
                multiplier: 20,
                description: "武道家やボクサー"
            }
        ],
        medical: [
            {
                name: "医師",
                skills: ["医学", "応急手当", "生物学", "薬学", "心理学", "信用", "説得", "他国語"],
                multiplier: 20,
                description: "医者や外科医"
            },
            {
                name: "看護師",
                skills: ["医学", "応急手当", "生物学", "心理学", "説得", "聞き耳", "目星", "薬学"],
                multiplier: 20,
                description: "医療従事者"
            }
        ],
        arts: [
            {
                name: "芸術家",
                skills: ["芸術", "心理学", "目星", "歴史", "説得", "魅惑", "他国語", "鑑定"],
                multiplier: 20,
                description: "画家、彫刻家など"
            },
            {
                name: "作家",
                skills: ["母国語", "他国語", "図書館", "心理学", "歴史", "オカルト", "説得", "目星"],
                multiplier: 20,
                description: "小説家や脚本家"
            }
        ],
        others: [
            {
                name: "犯罪者",
                skills: ["隠れる", "忍び歩き", "鍵開け", "手さばき", "目星", "聞き耳", "値切り", "変装"],
                multiplier: 20,
                description: "元犯罪者や裏社会の人間"
            },
            {
                name: "ディレッタント",
                skills: ["信用", "乗馬", "芸術", "他国語", "拳銃", "歴史", "魅惑", "経理"],
                multiplier: 20,
                description: "資産家、道楽者"
            }
        ]
    };

    // 職業テンプレート機能の初期化
    function initOccupationTemplates() {
        const categoryLinks = document.querySelectorAll('#occupationCategories a');
        categoryLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // アクティブクラスの切り替え
                categoryLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // カテゴリーの職業を表示
                const category = this.dataset.category;
                displayOccupations(category);
            });
        });
        
        // 初期表示
        displayOccupations('academic');
    }

    // 職業リストの表示
    function displayOccupations(category) {
        const occupationList = document.getElementById('occupationList');
        const occupations = OCCUPATION_TEMPLATES[category] || [];
        
        let html = '<div class="list-group">';
        occupations.forEach(occ => {
            html += `
                <a href="#" class="list-group-item list-group-item-action occupation-template-item" 
                   data-occupation='${JSON.stringify(occ)}'>
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${occ.name}</h6>
                        <small>倍率: EDU×${occ.multiplier}</small>
                    </div>
                    <p class="mb-1 text-muted small">${occ.description}</p>
                    <small>推奨技能: ${occ.skills.join(', ')}</small>
                </a>
            `;
        });
        html += '</div>';
        
        occupationList.innerHTML = html;
        
        // クリックイベントの設定
        document.querySelectorAll('.occupation-template-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const occupation = JSON.parse(this.dataset.occupation);
                applyOccupationTemplate(occupation);
            });
        });
    }

    // 職業テンプレートの適用
    function applyOccupationTemplate(occupation) {
        // 職業名を設定
        document.getElementById('occupation').value = occupation.name;
        
        // 職業倍率を設定
        const methodSelect = document.getElementById('occupationMethod');
        if (methodSelect && occupation.multiplier === 20) {
            methodSelect.value = 'edu20';
        }
        
        // 推奨技能をハイライト（実装は省略）
        // console.log('推奨技能:', occupation.skills);
        
        // モーダルを閉じる
        const modal = bootstrap.Modal.getInstance(document.getElementById('occupationTemplateModal'));
        modal.hide();
        
        // 技能ポイントを再計算
        calculateSkillPoints();
        updateSkillTotals();
    }

    // Bootstrap タブ初期化
    const triggerTabList = [].slice.call(document.querySelectorAll('#skillTabs button'));
    triggerTabList.forEach(function (triggerEl) {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            tabTrigger.show();
        });
    });
    
    // 画像アップロード機能
    function initImageUpload() {
        const imageInput = document.getElementById('character-image');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const removeBtn = document.getElementById('remove-image');
        
        if (!imageInput) return;
        
        // ファイル選択時のプレビュー表示
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // ファイルサイズチェック（5MB）
                if (file.size > 5 * 1024 * 1024) {
                    alert('ファイルサイズは5MB以下にしてください。');
                    imageInput.value = '';
                    return;
                }
                
                // ファイルタイプチェック
                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                    alert('JPG、PNG、GIF形式の画像ファイルを選択してください。');
                    imageInput.value = '';
                    return;
                }
                
                // プレビュー表示
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 画像削除
        removeBtn?.addEventListener('click', function() {
            imageInput.value = '';
            previewImg.src = '';
            imagePreview.style.display = 'none';
        });
    }
    
    // 初期化
    updateGlobalDiceFormula();
    generateSkillsList();
    addSkillInputEvents();  // 技能リスト生成後にイベントリスナーを追加
    
    // 技能リストが生成された後に派生ステータスを計算
    setTimeout(() => {
        calculateDerivedStats();
        updateSkillTotals();    // 初期計算を実行
    }, 0);
    
    initOccupationTemplates(); // 職業テンプレート機能を初期化
    initImageUpload(); // 画像アップロード機能を初期化
    
    // フォーム送信処理
    const characterForm = document.getElementById('character-sheet-form');
    if (characterForm) {
        characterForm.addEventListener('submit', function(e) {
            e.preventDefault();
        
            const formData = new FormData(this);
            const data = {};
            
            // FormDataからデータを取得（ファイル以外）
            for (let [key, value] of formData.entries()) {
                if (key !== 'character_image') {
                    data[key] = value;
                }
            }
            
            // バリデーション
            if (!data.name) {
                alert('探索者名は必須です。');
                return;
            }
            
            // 能力値バリデーション（フィールド名を修正）
            const abilities = ['str_value', 'con_value', 'pow_value', 'dex_value', 'app_value', 'siz_value', 'int_value', 'edu_value'];
            let hasAbilities = false;
            for (const ability of abilities) {
                if (data[ability] && parseInt(data[ability]) > 0) {
                    hasAbilities = true;
                    break;
                }
            }
            
            if (!hasAbilities) {
                alert('能力値を設定してください。');
                return;
            }
            
            // 6版用にAPIエンドポイントに送信
            const apiData = {
                edition: '6th',
                name: data.character_name,
                player_name: data.player_name || '',
                age: parseInt(data.age) || null,
                gender: data.gender || '',
                occupation: data.occupation || '',
                birthplace: data.birthplace || '',
                residence: data.residence || '',
                str_value: parseInt(data.str) || 10,
                con_value: parseInt(data.con) || 10,
                pow_value: parseInt(data.pow) || 10,
                dex_value: parseInt(data.dex) || 10,
                app_value: parseInt(data.app) || 10,
                siz_value: parseInt(data.siz) || 10,
                int_value: parseInt(data.int) || 10,
                edu_value: parseInt(data.edu) || 10,
                notes: data.notes || ''
            };
            
            // 戦闘ステータス
            if (data.current_hp) apiData.hit_points_current = parseInt(data.current_hp);
            if (data.current_mp) apiData.magic_points_current = parseInt(data.current_mp);
            if (data.current_san) apiData.sanity_points_current = parseInt(data.current_san);
            if (data.armor) apiData.armor = parseInt(data.armor) || 0;
            
            // 財産情報
            if (data.money) apiData.money = parseInt(data.money) || 0;
            if (data.assets) apiData.assets = parseInt(data.assets) || 0;
            if (data.income) apiData.income = parseInt(data.income) || 0;
            
            // 背景情報をnotesに統合
            const backgroundNotes = [];
            if (data.backstory) backgroundNotes.push(`背景ストーリー:\n${data.backstory}`);
            if (data.appearance) backgroundNotes.push(`外見:\n${data.appearance}`);
            if (data.ideals) backgroundNotes.push(`信念・信条:\n${data.ideals}`);
            if (data.bonds) backgroundNotes.push(`重要な人物:\n${data.bonds}`);
            if (data.flaws) backgroundNotes.push(`弱点・恐怖症:\n${data.flaws}`);
            if (data.items) backgroundNotes.push(`所持品:\n${data.items}`);
            
            if (backgroundNotes.length > 0) {
                apiData.notes = (apiData.notes ? apiData.notes + '\n\n' : '') + backgroundNotes.join('\n\n');
            }
            
            // 技能データの収集
            const skills = [];
            document.querySelectorAll('.occupation-skill').forEach(input => {
                const skillKey = input.dataset.skill;
                const occValue = parseInt(input.value) || 0;
                const intValue = parseInt(document.getElementById(`int_${skillKey}`)?.value) || 0;
                
                if (occValue > 0 || intValue > 0) {
                    // カスタム基本値があれば使用、なければデフォルト値を使用
                    let baseValue = 0;
                    if (window.customBaseValues && window.customBaseValues[skillKey] !== undefined) {
                        baseValue = window.customBaseValues[skillKey];
                    } else {
                        const skillData = ALL_SKILLS_6TH[skillKey];
                        if (skillData) {
                            let defaultBase = skillData.base;
                            if (typeof defaultBase === 'string') {
                                if (defaultBase === 'DEX×2') {
                                    const dex = parseInt(document.getElementById('dex')?.value) || 0;
                                    defaultBase = dex * 2;
                                } else if (defaultBase === 'EDU×5') {
                                    const edu = parseInt(document.getElementById('edu')?.value) || 0;
                                    defaultBase = edu * 5;
                                }
                            }
                            baseValue = parseInt(defaultBase) || 0;
                        }
                    }
                    
                    skills.push({
                        skill_name: ALL_SKILLS_6TH[skillKey]?.name || skillKey,
                        base_value: baseValue,
                        occupation_points: occValue,
                        interest_points: intValue,
                        other_points: 0
                    });
                }
            });
            
            if (skills.length > 0) {
                apiData.skills = skills;
            }
            
            // 画像ファイルがある場合はFormDataで送信
            const imageFile = formData.get('character_image');
            if (imageFile && imageFile.size > 0) {
                // FormDataを使用して画像を含めて送信
                const submitFormData = new FormData();
                
                // APIデータの各フィールドをFormDataに追加
                Object.keys(apiData).forEach(key => {
                    if (key === 'skills' || key === 'equipment') {
                        submitFormData.append(key, JSON.stringify(apiData[key]));
                    } else {
                        submitFormData.append(key, apiData[key]);
                    }
                });
                
                // 画像ファイルを追加
                submitFormData.append('character_image', imageFile);
                
                // APIに送信（multipart/form-data）
                fetch('/accounts/character-sheets/create_6th_edition/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: submitFormData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.json();
                })
                .then(result => {
                    // 成功時の処理（APIはCharacterSheetオブジェクトを返す）
                    if (result.id) {
                        alert('探索者シートが正常に作成されました！');
                        window.location.href = '/accounts/character/list/';
                    } else {
                        alert('エラーが発生しました: 予期しないレスポンス形式');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.error) {
                        alert('エラーが発生しました: ' + error.error);
                    } else {
                        alert('ネットワークエラーが発生しました。');
                    }
                });
            } else {
                // 画像なしの場合はJSONで送信
                fetch('/accounts/character-sheets/create_6th_edition/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(apiData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.json();
                })
                .then(result => {
                    // 成功時の処理（APIはCharacterSheetオブジェクトを返す）
                    if (result.id) {
                        alert('探索者シートが正常に作成されました！');
                        window.location.href = '/accounts/character/list/';
                    } else {
                        alert('エラーが発生しました: 予期しないレスポンス形式');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.error) {
                        alert('エラーが発生しました: ' + error.error);
                    } else {
                        alert('ネットワークエラーが発生しました。');
                    }
                });
            }
        });
    }
});
</script>

<style>
/* フッター調整 - 改善版 */
body {
    padding-bottom: 120px; /* フッター余白を拡大 */
}

/* 編集可能な基本値のスタイル */
.skill-base {
    background-color: #f0f8ff;
    border: 1px solid #4169e1;
    cursor: text;
    transition: all 0.2s ease;
}

.skill-base:hover {
    background-color: #e6f3ff;
    box-shadow: 0 0 0 0.1rem rgba(65, 105, 225, 0.25);
}

.skill-base:focus {
    background-color: #ffffff;
    border-color: #4169e1;
    box-shadow: 0 0 0 0.2rem rgba(65, 105, 225, 0.25);
}

/* カスタマイズされた基本値 */
.skill-base.customized {
    background-color: #fff3cd;
    border-color: #ffc107;
    font-weight: bold;
}

.skill-base.customized:hover {
    background-color: #ffeaa7;
}

.skill-base.customized:focus {
    background-color: #ffffff;
    border-color: #ffc107;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}

/* 必須フィールドマーカー */
.form-label:has(+ input[required])::after,
label[for="character-name"]::after {
    content: ' *';
    color: #dc3545;
    font-weight: bold;
}

/* モバイル対応の改善 */
@media (max-width: 768px) {
    body {
        padding-bottom: 160px; /* モバイルでより大きな余白 */
    }
    
    .container {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    /* iOSズーム防止 */
    .form-control, .form-select {
        font-size: 16px;
    }
}

.character-footer {
    z-index: 1020;
    border-top: 3px solid #ffc107;
}

.ability-score {
    text-align: center;
    font-weight: bold;
    transition: all 0.3s ease;
}

.dice-rolled {
    background-color: #ffeaa7 !important;
    border-color: #fdcb6e !important;
    box-shadow: 0 0 10px rgba(253, 203, 110, 0.5) !important;
    transform: scale(1.05);
}

.skill-item {
    transition: all 0.2s ease;
    background-color: #f8f9fa;
}

.skill-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    background-color: #ffffff;
}

.skill-dice-settings,
.ability-dice-settings {
    border-top: 1px solid #dee2e6;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    animation: slideDown 0.3s ease;
}


@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 200px;
    }
}

.skill-total {
    color: #1976d2;
    font-size: 0.9rem;
    padding: 2px 4px;
    border-radius: 4px;
    background-color: rgba(25, 118, 210, 0.1);
}


.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s ease;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.card-header {
    border-bottom: 2px solid #dee2e6;
}

.btn-primary {
    background-color: #1976d2;
    border-color: #1976d2;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    background-color: #1565c0;
    border-color: #1565c0;
    transform: translateY(-1px);
}

.btn-success:hover {
    transform: translateY(-1px);
}

.btn-outline-primary:hover {
    transform: translateY(-1px);
}

.text-purple {
    color: #6f42c1 !important;
}

.form-control:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 0.2rem rgba(25, 118, 210, 0.25);
}

.form-control-sm:focus {
    box-shadow: 0 0 0 0.15rem rgba(25, 118, 210, 0.25);
}

.occupation-skill:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.15rem rgba(40, 167, 69, 0.25);
}

.interest-skill:focus {
    border-color: #ffc107;
    box-shadow: 0 0 0 0.15rem rgba(255, 193, 7, 0.25);
}

.badge {
    font-size: 0.8rem;
    font-weight: 500;
}

.sticky-top {
    transition: all 0.3s ease;
}

hr {
    border-top: 2px solid #dee2e6;
    margin: 0.5rem 0 1rem 0;
}

/* アニメーション効果 */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

.dice-rolled {
    animation: pulse 0.6s ease-in-out;
}

/* タブスタイル */
.nav-tabs .nav-link {
    color: #6c757d;
    border: 1px solid transparent;
    font-weight: 500;
    transition: all 0.2s ease;
}

.nav-tabs .nav-link:hover {
    border-color: #dee2e6;
    background-color: #f8f9fa;
    color: #1976d2;
}

.nav-tabs .nav-link.active {
    color: #1976d2;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
    font-weight: 600;
}

.tab-content {
    border: 1px solid #dee2e6;
    border-top: none;
    background-color: #fff;
    min-height: 400px;
}

.tab-pane {
    padding: 1rem;
}

/* レスポンシブ調整 */
@media (max-width: 768px) {
    .character-creator-header h2 {
        font-size: 1.5rem;
    }
    
    .skill-item .row .col-4 {
        padding: 0 2px;
    }
    
    .form-control-sm {
        font-size: 0.8rem;
    }
    
    .nav-tabs .nav-link {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
    
    .nav-tabs .nav-link i {
        display: none;
    }
}

/* ヘルプアコーディオン */
.accordion-button:not(.collapsed) {
    background-color: rgba(25, 118, 210, 0.1);
    color: #1976d2;
}

.accordion-button:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 0.25rem rgba(25, 118, 210, 0.25);
}

/* 画像プレビュー */
#image-preview {
    border: 1px dashed #dee2e6;
    padding: 10px;
    border-radius: 0.25rem;
    background-color: #f8f9fa;
}

#image-preview img {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* 職業テンプレートモーダル */
.occupation-template-item:hover {
    background-color: #f8f9fa;
}

.occupation-template-item.active {
    background-color: #e3f2fd;
}

/* ポイント管理セクション */
.bg-light {
    border: 1px solid #dee2e6;
}

/* 能力値入力フィールド強調 */
.ability-score {
    font-size: 1.1rem;
}

.ability-score:focus {
    background-color: #fff3cd;
}

/* 技能ポイント残りが少ない時の警告色 */
#occupationRemaining.badge:has-text("0") {
    background-color: #dc3545 !important;
}

/* 成功メッセージのアニメーション */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert {
    animation: fadeInUp 0.3s ease;
}
</style>
{% endblock %}
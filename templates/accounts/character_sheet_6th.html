{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}クトゥルフ神話TRPG 6版 キャラクター作成 - Arkham Nexus{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/character_sheet_6th.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- プログレスバー -->
    <div class="progress-container">
        <div class="container">
            <div class="section-progress">
                <div class="section-indicator active" data-tab="basic">
                    <div class="indicator-circle">1</div>
                    <span>基本情報</span>
                </div>
                <div class="indicator-line"></div>
                
                <div class="section-indicator" data-tab="abilities">
                    <div class="indicator-circle">2</div>
                    <span>能力値</span>
                </div>
                <div class="indicator-line"></div>
                
                <div class="section-indicator" data-tab="skills">
                    <div class="indicator-circle">3</div>
                    <span>技能</span>
                </div>
                <div class="indicator-line"></div>
                
                <div class="section-indicator" data-tab="combat">
                    <div class="indicator-circle">4</div>
                    <span>戦闘・装備</span>
                </div>
                <div class="indicator-line"></div>
                
                <div class="section-indicator" data-tab="inventory">
                    <div class="indicator-circle">5</div>
                    <span>所持品・財産</span>
                </div>
                <div class="indicator-line"></div>
                
                <div class="section-indicator" data-tab="background">
                    <div class="indicator-circle">6</div>
                    <span>背景情報</span>
                </div>
                <div class="indicator-line"></div>
                
                <div class="section-indicator" data-tab="history">
                    <div class="indicator-circle">7</div>
                    <span>成長記録</span>
                </div>
            </div>
            
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 14%"></div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2 class="mb-4">
            <i class="fas fa-dice-d20"></i> クトゥルフ神話TRPG 6版 キャラクター作成
        </h2>
        
        <form method="post" id="character-form-6th" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- タブナビゲーション -->
            <ul class="nav nav-tabs mb-4" id="characterTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                        <i class="fas fa-user"></i> 基本情報
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="abilities-tab" data-bs-toggle="tab" data-bs-target="#abilities" type="button" role="tab">
                        <i class="fas fa-dice"></i> 能力値
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="skills-tab" data-bs-toggle="tab" data-bs-target="#skills" type="button" role="tab">
                        <i class="fas fa-graduation-cap"></i> 技能
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="combat-tab" data-bs-toggle="tab" data-bs-target="#combat" type="button" role="tab">
                        <i class="fas fa-shield-alt"></i> 戦闘・装備
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                        <i class="fas fa-backpack"></i> 所持品・財産
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="background-tab" data-bs-toggle="tab" data-bs-target="#background" type="button" role="tab">
                        <i class="fas fa-book"></i> 背景情報
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                        <i class="fas fa-history"></i> 成長記録
                    </button>
                </li>
            </ul>
            
            <!-- タブコンテンツ -->
            <div class="tab-content" id="characterTabContent">
                <!-- 基本情報タブ -->
                <div class="tab-pane fade show active" id="basic" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-id-card"></i> 探索者情報</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="name" class="form-label required-field">探索者名</label>
                                            <input type="text" class="form-control" id="name" name="name" required maxlength="100">
                                            <div class="invalid-feedback">探索者名を入力してください</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="player_name" class="form-label">プレイヤー名</label>
                                            <input type="text" class="form-control" id="player_name" name="player_name" maxlength="100">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label for="age" class="form-label required-field">年齢</label>
                                            <input type="number" class="form-control" id="age" name="age" min="15" max="90" required>
                                            <div class="invalid-feedback">年齢は15～90の範囲で入力してください</div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="gender" class="form-label">性別</label>
                                            <select class="form-select" id="gender" name="gender">
                                                <option value="">選択してください</option>
                                                <option value="male">男性</option>
                                                <option value="female">女性</option>
                                                <option value="other">その他</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="occupation" class="form-label required-field">職業</label>
                                            <input type="text" class="form-control" id="occupation" name="occupation" required maxlength="100" list="occupation-list">
                                            <datalist id="occupation-list">
                                                <option value="医師">
                                                <option value="看護師">
                                                <option value="教授">
                                                <option value="警察官">
                                                <option value="探偵">
                                                <option value="ジャーナリスト">
                                                <option value="作家">
                                                <option value="軍人">
                                                <option value="パイロット">
                                                <option value="エンジニア">
                                                <option value="考古学者">
                                                <option value="図書館司書">
                                                <option value="神職者">
                                                <option value="芸術家">
                                                <option value="犯罪者">
                                            </datalist>
                                            <div class="invalid-feedback">職業を入力してください</div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="birthplace" class="form-label">出身地</label>
                                            <input type="text" class="form-control" id="birthplace" name="birthplace" maxlength="100">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="residence" class="form-label">居住地</label>
                                            <input type="text" class="form-control" id="residence" name="residence" maxlength="100">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <label for="mental_disorder" class="form-label">精神障害</label>
                                            <input type="text" class="form-control" id="mental_disorder" name="mental_disorder" maxlength="200" placeholder="狂気に陥った際の症状">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-images"></i> キャラクター画像</h5>
                                </div>
                                <div class="card-body">
                                    <div class="image-upload-area" id="image-upload-area">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <p class="mb-0">クリックまたはドラッグ&ドロップで画像をアップロード</p>
                                        <small class="text-muted">JPG, PNG, GIF, BMP, WEBP (最大5MB) × 10枚まで</small>
                                        <input type="file" id="character-images" name="character_images" multiple accept="image/*" class="d-none">
                                    </div>
                                    
                                    <div class="image-grid" id="image-preview-grid">
                                        <!-- 画像プレビューがここに表示される -->
                                    </div>
                                    
                                    <div class="text-muted mt-2" id="image-count-display">
                                        <small>0 / 10 枚</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 能力値タブ -->
                <div class="tab-pane fade" id="abilities" role="tabpanel">
                    <!-- ダイス設定 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-dice-d6"></i> ダイス設定</h5>
                        </div>
                        <div class="card-body">
                            <div class="dice-preset-buttons mb-3">
                                <button type="button" class="btn btn-outline-primary" onclick="applyDicePreset('standard')">
                                    <i class="fas fa-dice"></i> 標準
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="applyDicePreset('high')">
                                    <i class="fas fa-dice-d20"></i> 高ステータス
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="toggleCustomDiceSettings()">
                                    <i class="fas fa-cog"></i> カスタム設定
                                </button>
                            </div>
                            
                            <div class="dice-setting-area" id="dice-settings" style="display: none;">
                                <div class="row">
                                    <!-- ダイス設定がここに動的に生成される -->
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-success btn-lg" onclick="rollAllDice()">
                                    <i class="fas fa-dice"></i> 全能力値をロール
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 能力値入力 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> 能力値</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="ability-input-group">
                                        <label for="str" class="form-label">STR（筋力）</label>
                                        <input type="number" class="form-control ability-input" id="str" name="str" min="3" max="18" required>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="rollSingleAbility('str')">
                                            <i class="fas fa-dice"></i> ロール
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="ability-input-group">
                                        <label for="con" class="form-label">CON（体力）</label>
                                        <input type="number" class="form-control ability-input" id="con" name="con" min="3" max="18" required>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="rollSingleAbility('con')">
                                            <i class="fas fa-dice"></i> ロール
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="ability-input-group">
                                        <label for="pow" class="form-label">POW（精神力）</label>
                                        <input type="number" class="form-control ability-input" id="pow" name="pow" min="3" max="18" required>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="rollSingleAbility('pow')">
                                            <i class="fas fa-dice"></i> ロール
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="ability-input-group">
                                        <label for="dex" class="form-label">DEX（敏捷性）</label>
                                        <input type="number" class="form-control ability-input" id="dex" name="dex" min="3" max="18" required>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="rollSingleAbility('dex')">
                                            <i class="fas fa-dice"></i> ロール
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="ability-input-group">
                                        <label for="app" class="form-label">APP（外見）</label>
                                        <input type="number" class="form-control ability-input" id="app" name="app" min="3" max="18" required>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="rollSingleAbility('app')">
                                            <i class="fas fa-dice"></i> ロール
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="ability-input-group">
                                        <label for="siz" class="form-label">SIZ（体格）</label>
                                        <input type="number" class="form-control ability-input" id="siz" name="siz" min="8" max="18" required>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="rollSingleAbility('siz')">
                                            <i class="fas fa-dice"></i> ロール
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="ability-input-group">
                                        <label for="int" class="form-label">INT（知性）</label>
                                        <input type="number" class="form-control ability-input" id="int" name="int" min="8" max="18" required>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="rollSingleAbility('int')">
                                            <i class="fas fa-dice"></i> ロール
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="ability-input-group">
                                        <label for="edu" class="form-label">EDU（教育）</label>
                                        <input type="number" class="form-control ability-input" id="edu" name="edu" min="6" max="21" required>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="rollSingleAbility('edu')">
                                            <i class="fas fa-dice"></i> ロール
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 副次能力値 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calculator"></i> 副次能力値（自動計算）</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <div class="derived-stat">
                                        <label class="form-label">HP</label>
                                        <div class="derived-stat-value" id="hp-value">-</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div class="derived-stat">
                                        <label class="form-label">MP</label>
                                        <div class="derived-stat-value" id="mp-value">-</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div class="derived-stat">
                                        <label class="form-label">SAN</label>
                                        <div class="derived-stat-value" id="san-value">-</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div class="derived-stat">
                                        <label class="form-label">アイデア</label>
                                        <div class="derived-stat-value" id="idea-value">-</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div class="derived-stat">
                                        <label class="form-label">幸運</label>
                                        <div class="derived-stat-value" id="luck-value">-</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div class="derived-stat">
                                        <label class="form-label">知識</label>
                                        <div class="derived-stat-value" id="knowledge-value">-</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <div class="derived-stat">
                                        <label class="form-label">ダメージボーナス</label>
                                        <div class="derived-stat-value" id="damage-bonus-value">-</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="derived-stat">
                                        <label class="form-label">回避</label>
                                        <div class="derived-stat-value" id="dodge-value">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="derived-stat">
                                        <label class="form-label">移動率</label>
                                        <div class="derived-stat-value" id="movement-value">通常: - / 重荷: - / 限界: -</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 技能タブ -->
                <div class="tab-pane fade" id="skills" role="tabpanel">
                    <!-- スキルポイント表示 -->
                    <div class="skill-points-display">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">職業技能ポイント</h6>
                                        <select class="form-select mb-2" id="occupation-formula" name="occupation_formula">
                                            <option value="edu20">EDU×20（標準）</option>
                                            <option value="edu10_str10">EDU×10+STR×10（肉体系）</option>
                                            <option value="edu10_con10">EDU×10+CON×10（耐久系）</option>
                                            <option value="edu10_pow10">EDU×10+POW×10（精神系）</option>
                                            <option value="edu10_dex10">EDU×10+DEX×10（技術系）</option>
                                            <option value="edu10_app10">EDU×10+APP×10（社交系）</option>
                                            <option value="edu10_siz10">EDU×10+SIZ×10（体格系）</option>
                                            <option value="edu10_int10">EDU×10+INT×10（知識系）</option>
                                        </select>
                                        <div class="points-info">
                                            <span class="points-total">合計: <strong id="occupation-points-total">0</strong></span>
                                            <span class="points-used">使用: <strong id="occupation-points-used">0</strong></span>
                                            <span class="points-remaining">残り: <strong id="occupation-points-remaining">0</strong></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">趣味技能ポイント</h6>
                                        <div class="points-info">
                                            <span class="points-total">合計: <strong id="interest-points-total">0</strong> (INT×10)</span>
                                            <span class="points-used">使用: <strong id="interest-points-used">0</strong></span>
                                            <span class="points-remaining">残り: <strong id="interest-points-remaining">0</strong></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- スキルフィルタータブ -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <ul class="nav nav-pills nav-fill" id="skillFilterTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="all-skills-tab" data-bs-toggle="tab" data-bs-target="#all-skills" type="button" role="tab">
                                        <i class="fas fa-list"></i> すべての技能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="combat-skills-tab" data-bs-toggle="tab" data-bs-target="#combat-skills" type="button" role="tab">
                                        <i class="fas fa-fist-raised"></i> 戦闘
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="search-skills-tab" data-bs-toggle="tab" data-bs-target="#search-skills" type="button" role="tab">
                                        <i class="fas fa-search"></i> 探索
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="action-skills-tab" data-bs-toggle="tab" data-bs-target="#action-skills" type="button" role="tab">
                                        <i class="fas fa-running"></i> 行動
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="negotiation-skills-tab" data-bs-toggle="tab" data-bs-target="#negotiation-skills" type="button" role="tab">
                                        <i class="fas fa-comments"></i> 交渉
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="knowledge-skills-tab" data-bs-toggle="tab" data-bs-target="#knowledge-skills" type="button" role="tab">
                                        <i class="fas fa-book"></i> 知識
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="allocated-skills-tab" data-bs-toggle="tab" data-bs-target="#allocated-skills" type="button" role="tab">
                                        <i class="fas fa-check-circle"></i> 割振り技能
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="skillFilterTabContent">
                                <div class="tab-pane fade show active" id="all-skills" role="tabpanel">
                                    <div id="all-skills-container">
                                        <!-- すべての技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="combat-skills" role="tabpanel">
                                    <div id="combat-skills-container">
                                        <!-- 戦闘技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="search-skills" role="tabpanel">
                                    <div id="search-skills-container">
                                        <!-- 探索技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="knowledge-skills" role="tabpanel">
                                    <div id="knowledge-skills-container">
                                        <!-- 知識技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="action-skills" role="tabpanel">
                                    <div id="action-skills-container">
                                        <!-- 行動技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="negotiation-skills" role="tabpanel">
                                    <div id="negotiation-skills-container">
                                        <!-- 交渉技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="allocated-skills" role="tabpanel">
                                    <div id="allocated-skills-container">
                                        <!-- 振り分け済み技能が表示される -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 戦闘・装備タブ -->
                <div class="tab-pane fade" id="combat" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <!-- 戦闘ステータス -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-heart"></i> 戦闘ステータス</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-4">
                                            <label class="form-label">HP</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="hp_current" name="hp_current">
                                                <span class="input-group-text">/</span>
                                                <input type="number" class="form-control" id="hp_max" name="hp_max" readonly>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">MP</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="mp_current" name="mp_current">
                                                <span class="input-group-text">/</span>
                                                <input type="number" class="form-control" id="mp_max" name="mp_max" readonly>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">SAN</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="san_current" name="san_current">
                                                <span class="input-group-text">/</span>
                                                <input type="number" class="form-control" id="san_max" name="san_max" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 武器 -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-sword"></i> 武器</h5>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addWeapon()">
                                        <i class="fas fa-plus"></i> 追加
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="weapons-list">
                                        <!-- 武器リストが動的に生成される -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <!-- 防具 -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-shield-alt"></i> 防具</h5>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addArmor()">
                                        <i class="fas fa-plus"></i> 追加
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="armor-list">
                                        <!-- 防具リストが動的に生成される -->
                                    </div>
                                    <div class="alert alert-info mt-3">
                                        総装甲値: <strong id="total-armor-value">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 所持品・財産タブ -->
                <div class="tab-pane fade" id="inventory" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <!-- 財産 -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-coins"></i> 財産</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="money" class="form-label">所持金</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="money" name="money" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="assets" class="form-label">総資産</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="assets" name="assets" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="income" class="form-label">年収</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="income" name="income" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="living_standard" class="form-label">生活水準</label>
                                            <select class="form-select" id="living_standard" name="living_standard">
                                                <option value="poor">貧困</option>
                                                <option value="normal" selected>一般</option>
                                                <option value="wealthy">裕福</option>
                                                <option value="rich">富豪</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="property" class="form-label">不動産</label>
                                        <textarea class="form-control" id="property" name="property" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <!-- 所持品 -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-backpack"></i> 所持品</h5>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addItem()">
                                        <i class="fas fa-plus"></i> 追加
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <select class="form-select" id="item-category-filter">
                                            <option value="">全カテゴリー</option>
                                            <option value="weapon">武器</option>
                                            <option value="armor">防具</option>
                                            <option value="tool">道具</option>
                                            <option value="book">書物</option>
                                            <option value="supply">補給品</option>
                                            <option value="other">その他</option>
                                        </select>
                                    </div>
                                    <div id="items-list">
                                        <!-- アイテムリストが動的に生成される -->
                                    </div>
                                    <div class="alert alert-info mt-3">
                                        <div>運搬能力: <strong id="carry-capacity">0</strong> kg (STR×3)</div>
                                        <div>現在の重量: <strong id="current-weight">0</strong> kg</div>
                                        <div id="weight-penalty" class="text-danger" style="display: none;">
                                            <i class="fas fa-exclamation-triangle"></i> 過重ペナルティ発生中
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 背景情報タブ -->
                <div class="tab-pane fade" id="background" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-user-circle"></i> 個人情報</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="appearance" class="form-label">外見の描写</label>
                                        <textarea class="form-control" id="appearance" name="appearance" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="beliefs" class="form-label">信念・信条</label>
                                        <textarea class="form-control" id="beliefs" name="beliefs" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="important_people" class="form-label">重要な人物</label>
                                        <textarea class="form-control" id="important_people" name="important_people" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="meaningful_places" class="form-label">意味のある場所</label>
                                        <textarea class="form-control" id="meaningful_places" name="meaningful_places" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="treasured_possessions" class="form-label">宝物</label>
                                        <textarea class="form-control" id="treasured_possessions" name="treasured_possessions" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-book-open"></i> 経歴・特徴</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="traits" class="form-label">特徴</label>
                                        <textarea class="form-control" id="traits" name="traits" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="personal_history" class="form-label">個人的な経歴</label>
                                        <textarea class="form-control" id="personal_history" name="personal_history" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="significant_events" class="form-label">重要な出来事</label>
                                        <textarea class="form-control" id="significant_events" name="significant_events" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="injuries_scars" class="form-label">傷・瘢痕</label>
                                        <textarea class="form-control" id="injuries_scars" name="injuries_scars" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="phobias_manias" class="form-label">恐怖症・マニア</label>
                                        <textarea class="form-control" id="phobias_manias" name="phobias_manias" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-users"></i> その他</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="fellow_investigators" class="form-label">仲間の探索者</label>
                                        <textarea class="form-control" id="fellow_investigators" name="fellow_investigators" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="notes" class="form-label">備考</label>
                                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 成長記録タブ -->
                <div class="tab-pane fade" id="history" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <!-- セッション記録 -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> セッション記録</h5>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addSessionRecord()">
                                        <i class="fas fa-plus"></i> 追加
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="session-records">
                                        <!-- セッション記録が動的に生成される -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <!-- 成長記録 -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> スキル成長記録</h5>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addGrowthRecord()">
                                        <i class="fas fa-plus"></i> 追加
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="growth-records">
                                        <!-- 成長記録が動的に生成される -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CCFOLIA連携 -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-file-export"></i> CCFOLIA連携</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="ccfolia_sync" name="ccfolia_sync">
                                        <label class="form-check-label" for="ccfolia_sync">
                                            CCFOLIA同期を有効にする
                                        </label>
                                    </div>
                                    <div class="mb-3">
                                        <label for="ccfolia_id" class="form-label">CCFOLIA キャラクターID</label>
                                        <input type="text" class="form-control" id="ccfolia_id" name="ccfolia_id" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-primary mb-2 w-100" onclick="exportToCCFOLIA()">
                                        <i class="fas fa-download"></i> CCFOLIA形式でエクスポート
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="generateCCFOLIACommands()">
                                        <i class="fas fa-terminal"></i> コマンド生成
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- フローティング保存ボタン -->
            <div class="floating-save">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 画像拡大モーダル -->
<div class="modal fade" id="imageViewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">画像プレビュー</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="拡大画像" class="img-fluid">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="{% static 'js/character_sheet_6th.js' %}"></script>
{% endblock %}
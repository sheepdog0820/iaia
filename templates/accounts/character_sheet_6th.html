{% extends 'base.html' %}
{% load static %}

{% block title %}クトゥルフ神話TRPG 第6版 探索者作成 - Arkham Nexus{% endblock %}

{% block extra_css %}
<link href="{% static 'css/character_sheet_improvements.css' %}" rel="stylesheet">
<link href="{% static 'css/character_sheet_modules.css' %}" rel="stylesheet">
<link href="{% static 'css/dice_settings_fix.css' %}" rel="stylesheet">
<link href="{% static 'css/dice_settings_grid_fix.css' %}" rel="stylesheet">
<link href="{% static 'css/skill_filter.css' %}" rel="stylesheet">
<style>
body {
    background-color: #f5f5f5;
}

.section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.section-title {
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.form-label {
    font-weight: 500;
}

.text-danger {
    font-weight: bold;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.btn-roll {
    min-width: 60px;
}

.skill-category {
    background-color: #f8f9fa;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
}

.skill-category h6 {
    color: #007bff;
    font-weight: bold;
    margin-bottom: 15px;
}

.skill-item {
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #e9ecef;
    border-radius: 5px;
    transition: background-color 0.2s;
}

.skill-item:hover {
    background-color: #f8f9fa;
}

.skill-inputs {
    display: flex;
    gap: 10px;
    align-items: center;
}

.skill-inputs input {
    width: 60px;
    text-align: center;
}

.skill-total {
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

.custom-skill-input {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #e8f4f9;
    border-radius: 8px;
}

/* タブペインの最小高さを設定 */
#skillTabContent .tab-pane {
    min-height: 100px;
}

/* 技能コンテナの最小高さ */
#allocated-skills-container {
    min-height: 50px;
}

/* 技能アイテムの表示を確実にする */
#allocated-skills-container .skill-item-wrapper {
    display: block !important;
    min-height: 50px !important;
}

#allocated-skills-container .skill-item {
    display: block !important;
    min-height: 40px !important;
}

/* フッター固定 */
#skills-footer {
    background-color: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    z-index: 1030;
}

.skill-points-display {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* サイドメニューのスタイル - 常時表示 */
#side-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 100vh;
    background-color: #343a40;
    color: white;
    z-index: 1030;
    overflow-y: auto;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    border-right: 1px solid #495057;
}

/* メインコンテンツをサイドメニュー分ずらす（デスクトップのみ） */

/* レスポンシブ: 小さい画面ではサイドメニューを非表示 */
@media (max-width: 992px) {
    #side-menu {
        left: -280px;
        transition: left 0.3s ease;
    }
    
    #side-menu.show {
        left: 0;
    }
    
    body {
        padding-left: 0;
    }
}

.side-menu-header {
    padding: 20px;
    background-color: #212529;
    border-bottom: 1px solid #495057;
}

.side-menu-content {
    padding: 0;
}

.side-menu-item {
    display: block;
    padding: 15px 20px;
    color: white;
    text-decoration: none;
    border-bottom: 1px solid #495057;
    transition: background-color 0.2s ease;
}

.side-menu-item:hover {
    background-color: #495057;
    color: white;
}

.side-menu-item i {
    width: 20px;
    margin-right: 10px;
}

.side-menu-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .skill-inputs {
        flex-wrap: wrap;
    }
    
    .skill-inputs input {
        width: 50px;
    }
    
    #side-menu {
        width: 280px;
        left: -280px;
    }
    
    #skills-footer .col-md-8,
    #skills-footer .col-md-4 {
        text-align: center !important;
        margin-bottom: 10px;
    }
    
    #skills-footer .d-flex {
        justify-content: center !important;
    }
}

/* アコーディオンのカスタマイズ */
.accordion-button:not(.collapsed) {
    background-color: #e8f4f9;
    color: #007bff;
}

.accordion-button:focus {
    box-shadow: none;
    border-color: #007bff;
}

/* 能力値セクション */
.ability-item {
    text-align: center;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 15px;
}

.ability-item label {
    font-weight: bold;
    color: #495057;
    margin-bottom: 10px;
}

.ability-item .input-group {
    max-width: 150px;
    margin: 0 auto;
}

/* ボタンスタイル */
.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
}

.btn-primary:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}

/* プログレスバー */
.progress {
    background-color: #e9ecef;
}

.progress-bar {
    background-color: #007bff;
    transition: width 0.3s ease;
}

/* カスタマイズされたアラート */
.alert {
    border-radius: 8px;
    border: none;
}

.alert-info {
    background-color: #e8f4f9;
    color: #0c5460;
}

/* ツールチップ風のヘルプテキスト */
.form-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

/* 画像プレビュー */
.image-preview-container {
    position: relative;
    width: 200px;
    height: 200px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    margin: 0 auto;
}

.image-preview-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
    font-size: 3rem;
}

#image-preview {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.image-preview-actions {
    position: absolute;
    bottom: 10px;
    right: 10px;
    display: none;
}

/* ダイスロールボタンのアニメーション */
@keyframes diceRoll {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.btn-roll:active {
    animation: diceRoll 0.5s;
}

/* フッター分のパディング */
body {
    padding-bottom: 70px;
}
</style>
{% endblock %}

{% block content %}
<script>
// グローバル関数定義（onclick用）- 先に定義する必要がある

// グローバル定数
const ABILITIES = ['str', 'con', 'pow', 'dex', 'app', 'siz', 'int', 'edu'];

// ダイス設定の初期値（標準6版）
const DEFAULT_DICE_SETTINGS = {
    str: { count: 3, sides: 6, bonus: 0 },
    con: { count: 3, sides: 6, bonus: 0 },
    pow: { count: 3, sides: 6, bonus: 0 },
    dex: { count: 3, sides: 6, bonus: 0 },
    app: { count: 3, sides: 6, bonus: 0 },
    siz: { count: 2, sides: 6, bonus: 6 },
    int: { count: 2, sides: 6, bonus: 6 },
    edu: { count: 3, sides: 6, bonus: 3 }
};

// 高能力値設定
const HIGH_DICE_SETTINGS = {
    str: { count: 4, sides: 6, bonus: -3 },
    con: { count: 4, sides: 6, bonus: -3 },
    pow: { count: 4, sides: 6, bonus: -3 },
    dex: { count: 4, sides: 6, bonus: -3 },
    app: { count: 4, sides: 6, bonus: -3 },
    siz: { count: 3, sides: 6, bonus: 3 },
    int: { count: 3, sides: 6, bonus: 3 },
    edu: { count: 4, sides: 6, bonus: 0 }
};

// 現在のダイス設定
let currentDiceSettings = { ...DEFAULT_DICE_SETTINGS };

// カスタム技能データ
let customSkills = [];

// 下書きデータキャッシュ
let draftDataCache = null;

// 技能データ管理はシンプルになりました - DOM要素のvalueで直接管理

// この関数は削除されました - シンプルなDOM-based管理に変更

// ダイス設定の表示切替
function toggleDiceSettings() {
    const settingsDiv = document.getElementById('dice-settings');
    if (settingsDiv.style.display === 'none') {
        settingsDiv.style.display = 'block';
    } else {
        settingsDiv.style.display = 'none';
    }
}

// プリセット読み込み
function loadDicePreset() {
    const preset = document.getElementById('dice-preset').value;
    
    if (preset === 'standard') {
        currentDiceSettings = { ...DEFAULT_DICE_SETTINGS };
    } else if (preset === 'high') {
        currentDiceSettings = { ...HIGH_DICE_SETTINGS };
    }
    // customの場合は現在の設定を維持
    
    // UIに反映
    if (preset !== 'custom') {
        ABILITIES.forEach(ability => {
            const settings = currentDiceSettings[ability];
            document.getElementById(`dice-${ability}-count`).value = settings.count;
            document.getElementById(`dice-${ability}-sides`).value = settings.sides;
            document.getElementById(`dice-${ability}-bonus`).value = settings.bonus;
        });
    }
}

// ダイス設定の初期化
function initializeDiceSettings() {
    // デフォルト値を各input要素に設定
    ABILITIES.forEach(ability => {
        const settings = DEFAULT_DICE_SETTINGS[ability];
        const countElement = document.getElementById(`dice-${ability}-count`);
        const sidesElement = document.getElementById(`dice-${ability}-sides`);
        const bonusElement = document.getElementById(`dice-${ability}-bonus`);
        
        if (countElement) countElement.value = settings.count;
        if (sidesElement) sidesElement.value = settings.sides;
        if (bonusElement) bonusElement.value = settings.bonus;
    });
    
    // プリセットを標準に設定
    const presetElement = document.getElementById('dice-preset');
    if (presetElement) presetElement.value = 'standard';
}

// カスタムダイス設定を保存
function saveCustomDiceSettings() {
    const customSettings = {};
    ABILITIES.forEach(ability => {
        customSettings[ability] = {
            count: parseInt(document.getElementById(`dice-${ability}-count`).value),
            sides: parseInt(document.getElementById(`dice-${ability}-sides`).value),
            bonus: parseInt(document.getElementById(`dice-${ability}-bonus`).value)
        };
    });
    
    localStorage.setItem('coc6th_custom_dice_settings', JSON.stringify(customSettings));
    showNotification('カスタム設定を保存しました', 'success');
}

// カスタムダイス設定を読み込み
function loadCustomDiceSettings() {
    const savedSettings = localStorage.getItem('coc6th_custom_dice_settings');
    if (savedSettings) {
        currentDiceSettings = JSON.parse(savedSettings);
        ABILITIES.forEach(ability => {
            const settings = currentDiceSettings[ability];
            document.getElementById(`dice-${ability}-count`).value = settings.count;
            document.getElementById(`dice-${ability}-sides`).value = settings.sides;
            document.getElementById(`dice-${ability}-bonus`).value = settings.bonus;
        });
        document.getElementById('dice-preset').value = 'custom';
        showNotification('カスタム設定を読み込みました', 'success');
    } else {
        showNotification('保存されたカスタム設定がありません', 'warning');
    }
}

// ダイスロール関数
function rollDice(count, sides, bonus = 0) {
    let total = bonus;
    for (let i = 0; i < count; i++) {
        total += Math.floor(Math.random() * sides) + 1;
    }
    return Math.max(1, total); // 最小値は1
}

// 単一能力値のロール
function rollSingleAbility(ability) {
    const settings = currentDiceSettings[ability];
    const value = rollDice(settings.count, settings.sides, settings.bonus);
    document.getElementById(ability).value = value;
    
    console.log(`[DEBUG] ダイスロール: ${ability} = ${value}`);
    
    // 副次ステータスを再計算
    calculateDerivedStats();
    
    // 既に値が入力されている場合の初期計算
    // ただし空の場合のみ計算を行う
    calculateDerivedStatsIfEmpty();
    
    // 全能力値変更時の自動更新を実行
    // 技能ポイント計算、技能初期値更新を含む
    console.log(`[DEBUG] ${ability}が変更されたため自動更新を実行`);
    setTimeout(() => {
        updateSkillBaseValues();
    }, 100);
}

// すべての能力値をロール
function rollAllAbilities() {
    console.log('[DEBUG] 全能力値ロール開始');
    ABILITIES.forEach(ability => {
        const settings = currentDiceSettings[ability];
        const value = rollDice(settings.count, settings.sides, settings.bonus);
        document.getElementById(ability).value = value;
        console.log(`[DEBUG] ${ability} = ${value}`);
    });
    
    // 副次ステータスを再計算
    calculateDerivedStats();
    
    // 空の副次ステータスのみ計算（関数が定義されてから実行）
    if (typeof calculateDerivedStatsIfEmpty === 'function') {
        calculateDerivedStatsIfEmpty();
    } else {
        // 関数が定義されていない場合は、DOMContentLoaded後に実行
        setTimeout(() => {
            if (typeof calculateDerivedStatsIfEmpty === 'function') {
                calculateDerivedStatsIfEmpty();
            }
        }, 1000);
    }
    
    // 全能力値変更時の自動更新を実行
    // 技能ポイント計算、技能初期値更新を含む
    console.log('[DEBUG] 全能力値ロール完了 - 全自動更新を実行');
    setTimeout(() => {
        updateSkillBaseValues();
    }, 200);
}
</script>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="card-title mb-0">
                                <i class="fas fa-dice-d20"></i> 
                                クトゥルフ神話TRPG 第6版 探索者作成
                            </h3>
                            <div class="mt-2">
                                <small>作成進捗: <span id="progress-text">0/0</span></small>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-success" id="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <!-- モバイル用ハンバーガーメニューボタン -->
                        <div class="ms-3 d-lg-none">
                            <button type="button" class="btn btn-outline-light" onclick="toggleSideMenu()" title="セクションメニュー">
                                <i class="fas fa-bars"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- セクションナビゲーション（モバイル用ヒント） -->
                    <div class="section-nav mb-3 d-lg-none">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            <strong>ヒント:</strong> 画面上部の <i class="fas fa-bars"></i> ボタンをタップすると、セクションメニューが表示されます。
                        </div>
                    </div>
                    
                    <!-- メインプログレスバー -->
                    <div class="main-progress-container mb-4">
                        <div class="progress" style="height: 30px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated main-progress-bar" 
                                 role="progressbar" style="width: 0%" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                 data-label="0%完了">
                            </div>
                        </div>
                        <div class="progress-text mt-1 text-center text-muted">
                            <span id="progress-text">0/7 セクション完了</span>
                        </div>
                    </div>
                    
                    <form id="character-form-6th" method="post" action="{% url 'character_create_6th' %}">
                        {% csrf_token %}
                        
                        <!-- 1. 基本情報 -->
                        <div class="section mb-4" id="section-basic" data-section-id="basic-info">
                            <h4 class="section-title">
                                <i class="fas fa-user"></i> 基本情報
                            </h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="character_name" class="form-label">
                                            探索者名 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="character_name" 
                                               name="name" maxlength="100" required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="age" class="form-label">年齢</label>
                                        <input type="number" class="form-control" id="age" name="age" required min="15" max="90">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="gender" class="form-label">性別</label>
                                        <input type="text" class="form-control" id="gender" 
                                               name="gender" maxlength="50">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="occupation" class="form-label">職業</label>
                                        <input type="text" class="form-control" id="occupation" 
                                               name="occupation" maxlength="100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="birthplace" class="form-label">出身地</label>
                                        <input type="text" class="form-control" id="birthplace" 
                                               name="birthplace" maxlength="100">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="mental_disorder" class="form-label">精神的な障害</label>
                                        <textarea class="form-control" id="mental_disorder" 
                                                  name="mental_disorder" rows="2" maxlength="500"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- キャラクター立ち絵 -->
                            <!-- 複数画像アップロード機能 -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="character_images" class="form-label">
                                            <i class="fas fa-images"></i> キャラクター画像 <span class="text-muted">(複数選択可能)</span>
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <!-- ドラッグ&ドロップエリア -->
                                                <div id="drop-zone" class="border-2 border-dashed rounded p-4 text-center" 
                                                     style="min-height: 150px; cursor: pointer; transition: all 0.3s;"
                                                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" 
                                                     ondragleave="handleDragLeave(event)" onclick="document.getElementById('character_images').click()">
                                                    <div class="drop-zone-content">
                                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                                        <h5 class="text-muted">画像をドラッグ&ドロップ</h5>
                                                        <p class="text-muted mb-2">または、クリックして選択</p>
                                                        <small class="text-muted">
                                                            JPG, PNG, GIF, WEBP形式対応 (最大10枚、各5MB以下)
                                                        </small>
                                                    </div>
                                                </div>
                                                <input type="file" class="d-none" id="character_images" 
                                                       name="character_images" accept="image/*" multiple
                                                       onchange="handleFileSelect(this)">
                                            </div>
                                            <div class="col-md-6">
                                                <!-- アップロード進捗 -->
                                                <div id="upload-progress" style="display: none;">
                                                    <div class="mb-2">
                                                        <small class="text-muted">アップロード中...</small>
                                                    </div>
                                                    <div class="progress">
                                                        <div id="upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                                    </div>
                                                </div>
                                                <!-- エラーメッセージ -->
                                                <div id="upload-errors" class="alert alert-danger d-none">
                                                    <strong>エラー:</strong>
                                                    <ul id="upload-error-list" class="mb-0 mt-2"></ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 画像プレビューグリッド -->
                                <div class="col-12">
                                    <div id="image-preview-grid" class="mb-3">
                                        <label class="form-label">画像プレビュー</label>
                                        <div id="image-grid" class="row g-3">
                                            <!-- 画像カードがここに動的に追加される -->
                                            <div id="no-images-placeholder" class="col-12 text-center text-muted py-4">
                                                <i class="fas fa-images fa-2x mb-2"></i>
                                                <p>まだ画像がアップロードされていません</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. 能力値 -->
                        <div class="section mb-4" id="section-abilities" data-section-id="abilities">
                            <h4 class="section-title">
                                <i class="fas fa-chart-bar"></i> 能力値
                            </h4>
                            
                            <!-- ダイス設定ボタン -->
                            <div class="mb-3 d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-outline-primary" onclick="toggleDiceSettings()">
                                    <i class="fas fa-cog"></i> 詳細設定
                                </button>
                                <button type="button" class="btn btn-success" onclick="rollAllAbilities()">
                                    <i class="fas fa-dice-d6"></i> すべてロール
                                </button>
                                <button type="button" class="btn btn-info" onclick="applyStandardPreset()">
                                    <i class="fas fa-refresh"></i> 標準設定
                                </button>
                            </div>
                            
                            <!-- ダイス設定エリア（改善版） -->
                            <div id="dice-settings" class="dice-settings mb-3" style="display: none;">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-dice"></i> ダイス設定（カスタマイズ）</h6>
                                        <button type="button" class="btn btn-sm btn-outline-light" onclick="toggleDiceSettings()">
                                            <i class="fas fa-times"></i> 閉じる
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="dice-preset" class="form-label">プリセット選択</label>
                                            <select class="form-select" id="dice-preset" onchange="loadDicePreset()">
                                                <option value="standard">標準6版設定</option>
                                                <option value="high">高能力値設定</option>
                                                <option value="custom">カスタム設定</option>
                                            </select>
                                        </div>
                                        
                                        <div class="row" id="custom-dice-settings">
                                            <!-- 各能力値のダイス設定 -->
                                            <div class="col-md-3 col-6 mb-3 ability-item">
                                                <h6>STR (筋力)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-str-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-str-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-str-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-3 ability-item">
                                                <h6>CON (体力)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-con-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-con-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-con-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-3 ability-item">
                                                <h6>POW (意志力)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-pow-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-pow-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-pow-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-3 ability-item">
                                                <h6>DEX (敏捷性)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-dex-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-dex-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-dex-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-3 ability-item">
                                                <h6>APP (外見)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-app-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-app-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-app-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-3 ability-item">
                                                <h6>SIZ (体格)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-siz-count" value="2" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-siz-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-siz-bonus" value="6">
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-3 ability-item">
                                                <h6>INT (知性)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-int-count" value="2" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-int-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-int-bonus" value="6">
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6 mb-3 ability-item">
                                                <h6>EDU (教育)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-edu-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-edu-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-edu-bonus" value="3">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3 d-flex gap-2 flex-wrap">
                                            <button type="button" class="btn btn-sm btn-success" onclick="saveCustomDiceSettings()">
                                                <i class="fas fa-save"></i> 保存
                                            </button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="loadCustomDiceSettings()">
                                                <i class="fas fa-folder-open"></i> 読み込み
                                            </button>
                                            <button type="button" class="btn btn-sm btn-warning" onclick="resetDiceSettings()">
                                                <i class="fas fa-undo"></i> リセット
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 能力値入力エリア -->
                            <div class="row ability-values-container">
                                <div class="col-md-3 col-6 mb-3 ability-item">
                                    <label for="str" class="form-label">STR (筋力)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="str" name="str_value" required onchange="updateSkillBaseValues()">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('str')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3 ability-item">
                                    <label for="con" class="form-label">CON (体力)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="con" name="con_value" required onchange="updateSkillBaseValues()">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('con')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3 ability-item">
                                    <label for="pow" class="form-label">POW (意志力)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="pow" name="pow_value" required onchange="updateSkillBaseValues()">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('pow')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3 ability-item">
                                    <label for="dex" class="form-label">DEX (敏捷性)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="dex" name="dex_value" required onchange="updateSkillBaseValues()">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('dex')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 col-6 mb-3 ability-item">
                                    <label for="app" class="form-label">APP (外見)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="app" name="app_value" required onchange="updateSkillBaseValues()">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('app')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3 ability-item">
                                    <label for="siz" class="form-label">SIZ (体格)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="siz" name="siz_value" required onchange="updateSkillBaseValues()">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('siz')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3 ability-item">
                                    <label for="int" class="form-label">INT (知性)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="int" name="int_value" required onchange="updateSkillBaseValues()">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('int')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3 ability-item">
                                    <label for="edu" class="form-label">EDU (教育)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="edu" name="edu_value" required onchange="updateSkillBaseValues()">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('edu')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. 副次的ステータス -->
                        <div class="section mb-4" id="section-derived-stats" data-section-id="derived-stats">
                            <h4 class="section-title">
                                <i class="fas fa-calculator"></i> 副次的ステータス
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label for="hp" class="form-label">HP</label>
                                    <input type="number" class="form-control bg-light" id="hp" name="hit_points_max" readonly>
                                    <!-- 現在HPも同じ値で初期化 -->
                                    <input type="hidden" id="hit_points_current" name="hit_points_current">
                                    <small class="text-muted">(CON+SIZ)÷2</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="mp" class="form-label">MP</label>
                                    <input type="number" class="form-control bg-light" id="mp" name="magic_points_max" readonly>
                                    <!-- 現在MPも同じ値で初期化 -->
                                    <input type="hidden" id="magic_points_current" name="magic_points_current">
                                    <small class="text-muted">POW</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="san" class="form-label">SAN</label>
                                    <input type="number" class="form-control bg-light" id="san" name="sanity_starting" readonly>
                                    <!-- 最大SAN・現在SANも同じ値で初期化 -->
                                    <input type="hidden" id="sanity_max" name="sanity_max">
                                    <input type="hidden" id="sanity_current" name="sanity_current">
                                    <small class="text-muted">POW×5</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="idea" class="form-label">アイデア</label>
                                    <input type="number" class="form-control bg-light" id="idea" name="idea" readonly>
                                    <small class="text-muted">INT×5</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="luck" class="form-label">幸運</label>
                                    <input type="number" class="form-control bg-light" id="luck" name="luck" readonly>
                                    <small class="text-muted">POW×5</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="know" class="form-label">知識</label>
                                    <input type="number" class="form-control bg-light" id="know" name="know" readonly>
                                    <small class="text-muted">EDU×5</small>
                                </div>
                            </div>
                            
                        </div>

                        <!-- 4. 戦闘データ -->
                        <div class="section mb-4" id="section-combat" data-section-id="combat">
                            <h4 class="section-title">
                                <i class="fas fa-shield-alt"></i> 戦闘データ
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="damage_bonus" class="form-label">ダメージボーナス</label>
                                    <input type="text" class="form-control bg-light" id="damage_bonus" name="damage_bonus" readonly>
                                    <small class="text-muted">STR+SIZから算出</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="current_san_combat" class="form-label">現在SAN値</label>
                                    <input type="number" class="form-control" id="current_san_combat" name="current_san_combat" min="0" max="99">
                                    <small class="text-muted">初期値: POW×5</small>
                                </div>
                            </div>
                        </div>

                        <!-- 5. 技能ポイント -->
                        <div class="section mb-4">
                            <h4 class="section-title">
                                <i class="fas fa-graduation-cap"></i> 技能ポイント
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>職業技能ポイント</span>
                                                <div class="d-flex align-items-center gap-2">
                                                    <select class="form-select form-select-sm" 
                                                            id="occupation-formula" name="occupation_formula" 
                                                            style="width: 160px;">
                                                        <option value="edu20">EDU×20</option>
                                                        <option value="edu10str10">EDU×10＋STR×10</option>
                                                        <option value="edu10con10">EDU×10＋CON×10</option>
                                                        <option value="edu10pow10">EDU×10＋POW×10</option>
                                                        <option value="edu10dex10">EDU×10＋DEX×10</option>
                                                        <option value="edu10app10">EDU×10＋APP×10</option>
                                                        <option value="edu10int10">EDU×10＋INT×10</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <p class="mb-1">総ポイント: <strong class="text-primary"><span id="occupation-points-total">0</span>点</strong></p>
                                                    <p class="mb-0 text-muted">残りポイント: <span id="occupation-points-remaining" class="fw-bold">0</span>点</p>
                                                </div>
                                                <div class="progress" style="width: 100px; height: 20px;">
                                                    <div class="progress-bar bg-primary" role="progressbar" 
                                                         id="occupation-points-progress" style="width: 0%"
                                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <span>趣味技能ポイント</span>
                                            <small class="float-end">INT×10</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <p class="mb-1">総ポイント: <strong class="text-success"><span id="interest-points-total">0</span>点</strong></p>
                                                    <p class="mb-0 text-muted">残りポイント: <span id="interest-points-remaining" class="fw-bold">0</span>点</p>
                                                </div>
                                                <div class="progress" style="width: 100px; height: 20px;">
                                                    <div class="progress-bar bg-success" role="progressbar" 
                                                         id="interest-points-progress" style="width: 0%"
                                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 互換性のための隠しフィールド -->
                            <input type="hidden" id="occupation-points" value="0">
                            <input type="hidden" id="interest-points" value="0">
                            
                            <!-- 技能ポイント管理ツール -->
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" onclick="autoDistributePoints('occupation')">
                                            <i class="fas fa-magic"></i> 職業ポイント自動配分
                                        </button>
                                        <button type="button" class="btn btn-outline-success" onclick="autoDistributePoints('interest')">
                                            <i class="fas fa-magic"></i> 趣味ポイント自動配分
                                        </button>
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-warning" onclick="clearAllPoints()">
                                            <i class="fas fa-eraser"></i> ポイント配分をクリア
                                        </button>
                                        <button type="button" class="btn btn-outline-info" onclick="showPointDistributionHelp()">
                                            <i class="fas fa-question-circle"></i> ヘルプ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 6. 技能 -->
                        <div class="section mb-4" id="section-skills" data-section-id="skills">
                            <h4 class="section-title">
                                <i class="fas fa-cogs"></i> 技能
                            </h4>
                            
                            <!-- 技能管理ツールバー -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="skill-filter-controls">
                                    <label for="skill-search" class="form-label mb-0 me-2">検索:</label>
                                    <input type="text" class="form-control form-control-sm d-inline-block" 
                                           id="skill-search" placeholder="技能名で検索" style="width: 150px;">
                                </div>
                                <div class="skill-action-buttons">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetAllSkills()">
                                        <i class="fas fa-eraser"></i> リセット
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="showRecommendedSkills()">
                                        <i class="fas fa-star"></i> 推奨技能
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 技能タブ（最適化版） -->
                            <ul class="nav nav-pills nav-fill mb-3" id="skillTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="allocated-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#allocated-skills" type="button" role="tab"
                                            aria-controls="allocated-skills" aria-selected="false"
                                            data-skill-tab="allocated">
                                        <i class="fas fa-chart-bar"></i> ポイント割り振り <span class="badge bg-secondary ms-1" id="allocated-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="all-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#all-skills" type="button" role="tab" 
                                            aria-controls="all-skills" aria-selected="false"
                                            data-skill-tab="all">
                                        <i class="fas fa-list"></i> 全て <span class="badge bg-secondary ms-1" id="all-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="combat-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#combat-skills" type="button" role="tab"
                                            aria-controls="combat-skills" aria-selected="false"
                                            data-skill-tab="combat">
                                        <i class="fas fa-sword"></i> 戦闘 <span class="badge bg-secondary ms-1" id="combat-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="search-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#search-skills" type="button" role="tab"
                                            aria-controls="search-skills" aria-selected="false"
                                            data-skill-tab="search">
                                        <i class="fas fa-search"></i> 探索 <span class="badge bg-secondary ms-1" id="search-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="action-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#action-skills" type="button" role="tab"
                                            aria-controls="action-skills" aria-selected="false"
                                            data-skill-tab="action">
                                        <i class="fas fa-running"></i> 行動 <span class="badge bg-secondary ms-1" id="action-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="negotiation-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#negotiation-skills" type="button" role="tab"
                                            aria-controls="negotiation-skills" aria-selected="false"
                                            data-skill-tab="negotiation">
                                        <i class="fas fa-comments"></i> 交渉 <span class="badge bg-secondary ms-1" id="negotiation-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="knowledge-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#knowledge-skills" type="button" role="tab"
                                            aria-controls="knowledge-skills" aria-selected="false"
                                            data-skill-tab="knowledge">
                                        <i class="fas fa-brain"></i> 知識 <span class="badge bg-secondary ms-1" id="knowledge-count">0</span>
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- 技能タブコンテンツ -->
                            <div class="tab-content" id="skillTabContent">
                                <div class="tab-pane fade" id="all-skills" role="tabpanel" aria-labelledby="all-skills-tab">
                                    <div id="all-skills-container">
                                        <!-- 全技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="combat-skills" role="tabpanel" aria-labelledby="combat-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>戦闘技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('combat')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="combat-skills-container">
                                        <!-- 戦闘技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="search-skills" role="tabpanel" aria-labelledby="search-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>探索技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('search')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="search-skills-container">
                                        <!-- 探索技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="action-skills" role="tabpanel" aria-labelledby="action-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>行動技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('action')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="action-skills-container">
                                        <!-- 行動技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="negotiation-skills" role="tabpanel" aria-labelledby="negotiation-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>交渉技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('negotiation')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="negotiation-skills-container">
                                        <!-- 交渉技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="knowledge-skills" role="tabpanel" aria-labelledby="knowledge-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>知識技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('knowledge')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="knowledge-skills-container">
                                        <!-- 知識技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="allocated-skills" role="tabpanel" aria-labelledby="allocated-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>ポイント割り振り済み技能</h5>
                                        <small class="text-muted">職業技能・趣味技能にポイントを割り振った技能のみ表示</small>
                                    </div>
                                    <div id="allocated-skills-container">
                                        <!-- ポイント割り振り済み技能が表示される -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 6. 戦闘データ -->
                        <div class="section mb-4" id="section-combat" data-section-id="combat">
                            <h4 class="section-title">
                                <i class="fas fa-shield-alt"></i> 戦闘データ
                            </h4>
                            <!-- 武器管理 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>武器</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addWeapon()">
                                            <i class="fas fa-plus"></i> 武器追加
                                        </button>
                                    </div>
                                    <div id="weapons-container">
                                        <div class="weapon-item mb-3" id="weapon-template" style="display: none;">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-3">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="武器名" name="weapon_name[]">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   placeholder="成功率%" name="weapon_skill[]" 
                                                                   min="0" max="99">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="ダメージ" name="weapon_damage[]">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="射程" name="weapon_range[]">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="弾数/耐久" name="weapon_ammo[]">
                                                        </div>
                                                        <div class="col-md-1">
                                                            <button type="button" class="btn btn-sm btn-danger" 
                                                                    onclick="removeWeapon(this)">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- デフォルト武器 -->
                                        <div class="weapon-item mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-3">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="武器名" name="weapon_name[]" value="素手">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   placeholder="成功率%" name="weapon_skill[]" 
                                                                   min="0" max="99" value="50">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="ダメージ" name="weapon_damage[]" value="1D3+DB">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="射程" name="weapon_range[]" value="タッチ">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="弾数/耐久" name="weapon_ammo[]" value="-">
                                                        </div>
                                                        <div class="col-md-1">
                                                            <button type="button" class="btn btn-sm btn-danger" 
                                                                    onclick="removeWeapon(this)">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 防具管理 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>防具・防護点</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addArmor()">
                                            <i class="fas fa-plus"></i> 防具追加
                                        </button>
                                    </div>
                                    <div id="armor-container">
                                        <div class="armor-item mb-3" id="armor-template" style="display: none;">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-4">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="防具名" name="armor_name[]">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   placeholder="防護点" name="armor_value[]" 
                                                                   min="0" max="20">
                                                        </div>
                                                        <div class="col-md-4">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="備考" name="armor_notes[]">
                                                        </div>
                                                        <div class="col-md-1">
                                                            <button type="button" class="btn btn-sm btn-danger" 
                                                                    onclick="removeArmor(this)">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> 
                                            総防護点: <strong id="total-armor-value">0</strong>点
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 戦闘メモ -->
                            <div class="row">
                                <div class="col-md-12">
                                    <h5 class="mb-3">戦闘メモ</h5>
                                    <textarea class="form-control" id="combat_notes" name="combat_notes" 
                                              rows="3" placeholder="戦闘時の特記事項、戦術、弱点など..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- 7. 所持品・装備管理 -->
                        <div class="section mb-4" id="section-inventory" data-section-id="inventory">
                            <h4 class="section-title">
                                <i class="fas fa-backpack"></i> 所持品・装備管理
                            </h4>
                            
                            <!-- 財務情報 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h5 class="mb-3">財務情報</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label for="cash" class="form-label">所持金</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control" 
                                                               id="cash" name="cash" 
                                                               step="0.01" min="0" value="0.00">
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="assets" class="form-label">資産総額</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control" 
                                                               id="assets" name="assets" 
                                                               step="0.01" min="0" value="0.00">
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="annual_income" class="form-label">年収</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control" 
                                                               id="annual_income" name="annual_income" 
                                                               step="0.01" min="0" value="0.00">
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="spending_level" class="form-label">生活レベル</label>
                                                    <select class="form-select" id="spending_level" name="spending_level">
                                                        <option value="poor">貧困（$5/日）</option>
                                                        <option value="average" selected>平均（$10/日）</option>
                                                        <option value="wealthy">裕福（$50/日）</option>
                                                        <option value="rich">富裕（$250/日）</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-12">
                                                    <label for="real_estate" class="form-label">不動産・土地</label>
                                                    <textarea class="form-control" id="real_estate" name="real_estate" 
                                                              rows="2" placeholder="所有する不動産や土地について記載"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 所持品管理 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>所持品</h5>
                                        <div>
                                            <div class="btn-group btn-group-sm me-2" role="group">
                                                <button type="button" class="btn btn-outline-secondary" onclick="addItemByCategory('tool')">
                                                    <i class="fas fa-tools"></i> 道具
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="addItemByCategory('book')">
                                                    <i class="fas fa-book"></i> 書籍
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="addItemByCategory('supply')">
                                                    <i class="fas fa-box"></i> 消耗品
                                                </button>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInventoryItem()">
                                                <i class="fas fa-plus"></i> アイテム追加
                                            </button>
                                        </div>
                                    </div>
                                    <div id="inventory-container">
                                        <div class="inventory-item mb-3" id="inventory-template" style="display: none;">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-3">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="アイテム名" name="item_name[]">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <select class="form-select form-select-sm" name="item_category[]">
                                                                <option value="weapon">武器</option>
                                                                <option value="armor">防具</option>
                                                                <option value="tool">道具</option>
                                                                <option value="book">書籍</option>
                                                                <option value="supply">消耗品</option>
                                                                <option value="other">その他</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   placeholder="数量" name="item_quantity[]" 
                                                                   min="1" value="1">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   placeholder="重量(kg)" name="item_weight[]" 
                                                                   step="0.1" min="0" value="0"
                                                                   onchange="updateTotalWeight()">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="備考" name="item_notes[]">
                                                        </div>
                                                        <div class="col-md-1">
                                                            <button type="button" class="btn btn-sm btn-danger" 
                                                                    onclick="removeInventoryItem(this)">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- デフォルトアイテム -->
                                        <div class="inventory-item mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-3">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="アイテム名" name="item_name[]" value="懐中電灯">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <select class="form-select form-select-sm" name="item_category[]">
                                                                <option value="weapon">武器</option>
                                                                <option value="armor">防具</option>
                                                                <option value="tool" selected>道具</option>
                                                                <option value="book">書籍</option>
                                                                <option value="supply">消耗品</option>
                                                                <option value="other">その他</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-1">
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   placeholder="数量" name="item_quantity[]" 
                                                                   min="1" value="1">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   placeholder="重量(kg)" name="item_weight[]" 
                                                                   step="0.1" min="0" value="0.5"
                                                                   onchange="updateTotalWeight()">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   placeholder="備考" name="item_notes[]" value="予備電池付き">
                                                        </div>
                                                        <div class="col-md-1">
                                                            <button type="button" class="btn btn-sm btn-danger" 
                                                                    onclick="removeInventoryItem(this)">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 重量管理 -->
                                    <div class="mt-3">
                                        <div class="alert alert-info">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <i class="fas fa-weight"></i> 
                                                    総重量: <strong id="total-weight">0.5</strong> kg
                                                </div>
                                                <div class="col-md-6">
                                                    <i class="fas fa-dumbbell"></i> 
                                                    運搬能力: <strong id="carry-capacity">30</strong> kg
                                                    <small class="text-muted">（STR×3）</small>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-12">
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar" role="progressbar" 
                                                             id="weight-progress" style="width: 0%"
                                                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                            <span id="weight-percentage">0%</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mt-1">
                                                <div class="col-12">
                                                    <small id="movement-penalty-info" class="text-muted">
                                                        移動ペナルティ: なし
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 所持品メモ -->
                            <div class="row">
                                <div class="col-md-12">
                                    <h5 class="mb-3">所持品メモ</h5>
                                    <textarea class="form-control" id="inventory_notes" name="inventory_notes" 
                                              rows="3" placeholder="特別なアイテム、保管場所、入手経緯など..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- 8. 背景情報 -->
                        <div class="section mb-4" id="section-background" data-section-id="background">
                            <h4 class="section-title">
                                <i class="fas fa-user-circle"></i> 背景情報
                            </h4>
                            
                            <!-- 外見・性格 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h5 class="mb-3">外見・性格</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="appearance_description" class="form-label">容姿・外見</label>
                                                    <textarea class="form-control" id="appearance_description" 
                                                              name="appearance_description" rows="3" 
                                                              placeholder="身長、体格、髪色、服装など..."></textarea>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="traits_mannerisms" class="form-label">性格・癖</label>
                                                    <textarea class="form-control" id="traits_mannerisms" 
                                                              name="traits_mannerisms" rows="3" 
                                                              placeholder="口癖、しぐさ、性格的特徴など..."></textarea>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="scars_injuries" class="form-label">傷跡・怪我</label>
                                                    <textarea class="form-control" id="scars_injuries" 
                                                              name="scars_injuries" rows="2" 
                                                              placeholder="目立つ傷跡、過去の怪我など..."></textarea>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="phobias_manias" class="form-label">恐怖症・狂気</label>
                                                    <textarea class="form-control" id="phobias_manias" 
                                                              name="phobias_manias" rows="2" 
                                                              placeholder="恐怖症、強迫観念、奇癖など..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 信念・価値観 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h5 class="mb-3">信念・価値観</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="beliefs_ideology" class="form-label">信念・思想</label>
                                                    <textarea class="form-control" id="beliefs_ideology" 
                                                              name="beliefs_ideology" rows="3" 
                                                              placeholder="宗教観、政治的信念、人生観など..."></textarea>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="significant_people" class="form-label">重要な人物</label>
                                                    <textarea class="form-control" id="significant_people" 
                                                              name="significant_people" rows="3" 
                                                              placeholder="家族、友人、恩師、恋人など..."></textarea>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="meaningful_locations" class="form-label">意味のある場所</label>
                                                    <textarea class="form-control" id="meaningful_locations" 
                                                              name="meaningful_locations" rows="2" 
                                                              placeholder="故郷、思い出の場所、聖地など..."></textarea>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="treasured_possessions" class="form-label">大切な所有物</label>
                                                    <textarea class="form-control" id="treasured_possessions" 
                                                              name="treasured_possessions" rows="2" 
                                                              placeholder="形見、お守り、思い出の品など..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 経歴・人生史 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h5 class="mb-3">経歴・人生史</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-12 mb-3">
                                                    <label for="personal_history" class="form-label">個人史</label>
                                                    <textarea class="form-control" id="personal_history" 
                                                              name="personal_history" rows="4" 
                                                              placeholder="生い立ち、教育、職歴、重要な出来事など..."></textarea>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12 mb-3">
                                                    <label for="important_events" class="form-label">重要な出来事</label>
                                                    <textarea class="form-control" id="important_events" 
                                                              name="important_events" rows="3" 
                                                              placeholder="人生を変えた出来事、トラウマ、成功体験など..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 人間関係 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h5 class="mb-3">人間関係</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-12 mb-3">
                                                    <label for="fellow_investigators" class="form-label">仲間の探索者たち</label>
                                                    <textarea class="form-control" id="fellow_investigators" 
                                                              name="fellow_investigators" rows="3" 
                                                              placeholder="他の探索者との関係、共通の目的、過去の関わりなど..."></textarea>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label for="notes_memo" class="form-label">備考・メモ</label>
                                                    <textarea class="form-control" id="notes_memo" 
                                                              name="notes_memo" rows="3" 
                                                              placeholder="キャラクターに関する追加情報、プレイノート、設定メモなど..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- クイック背景生成 -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="d-flex justify-content-center gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="generateRandomBackground('appearance')">
                                            <i class="fas fa-dice"></i> 容姿ランダム
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="generateRandomBackground('personality')">
                                            <i class="fas fa-dice"></i> 性格ランダム
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                onclick="generateRandomBackground('history')">
                                            <i class="fas fa-dice"></i> 経歴ランダム
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                onclick="showBackgroundHelp()">
                                            <i class="fas fa-question-circle"></i> ヘルプ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 9. 成長記録 -->
                        <div class="section mb-4" id="section-growth" data-section-id="growth">
                            <h4 class="section-title">
                                <i class="fas fa-chart-line"></i> 成長記録
                            </h4>
                            
                            <!-- セッション記録一覧 -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>セッション履歴</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addGrowthRecord()">
                                            <i class="fas fa-plus"></i> セッション記録追加
                                        </button>
                                    </div>
                                    
                                    <div id="growth-records-container">
                                        <div class="growth-record-item mb-3" id="growth-record-template" style="display: none;">
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong class="session-date">yyyy/mm/dd</strong> - 
                                                        <span class="scenario-name">シナリオ名</span>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            onclick="removeGrowthRecord(this)">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <label class="form-label form-label-sm">日付</label>
                                                            <input type="date" class="form-control form-control-sm" 
                                                                   name="session_date[]">
                                                        </div>
                                                        <div class="col-md-5">
                                                            <label class="form-label form-label-sm">シナリオ名</label>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   name="scenario_name[]" placeholder="例: 狂気山脈">
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label form-label-sm">GM名</label>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   name="gm_name[]" placeholder="例: 田中太郎">
                                                        </div>
                                                    </div>
                                                    <div class="row mt-2">
                                                        <div class="col-md-3">
                                                            <label class="form-label form-label-sm text-success">正気度回復</label>
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   name="sanity_gained[]" min="0" max="99" value="0">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label form-label-sm text-danger">正気度喪失</label>
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   name="sanity_lost[]" min="0" max="99" value="0">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label form-label-sm text-info">経験値獲得</label>
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   name="experience_gained[]" min="0" max="10" value="0">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label form-label-sm">特別報酬</label>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   name="special_rewards[]" placeholder="例: 魔術書">
                                                        </div>
                                                    </div>
                                                    <div class="row mt-2">
                                                        <div class="col-12">
                                                            <label class="form-label form-label-sm">セッションメモ</label>
                                                            <textarea class="form-control form-control-sm" 
                                                                      name="session_notes[]" rows="2" 
                                                                      placeholder="重要な出来事、成長した技能など..."></textarea>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 技能成長記録 -->
                                                    <div class="mt-3">
                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <h6 class="mb-0">技能成長</h6>
                                                            <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                                    onclick="addSkillGrowth(this)">
                                                                <i class="fas fa-plus"></i> 技能追加
                                                            </button>
                                                        </div>
                                                        <div class="skill-growth-container">
                                                            <!-- 技能成長アイテムがここに追加される -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- サマリー統計 -->
                                    <div class="mt-4">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">
                                                    <i class="fas fa-chart-bar"></i> 成長サマリー
                                                </h5>
                                                <div class="row text-center">
                                                    <div class="col-md-3">
                                                        <div class="stat-box">
                                                            <h6 class="text-muted">総セッション数</h6>
                                                            <h3 id="total-sessions">0</h3>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="stat-box">
                                                            <h6 class="text-muted">正気度変化</h6>
                                                            <h3 id="total-sanity-change" class="text-danger">-0</h3>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="stat-box">
                                                            <h6 class="text-muted">総経験値</h6>
                                                            <h3 id="total-experience" class="text-info">0</h3>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="stat-box">
                                                            <h6 class="text-muted">成長技能数</h6>
                                                            <h3 id="grown-skills" class="text-success">0</h3>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 職業・趣味ポイント（非表示フィールド） -->
                        <input type="hidden" id="occupation-points" value="0">
                        <input type="hidden" id="interest-points" value="0">
                        
                        <!-- 隠しフィールド（現在値保存用） -->
                        <input type="hidden" name="hit_points_current" id="hit_points_current_hidden">
                        <input type="hidden" name="magic_points_current" id="magic_points_current_hidden">
                        <input type="hidden" name="sanity_current" id="sanity_current_hidden">
                        <input type="hidden" name="sanity_max" id="sanity_max_hidden">
                        
                        <!-- フォーム送信ボタンはフッターに移動 -->
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- フローティング保存ボタン -->
<!-- フローティング保存ボタンを削除 - フッターのボタンを使用 -->

<!-- 自動保存インジケーター -->
<div class="auto-save-indicator" id="auto-save-indicator">
    <i class="fas fa-circle"></i> 自動保存中...
</div>

<!-- キーボードショートカットヘルプ -->
<div class="keyboard-shortcuts-help">
    <button class="keyboard-shortcuts-toggle" onclick="toggleKeyboardHelp()" title="キーボードショートカット">
        <i class="fas fa-keyboard"></i>
    </button>
    <div class="keyboard-shortcuts-panel" id="keyboard-shortcuts-panel">
        <h6>キーボードショートカット</h6>
        <div class="keyboard-shortcut">
            <span>下書き保存</span>
            <kbd>Ctrl+S</kbd>
        </div>
        <div class="keyboard-shortcut">
            <span>セクション移動</span>
            <kbd>Alt+Tab</kbd>
        </div>
        <div class="keyboard-shortcut">
            <span>次の入力欄</span>
            <kbd>Tab</kbd>
        </div>
        <div class="keyboard-shortcut">
            <span>前の入力欄</span>
            <kbd>Shift+Tab</kbd>
        </div>
    </div>
</div>

<!-- フッター（固定表示） -->
<div class="fixed-bottom bg-white border-top shadow-sm" id="skills-footer">
    <div class="container-fluid">
        <div class="row align-items-center py-2">
            <div class="col-md-8">
                <div class="d-flex justify-content-start gap-4">
                    <div class="skill-points-display">
                        <span class="fw-bold text-primary">職業技能:</span>
                        <span id="occupation-used-total" class="badge bg-primary">0/0</span>
                    </div>
                    <div class="skill-points-display">
                        <span class="fw-bold text-success">趣味技能:</span>
                        <span id="interest-used-total" class="badge bg-success">0/0</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="saveDraftCharacter()">
                    <i class="fas fa-file-alt"></i> 下書き保存
                </button>
                <button type="submit" class="btn btn-primary btn-sm" form="character-form-6th">
                    <i class="fas fa-save"></i> 探索者を保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- メインコンテンツにパディングを追加（フッター分） -->
<style>
body {
    padding-bottom: 70px;
}

/* デスクトップでのサイドメニュー分のパディング調整 */
@media (min-width: 993px) {
    body {
        padding-left: 280px;
        padding-bottom: 70px;
    }
    
    /* フッターもサイドメニュー分調整 */
    #skills-footer {
        left: 280px;
        width: calc(100% - 280px);
    }
}
</style>
    </div>
</div>

<!-- サイドメニュー -->
<div id="side-menu">
    <div class="side-menu-header">
        <h5 class="mb-0">
            <i class="fas fa-dice-d20"></i> セクションメニュー
        </h5>
    </div>
    <div class="side-menu-content">
        <a href="javascript:void(0)" class="side-menu-item" onclick="scrollToSection('section-basic')">
            <i class="fas fa-user"></i> 基本情報
        </a>
        <a href="javascript:void(0)" class="side-menu-item" onclick="scrollToSection('section-abilities')">
            <i class="fas fa-dice-d6"></i> 能力値
        </a>
        <a href="javascript:void(0)" class="side-menu-item" onclick="scrollToSection('section-skills')">
            <i class="fas fa-graduation-cap"></i> 技能
        </a>
        <a href="javascript:void(0)" class="side-menu-item" onclick="scrollToSection('section-derived-stats')">
            <i class="fas fa-calculator"></i> 副次ステータス
        </a>
        <a href="javascript:void(0)" class="side-menu-item" onclick="scrollToSection('section-combat')">
            <i class="fas fa-shield-alt"></i> 戦闘データ
        </a>
        <a href="javascript:void(0)" class="side-menu-item" onclick="scrollToSection('section-inventory')">
            <i class="fas fa-backpack"></i> 所持品
        </a>
        <a href="javascript:void(0)" class="side-menu-item" onclick="scrollToSection('section-background')">
            <i class="fas fa-book"></i> 背景
        </a>
        <a href="javascript:void(0)" class="side-menu-item" onclick="scrollToSection('section-growth')">
            <i class="fas fa-level-up-alt"></i> 成長
        </a>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// グローバル変数は既に上部の<script>ブロックで定義済み
// ABILITIES, DEFAULT_DICE_SETTINGS, HIGH_DICE_SETTINGS, currentDiceSettings, customSkills
// これらの変数はすべて利用可能

// 以下の関数は既にグローバルスコープで定義済み

// 副次ステータスの計算
function calculateDerivedStats() {
    const str = parseInt(document.getElementById('str').value) || 0;
    const con = parseInt(document.getElementById('con').value) || 0;
    const pow = parseInt(document.getElementById('pow').value) || 0;
    const dex = parseInt(document.getElementById('dex').value) || 0;
    const siz = parseInt(document.getElementById('siz').value) || 0;
    const int = parseInt(document.getElementById('int').value) || 0;
    const edu = parseInt(document.getElementById('edu').value) || 0;
    
    // HP計算
    document.getElementById('hp').value = Math.ceil((con + siz) / 2);
    
    // MP計算
    document.getElementById('mp').value = pow;
    
    // SAN計算
    document.getElementById('san').value = pow * 5;
    
    // アイデアロール
    document.getElementById('idea').value = int * 5;
    
    // 幸運ロール
    document.getElementById('luck').value = pow * 5;
    
    // 知識ロール
    document.getElementById('know').value = edu * 5;
    
    // ダメージボーナス計算
    const total = str + siz;
    let damageBonus = '';
    
    if (total <= 12) damageBonus = '-1D6';
    else if (total <= 16) damageBonus = '-1D4';
    else if (total <= 24) damageBonus = '+0';
    else if (total <= 32) damageBonus = '+1D4';
    else if (total <= 40) damageBonus = '+1D6';
    else if (total <= 56) damageBonus = '+2D6';
    else if (total <= 72) damageBonus = '+3D6';
    else if (total <= 88) damageBonus = '+4D6';
    else damageBonus = '+5D6';
    
    document.getElementById('damage_bonus').value = damageBonus;
    
    // 移動率計算
    let movementRate = 8;
    if (dex < siz) movementRate = 7;
    if (dex > siz) movementRate = 9;
    // movement_rate要素が存在する場合のみ値を設定
    const movementRateElement = document.getElementById('movement_rate');
    if (movementRateElement) {
        movementRateElement.value = movementRate;
    }
    
    // 戦闘データのSAN値設定（初期値POW×5）
    const currentSanCombat = document.getElementById('current_san_combat');
    if (currentSanCombat && (!currentSanCombat.value || currentSanCombat.value === '0' || currentSanCombat.value === '')) {
        currentSanCombat.value = pow * 5;
    }
    
    // 技能ポイント計算
    calculateSkillPoints();
}

// 副次ステータスが空の場合のみ計算する関数
function calculateDerivedStatsIfEmpty() {
    console.log('[DEBUG] calculateDerivedStatsIfEmpty 開始');
    
    const str = parseInt(document.getElementById('str').value) || 0;
    const con = parseInt(document.getElementById('con').value) || 0;
    const pow = parseInt(document.getElementById('pow').value) || 0;
    const dex = parseInt(document.getElementById('dex').value) || 0;
    const siz = parseInt(document.getElementById('siz').value) || 0;
    const int = parseInt(document.getElementById('int').value) || 0;
    const edu = parseInt(document.getElementById('edu').value) || 0;
    
    console.log(`[DEBUG] 能力値: STR=${str}, CON=${con}, POW=${pow}, DEX=${dex}, SIZ=${siz}, INT=${int}, EDU=${edu}`);
    
    // 能力値が設定されている場合のみ計算
    if (str > 0 || con > 0 || pow > 0 || dex > 0) {
        // HP計算（空の場合のみ）
        const hpField = document.getElementById('hp');
        if (hpField && (!hpField.value || hpField.value === '0' || hpField.value === '')) {
            const hpValue = Math.ceil((con + siz) / 2);
            hpField.value = hpValue;
            
            // 現在HPも同じ値で初期化
            const hitPointsCurrentField = document.getElementById('hit_points_current');
            if (hitPointsCurrentField) {
                hitPointsCurrentField.value = hpValue;
            }
            
            console.log(`[DEBUG] HP計算: (${con} + ${siz}) / 2 = ${hpValue}`);
        }
        
        // MP計算（空の場合のみ）
        const mpField = document.getElementById('mp');
        if (mpField && (!mpField.value || mpField.value === '0' || mpField.value === '')) {
            mpField.value = pow;
            
            // 現在MPも同じ値で初期化
            const magicPointsCurrentField = document.getElementById('magic_points_current');
            if (magicPointsCurrentField) {
                magicPointsCurrentField.value = pow;
            }
            
            console.log(`[DEBUG] MP計算: ${pow}`);
        }
        
        // SAN計算（空の場合のみ）
        const sanField = document.getElementById('san');
        if (sanField && (!sanField.value || sanField.value === '0' || sanField.value === '')) {
            const sanValue = pow * 5;
            sanField.value = sanValue;
            
            // 最大SAN・現在SANも同じ値で初期化
            const sanityMaxField = document.getElementById('sanity_max');
            const sanityCurrentField = document.getElementById('sanity_current');
            if (sanityMaxField) {
                sanityMaxField.value = sanValue;
            }
            if (sanityCurrentField) {
                sanityCurrentField.value = sanValue;
            }
            
            console.log(`[DEBUG] SAN計算: ${pow} × 5 = ${sanValue}`);
        }
        
        // 戦闘データのSAN値計算（空の場合のみ）
        const currentSanCombatField = document.getElementById('current_san_combat');
        if (currentSanCombatField && (!currentSanCombatField.value || currentSanCombatField.value === '0' || currentSanCombatField.value === '')) {
            const sanValue = pow * 5;
            currentSanCombatField.value = sanValue;
            console.log(`[DEBUG] 戦闘SAN計算: ${pow} × 5 = ${sanValue}`);
        }
        
        // アイデアロール（空の場合のみ）
        const ideaField = document.getElementById('idea');
        if (ideaField && (!ideaField.value || ideaField.value === '0' || ideaField.value === '')) {
            const ideaValue = int * 5;
            ideaField.value = ideaValue;
            console.log(`[DEBUG] アイデア計算: ${int} × 5 = ${ideaValue}`);
        }
        
        // 幸運ロール（空の場合のみ）
        const luckField = document.getElementById('luck');
        if (luckField && (!luckField.value || luckField.value === '0' || luckField.value === '')) {
            const luckValue = pow * 5;
            luckField.value = luckValue;
            console.log(`[DEBUG] 幸運計算: ${pow} × 5 = ${luckValue}`);
        }
        
        // 知識ロール（空の場合のみ）
        const knowField = document.getElementById('know');
        if (knowField && (!knowField.value || knowField.value === '0' || knowField.value === '')) {
            const knowValue = edu * 5;
            knowField.value = knowValue;
            console.log(`[DEBUG] 知識計算: ${edu} × 5 = ${knowValue}`);
        }
        
        // 技能ポイント計算も実行
        calculateSkillPoints();
        
        console.log('[DEBUG] 副次ステータス自動計算完了');
    } else {
        console.log('[DEBUG] 能力値が設定されていないため計算をスキップ');
    }
}

// 技能ポイント計算（改良版）
function calculateSkillPoints() {
    console.log('[DEBUG] 技能ポイント計算開始');
    
    // 能力値取得
    const edu = parseInt(document.getElementById('edu').value) || 0;
    const int = parseInt(document.getElementById('int').value) || 0;
    const str = parseInt(document.getElementById('str').value) || 0;
    const con = parseInt(document.getElementById('con').value) || 0;
    const pow = parseInt(document.getElementById('pow').value) || 0;
    const dex = parseInt(document.getElementById('dex').value) || 0;
    const app = parseInt(document.getElementById('app').value) || 0;
    
    // 職業技能ポイント計算式を取得
    const formulaSelect = document.getElementById('occupation-formula');
    const formula = formulaSelect ? formulaSelect.value : 'edu20';
    
    let occupationTotal = 0;
    
    // 選択された計算式で職業技能ポイントを計算
    switch(formula) {
        case 'edu20':
            occupationTotal = edu * 20;
            break;
        case 'edu10str10':
            occupationTotal = (edu * 10) + (str * 10);
            break;
        case 'edu10con10':
            occupationTotal = (edu * 10) + (con * 10);
            break;
        case 'edu10pow10':
            occupationTotal = (edu * 10) + (pow * 10);
            break;
        case 'edu10dex10':
            occupationTotal = (edu * 10) + (dex * 10);
            break;
        case 'edu10app10':
            occupationTotal = (edu * 10) + (app * 10);
            break;
        case 'edu10int10':
            occupationTotal = (edu * 10) + (int * 10);
            break;
        default:
            occupationTotal = edu * 20;
    }
    
    // 趣味技能ポイント計算
    const interestTotal = int * 10;
    
    console.log(`[DEBUG] 技能ポイント計算: EDU=${edu}, INT=${int}, 計算式=${formula}`);
    console.log(`[DEBUG] 計算結果: 職業ポイント=${occupationTotal}, 趣味ポイント=${interestTotal}`);
    
    // 総ポイント表示更新
    const occupationTotalElement = document.getElementById('occupation-points-total');
    const interestTotalElement = document.getElementById('interest-points-total');
    
    if (occupationTotalElement) {
        occupationTotalElement.textContent = occupationTotal;
    }
    if (interestTotalElement) {
        interestTotalElement.textContent = interestTotal;
    }
    
    // 残りポイント初期表示（使用量がまだ計算されていない場合）
    const occupationRemainingElement = document.getElementById('occupation-points-remaining');
    const interestRemainingElement = document.getElementById('interest-points-remaining');
    
    if (occupationRemainingElement && occupationRemainingElement.textContent === '0') {
        occupationRemainingElement.textContent = occupationTotal;
    }
    if (interestRemainingElement && interestRemainingElement.textContent === '0') {
        interestRemainingElement.textContent = interestTotal;
    }
    
    // フッター表示も更新
    const occupationUsedElement = document.getElementById('occupation-used-total');
    const interestUsedElement = document.getElementById('interest-used-total');
    
    if (occupationUsedElement && occupationUsedElement.textContent === '0/0') {
        occupationUsedElement.textContent = `0/${occupationTotal}`;
    }
    if (interestUsedElement && interestUsedElement.textContent === '0/0') {
        interestUsedElement.textContent = `0/${interestTotal}`;
    }
    
    // 古い要素にも互換性のため設定
    const occupationPointsOld = document.getElementById('occupation-points');
    const interestPointsOld = document.getElementById('interest-points');
    if (occupationPointsOld) occupationPointsOld.value = occupationTotal;
    if (interestPointsOld) interestPointsOld.value = interestTotal;
    
    // 使用済みポイントの計算
    updateSkillPointsUsage();
}

// 技能ポイント更新時の呼び出し
function updateSkillPoints() {
    calculateSecondaryStats();
}

// 技能ポイント使用状況の更新
function updateSkillPointsUsage() {
    let occupationUsed = 0;
    let interestUsed = 0;
    
    // すべての技能項目を取得
    const skillItems = document.querySelectorAll('.skill-item');
    
    console.log(`[DEBUG] 技能ポイント集計開始 - 技能項目数: ${skillItems.length}`);
    
    skillItems.forEach(item => {
        const occupationInput = item.querySelector('.occupation-points-input');
        const interestInput = item.querySelector('.interest-points-input');
        const skillTitle = item.querySelector('.skill-title')?.textContent?.trim();
        
        if (occupationInput) {
            const occValue = parseInt(occupationInput.value) || 0;
            if (occValue > 0) {
                console.log(`[DEBUG] 職業技能ポイント: ${skillTitle} = ${occValue}`);
            }
            occupationUsed += occValue;
        }
        if (interestInput) {
            const intValue = parseInt(interestInput.value) || 0;
            if (intValue > 0) {
                console.log(`[DEBUG] 趣味技能ポイント: ${skillTitle} = ${intValue}`);
            }
            interestUsed += intValue;
        }
    });
    
    console.log(`[DEBUG] 技能ポイント集計結果 - 職業: ${occupationUsed}, 趣味: ${interestUsed}`);
    
    // 総ポイント取得
    const occupationTotal = parseInt(document.getElementById('occupation-points-total').textContent) || 0;
    const interestTotal = parseInt(document.getElementById('interest-points-total').textContent) || 0;
    
    // 残りポイント計算
    const occupationRemaining = occupationTotal - occupationUsed;
    const interestRemaining = interestTotal - interestUsed;
    
    // 残りポイント表示
    document.getElementById('occupation-points-remaining').textContent = occupationRemaining;
    document.getElementById('interest-points-remaining').textContent = interestRemaining;
    
    // プログレスバー更新
    const occupationProgress = occupationTotal > 0 ? (occupationUsed / occupationTotal) * 100 : 0;
    const interestProgress = interestTotal > 0 ? (interestUsed / interestTotal) * 100 : 0;
    
    document.getElementById('occupation-points-progress').style.width = occupationProgress + '%';
    document.getElementById('interest-points-progress').style.width = interestProgress + '%';
    
    // フッターの表示更新
    document.getElementById('occupation-used-total').textContent = `${occupationUsed}/${occupationTotal}`;
    document.getElementById('interest-used-total').textContent = `${interestUsed}/${interestTotal}`;
    
    // 警告表示（ポイント超過時）
    if (occupationRemaining < 0) {
        document.getElementById('occupation-points-remaining').classList.add('text-danger');
    } else {
        document.getElementById('occupation-points-remaining').classList.remove('text-danger');
    }
    
    if (interestRemaining < 0) {
        document.getElementById('interest-points-remaining').classList.add('text-danger');
    } else {
        document.getElementById('interest-points-remaining').classList.remove('text-danger');
    }
}

// 基本技能データ
function getBaseSkills() {
    return [
        // 戦闘技能
        { name: '回避', base: 'DEX×2', category: 'combat', isCustom: false },
        { name: 'キック', base: 25, category: 'combat', isCustom: false },
        { name: '組み付き', base: 25, category: 'combat', isCustom: false },
        { name: 'こぶし（パンチ）', base: 50, category: 'combat', isCustom: false },
        { name: '頭突き', base: 10, category: 'combat', isCustom: false },
        { name: '投擲', base: 25, category: 'combat', isCustom: false },
        { name: 'マーシャルアーツ', base: 1, category: 'combat', isCustom: false },
        { name: '拳銃', base: 20, category: 'combat', isCustom: false },
        { name: 'サブマシンガン', base: 15, category: 'combat', isCustom: false },
        { name: 'ショットガン', base: 30, category: 'combat', isCustom: false },
        { name: 'マシンガン', base: 15, category: 'combat', isCustom: false },
        { name: 'ライフル', base: 25, category: 'combat', isCustom: false },
        
        // 探索技能
        { name: '応急手当', base: 30, category: 'search', isCustom: false },
        { name: '鍵開け', base: 1, category: 'search', isCustom: false },
        { name: '隠す', base: 15, category: 'search', isCustom: false },
        { name: '隠れる', base: 10, category: 'search', isCustom: false },
        { name: '聞き耳', base: 25, category: 'search', isCustom: false },
        { name: '忍び歩き', base: 10, category: 'search', isCustom: false },
        { name: '写真術', base: 10, category: 'search', isCustom: false },
        { name: '精神分析', base: 1, category: 'negotiation', isCustom: false },
        { name: '追跡', base: 10, category: 'search', isCustom: false },
        { name: '登攀', base: 40, category: 'search', isCustom: false },
        { name: '図書館', base: 25, category: 'search', isCustom: false },
        { name: '目星', base: 25, category: 'search', isCustom: false },
        
        // 知識技能
        { name: '医学', base: 5, category: 'knowledge', isCustom: false },
        { name: 'オカルト', base: 5, category: 'knowledge', isCustom: false },
        { name: '化学', base: 1, category: 'knowledge', isCustom: false },
        { name: 'クトゥルフ神話', base: 0, category: 'knowledge', isCustom: false },
        { name: '芸術', base: 5, category: 'knowledge', isCustom: false },
        { name: '経理', base: 10, category: 'knowledge', isCustom: false },
        { name: '考古学', base: 1, category: 'knowledge', isCustom: false },
        { name: 'コンピューター', base: 1, category: 'knowledge', isCustom: false },
        { name: '心理学', base: 5, category: 'negotiation', isCustom: false },
        { name: '人類学', base: 1, category: 'knowledge', isCustom: false },
        { name: '生物学', base: 1, category: 'knowledge', isCustom: false },
        { name: '地質学', base: 1, category: 'knowledge', isCustom: false },
        { name: '電子工学', base: 1, category: 'knowledge', isCustom: false },
        { name: '天文学', base: 1, category: 'knowledge', isCustom: false },
        { name: '博物学', base: 10, category: 'knowledge', isCustom: false },
        { name: '物理学', base: 1, category: 'knowledge', isCustom: false },
        { name: '法律', base: 5, category: 'knowledge', isCustom: false },
        { name: '薬学', base: 1, category: 'knowledge', isCustom: false },
        { name: '歴史', base: 20, category: 'knowledge', isCustom: false },
        { name: '他の言語', base: 1, category: 'knowledge', isCustom: false },
        
        // 行動技能
        { name: '運転（自動車）', base: 20, category: 'action', isCustom: false },
        { name: '運転（その他）', base: 1, category: 'action', isCustom: false },
        { name: '機械修理', base: 20, category: 'action', isCustom: false },
        { name: '重機械操作', base: 1, category: 'action', isCustom: false },
        { name: '乗馬', base: 5, category: 'action', isCustom: false },
        { name: '水泳', base: 25, category: 'action', isCustom: false },
        { name: '跳躍', base: 25, category: 'action', isCustom: false },
        { name: '電気修理', base: 10, category: 'action', isCustom: false },
        { name: 'ナビゲート', base: 10, category: 'action', isCustom: false },
        { name: '変装', base: 1, category: 'action', isCustom: false },
        
        // 交渉技能
        { name: '言いくるめ', base: 5, category: 'negotiation', isCustom: false },
        { name: '信用', base: 15, category: 'negotiation', isCustom: false },
        { name: '説得', base: 15, category: 'negotiation', isCustom: false },
        { name: '値切り', base: 5, category: 'negotiation', isCustom: false },
        { name: '母国語', base: 'EDU×5', category: 'negotiation', isCustom: false }
    ];
}

// 全技能取得（基本技能 + カスタム技能）
function getAllSkills() {
    return [...getBaseSkills(), ...customSkills];
}

// 技能リスト生成（シンプル版 - 一度だけ生成）
let skillsGenerated = false;

function generateSkillsList() {
    // 既に生成済みの場合はスキップ
    if (skillsGenerated) {
        console.log('[DEBUG] 技能リストは既に生成済みです');
        return;
    }
    
    const allSkills = getAllSkills();
    const container = document.getElementById('all-skills-container');
    if (!container) return;
    
    // 全技能を一度に生成
    let html = '<div class="row">';
    
    allSkills.forEach(skill => {
        let baseValue = skill.base;
        if (skill.base === 'DEX×2') {
            baseValue = (parseInt(document.getElementById('dex').value) || 0) * 2;
        } else if (skill.base === 'EDU×5') {
            baseValue = (parseInt(document.getElementById('edu').value) || 0) * 5;
        }
        
        const skillId = skill.name.replace(/[^a-zA-Z0-9]/g, '_');
        
        // 技能HTML生成（シンプル版）
        html += `
            <div class="col-12 col-md-6 col-lg-4 skill-item-wrapper" 
                 data-skill-name="${skill.name.toLowerCase()}"
                 data-skill-category="${skill.category}"
                 data-skill-id="${skillId}">
                <div class="skill-item mb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <h6 class="skill-title">${skill.name}${skill.isCustom ? ' <span class="badge bg-secondary">カスタム</span>' : ''}</h6>
                        ${skill.isCustom ? `<button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeCustomSkill('${skill.name}')" title="削除"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                    <div class="row g-1">
                        <div class="col-3">
                            <label class="form-label form-label-sm">初期値</label>
                            <input type="number" class="form-control form-control-sm skill-base" 
                                   name="skill_${skillId}_base" 
                                   min="0" max="999" value="${baseValue}"
                                   data-skill="${skill.name}"
                                   onchange="updateSkillTotalSimple(this);">
                        </div>
                        <div class="col-3">
                            <label class="form-label form-label-sm text-primary">職業</label>
                            <input type="number" class="form-control form-control-sm skill-occupation occupation-points-input" 
                                   name="skill_${skillId}_occupation" 
                                   min="0" max="999" value="0"
                                   data-skill="${skill.name}"
                                   onchange="updateSkillTotalSimple(this); updateSkillPointsUsage();">
                        </div>
                        <div class="col-3">
                            <label class="form-label form-label-sm text-success">趣味</label>
                            <input type="number" class="form-control form-control-sm skill-interest interest-points-input" 
                                   name="skill_${skillId}_interest" 
                                   min="0" max="999" value="0"
                                   data-skill="${skill.name}"
                                   onchange="updateSkillTotalSimple(this); updateSkillPointsUsage();">
                        </div>
                        <div class="col-3">
                            <label class="form-label form-label-sm">ボーナス</label>
                            <input type="number" class="form-control form-control-sm skill-bonus" 
                                   name="skill_${skillId}_bonus" 
                                   min="0" max="999" value="0"
                                   data-skill="${skill.name}"
                                   onchange="updateSkillTotalSimple(this);">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <label class="form-label form-label-sm fw-bold">合計</label>
                            <input type="number" class="form-control form-control-sm bg-light skill-total" 
                                   name="skill_${skillId}_total" 
                                   readonly value="${baseValue}"
                                   data-skill="${skill.name}">
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // タブバッジの更新
    updateSkillTabBadges(allSkills);
    
    skillsGenerated = true;
    console.log('[DEBUG] 技能リスト生成完了（シンプル版）');
    
    // 技能リスト生成後に初期値を更新とタブ初期化
    setTimeout(() => {
        updateSkillBaseValues();
        initializeSkillTabs(); // 技能タブ初期化
    }, 100);
}

// 能力値変更時に技能初期値と技能ポイントを更新
function updateSkillBaseValues() {
    console.log('[DEBUG] 能力値変更による自動更新開始');
    
    // 能力値を取得
    const str = parseInt(document.getElementById('str').value) || 0;
    const con = parseInt(document.getElementById('con').value) || 0;
    const pow = parseInt(document.getElementById('pow').value) || 0;
    const dex = parseInt(document.getElementById('dex').value) || 0;
    const app = parseInt(document.getElementById('app').value) || 0;
    const siz = parseInt(document.getElementById('siz').value) || 0;
    const int = parseInt(document.getElementById('int').value) || 0;
    const edu = parseInt(document.getElementById('edu').value) || 0;
    
    console.log(`[DEBUG] 能力値: STR=${str}, CON=${con}, POW=${pow}, DEX=${dex}, APP=${app}, SIZ=${siz}, INT=${int}, EDU=${edu}`);
    
    // 1. 技能ポイント自動計算
    calculateSkillPoints();
    
    // 2. 副次ステータス自動計算
    calculateDerivedStats();
    
    // 3. 技能初期値の自動更新
    updateAbilityBasedSkills();
    
    // 4. フッター技能ポイント表示更新
    updateFooterSkillPoints();
    
    console.log('[DEBUG] 能力値変更による自動更新完了');
}

// 能力値参照技能の初期値更新
function updateAbilityBasedSkills() {
    const dex = parseInt(document.getElementById('dex').value) || 0;
    const edu = parseInt(document.getElementById('edu').value) || 0;
    
    console.log(`[DEBUG] 能力値参照技能更新: DEX=${dex}, EDU=${edu}`);
    
    // 全ての技能要素を取得
    const skillElements = document.querySelectorAll('.skill-item-wrapper');
    
    skillElements.forEach(skillElement => {
        const skillTitle = skillElement.querySelector('.skill-title, h6, strong');
        if (!skillTitle) return;
        
        const skillName = skillTitle.textContent.replace(/\s*カスタム\s*/, '').trim();
        
        // 回避技能 (DEX×2)
        if (skillName === '回避') {
            const baseInput = skillElement.querySelector('.skill-base');
            if (baseInput) {
                const newValue = dex * 2;
                baseInput.value = newValue;
                updateSkillTotalSimple(baseInput);
                console.log(`[DEBUG] 回避技能初期値更新: ${newValue}`);
            }
        }
        
        // 母国語技能 (EDU×5)
        if (skillName === '母国語') {
            const baseInput = skillElement.querySelector('.skill-base');
            if (baseInput) {
                const newValue = edu * 5;
                baseInput.value = newValue;
                updateSkillTotalSimple(baseInput);
                console.log(`[DEBUG] 母国語技能初期値更新: ${newValue}`);
            }
        }
    });
}

// この関数は削除されました - 新しいCSS-based filtering system を使用

// 技能合計計算
function updateSkillTotal(inputElement) {
    // inputElementがDOM要素の場合、技能名を取得
    let skillName;
    if (typeof inputElement === 'string') {
        skillName = inputElement;
    } else if (inputElement && inputElement.closest) {
        // DOM要素から技能名を取得
        const skillItem = inputElement.closest('.skill-item, .skill-item-wrapper');
        if (skillItem) {
            const skillTitle = skillItem.querySelector('.skill-title, h6, strong');
            skillName = skillTitle ? skillTitle.textContent.trim() : '';
        }
    }
    
    if (!skillName) {
        console.error('[DEBUG] 技能名を取得できませんでした');
        return;
    }
    
    const skillId = skillName.replace(/[^a-zA-Z0-9]/g, '_');
    const baseInput = document.querySelector(`input[name="skill_${skillId}_base"]`);
    const occupationInput = document.querySelector(`input[name="skill_${skillId}_occupation"]`);
    const interestInput = document.querySelector(`input[name="skill_${skillId}_interest"]`);
    const bonusInput = document.querySelector(`input[name="skill_${skillId}_bonus"]`);
    const totalInput = document.querySelector(`input[name="skill_${skillId}_total"]`);
    
    if (!baseInput || !occupationInput || !interestInput || !bonusInput || !totalInput) return;
    
    const base = parseInt(baseInput.value) || 0;
    const occupation = parseInt(occupationInput.value) || 0;
    const interest = parseInt(interestInput.value) || 0;
    const bonus = parseInt(bonusInput.value) || 0;
    
    const total = base + occupation + interest + bonus;
    totalInput.value = total;
    
    // フッターの更新
    updateFooterSkillPoints();
}

// 技能入力欄のイベントリスナー追加
function addSkillEventListeners(skillName) {
    const skillId = skillName.replace(/[^a-zA-Z0-9]/g, '_');
    const inputs = [
        document.querySelector(`input[name="skill_${skillId}_base"]`),
        document.querySelector(`input[name="skill_${skillId}_occupation"]`),
        document.querySelector(`input[name="skill_${skillId}_interest"]`),
        document.querySelector(`input[name="skill_${skillId}_bonus"]`)
    ];
    
    inputs.forEach(input => {
        if (input) {
            input.addEventListener('input', () => {
                updateSkillTotal(skillName);
            });
        }
    });
}

// フッターの技能ポイント表示更新
function updateFooterSkillPoints() {
    let occupationUsed = 0;
    let interestUsed = 0;
    
    // 全ての職業技能・趣味技能の合計を計算
    document.querySelectorAll('.skill-occupation').forEach(input => {
        occupationUsed += parseInt(input.value) || 0;
    });
    
    document.querySelectorAll('.skill-interest').forEach(input => {
        interestUsed += parseInt(input.value) || 0;
    });
    
    const occupationTotal = parseInt(document.getElementById('occupation-points').textContent) || 0;
    const interestTotal = parseInt(document.getElementById('interest-points').textContent) || 0;
    
    // フッターの表示を更新
    const occupationDisplay = document.getElementById('occupation-used-total');
    const interestDisplay = document.getElementById('interest-used-total');
    
    if (occupationDisplay) {
        occupationDisplay.textContent = `${occupationUsed}/${occupationTotal}`;
        occupationDisplay.className = occupationUsed > occupationTotal ? 'badge bg-danger' : 'badge bg-primary';
    }
    
    if (interestDisplay) {
        interestDisplay.textContent = `${interestUsed}/${interestTotal}`;
        interestDisplay.className = interestUsed > interestTotal ? 'badge bg-danger' : 'badge bg-success';
    }
}

// 下書き保存
function saveDraft() {
    const formData = new FormData(document.getElementById('character-form-6th'));
    const data = {};
    
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    // キャッシュも更新
    draftDataCache = data;
    
    localStorage.setItem('coc6th_character_draft', JSON.stringify(data));
    showNotification('下書きを保存しました', 'success');
}

// saveDraftCharacter関数のエイリアス（フッターボタン用）
function saveDraftCharacter() {
    saveDraft();
}

// 通知表示関数
function showNotification(message, type = 'success') {
    // 既存の通知を削除
    const existingNotification = document.querySelector('.notification-toast');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // 通知要素を作成
    const notification = document.createElement('div');
    notification.className = `notification-toast alert alert-${type === 'error' ? 'danger' : type} position-fixed top-0 end-0 m-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // 3秒後に自動で削除
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// 下書き読み込み
function loadDraft() {
    const savedData = localStorage.getItem('coc6th_character_draft');
    if (savedData) {
        const data = JSON.parse(savedData);
        
        // 下書きデータをキャッシュに保存
        draftDataCache = data;
        
        Object.entries(data).forEach(([key, value]) => {
            const element = document.querySelector(`[name="${key}"]`);
            if (element) {
                element.value = value;
            }
        });
        
        // 副次ステータスを再計算
        calculateDerivedStats();
        
        // 技能リストを再生成
        generateSkillsList();
    }
}

// カスタム技能追加
function addCustomSkill(category) {
    const skillName = prompt('技能名を入力してください（最大50文字）:');
    if (!skillName || skillName.trim() === '') {
        return;
    }
    
    // 重複チェック
    const allSkills = getAllSkills();
    if (allSkills.some(skill => skill.name === skillName.trim())) {
        showNotification('同じ名前の技能が既に存在します。', 'warning');
        return;
    }
    
    const baseValueStr = prompt('初期値を入力してください（0-90）:', '1');
    if (!baseValueStr || isNaN(baseValueStr)) {
        return;
    }
    
    const baseValue = parseInt(baseValueStr);
    if (baseValue < 0 || baseValue > 90) {
        showNotification('初期値は0から90の間で入力してください。', 'error');
        return;
    }
    
    const newSkill = {
        name: skillName.trim(),
        base: baseValue,
        category: category,
        isCustom: true
    };
    
    customSkills.push(newSkill);
    generateSkillsList();
    updateFooterSkillPoints();
    
    // カスタム技能をローカルストレージに保存
    localStorage.setItem('coc6th_custom_skills', JSON.stringify(customSkills));
}

// タブバッジ更新
function updateSkillTabBadges(allSkills) {
    const categories = {
        all: allSkills.length,
        combat: allSkills.filter(s => s.category === 'combat').length,
        search: allSkills.filter(s => s.category === 'search').length,
        knowledge: allSkills.filter(s => s.category === 'knowledge').length,
        other: allSkills.filter(s => s.category === 'other').length
    };
    
    Object.keys(categories).forEach(category => {
        const badge = document.getElementById(`${category}-count`);
        if (badge) {
            badge.textContent = categories[category];
        }
    });
}

// 技能合計値の更新（シンプル版）
function updateSkillTotalSimple(element) {
    const skillName = element.dataset.skill;
    if (!skillName) {
        console.error('[DEBUG] 技能名が見つかりません', element);
        return;
    }
    
    const skillId = skillName.replace(/[^a-zA-Z0-9]/g, '_');
    
    // 各値を取得
    const baseInput = document.querySelector(`[name="skill_${skillId}_base"]`);
    const occupationInput = document.querySelector(`[name="skill_${skillId}_occupation"]`);
    const interestInput = document.querySelector(`[name="skill_${skillId}_interest"]`);
    const bonusInput = document.querySelector(`[name="skill_${skillId}_bonus"]`);
    const totalInput = document.querySelector(`[name="skill_${skillId}_total"]`);
    
    if (baseInput && occupationInput && interestInput && bonusInput && totalInput) {
        const base = parseInt(baseInput.value) || 0;
        const occupation = parseInt(occupationInput.value) || 0;
        const interest = parseInt(interestInput.value) || 0;
        const bonus = parseInt(bonusInput.value) || 0;
        
        const total = base + occupation + interest + bonus; // 上限なし
        totalInput.value = total;
        
        console.log(`[DEBUG] ${skillName}: 基本=${base} + 職業=${occupation} + 趣味=${interest} + ボーナス=${bonus} = ${total}`);
    }
}

// ダイス設定リセット
function resetDiceSettings() {
    currentDiceSettings = { ...DEFAULT_DICE_SETTINGS };
    ABILITIES.forEach(ability => {
        const settings = currentDiceSettings[ability];
        document.getElementById(`dice-${ability}-count`).value = settings.count;
        document.getElementById(`dice-${ability}-sides`).value = settings.sides;
        document.getElementById(`dice-${ability}-bonus`).value = settings.bonus;
    });
    document.getElementById('dice-preset').value = 'standard';
}

// 標準プリセット適用
function applyStandardPreset() {
    document.getElementById('dice-preset').value = 'standard';
    loadDicePreset();
}

// 技能合計値の更新（要素ベース）
function updateSkillTotalFromElement(element) {
    const skillName = element.dataset.skill;
    if (!skillName) {
        console.error('[DEBUG] 技能名が見つかりません', element);
        return;
    }
    const skillId = skillName.replace(/[^a-zA-Z0-9]/g, '_');
    
    // 各値を取得
    const baseInput = document.querySelector(`[name="skill_${skillId}_base"]`);
    const occupationInput = document.querySelector(`[name="skill_${skillId}_occupation"]`);
    const interestInput = document.querySelector(`[name="skill_${skillId}_interest"]`);
    const bonusInput = document.querySelector(`[name="skill_${skillId}_bonus"]`);
    const totalInput = document.querySelector(`[name="skill_${skillId}_total"]`);
    
    if (baseInput && occupationInput && interestInput && bonusInput && totalInput) {
        const base = parseInt(baseInput.value) || 0;
        const occupation = parseInt(occupationInput.value) || 0;
        const interest = parseInt(interestInput.value) || 0;
        const bonus = parseInt(bonusInput.value) || 0;
        
        const total = base + occupation + interest + bonus;
        totalInput.value = total; // 上限なし
    }
}

// 技能ポイント自動配分
function autoDistributePoints(type) {
    const occupationTotal = parseInt(document.getElementById('occupation-points-total').textContent) || 0;
    const interestTotal = parseInt(document.getElementById('interest-points-total').textContent) || 0;
    
    if (type === 'occupation' && occupationTotal === 0) {
        showNotification('職業技能ポイントが0です。EDUを設定してください。', 'warning');
        return;
    }
    
    if (type === 'interest' && interestTotal === 0) {
        showNotification('趣味技能ポイントが0です。INTを設定してください。', 'warning');
        return;
    }
    
    // 推奨技能（職業別）
    const occupationSkills = {
        '医師': ['医学', '応急手当', '精神分析', '薬学', '生物学', '図書館', '信用', '心理学'],
        '教授': ['図書館', '他の言語', '心理学', '信用', 'オカルト', '歴史', '人類学', '考古学'],
        '警察官': ['拳銃', '法律', '目星', '聞き耳', '心理学', '追跡', '運転（自動車）', '組み付き'],
        'ジャーナリスト': ['図書館', '説得', '心理学', '写真術', '信用', '聞き耳', '目星', '他の言語'],
        '探偵': ['目星', '聞き耳', '心理学', '追跡', '鍵開け', '法律', '写真術', '図書館']
    };
    
    // 一般的な推奨技能（趣味用）
    const interestSkills = ['回避', '目星', '聞き耳', '図書館', '隠れる', '忍び歩き', '運転（自動車）', '信用'];
    
    if (type === 'occupation') {
        // 職業技能の配分
        const occupation = document.getElementById('occupation').value || '探偵';
        const skills = occupationSkills[occupation] || occupationSkills['探偵'];
        distributePointsToSkills(skills, occupationTotal, 'occupation');
    } else {
        // 趣味技能の配分
        distributePointsToSkills(interestSkills, interestTotal, 'interest');
    }
    
    updateSkillPointsUsage();
}

// 技能にポイントを配分
function distributePointsToSkills(skillNames, totalPoints, type) {
    // まず全てのポイントをクリア
    document.querySelectorAll(`.${type}-points-input`).forEach(input => {
        input.value = 0;
    });
    
    // 技能数で均等配分（余りは最初の技能に追加）
    const pointsPerSkill = Math.floor(totalPoints / skillNames.length);
    const remainder = totalPoints % skillNames.length;
    
    skillNames.forEach((skillName, index) => {
        const skillId = skillName.replace(/[^a-zA-Z0-9]/g, '_');
        const input = document.querySelector(`[name="skill_${skillId}_${type}"]`);
        
        if (input) {
            const points = pointsPerSkill + (index === 0 ? remainder : 0);
            input.value = points; // 上限なし
            
            // 合計値を更新
            updateSkillTotalFromElement(input);
        }
    });
}

// 全ポイントクリア
function clearAllPoints() {
    if (confirm('すべての技能ポイント配分をクリアしますか？')) {
        document.querySelectorAll('.occupation-points-input, .interest-points-input').forEach(input => {
            input.value = 0;
            updateSkillTotalFromElement(input);
        });
        updateSkillPointsUsage();
    }
}

// ポイント配分ヘルプ表示
function showPointDistributionHelp() {
    const helpText = `
技能ポイント配分のヘルプ

【職業技能ポイント】
- EDU×倍率（通常20）で計算されます
- 職業に関連する技能に配分してください
- 倍率は職業によって15～30の範囲で変更可能です

【趣味技能ポイント】
- INT×10で計算されます
- 自由に好きな技能に配分できます

【配分のコツ】
- 汎用性の高い技能（目星、聞き耳、図書館など）を優先
- 職業のイメージに合った技能を選択
- 1つの技能に集中するより、バランスよく配分

【上限】
- 各技能の最大値は99です
- 初期値＋職業＋趣味＋ボーナスの合計が99を超えることはありません
`;
    
    showHelpModal('技能ポイントの使い方', helpText);
}

// 推奨技能表示
function showRecommendedSkills() {
    const recommendedSkills = [
        '目星', '聞き耳', '図書館', '心理学', '信用',
        '説得', '応急手当', '拳銃', '回避', '鍵開け'
    ];
    
    const helpText = '推奨技能:\n' + recommendedSkills.join(', ') + 
          '\n\nこれらは一般的なシナリオでよく使用される技能です。';
    showHelpModal('推奨技能', helpText);
}

// 全技能リセット
function resetAllSkills() {
    if (confirm('すべての技能ポイントをリセットしますか？')) {
        document.querySelectorAll('.skill-occupation, .skill-interest, .skill-bonus').forEach(input => {
            input.value = 0;
        });
        document.querySelectorAll('.skill-total').forEach(input => {
            const skillName = input.dataset.skill;
            if (skillName) {
                updateSkillTotal(skillName);
            }
        });
        updateFooterSkillPoints();
    }
}

// フォームデータ収集関数
function collectFormData() {
    const form = document.getElementById('character-form-6th');
    const formData = {};
    
    // 通常のフォーム要素
    const inputs = form.querySelectorAll('input:not([type="file"]), select, textarea');
    inputs.forEach(input => {
        if (input.name) {
            if (input.type === 'checkbox') {
                formData[input.name] = input.checked;
            } else if (input.type === 'radio') {
                if (input.checked) {
                    formData[input.name] = input.value;
                }
            } else {
                formData[input.name] = input.value;
            }
        }
    });
    
    // 技能データ
    const skills = [];
    document.querySelectorAll('.skill-item').forEach(item => {
        const skillName = item.querySelector('.skill-title')?.textContent;
        if (skillName) {
            const skillData = {
                name: skillName,
                occupation: item.querySelector('.occupation-points-input')?.value || 0,
                interest: item.querySelector('.interest-points-input')?.value || 0,
                bonus: item.querySelector('.skill-bonus')?.value || 0,
                total: item.querySelector('.skill-total')?.value || 0
            };
            skills.push(skillData);
        }
    });
    formData.skills = skills;
    
    return formData;
}

// 下書き保存関数
function saveDraftCharacter() {
    const formData = collectFormData();
    
    // デバッグ: 技能データを確認
    const skillKeys = Object.keys(formData).filter(key => key.includes('skill_') && key.includes('_occupation'));
    if (skillKeys.length > 0) {
        console.log('[DEBUG] 下書き保存時の技能データ:');
        skillKeys.forEach(key => {
            const value = formData[key];
            if (value && value !== '0') {
                console.log(`  ${key}: ${value}`);
            }
        });
    }
    
    // キャッシュも更新
    draftDataCache = formData;
    
    localStorage.setItem('coc6th_character_draft', JSON.stringify(formData));
    showNotification('下書きを保存しました', 'success');
    showAutoSaveIndicator();
}

// フォーム送信関数
function submitCharacterForm() {
    console.log('[DEBUG] フォーム送信開始');
    const form = document.getElementById('character-form-6th');
    if (!form) {
        console.error('[ERROR] フォーム要素が見つかりません');
        showNotification('フォームが見つかりません', 'danger');
        return;
    }
    
    console.log('[DEBUG] フォーム要素確認済み');
    
    // バリデーションチェック
    if (!validateForm()) {
        console.log('[DEBUG] バリデーション失敗');
        return;
    }
    
    console.log('[DEBUG] バリデーション成功');
    
    try {
        // 技能データをhidden inputとして追加
        addSkillDataToForm();
        console.log('[DEBUG] 技能データ追加完了');
        
        // CSRFトークンの確認
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            console.error('[ERROR] CSRFトークンが見つかりません');
            showNotification('セキュリティトークンエラー', 'danger');
            return;
        }
        console.log('[DEBUG] CSRFトークン確認済み');
        
        // 必須フィールドの最終確認
        const requiredFields = ['name', 'str_value', 'con_value', 'pow_value', 'dex_value', 'app_value', 'siz_value', 'int_value', 'edu_value'];
        let missingFields = [];
        
        requiredFields.forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (!field || !field.value.trim()) {
                missingFields.push(fieldName);
            }
        });
        
        if (missingFields.length > 0) {
            console.error('[ERROR] 必須フィールドが不足:', missingFields);
            showNotification(`必須項目が不足しています: ${missingFields.join(', ')}`, 'danger');
            return;
        }
        
        console.log('[DEBUG] 必須フィールド確認済み');
        
        // フォーム送信
        console.log('[DEBUG] フォーム送信実行');
        form.submit();
        
    } catch (error) {
        console.error('[ERROR] フォーム送信中にエラー:', error);
        showNotification('送信処理中にエラーが発生しました', 'danger');
    }
}

// 技能データをフォームにhidden inputとして追加
function addSkillDataToForm() {
    const form = document.getElementById('character-form-6th');
    
    // 既存の技能related hidden inputを削除
    const existingSkillInputs = form.querySelectorAll('input[name^="skill_"]');
    existingSkillInputs.forEach(input => input.remove());
    
    // 技能データを収集してhidden inputとして追加
    document.querySelectorAll('.skill-item-wrapper').forEach(skillWrapper => {
        const skillTitle = skillWrapper.querySelector('.skill-title');
        if (skillTitle) {
            const skillName = skillTitle.textContent.trim().replace(/\s*カスタム\s*/, '');
            if (!skillName) {
                console.warn('[DEBUG] 技能名が空です', skillTitle);
                return; // forEachでは continue の代わりに return を使用
            }
            const skillId = skillWrapper.dataset.skillId || skillName.replace(/[^a-zA-Z0-9]/g, '_');
            
            // 各種ポイントを取得
            const baseInput = skillWrapper.querySelector('.skill-base');
            const occupationInput = skillWrapper.querySelector('.skill-occupation');
            const interestInput = skillWrapper.querySelector('.skill-interest');
            const bonusInput = skillWrapper.querySelector('.skill-bonus');
            const totalInput = skillWrapper.querySelector('.skill-total');
            
            if (baseInput) {
                const hiddenBase = document.createElement('input');
                hiddenBase.type = 'hidden';
                hiddenBase.name = `skill_${skillId}_base`;
                hiddenBase.value = baseInput.value || '0';
                form.appendChild(hiddenBase);
            }
            
            if (occupationInput) {
                const hiddenOccupation = document.createElement('input');
                hiddenOccupation.type = 'hidden';
                hiddenOccupation.name = `skill_${skillId}_occupation`;
                hiddenOccupation.value = occupationInput.value || '0';
                form.appendChild(hiddenOccupation);
            }
            
            if (interestInput) {
                const hiddenInterest = document.createElement('input');
                hiddenInterest.type = 'hidden';
                hiddenInterest.name = `skill_${skillId}_interest`;
                hiddenInterest.value = interestInput.value || '0';
                form.appendChild(hiddenInterest);
            }
            
            if (bonusInput) {
                const hiddenBonus = document.createElement('input');
                hiddenBonus.type = 'hidden';
                hiddenBonus.name = `skill_${skillId}_bonus`;
                hiddenBonus.value = bonusInput.value || '0';
                form.appendChild(hiddenBonus);
            }
            
            if (totalInput) {
                const hiddenTotal = document.createElement('input');
                hiddenTotal.type = 'hidden';
                hiddenTotal.name = `skill_${skillId}_total`;
                hiddenTotal.value = totalInput.value || '0';
                form.appendChild(hiddenTotal);
            }
            
            // 技能名も追加
            const hiddenSkillName = document.createElement('input');
            hiddenSkillName.type = 'hidden';
            hiddenSkillName.name = `skill_${skillId}_name`;
            hiddenSkillName.value = skillName;
            form.appendChild(hiddenSkillName);
        }
    });
    
    console.log('[DEBUG] 技能データをフォームに追加完了');
}

// 通知表示関数
function showNotification(message, type = 'info') {
    // 既存の通知を削除
    const existingNotification = document.querySelector('.notification-toast');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // 通知要素を作成
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show notification-toast`;
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
        animation: slideIn 0.3s ease;
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // 3秒後に自動的に削除
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 150);
    }, 3000);
}

// フォームバリデーション
function validateForm() {
    const requiredFields = document.querySelectorAll('[required]');
    let isValid = true;
    let firstInvalidField = null;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            if (!firstInvalidField) {
                firstInvalidField = field;
            }
            isValid = false;
            
            // エラーメッセージを表示
            let errorDiv = field.parentElement.querySelector('.invalid-feedback');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = 'この項目は必須です';
                field.parentElement.appendChild(errorDiv);
            }
        } else {
            field.classList.remove('is-invalid');
            const errorDiv = field.parentElement.querySelector('.invalid-feedback');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
    });
    
    if (!isValid) {
        showNotification('必須項目を入力してください', 'danger');
        if (firstInvalidField) {
            firstInvalidField.focus();
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    return isValid;
}

// 技能タブ切り替え処理（改良版）
function initializeSkillTabs() {
    console.log('[DEBUG] 技能タブ初期化開始');
    
    // 技能分類定義（フォールバック用 - 通常はdata-skill-categoryを使用）
    const skillCategories = {
        combat: ['回避', 'キック', '組み付き', 'こぶし（パンチ）', '頭突き', '投擲', 'マーシャルアーツ', '拳銃', 'サブマシンガン', 'ショットガン', 'マシンガン', 'ライフル'],
        search: ['応急手当', '鍵開け', '隠す', '隠れる', '聞き耳', '忍び歩き', '写真術', '精神分析', '追跡', '登攀', '図書館', '目星'],
        action: ['運転（自動車）', '運転（その他）', '機械修理', '重機械操作', '乗馬', '水泳', '跳躍', '電気修理', 'ナビゲート', '変装'],
        negotiation: ['言いくるめ', '信用', '説得', '値切り', '心理学', '母国語'],
        knowledge: ['医学', 'オカルト', '化学', 'クトゥルフ神話', '芸術', '経理', '考古学', 'コンピューター', '人類学', '生物学', '地質学', '電子工学', '天文学', '博物学', '物理学', '法律', '薬学', '歴史', '他の言語'],
        other: []
    };
    
    // タブ切り替えイベントリスナーを追加
    const skillTabButtons = document.querySelectorAll('[data-skill-tab]');
    skillTabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetCategory = this.getAttribute('data-skill-tab');
            console.log(`[DEBUG] タブ切り替え: ${targetCategory}`);
            
            // タブコンテンツを更新
            setTimeout(() => {
                populateSkillCategory(targetCategory);
                
                // allocatedタブの場合、追加の処理
                if (targetCategory === 'allocated') {
                    const allocatedTab = document.getElementById('allocated-skills');
                    const allocatedContainer = document.getElementById('allocated-skills-container');
                    
                    // タブが完全に表示されるのを待つ
                    setTimeout(() => {
                        // 強制的にリフローを発生させる
                        allocatedTab.style.display = 'block';
                        allocatedTab.offsetHeight; // リフロー
                        
                        // 各要素の高さを再計算
                        const skillElements = allocatedContainer.querySelectorAll('.skill-item-wrapper');
                        skillElements.forEach(elem => {
                            elem.style.height = 'auto';
                            elem.style.minHeight = '50px';
                            const skillItem = elem.querySelector('.skill-item');
                            if (skillItem) {
                                skillItem.style.height = 'auto';
                                skillItem.style.minHeight = '40px';
                            }
                        });
                        
                        console.log(`[DEBUG] allocated タブ表示処理完了`);
                    }, 100); // Bootstrap のアニメーション完了待ち
                }
            }, 50); // Bootstrap のタブ切り替えアニメーション待ち
        });
    });
    
    // カテゴリ別技能配置関数
    window.populateSkillCategory = function(targetCategory) {
        console.log(`[DEBUG] カテゴリ配置: ${targetCategory}`);
        
        // 毎回最新の技能要素を取得
        const allSkillElements = document.querySelectorAll('#all-skills-container .skill-item-wrapper');
        console.log(`[DEBUG] 全技能要素数: ${allSkillElements.length}`);
        
        // targetCategoryが 'all' の場合は何もしない（常に表示）
        if (targetCategory === 'all') {
            console.log('[DEBUG] 全て表示タブ - 処理スキップ');
            return;
        }
        
        const containers = {
            all: document.getElementById('all-skills-container'),
            combat: document.getElementById('combat-skills-container'),
            search: document.getElementById('search-skills-container'),
            action: document.getElementById('action-skills-container'),
            negotiation: document.getElementById('negotiation-skills-container'),
            knowledge: document.getElementById('knowledge-skills-container'),
            allocated: document.getElementById('allocated-skills-container')
        };
        
        // コンテナが存在しない場合は処理をスキップ
        if (!containers[targetCategory]) {
            console.log(`[DEBUG] カテゴリ ${targetCategory} のコンテナが見つかりません`);
            return;
        }
        
        // 対象コンテナをクリア
        containers[targetCategory].innerHTML = '';
        
        const categoryCounts = {
            all: 0,
            combat: 0,
            search: 0,
            action: 0,
            negotiation: 0,
            knowledge: 0,
            allocated: 0
        };
        
        // 3列レイアウト用のコンテナ作成
        const createThreeColumnContainer = (containerElement) => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row';
            containerElement.appendChild(rowDiv);
            return rowDiv;
        };
        
        // 各カテゴリに3列コンテナを作成
        const categoryRows = {};
        Object.keys(containers).forEach(key => {
            if (key !== 'all' && containers[key]) {
                categoryRows[key] = createThreeColumnContainer(containers[key]);
            }
        });
        
        allSkillElements.forEach(skillElement => {
            const skillNameElement = skillElement.querySelector('.skill-title, h6, strong');
            if (!skillNameElement) return;
            
            const skillName = skillNameElement.textContent.replace(/\s*カスタム\s*/, '').trim();
            
            // カテゴリ判定（データ属性から取得 - より正確）
            const skillCategoryData = skillElement.getAttribute('data-skill-category');
            let assignedCategory = skillCategoryData || 'knowledge';  // デフォルトを知識技能に変更
            
            // data-skill-categoryがない場合のフォールバック（古い方式）
            if (!skillCategoryData) {
                for (const [category, skills] of Object.entries(skillCategories)) {
                    if (skills.some(skill => skillName === skill)) {  // 完全一致
                        assignedCategory = category;
                        break;
                    }
                }
            }
            
            // ポイント割り振り判定
            // skill-item内のinput要素を探す
            const skillItem = skillElement.querySelector('.skill-item');
            const occupationInput = skillItem ? skillItem.querySelector('.occupation-points-input') : skillElement.querySelector('.occupation-points-input');
            const interestInput = skillItem ? skillItem.querySelector('.interest-points-input') : skillElement.querySelector('.interest-points-input');
            const hasPointsAllocated = (occupationInput && parseInt(occupationInput.value) > 0) || 
                                     (interestInput && parseInt(interestInput.value) > 0);
            
            // デバッグ用ログ
            if (targetCategory === 'allocated' && skillName.includes('医学')) {
                console.log(`[DEBUG] 技能: ${skillName}`);
                console.log(`[DEBUG] skillElement:`, skillElement);
                console.log(`[DEBUG] skillElement HTML:`, skillElement.innerHTML);
                console.log(`[DEBUG] 職業input:`, occupationInput);
                console.log(`[DEBUG] 趣味input:`, interestInput);
                if (occupationInput) console.log(`[DEBUG] 職業値: ${occupationInput.value}`);
                if (interestInput) console.log(`[DEBUG] 趣味値: ${interestInput.value}`);
                console.log(`[DEBUG] ポイント割り振り判定: ${hasPointsAllocated}`);
            }
            
            // カウント更新
            categoryCounts.all++;
            categoryCounts[assignedCategory]++;
            if (hasPointsAllocated) {
                categoryCounts.allocated++;
            }
            
            // targetCategoryに該当する技能のみ配置
            if (targetCategory === assignedCategory || (targetCategory === 'allocated' && hasPointsAllocated)) {
                // 該当カテゴリの row を作成・取得
                if (!categoryRows[targetCategory]) {
                    const row = document.createElement('div');
                    row.className = 'row';
                    categoryRows[targetCategory] = row;
                    containers[targetCategory].appendChild(row);
                }
                
                const clonedElement = skillElement.cloneNode(true);
                
                // クローン要素であることを示すクラスを追加（重複カウント防止用）
                clonedElement.classList.add('skill-clone');
                
                // 入力値を保持するため、元の要素から値をコピー
                const originalInputs = skillElement.querySelectorAll('input');
                const clonedInputs = clonedElement.querySelectorAll('input');
                
                originalInputs.forEach((input, index) => {
                    if (clonedInputs[index]) {
                        clonedInputs[index].value = input.value;
                        // クローンされた入力要素にもマーカーを追加
                        clonedInputs[index].classList.add('cloned-input');
                        
                        // イベントリスナーも再設定
                        clonedInputs[index].onchange = function() {
                            // 元の要素の値も更新
                            originalInputs[index].value = this.value;
                            originalInputs[index].dispatchEvent(new Event('change', { bubbles: true }));
                            // 合計値更新
                            updateSkillTotal(this);
                            // ポイント使用量更新
                            updateSkillPointsUsage();
                        };
                    }
                });
                
                // Bootstrap のカラムクラスを追加
                clonedElement.classList.add('col-12', 'col-md-6', 'col-lg-4');
                
                // 要素のスタイルをリセット（高さ0の問題を解決）
                clonedElement.style.height = '';
                clonedElement.style.display = '';
                clonedElement.style.visibility = '';
                clonedElement.style.minHeight = '50px'; // 最小高さを設定
                
                // 内部の要素もスタイルをリセット
                const innerElements = clonedElement.querySelectorAll('*');
                innerElements.forEach(el => {
                    el.style.height = '';
                    el.style.display = '';
                    el.style.visibility = '';
                });
                
                // skill-itemクラスに最小高さを設定
                const skillItemElem = clonedElement.querySelector('.skill-item');
                if (skillItemElem) {
                    skillItemElem.style.minHeight = '40px';
                }
                
                categoryRows[targetCategory].appendChild(clonedElement);
            }
        });
        
        // タブバッジ更新
        Object.entries(categoryCounts).forEach(([category, count]) => {
            const badgeElement = document.getElementById(`${category}-count`);
            if (badgeElement) {
                badgeElement.textContent = count;
            }
        });
        
        // allocatedタブの内容を確認
        if (targetCategory === 'allocated') {
            const allocatedContainer = document.getElementById('allocated-skills-container');
            console.log(`[DEBUG] allocated-skills-container 要素数:`, allocatedContainer.children.length);
            
            // 表示されない問題のデバッグ
            if (allocatedContainer.children.length > 0) {
                const firstRow = allocatedContainer.querySelector('.row');
                if (firstRow) {
                    console.log(`[DEBUG] row要素の高さ:`, firstRow.offsetHeight);
                    console.log(`[DEBUG] row要素のスタイル:`, window.getComputedStyle(firstRow));
                    const firstSkill = firstRow.querySelector('.skill-item-wrapper');
                    if (firstSkill) {
                        console.log(`[DEBUG] skill-item-wrapper の高さ:`, firstSkill.offsetHeight);
                        console.log(`[DEBUG] skill-item-wrapper のスタイル:`, window.getComputedStyle(firstSkill));
                    }
                }
            }
        }
        
        console.log(`[DEBUG] カテゴリ配置完了:`, categoryCounts);
    };
    
    // 初期配置実行 - 全技能タブから開始
    console.log('[DEBUG] 初期化: 全技能タブを表示');
    
    // 全技能タブをアクティブに設定
    document.getElementById('all-skills-tab').classList.add('active');
    document.getElementById('allocated-skills-tab').classList.remove('active');
    document.getElementById('all-skills').classList.add('show', 'active');
    document.getElementById('allocated-skills').classList.remove('show', 'active');
    
    // 各タブのコンテンツを初期化
    setTimeout(() => {
        populateSkillCategory('combat');
        populateSkillCategory('search');
        populateSkillCategory('action');
        populateSkillCategory('negotiation');
        populateSkillCategory('knowledge');
        populateSkillCategory('allocated');
    }, 100);
}

// 技能ポイント使用量更新
function updateSkillPointsUsage() {
    console.log('[DEBUG] 技能ポイント使用量更新開始');
    
    let occupationUsed = 0;
    let interestUsed = 0;
    
    // クローンされていない要素のみをカウント（cloned-inputクラスを持たない要素）
    document.querySelectorAll('.occupation-points-input:not(.cloned-input)').forEach(input => {
        occupationUsed += parseInt(input.value) || 0;
    });
    
    document.querySelectorAll('.interest-points-input:not(.cloned-input)').forEach(input => {
        interestUsed += parseInt(input.value) || 0;
    });
    
    console.log(`[DEBUG] ポイント使用量: 職業=${occupationUsed}, 趣味=${interestUsed}`);
    
    // 総ポイント計算
    const edu = parseInt(document.getElementById('edu').value) || 0;
    const int = parseInt(document.getElementById('int').value) || 0;
    // 職業技能ポイントを再計算
    let occupationTotal = 0;
    const formulaSelect = document.getElementById('occupation-formula');
    const formula = formulaSelect ? formulaSelect.value : 'edu20';
    
    // 既存のcalculateSkillPoints関数のロジックを使用
    const str = parseInt(document.getElementById('str').value) || 0;
    const con = parseInt(document.getElementById('con').value) || 0;
    const pow = parseInt(document.getElementById('pow').value) || 0;
    const dex = parseInt(document.getElementById('dex').value) || 0;
    const app = parseInt(document.getElementById('app').value) || 0;
    
    switch(formula) {
        case 'edu20':
            occupationTotal = edu * 20;
            break;
        case 'edu10str10':
            occupationTotal = (edu * 10) + (str * 10);
            break;
        case 'edu10con10':
            occupationTotal = (edu * 10) + (con * 10);
            break;
        case 'edu10pow10':
            occupationTotal = (edu * 10) + (pow * 10);
            break;
        case 'edu10dex10':
            occupationTotal = (edu * 10) + (dex * 10);
            break;
        case 'edu10app10':
            occupationTotal = (edu * 10) + (app * 10);
            break;
        case 'edu10int10':
            occupationTotal = (edu * 10) + (int * 10);
            break;
        default:
            occupationTotal = edu * 20;
    }
    
    const interestTotal = int * 10;
    
    // 残りポイント計算
    const occupationRemaining = Math.max(0, occupationTotal - occupationUsed);
    const interestRemaining = Math.max(0, interestTotal - interestUsed);
    
    // UI更新
    const occupationUsedElement = document.getElementById('occupation-used-total');
    const interestUsedElement = document.getElementById('interest-used-total');
    
    if (occupationUsedElement) {
        occupationUsedElement.textContent = `${occupationUsed}/${occupationTotal}`;
    }
    
    if (interestUsedElement) {
        interestUsedElement.textContent = `${interestUsed}/${interestTotal}`;
    }
    
    // 残りポイント表示更新
    const occupationRemainingElement = document.getElementById('occupation-points-remaining');
    const interestRemainingElement = document.getElementById('interest-points-remaining');
    
    if (occupationRemainingElement) {
        occupationRemainingElement.textContent = occupationRemaining;
    }
    
    if (interestRemainingElement) {
        interestRemainingElement.textContent = interestRemaining;
    }
    
    // プログレスバー更新
    const occupationProgress = Math.min(100, (occupationUsed / occupationTotal) * 100);
    const interestProgress = Math.min(100, (interestUsed / interestTotal) * 100);
    
    const occupationProgressBar = document.getElementById('occupation-points-progress');
    const interestProgressBar = document.getElementById('interest-points-progress');
    
    if (occupationProgressBar) {
        occupationProgressBar.style.width = `${occupationProgress}%`;
        occupationProgressBar.setAttribute('aria-valuenow', occupationProgress);
    }
    
    if (interestProgressBar) {
        interestProgressBar.style.width = `${interestProgress}%`;
        interestProgressBar.setAttribute('aria-valuenow', interestProgress);
    }
    
    // ポイント割り振りタブの動的更新
    if (window.populateSkillCategory) {
        // 現在アクティブなタブを確認
        const activeTab = document.querySelector('.nav-link.active[data-skill-tab]');
        if (activeTab) {
            const currentCategory = activeTab.getAttribute('data-skill-tab');
            // 現在のタブを再描画（ポイント割り振り状況を反映）
            window.populateSkillCategory(currentCategory);
            
            // ポイント割り振りタブの場合は特に更新が重要
            if (currentCategory === 'allocated') {
                console.log('[DEBUG] ポイント割り振りタブの内容を更新');
            }
        }
    }
    
    console.log(`[DEBUG] ポイント使用量: 職業=${occupationUsed}/${occupationTotal}, 趣味=${interestUsed}/${interestTotal}`);
}

// プログレスバー更新
function updateProgress() {
    const sections = [
        { id: 'character_name', required: true, name: '基本情報' },
        { id: 'str', required: true, name: '能力値' },
        { id: 'hp', required: false, name: '副次ステータス' },
        { id: 'occupation-points', required: false, name: '技能ポイント' },
        { id: 'all-skills-container', required: false, name: '技能' },
        { id: 'armor_name', required: false, name: '戦闘データ' },
        { id: 'cash_amount', required: false, name: '所持品' },
        { id: 'appearance_description', required: false, name: '背景情報' }
    ];
    
    let completed = 0;
    const total = sections.length;
    
    sections.forEach((section, index) => {
        const element = document.getElementById(section.id);
        let isCompleted = false;
        
        if (element && section.required) {
            isCompleted = element.value && element.value.trim() !== '';
        } else if (element) {
            isCompleted = true; // オプションセクションは存在するだけでOK
        }
        
        if (isCompleted) completed++;
        
        // ステータスバッジの更新
        const statusBadge = document.getElementById(`${section.name.replace(/\s+/g, '-').toLowerCase()}-status`);
        if (statusBadge) {
            if (isCompleted) {
                statusBadge.textContent = '完了';
                statusBadge.className = 'badge bg-success ms-auto me-2';
            } else if (section.required) {
                statusBadge.textContent = '未完了';
                statusBadge.className = 'badge bg-danger ms-auto me-2';
            } else {
                statusBadge.textContent = '未設定';
                statusBadge.className = 'badge bg-secondary ms-auto me-2';
            }
        }
    });
    
    const percentage = Math.round((completed / total) * 100);
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    if (progressBar) {
        progressBar.style.width = percentage + '%';
        progressBar.setAttribute('aria-valuenow', percentage);
    }
    
    if (progressText) {
        progressText.textContent = `${completed}/${total}`;
    }
}

// 戦闘データ計算
function calculateCombatData() {
    const dex = parseInt(document.getElementById('dex').value) || 0;
    const siz = parseInt(document.getElementById('siz').value) || 0;
    
    // 移動率計算（簡単版）
    let movementRate = 8;
    if (dex < siz) movementRate = 7;
    if (dex > siz) movementRate = 9;
    
    const movementElement = document.getElementById('movement_rate');
    if (movementElement) {
        movementElement.value = movementRate;
    }
    
    // 戦闘ステータスの表示更新
    updateCombatStatusDisplay();
}

// 戦闘ステータス表示の更新
function updateCombatStatusDisplay() {
    // HP表示
    const hp = document.getElementById('hp')?.value || 0;
    const maxHpDisplay = document.getElementById('max_hp_display');
    if (maxHpDisplay) maxHpDisplay.value = hp;
    
    // MP表示
    const mp = document.getElementById('mp')?.value || 0;
    const maxMpDisplay = document.getElementById('max_mp_display');
    if (maxMpDisplay) maxMpDisplay.value = mp;
    
    // ダメージボーナス表示
    const damageBonus = document.getElementById('damage_bonus')?.value || '+0';
    const damageBonusDisplay = document.getElementById('damage_bonus_display');
    if (damageBonusDisplay) damageBonusDisplay.value = damageBonus;
}

// 武器追加
function addWeapon() {
    const template = document.getElementById('weapon-template');
    const container = document.getElementById('weapons-container');
    
    if (template && container) {
        const newWeapon = template.cloneNode(true);
        newWeapon.id = '';
        newWeapon.style.display = '';
        
        // ダメージボーナスを自動入力
        const damageInput = newWeapon.querySelector('[name="weapon_damage[]"]');
        if (damageInput && !damageInput.value) {
            damageInput.placeholder = 'ダメージ（+DBで自動追加）';
        }
        
        container.appendChild(newWeapon);
    }
}

// 武器削除
function removeWeapon(button) {
    const weaponItem = button.closest('.weapon-item');
    if (weaponItem && confirm('この武器を削除しますか？')) {
        weaponItem.remove();
    }
}

// 防具追加
function addArmor() {
    const template = document.getElementById('armor-template');
    const container = document.getElementById('armor-container');
    
    if (template && container) {
        const newArmor = template.cloneNode(true);
        newArmor.id = '';
        newArmor.style.display = '';
        
        // 防護点変更イベントを設定
        const armorValueInput = newArmor.querySelector('[name="armor_value[]"]');
        if (armorValueInput) {
            armorValueInput.addEventListener('change', updateTotalArmorValue);
        }
        
        container.appendChild(newArmor);
    }
}

// 防具削除
function removeArmor(button) {
    const armorItem = button.closest('.armor-item');
    if (armorItem && confirm('この防具を削除しますか？')) {
        armorItem.remove();
        updateTotalArmorValue();
    }
}

// 総防護点の更新
function updateTotalArmorValue() {
    let totalArmor = 0;
    document.querySelectorAll('[name="armor_value[]"]').forEach(input => {
        totalArmor += parseInt(input.value) || 0;
    });
    
    const totalArmorDisplay = document.getElementById('total-armor-value');
    if (totalArmorDisplay) {
        totalArmorDisplay.textContent = totalArmor;
    }
}

// プリセット武器の追加
function addPresetWeapon(weaponType) {
    const presetWeapons = {
        'pistol': { name: '拳銃（.38リボルバー）', skill: 20, damage: '1D10', range: '15m', ammo: '6' },
        'shotgun': { name: 'ショットガン', skill: 30, damage: '4D6/2D6/1D6', range: '10/20/50m', ammo: '2' },
        'rifle': { name: 'ライフル', skill: 25, damage: '2D6+4', range: '110m', ammo: '5' },
        'knife': { name: 'ナイフ', skill: 25, damage: '1D4+2+DB', range: 'タッチ', ammo: '-' },
        'club': { name: '棍棒', skill: 25, damage: '1D6+DB', range: 'タッチ', ammo: '-' }
    };
    
    const weapon = presetWeapons[weaponType];
    if (weapon) {
        addWeapon();
        const newWeaponItem = document.querySelector('#weapons-container .weapon-item:last-child');
        if (newWeaponItem) {
            newWeaponItem.querySelector('[name="weapon_name[]"]').value = weapon.name;
            newWeaponItem.querySelector('[name="weapon_skill[]"]').value = weapon.skill;
            newWeaponItem.querySelector('[name="weapon_damage[]"]').value = weapon.damage;
            newWeaponItem.querySelector('[name="weapon_range[]"]').value = weapon.range;
            newWeaponItem.querySelector('[name="weapon_ammo[]"]').value = weapon.ammo;
        }
    }
}
// 所持品管理関数
function addInventoryItem() {
    const template = document.getElementById('inventory-template');
    const container = document.getElementById('inventory-container');
    
    if (template && container) {
        const newItem = template.cloneNode(true);
        newItem.id = '';
        newItem.style.display = '';
        
        // 重量変更イベントを設定
        const weightInput = newItem.querySelector('[name="item_weight[]"]');
        if (weightInput) {
            weightInput.addEventListener('change', updateTotalWeight);
        }
        
        container.appendChild(newItem);
    }
}

// カテゴリ別アイテム追加
function addItemByCategory(category) {
    const categoryItems = {
        'tool': [
            { name: 'ロープ（10m）', weight: 2.0, notes: '丈夫な麻縄' },
            { name: '鍵開け道具', weight: 0.1, notes: 'ピックセット' },
            { name: 'ランタン', weight: 1.0, notes: '油付き' },
            { name: '医療キット', weight: 1.5, notes: '応急手当用' },
            { name: 'カメラ', weight: 0.5, notes: 'フィルム付き' }
        ],
        'book': [
            { name: 'ネクロノミコン（断片）', weight: 0.5, notes: '狂気度+1D8' },
            { name: '地図帳', weight: 1.0, notes: 'アーカム周辺' },
            { name: '研究ノート', weight: 0.3, notes: '個人的な記録' },
            { name: '辞書', weight: 1.5, notes: 'ラテン語-英語' }
        ],
        'supply': [
            { name: '食料（3日分）', weight: 1.5, notes: '保存食' },
            { name: '水筒', weight: 1.0, notes: '1リットル' },
            { name: 'マッチ', weight: 0.1, notes: '防水ケース入り' },
            { name: '包帯', weight: 0.2, notes: '清潔な布' },
            { name: '弾薬', weight: 0.5, notes: '20発' }
        ]
    };
    
    const items = categoryItems[category];
    if (items && items.length > 0) {
        const randomItem = items[Math.floor(Math.random() * items.length)];
        addInventoryItem();
        
        const newItemElement = document.querySelector('#inventory-container .inventory-item:last-child');
        if (newItemElement) {
            newItemElement.querySelector('[name="item_name[]"]').value = randomItem.name;
            newItemElement.querySelector('[name="item_category[]"]').value = category;
            newItemElement.querySelector('[name="item_weight[]"]').value = randomItem.weight;
            newItemElement.querySelector('[name="item_notes[]"]').value = randomItem.notes;
            
            updateTotalWeight();
        }
    }
}

// 所持品削除
function removeInventoryItem(button) {
    const itemElement = button.closest('.inventory-item');
    if (itemElement && confirm('このアイテムを削除しますか？')) {
        itemElement.remove();
        updateTotalWeight();
    }
}

// 総重量の更新
function updateTotalWeight() {
    let totalWeight = 0;
    
    document.querySelectorAll('[name="item_weight[]"]').forEach((input, index) => {
        const weight = parseFloat(input.value) || 0;
        const quantityInput = document.querySelectorAll('[name="item_quantity[]"]')[index];
        const quantity = parseInt(quantityInput?.value) || 1;
        
        totalWeight += weight * quantity;
    });
    
    // 総重量表示
    const totalWeightElement = document.getElementById('total-weight');
    if (totalWeightElement) {
        totalWeightElement.textContent = totalWeight.toFixed(1);
    }
    
    // 運搬能力計算と表示
    updateCarryCapacity();
    
    // 進捗バーと移動ペナルティ更新
    updateWeightProgress(totalWeight);
}

// 運搬能力の更新
function updateCarryCapacity() {
    const str = parseInt(document.getElementById('str')?.value) || 10;
    const carryCapacity = str * 3; // STR×3 kg
    
    const carryCapacityElement = document.getElementById('carry-capacity');
    if (carryCapacityElement) {
        carryCapacityElement.textContent = carryCapacity;
    }
    
    return carryCapacity;
}

// 重量進捗バーと移動ペナルティの更新
function updateWeightProgress(totalWeight) {
    const carryCapacity = updateCarryCapacity();
    const percentage = Math.min((totalWeight / carryCapacity) * 100, 200);
    
    const progressBar = document.getElementById('weight-progress');
    const percentageText = document.getElementById('weight-percentage');
    
    if (progressBar && percentageText) {
        progressBar.style.width = Math.min(percentage, 100) + '%';
        percentageText.textContent = Math.round(percentage) + '%';
        
        // 進捗バーの色を変更
        if (percentage <= 50) {
            progressBar.className = 'progress-bar bg-success';
        } else if (percentage <= 100) {
            progressBar.className = 'progress-bar bg-warning';
        } else {
            progressBar.className = 'progress-bar bg-danger';
        }
    }
    
    // 移動ペナルティの計算と表示
    const penaltyInfo = document.getElementById('movement-penalty-info');
    if (penaltyInfo) {
        let penalty = '';
        if (totalWeight <= carryCapacity) {
            penalty = '移動ペナルティ: なし';
        } else if (totalWeight <= carryCapacity * 1.5) {
            penalty = '移動ペナルティ: -10% （軽度の過重）';
        } else if (totalWeight <= carryCapacity * 2) {
            penalty = '移動ペナルティ: -20% （中度の過重）';
        } else {
            penalty = '移動ペナルティ: -30% （重度の過重）';
        }
        penaltyInfo.textContent = penalty;
    }
}

// 背景情報ランダム生成
function generateRandomBackground(type) {
    const backgroundData = {
        'appearance': {
            height: ['背が高く', '中背で', '小柄で', '長身で', '平均的な身長で'],
            build: ['痩せ型', 'がっしりした体格', '筋肉質', 'ふくよか', '細身'],
            hair: ['黒髪', '茶髪', '金髪', '赤毛', '白髪混じり', '銀髪'],
            features: ['鋭い目つき', '優しい目', '眼鏡をかけている', '口ひげを生やしている', '傷跡がある'],
            clothing: ['スーツを着崩している', 'カジュアルな服装', '研究者らしい白衣', '古風な服装', '実用的な作業着']
        },
        'personality': {
            traits: ['慎重で思慮深い', '大胆不敵', '好奇心旺盛', '冷静沈着', '情熱的'],
            habits: ['考え事をする時に眼鏡を外す', '緊張すると指を鳴らす', '独り言が多い', '几帳面にメモを取る', '時計を頻繁に確認する'],
            quirks: ['古書の匂いを嗅ぐ癖', '左利き', '方向音痴', '記憶力が異常に良い', '動物に好かれやすい'],
            fears: ['暗所恐怖症', '高所恐怖症', '狭所恐怖症', '虫が苦手', '大きな音が苦手'],
            likes: ['読書', 'クラシック音楽', '料理', '天体観測', '骨董品収集']
        },
        'history': {
            birthplace: ['ボストン郊外', 'ニューイングランドの田舎町', 'アーカム', 'ダンウィッチ近郊', 'インスマス'],
            education: ['ミスカトニック大学卒業', 'ハーバード大学中退', '独学の研究者', '軍隊での教育', '家庭教師による英才教育'],
            occupation_history: ['大学の研究員', '新聞記者', '私立探偵', '医師', '古書店経営'],
            events: ['家族の失踪事件', '戦争体験', '超常現象との遭遇', '重大な発見', '親友の死'],
            motivations: ['真実の探求', '家族の復讐', '知識への渇望', '正義感', '好奇心']
        }
    };
    
    if (type === 'appearance') {
        const height = randomChoice(backgroundData.appearance.height);
        const build = randomChoice(backgroundData.appearance.build);
        const hair = randomChoice(backgroundData.appearance.hair);
        const features = randomChoice(backgroundData.appearance.features);
        const clothing = randomChoice(backgroundData.appearance.clothing);
        
        const description = `${height}${build}の体格。${hair}で、${features}。普段は${clothing}。`;
        document.getElementById('appearance_description').value = description;
        
    } else if (type === 'personality') {
        const trait = randomChoice(backgroundData.personality.traits);
        const habit = randomChoice(backgroundData.personality.habits);
        const quirk = randomChoice(backgroundData.personality.quirks);
        
        const personality = `${trait}な性格で、${habit}癖がある。また、${quirk}という特徴がある。`;
        document.getElementById('traits_mannerisms').value = personality;
        
        const fear = randomChoice(backgroundData.personality.fears);
        const like = randomChoice(backgroundData.personality.likes);
        
        const phobia = `${fear}を持っている。趣味は${like}。`;
        document.getElementById('phobias_manias').value = phobia;
        
    } else if (type === 'history') {
        const birthplace = randomChoice(backgroundData.history.birthplace);
        const education = randomChoice(backgroundData.history.education);
        const occupation = randomChoice(backgroundData.history.occupation_history);
        
        const history = `${birthplace}で生まれ育った。${education}の後、${occupation}として働いていた。`;
        document.getElementById('personal_history').value = history;
        
        const event = randomChoice(backgroundData.history.events);
        const motivation = randomChoice(backgroundData.history.motivations);
        
        const events = `人生の転機は${event}だった。現在の行動原理は${motivation}である。`;
        document.getElementById('important_events').value = events;
    }
}

// 配列からランダムに選択
function randomChoice(array) {
    return array[Math.floor(Math.random() * array.length)];
}

// 背景情報ヘルプ表示
function showBackgroundHelp() {
    const helpText = `
背景情報作成のヘルプ

【容姿・外見】
探索者の見た目を描写します。身長、体格、髪色、
特徴的な部分、普段の服装などを記載してください。

【性格・癖】
探索者の性格や行動パターン、口癖、しぐさなどを
記載します。ロールプレイの参考になります。

【信念・思想】
探索者が大切にしている価値観、宗教観、政治的
信念などを記載します。

【重要な人物】
探索者にとって大切な人物を記載します。
家族、友人、恩師、恋人など。

【個人史】
探索者の生い立ちから現在までの経歴を記載します。
出身地、教育、職歴、重要な出来事など。

【ランダム生成】
各ボタンをクリックすると、該当する項目の
サンプルテキストが自動生成されます。
自由に編集してお使いください。
`;
    
    showHelpModal('背景情報作成のヘルプ', helpText);
}

// 成長記録管理
function addGrowthRecord() {
    const template = document.getElementById('growth-record-template');
    const container = document.getElementById('growth-records-container');
    
    if (template && container) {
        const newRecord = template.cloneNode(true);
        newRecord.id = '';
        newRecord.style.display = '';
        
        // 今日の日付を設定
        const today = new Date().toISOString().split('T')[0];
        const dateInput = newRecord.querySelector('[name="session_date[]"]');
        if (dateInput) {
            dateInput.value = today;
        }
        
        container.appendChild(newRecord);
        updateGrowthSummary();
    }
}

// 成長記録削除
function removeGrowthRecord(button) {
    const recordItem = button.closest('.growth-record-item');
    if (recordItem && confirm('この成長記録を削除しますか？')) {
        recordItem.remove();
        updateGrowthSummary();
    }
}

// 技能成長追加
function addSkillGrowth(button) {
    const container = button.closest('.growth-record-item').querySelector('.skill-growth-container');
    
    if (container) {
        const skillGrowthHtml = `
            <div class="skill-growth-item mb-2">
                <div class="input-group input-group-sm">
                    <select class="form-select form-select-sm" name="growth_skill_name[]">
                        <option value="">技能を選択</option>
                        <option value="目星">目星</option>
                        <option value="聞き耳">聞き耳</option>
                        <option value="図書館">図書館</option>
                        <option value="心理学">心理学</option>
                        <option value="応急手当">応急手当</option>
                        <option value="拳銃">拳銃</option>
                        <option value="回避">回避</option>
                        <option value="その他">その他（自由記入）</option>
                    </select>
                    <input type="number" class="form-control form-control-sm" 
                           name="growth_before[]" placeholder="成長前" min="0" max="99">
                    <span class="input-group-text">→</span>
                    <input type="number" class="form-control form-control-sm" 
                           name="growth_after[]" placeholder="成長後" min="0" max="99">
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            onclick="removeSkillGrowth(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', skillGrowthHtml);
        updateGrowthSummary();
    }
}

// 技能成長削除
function removeSkillGrowth(button) {
    const skillItem = button.closest('.skill-growth-item');
    if (skillItem) {
        skillItem.remove();
        updateGrowthSummary();
    }
}

// 成長サマリー更新
function updateGrowthSummary() {
    const records = document.querySelectorAll('.growth-record-item:not(#growth-record-template)');
    let totalSessions = records.length;
    let totalSanityChange = 0;
    let totalExperience = 0;
    let grownSkillsCount = 0;
    
    records.forEach(record => {
        const sanityGained = parseInt(record.querySelector('[name="sanity_gained[]"]')?.value) || 0;
        const sanityLost = parseInt(record.querySelector('[name="sanity_lost[]"]')?.value) || 0;
        const experience = parseInt(record.querySelector('[name="experience_gained[]"]')?.value) || 0;
        
        totalSanityChange += (sanityGained - sanityLost);
        totalExperience += experience;
        
        // 技能成長カウント
        const skillGrowths = record.querySelectorAll('.skill-growth-item');
        grownSkillsCount += skillGrowths.length;
    });
    
    // サマリー表示更新
    document.getElementById('total-sessions').textContent = totalSessions;
    
    const sanityChangeElement = document.getElementById('total-sanity-change');
    if (sanityChangeElement) {
        sanityChangeElement.textContent = (totalSanityChange >= 0 ? '+' : '') + totalSanityChange;
        sanityChangeElement.className = totalSanityChange >= 0 ? 'text-success' : 'text-danger';
    }
    
    document.getElementById('total-experience').textContent = totalExperience;
    document.getElementById('grown-skills').textContent = grownSkillsCount;
}

// カスタム技能削除
function removeCustomSkill(skillName) {
    if (confirm(`「${skillName}」を削除してもよろしいですか？`)) {
        customSkills = customSkills.filter(skill => skill.name !== skillName);
        generateSkillsList();
        updateFooterSkillPoints();
        
        // カスタム技能をローカルストレージに保存
        localStorage.setItem('coc6th_custom_skills', JSON.stringify(customSkills));
    }
}

// CSRFトークン取得
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// スキルデータ収集
function collectSkillsData() {
    const skills = [];
    
    // クローンされていない元の要素のみを収集（skill-cloneクラスを持たない要素）
    const skillItems = document.querySelectorAll('.skill-item-wrapper:not(.skill-clone) .skill-item');
    console.log(`技能項目数（オリジナルのみ）: ${skillItems.length}`);
    
    skillItems.forEach((skillItem, index) => {
        const occupationInput = skillItem.querySelector('.occupation-points-input:not(.cloned-input)');
        const interestInput = skillItem.querySelector('.interest-points-input:not(.cloned-input)');
        const baseInput = skillItem.querySelector('.skill-base');
        const skillTitle = skillItem.querySelector('.skill-title');
        
        if (occupationInput && interestInput && skillTitle) {
            const skillName = occupationInput.dataset.skill || skillTitle.textContent.replace(/\s*カスタム\s*/, '').trim();
            const occupationPoints = parseInt(occupationInput.value) || 0;
            const interestPoints = parseInt(interestInput.value) || 0;
            const baseValue = parseInt(baseInput?.value) || 0;
            
            // ポイントが割り振られているスキルのみ収集
            if (occupationPoints > 0 || interestPoints > 0) {
                const skillData = {
                    skill_name: skillName,
                    category: '特殊・その他', // デフォルトカテゴリ
                    base_value: baseValue,
                    occupation_points: occupationPoints,
                    interest_points: interestPoints
                };
                console.log(`スキル収集[${index}]: ${skillName} - 職業:${occupationPoints}, 趣味:${interestPoints}, 基本値:${baseValue}`);
                skills.push(skillData);
            }
        } else {
            console.warn(`スキル項目[${index}]で必要な要素が見つかりません`);
        }
    });
    
    console.log(`収集完了 - 総スキル数: ${skills.length}`);
    return skills;
}

// 複数画像管理用グローバル変数
let selectedImages = [];
let characterId = null;

// ドラッグ&ドロップ処理
function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropZone = document.getElementById('drop-zone');
    dropZone.classList.add('border-primary');
    dropZone.style.backgroundColor = '#e8f4f9';
}

function handleDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropZone = document.getElementById('drop-zone');
    dropZone.classList.remove('border-primary');
    dropZone.style.backgroundColor = '';
}

function handleDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    handleDragLeave(event);
    
    const files = Array.from(event.dataTransfer.files);
    const imageFiles = files.filter(file => file.type.startsWith('image/'));
    
    if (imageFiles.length === 0) {
        showNotification('画像ファイルを選択してください。', 'error');
        return;
    }
    
    processSelectedImages(imageFiles);
}

// ファイル選択処理
function handleFileSelect(input) {
    const files = Array.from(input.files);
    processSelectedImages(files);
}

// 選択された画像の処理
function processSelectedImages(files) {
    // 画像数制限チェック
    if (selectedImages.length + files.length > 10) {
        showNotification(`画像は最大10枚までです。現在${selectedImages.length}枚、追加可能: ${10 - selectedImages.length}枚`, 'error');
        return;
    }
    
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    const maxSize = 5 * 1024 * 1024; // 5MB
    
    files.forEach((file, index) => {
        // ファイル形式チェック
        if (!allowedTypes.includes(file.type)) {
            showNotification(`${file.name}: サポートされていないファイル形式です。`, 'error');
            return;
        }
        
        // ファイルサイズチェック
        if (file.size > maxSize) {
            showNotification(`${file.name}: ファイルサイズが5MBを超えています。`, 'error');
            return;
        }
        
        // 画像オブジェクトを作成
        const imageObj = {
            id: `temp_${Date.now()}_${index}`,
            file: file,
            name: file.name,
            size: file.size,
            isMain: selectedImages.length === 0, // 最初の画像をメインに設定
            order: selectedImages.length
        };
        
        selectedImages.push(imageObj);
        
        // プレビューを作成
        createImagePreview(imageObj);
    });
    
    updateImageGrid();
}

// 画像プレビューカードを作成
function createImagePreview(imageObj) {
    const reader = new FileReader();
    reader.onload = function(e) {
        imageObj.dataUrl = e.target.result;
        renderImageCard(imageObj);
    };
    reader.readAsDataURL(imageObj.file);
}

// 画像カードをレンダリング
function renderImageCard(imageObj) {
    const imageGrid = document.getElementById('image-grid');
    const placeholder = document.getElementById('no-images-placeholder');
    
    // プレースホルダーを非表示
    if (placeholder) {
        placeholder.style.display = 'none';
    }
    
    // 画像カードのHTML
    const cardHtml = `
        <div class="col-md-4 col-sm-6" id="image-card-${imageObj.id}">
            <div class="card image-card" style="height: 280px;">
                <div class="position-relative">
                    <img src="${imageObj.dataUrl}" class="card-img-top" style="height: 180px; object-fit: contain;">
                    ${imageObj.isMain ? '<span class="badge bg-primary position-absolute top-0 start-0 m-2">メイン</span>' : ''}
                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" 
                            onclick="removeImage('${imageObj.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="card-body p-2">
                    <h6 class="card-title text-truncate" style="font-size: 0.9rem;">${imageObj.name}</h6>
                    <small class="text-muted">${formatFileSize(imageObj.size)}</small>
                    <div class="mt-2">
                        ${!imageObj.isMain ? `<button type="button" class="btn btn-sm btn-outline-primary" onclick="setMainImage('${imageObj.id}')">メインに設定</button>` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    imageGrid.insertAdjacentHTML('beforeend', cardHtml);
}

// ファイルサイズをフォーマット
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 画像を削除
function removeImage(imageId) {
    const index = selectedImages.findIndex(img => img.id === imageId);
    if (index > -1) {
        const removedImage = selectedImages.splice(index, 1)[0];
        
        // メイン画像を削除した場合、次の画像をメインに設定
        if (removedImage.isMain && selectedImages.length > 0) {
            selectedImages[0].isMain = true;
        }
        
        // カードを削除
        const card = document.getElementById(`image-card-${imageId}`);
        if (card) {
            card.remove();
        }
        
        updateImageGrid();
    }
}

// メイン画像を設定
function setMainImage(imageId) {
    selectedImages.forEach(img => {
        img.isMain = img.id === imageId;
    });
    
    // 画像グリッドを再描画
    renderAllImageCards();
}

// 画像グリッドを更新
function updateImageGrid() {
    const placeholder = document.getElementById('no-images-placeholder');
    
    if (selectedImages.length === 0) {
        if (placeholder) {
            placeholder.style.display = 'block';
        }
    } else {
        if (placeholder) {
            placeholder.style.display = 'none';
        }
    }
}

// 全画像カードを再描画
function renderAllImageCards() {
    const imageGrid = document.getElementById('image-grid');
    const placeholder = document.getElementById('no-images-placeholder');
    
    // 既存のカードをクリア（プレースホルダー以外）
    Array.from(imageGrid.children).forEach(child => {
        if (child.id !== 'no-images-placeholder') {
            child.remove();
        }
    });
    
    // 全画像を再描画
    selectedImages.forEach(imageObj => {
        renderImageCard(imageObj);
    });
    
    updateImageGrid();
}

// 古い関数（後方互換性のため残す）
function previewCharacterImage(input) {
    handleFileSelect(input);
}

function removeCharacterImage() {
    if (selectedImages.length > 0) {
        removeImage(selectedImages[0].id);
    }
}

// キャラクター画像削除
function removeCharacterImage() {
    const input = document.getElementById('character_image');
    const preview = document.getElementById('image-preview');
    const placeholder = document.getElementById('image-preview-placeholder');
    const actions = document.getElementById('image-preview-actions');
    
    input.value = '';
    preview.src = '';
    preview.style.display = 'none';
    placeholder.style.display = 'flex';
    actions.style.display = 'none';
    
    // 削除フラグをマークする（hidden inputを追加）
    let deleteFlag = document.getElementById('delete_image_flag');
    if (!deleteFlag) {
        deleteFlag = document.createElement('input');
        deleteFlag.type = 'hidden';
        deleteFlag.id = 'delete_image_flag';
        deleteFlag.name = 'delete_image';
        document.getElementById('character-form-6th').appendChild(deleteFlag);
    }
    deleteFlag.value = 'true';
}

// DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // カスタム技能をローカルストレージから読み込み
    const savedCustomSkills = localStorage.getItem('coc6th_custom_skills');
    if (savedCustomSkills) {
        customSkills = JSON.parse(savedCustomSkills);
    }
    
    // 能力値変更時のイベントリスナー
    ABILITIES.forEach(ability => {
        const element = document.getElementById(ability);
        if (element) {
            element.addEventListener('input', function() {
                calculateDerivedStats();
                calculateCombatData();
                updateProgress();
            });
        }
    });
    
    // 技能リスト生成（シンプル版 - 一度だけ生成）
    generateSkillsList();
    
    // SkillFilterManager は skill_filter_simple.js で自動初期化されます
    
    // 初回のフッター更新
    updateFooterSkillPoints();
    
    // 初回のプログレス更新
    updateProgress();
    
    // 戦闘ステータスの初期表示
    updateCombatStatusDisplay();
    
    // ダイス設定の初期化
    initializeDiceSettings();
    
    // 防具の総防護点イベント設定
    document.querySelectorAll('[name="armor_value[]"]').forEach(input => {
        input.addEventListener('change', updateTotalArmorValue);
    });
    
    // 所持品の重量管理初期化
    updateTotalWeight();
    updateCarryCapacity();
    
    // 所持品の重量変更イベント設定
    document.querySelectorAll('[name="item_weight[]"], [name="item_quantity[]"]').forEach(input => {
        input.addEventListener('change', updateTotalWeight);
    });
    
    // アコーディオンイベントリスナー
    const accordionButtons = document.querySelectorAll('.accordion-button');
    accordionButtons.forEach(button => {
        button.addEventListener('click', function() {
            setTimeout(updateProgress, 100); // アコーディオン開閉後に更新
        });
    });
    
    // 入力フィールドの変更イベント
    const formInputs = document.querySelectorAll('input, textarea, select');
    formInputs.forEach(input => {
        input.addEventListener('input', function() {
            setTimeout(updateProgress, 100);
            
            // 能力値変更時に技能ポイントを再計算
            if (input.id === 'edu' || input.id === 'int') {
                setTimeout(() => {
                    calculateSkillPoints();
                    updateSkillPointsUsage();
                }, 50);
            }
            
            // DEXまたはEDU変更時に技能初期値を更新
            if (input.id === 'dex' || input.id === 'edu') {
                setTimeout(() => {
                    if (skillsGenerated) {
                        updateSkillBaseValues();
                    }
                }, 50);
            }
            
            // リアルタイムバリデーション
            if (input.hasAttribute('required') && input.value.trim()) {
                input.classList.remove('is-invalid');
                const errorDiv = input.parentElement.querySelector('.invalid-feedback');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }
        });
        
        // フォーカスアウト時のバリデーション
        if (input.hasAttribute('required')) {
            input.addEventListener('blur', () => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    let errorDiv = input.parentElement.querySelector('.invalid-feedback');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'この項目は必須です';
                        input.parentElement.appendChild(errorDiv);
                    }
                }
            });
        }
    });
    
    // 下書きデータキャッシュの初期化
    const savedDraftData = localStorage.getItem('coc6th_character_draft');
    if (savedDraftData) {
        try {
            draftDataCache = JSON.parse(savedDraftData);
            console.log('下書きデータをキャッシュに読み込み完了');
        } catch (e) {
            console.warn('下書きデータの読み込みでエラー:', e);
            draftDataCache = null;
        }
    }

    // 初期化処理（DOM準備完了後に実行）
    setTimeout(() => {
        console.log('初期化処理を開始...');
        console.log('現在のURL:', window.location.href);
        
        // URLパラメータを確認して編集モードか判定
        const urlParams = new URLSearchParams(window.location.search);
        const characterId = urlParams.get('id') || urlParams.get('character_id');
        console.log('URLパラメータ:', {
            id: urlParams.get('id'),
            character_id: urlParams.get('character_id'),
            characterId: characterId
        });
        
        if (characterId) {
            console.log('編集モードで初期化:', characterId);
            loadCharacterForEdit(characterId);
        } else {
            console.log('新規作成モードで初期化');
            
            // 新規作成時はフォームをクリア
            clearFormForNewCharacter();
            
            // 技能リスト再生成（クリア後）
            generateSkillsList();
            
            // 技能ポイント計算（少し遅延させて確実に実行）
            setTimeout(() => {
                calculateSkillPoints();
                updateSkillPointsUsage();
                // 技能フィールドを再度クリア（生成後）
                clearSkillInputsOnly();
                console.log('技能ポイント初期化完了');
            }, 100);
        }
    }, 50);
    
    // 下書きがあれば読み込み（新規作成時のみ）
    setTimeout(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const characterId = urlParams.get('id') || urlParams.get('character_id');
        
        // 新規作成時のみ下書き読み込みを確認
        if (!characterId && localStorage.getItem('coc6th_character_draft')) {
            if (confirm('保存された下書きがあります。読み込みますか？')) {
                loadDraft();
                // 下書き読み込み後に技能ポイント再計算
                setTimeout(() => {
                    calculateSkillPoints();
                    updateSkillPointsUsage();
                }, 100);
            }
        }
    }, 100);
    
    // フォーム送信処理
    document.getElementById('character-form-6th').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // 新規作成か編集かを判定
        const urlParams = new URLSearchParams(window.location.search);
        const characterId = urlParams.get('id') || urlParams.get('character_id');
        const isEditing = !!characterId;
        
        console.log('保存処理開始:', isEditing ? `編集モード (ID: ${characterId})` : '新規作成モード');
        
        // 必須フィールドのバリデーション
        const characterName = document.getElementById('character_name').value.trim();
        if (!characterName) {
            showNotification('キャラクター名は必須項目です。', 'danger');
            return;
        }
        
        // FormDataオブジェクトを作成（画像アップロード対応）
        const formData = new FormData();
        
        // 基本情報
        formData.append('edition', '6th');
        formData.append('name', characterName);
        formData.append('age', parseInt(document.getElementById('age').value) || 25);
        formData.append('gender', document.getElementById('gender').value || '');
        formData.append('occupation', document.getElementById('occupation').value || '');
        formData.append('birthplace', document.getElementById('birthplace').value || '');
        
        // 能力値（6版の値として送信）
        const abilities = {
            str: parseInt(document.getElementById('str').value) || 10,
            con: parseInt(document.getElementById('con').value) || 10,
            pow: parseInt(document.getElementById('pow').value) || 10,
            dex: parseInt(document.getElementById('dex').value) || 10,
            app: parseInt(document.getElementById('app').value) || 10,
            siz: parseInt(document.getElementById('siz').value) || 13,
            int: parseInt(document.getElementById('int').value) || 13,
            edu: parseInt(document.getElementById('edu').value) || 12
        };
        
        // 能力値の値を確認（デバッグ用）
        console.log('送信する能力値:', abilities);
        
        // FormDataに追加
        formData.append('str_value', abilities.str);
        formData.append('con_value', abilities.con);
        formData.append('pow_value', abilities.pow);
        formData.append('dex_value', abilities.dex);
        formData.append('app_value', abilities.app);
        formData.append('siz_value', abilities.siz);
        formData.append('int_value', abilities.int);
        formData.append('edu_value', abilities.edu);
        
        // 6版固有データ
        formData.append('mental_disorder', document.getElementById('mental_disorder').value || '');
        
        // 複数キャラクター画像
        if (selectedImages.length > 0) {
            selectedImages.forEach((imageObj, index) => {
                formData.append('character_images', imageObj.file);
                if (imageObj.isMain) {
                    formData.append('main_image_index', index.toString());
                }
            });
        }
        
        // 後方互換性: 単一画像も対応
        const imageInput = document.getElementById('character_image');
        if (imageInput && imageInput.files.length > 0 && selectedImages.length === 0) {
            formData.append('character_image', imageInput.files[0]);
        }
        
        // スキルデータをJSONとして追加
        const skillsData = collectSkillsData();
        console.log('収集したスキルデータ:', skillsData);
        if (skillsData && skillsData.length > 0) {
            formData.append('skills_data', JSON.stringify(skillsData));
            console.log('送信するスキルデータ数:', skillsData.length);
        } else {
            console.log('スキルデータがありません');
        }
        
        // 送信前のデータ確認（デバッグ用）
        console.log('=== 送信データの詳細 ===');
        for (let [key, value] of formData.entries()) {
            console.log(`${key}:`, value);
        }
        console.log('=== 送信データ終了 ===');
        
        // ローディング表示
        showLoadingOverlay();
        
        try {
            let response;
            if (isEditing) {
                // 編集モード: PUT リクエスト
                const apiUrl = `/api/accounts/character-sheets/${characterId}/`;
                console.log('APIエンドポイントに送信開始（編集）:', apiUrl);
                response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });
            } else {
                // 新規作成モード: POST リクエスト
                console.log('APIエンドポイントに送信開始（新規）:', '/api/accounts/character-sheets/');
                response = await fetch('/api/accounts/character-sheets/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });
            }
            
            console.log('レスポンス受信:', {
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries())
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (isEditing) {
                    showNotification('探索者の情報が正常に更新されました！', 'success');
                    // 編集後はキャラクター詳細画面に戻る
                    setTimeout(() => {
                        window.location.href = `/accounts/character/${characterId}/`;
                    }, 1000);
                } else {
                    showNotification('探索者が正常に作成されました！', 'success');
                    // 下書きをクリア
                    localStorage.removeItem('coc6th_character_draft');
                    // 新規作成後はキャラクター詳細画面にリダイレクト
                    setTimeout(() => {
                        window.location.href = `/accounts/character/${result.id}/`;
                    }, 1000);
                }
            } else {
                const errorText = await response.text();
                let error;
                try {
                    error = JSON.parse(errorText);
                } catch (e) {
                    console.error('エラーレスポンスのパース失敗:', errorText);
                    showNotification('保存に失敗しました。サーバーエラーです。', 'danger');
                    return;
                }
                console.error('保存エラー:', error);
                console.error('ステータスコード:', response.status);
                
                // 詳細なエラーメッセージを表示
                if (error.detail) {
                    showNotification(error.detail, 'danger');
                } else if (error.message) {
                    showNotification(error.message, 'danger');
                } else if (error.errors) {
                    // フィールド別エラーがある場合
                    const errorMessages = Object.entries(error.errors).map(([field, messages]) => {
                        return `${field}: ${Array.isArray(messages) ? messages.join(', ') : messages}`;
                    }).join('\n');
                    showNotification(`保存エラー:\n${errorMessages}`, 'danger');
                } else {
                    showNotification('保存に失敗しました。入力内容を確認してください。', 'danger');
                }
                
                // フィールドエラーがある場合は表示
                if (error.errors) {
                    Object.keys(error.errors).forEach(fieldName => {
                        const field = document.querySelector(`[name="${fieldName}"]`);
                        if (field) {
                            field.classList.add('is-invalid');
                            let errorDiv = field.parentElement.querySelector('.invalid-feedback');
                            if (!errorDiv) {
                                errorDiv = document.createElement('div');
                                errorDiv.className = 'invalid-feedback';
                                field.parentElement.appendChild(errorDiv);
                            }
                            errorDiv.textContent = error.errors[fieldName][0];
                        }
                    });
                }
            }
        } catch (error) {
            console.error('通信エラー:', error);
            console.error('エラーの詳細:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });
            
            // ネットワークエラーかサーバーエラーかを判別
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                showNotification('サーバーに接続できません。ネットワーク接続を確認してください。', 'danger');
            } else if (error.message) {
                showNotification(`保存エラー: ${error.message}`, 'danger');
            } else {
                showNotification('通信エラーが発生しました。もう一度お試しください。', 'danger');
            }
        } finally {
            // ローディング非表示
            hideLoadingOverlay();
        }
    });
    
    // セクションナビゲーションの設定
    setupSectionNavigation();
});

// セクションナビゲーション設定
function setupSectionNavigation() {
    const navItems = document.querySelectorAll('.section-nav-item');
    const sections = document.querySelectorAll('.section');
    
    // ナビゲーションクリックイベント
    navItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // アクティブクラスの切り替え
            navItems.forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
            
            // スムーズスクロール
            const targetId = this.getAttribute('href').substring(1);
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    
    // スクロールイベントでアクティブセクションを更新
    let scrollTimer;
    window.addEventListener('scroll', function() {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(function() {
            let currentSection = null;
            
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 150 && rect.bottom > 150) {
                    currentSection = section;
                }
            });
            
            if (currentSection) {
                const sectionId = currentSection.getAttribute('data-section-id');
                navItems.forEach(item => {
                    if (item.getAttribute('data-section') === sectionId) {
                        navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                    }
                });
            }
        }, 100);
    });
}

// ローディングオーバーレイ表示
function showLoadingOverlay() {
    const overlay = document.createElement('div');
    overlay.id = 'loading-overlay';
    overlay.className = 'loading-overlay';
    overlay.innerHTML = `
        <div class="loading-spinner"></div>
        <div class="text-white mt-3">保存中...</div>
    `;
    document.body.appendChild(overlay);
}

// ローディングオーバーレイ非表示
function hideLoadingOverlay() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.remove();
    }
}

// 編集用キャラクターデータ読み込み
async function loadCharacterForEdit(characterId) {
    try {
        console.log('キャラクターデータ読み込み開始:', characterId);
        
        const response = await fetch(`/api/accounts/character-sheets/${characterId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            const character = await response.json();
            console.log('キャラクターデータ取得成功:', character);
            
            // フォームにデータを設定
            populateFormWithCharacterData(character);
            
            // 技能リスト生成
            generateSkillsList();
            
            // 技能ポイント計算と使用状況更新
            setTimeout(() => {
                calculateSkillPoints();
                updateSkillPointsUsage();
                console.log('編集モード初期化完了');
            }, 100);
            
        } else {
            console.error('キャラクターデータ取得エラー:', response.status);
            showNotification('キャラクターデータの読み込みに失敗しました。', 'danger');
        }
        
    } catch (error) {
        console.error('キャラクター読み込みエラー:', error);
        showNotification('キャラクターデータの読み込み中にエラーが発生しました。', 'danger');
    }
}

// 新規作成時のフォームクリア
function clearFormForNewCharacter() {
    console.log('新規作成用フォームクリア開始');
    
    // 基本情報をクリア
    document.getElementById('character_name').value = '';
    document.getElementById('age').value = '';
    document.getElementById('gender').value = '';
    document.getElementById('occupation').value = '';
    document.getElementById('birthplace').value = '';
    document.getElementById('mental_disorder').value = '';
    
    // 能力値をクリア
    const abilities = ['str', 'con', 'pow', 'dex', 'app', 'siz', 'int', 'edu'];
    abilities.forEach(ability => {
        const element = document.getElementById(ability);
        if (element) {
            element.value = '';
        }
    });
    
    // 副次ステータスをクリア
    const derivedStats = ['hp', 'mp', 'san', 'idea', 'luck', 'know', 'damage_bonus'];
    derivedStats.forEach(stat => {
        const element = document.getElementById(stat);
        if (element) {
            element.value = '';
        }
    });
    
    // 現在値もクリア
    const currentValues = ['current_hp', 'current_mp', 'current_san'];
    currentValues.forEach(current => {
        const element = document.getElementById(current);
        if (element) {
            element.value = '';
        }
    });
    
    // キャラクター画像をクリア
    const imageInput = document.getElementById('character_image');
    if (imageInput) {
        imageInput.value = '';
    }
    
    // 技能関連のクリア
    clearSkillsForNewCharacter();
    
    // ページタイトルを新規作成モードに設定
    const pageTitle = document.querySelector('h1, .page-title');
    if (pageTitle) {
        pageTitle.textContent = '新規探索者作成';
    }
    
    // 保存ボタンのテキストを新規作成モードに設定
    const saveButton = document.querySelector('button[type="submit"]');
    if (saveButton) {
        saveButton.innerHTML = '<i class="fas fa-save"></i> 探索者を保存';
    }
    
    console.log('新規作成用フォームクリア完了');
}

// 技能関連のクリア
function clearSkillsForNewCharacter() {
    console.log('技能データクリア開始');
    
    // カスタム技能配列をクリア
    customSkills = [];
    console.log('カスタム技能配列をクリア:', customSkills);
    
    // LocalStorageからカスタム技能を削除
    localStorage.removeItem('coc6th_custom_skills');
    
    // 下書きキャッシュもクリア
    draftDataCache = null;
    
    // 技能データキャッシュもクリア
    window.skillDataCache = {};
    
    // 既存の技能入力フィールドをクリア
    const skillItems = document.querySelectorAll('.skill-item');
    skillItems.forEach((skillItem, index) => {
        const occupationInput = skillItem.querySelector('.occupation-points-input');
        const interestInput = skillItem.querySelector('.interest-points-input');
        const bonusInput = skillItem.querySelector('.skill-bonus');
        const totalInput = skillItem.querySelector('.skill-total');
        
        if (occupationInput) occupationInput.value = '0';
        if (interestInput) interestInput.value = '0';
        if (bonusInput) bonusInput.value = '0';
        if (totalInput) {
            // 基本値に戻す
            const baseInput = skillItem.querySelector('.skill-base');
            const baseValue = baseInput ? baseInput.value : '0';
            totalInput.value = baseValue;
        }
    });
    
    // 技能ポイント表示をリセット
    const occupationTotal = document.getElementById('occupation-points-total');
    const interestTotal = document.getElementById('interest-points-total');
    const occupationRemaining = document.getElementById('occupation-points-remaining');
    const interestRemaining = document.getElementById('interest-points-remaining');
    
    if (occupationTotal) occupationTotal.textContent = '0';
    if (interestTotal) interestTotal.textContent = '0';
    if (occupationRemaining) occupationRemaining.textContent = '0';
    if (interestRemaining) interestRemaining.textContent = '0';
    
    console.log('技能データクリア完了');
}

// 技能入力フィールドのみをクリア（技能リスト生成後用）
function clearSkillInputsOnly() {
    console.log('技能入力フィールドクリア開始');
    
    // 技能入力フィールドをすべて0にリセット
    const skillItems = document.querySelectorAll('.skill-item');
    skillItems.forEach((skillItem) => {
        const occupationInput = skillItem.querySelector('.occupation-points-input');
        const interestInput = skillItem.querySelector('.interest-points-input');
        const bonusInput = skillItem.querySelector('.skill-bonus');
        const totalInput = skillItem.querySelector('.skill-total');
        
        if (occupationInput) {
            occupationInput.value = '0';
        }
        if (interestInput) {
            interestInput.value = '0';
        }
        if (bonusInput) {
            bonusInput.value = '0';
        }
        if (totalInput) {
            // 基本値に戻す
            const baseInput = skillItem.querySelector('.skill-base');
            const baseValue = baseInput ? baseInput.value : '0';
            totalInput.value = baseValue;
        }
    });
    
    // 技能ポイント使用量表示をリセット
    const occupationUsed = document.getElementById('occupation-points-used');
    const interestUsed = document.getElementById('interest-points-used');
    const occupationRemaining = document.getElementById('occupation-points-remaining');
    const interestRemaining = document.getElementById('interest-points-remaining');
    
    if (occupationUsed) occupationUsed.textContent = '0';
    if (interestUsed) interestUsed.textContent = '0';
    if (occupationRemaining) {
        const totalOccupation = document.getElementById('occupation-points-total');
        occupationRemaining.textContent = totalOccupation ? totalOccupation.textContent : '0';
    }
    if (interestRemaining) {
        const totalInterest = document.getElementById('interest-points-total');
        interestRemaining.textContent = totalInterest ? totalInterest.textContent : '0';
    }
    
    // 副次ステータスも再クリア（新規作成時のみ）
    const urlParams = new URLSearchParams(window.location.search);
    const characterId = urlParams.get('id') || urlParams.get('character_id');
    if (!characterId) {
        const derivedStats = ['hp', 'mp', 'san', 'idea', 'luck', 'know', 'damage_bonus'];
        derivedStats.forEach(stat => {
            const element = document.getElementById(stat);
            if (element) {
                element.value = '';
            }
        });
        
        const currentValues = ['current_hp', 'current_mp', 'current_san'];
        currentValues.forEach(current => {
            const element = document.getElementById(current);
            if (element) {
                element.value = '';
            }
        });
    }
    
    console.log('技能入力フィールドクリア完了');
}

// フォームにキャラクターデータを設定
function populateFormWithCharacterData(character) {
    // 基本情報
    document.getElementById('character_name').value = character.name || '';
    document.getElementById('age').value = character.age || '';
    document.getElementById('gender').value = character.gender || '';
    document.getElementById('occupation').value = character.occupation || '';
    document.getElementById('birthplace').value = character.birthplace || '';
    
    // 能力値（6版の場合は内部値を÷5して表示）
    if (character.edition === '6th') {
        document.getElementById('str').value = Math.round((character.str_value || 50) / 5);
        document.getElementById('con').value = Math.round((character.con_value || 50) / 5);
        document.getElementById('pow').value = Math.round((character.pow_value || 50) / 5);
        document.getElementById('dex').value = Math.round((character.dex_value || 50) / 5);
        document.getElementById('app').value = Math.round((character.app_value || 50) / 5);
        document.getElementById('siz').value = Math.round((character.siz_value || 65) / 5);
        document.getElementById('int').value = Math.round((character.int_value || 65) / 5);
        document.getElementById('edu').value = Math.round((character.edu_value || 60) / 5);
    }
    
    // 6版固有データ
    if (character.sixth_edition_data) {
        document.getElementById('mental_disorder').value = character.sixth_edition_data.mental_disorder || '';
    }
    
    console.log('フォームデータ設定完了');
    
    // 画面タイトルを編集モードに変更
    const pageTitle = document.querySelector('h1, .page-title');
    if (pageTitle) {
        pageTitle.textContent = `探索者編集: ${character.name}`;
    }
    
    // 保存ボタンのテキストも変更
    const saveButton = document.querySelector('button[type="submit"]');
    if (saveButton) {
        saveButton.innerHTML = '<i class="fas fa-save"></i> 探索者を更新';
    }
}

// デバッグ用：フォームデータ確認
function debugFormData() {
    console.log('=== デバッグ: フォームデータ確認 ===');
    
    // 能力値確認
    const abilities = {
        str: parseInt(document.getElementById('str').value) || 0,
        con: parseInt(document.getElementById('con').value) || 0,
        pow: parseInt(document.getElementById('pow').value) || 0,
        dex: parseInt(document.getElementById('dex').value) || 0,
        app: parseInt(document.getElementById('app').value) || 0,
        siz: parseInt(document.getElementById('siz').value) || 0,
        int: parseInt(document.getElementById('int').value) || 0,
        edu: parseInt(document.getElementById('edu').value) || 0
    };
    console.log('能力値:', abilities);
    
    // 技能ポイント確認
    const occupationTotal = parseInt(document.getElementById('occupation-points-total').textContent) || 0;
    const interestTotal = parseInt(document.getElementById('interest-points-total').textContent) || 0;
    console.log('技能ポイント:', {occupationTotal, interestTotal});
    
    // スキルデータ確認
    const skillsData = collectSkillsData();
    console.log('収集したスキルデータ:', skillsData);
    
    // 技能項目数確認
    const skillItems = document.querySelectorAll('.skill-item');
    console.log('技能項目数:', skillItems.length);
    
    alert('デバッグ情報をコンソールに出力しました。F12で確認してください。');
}

// キャッシュデバッグ用関数
function debugSkillCache() {
    console.log('=== 技能データキャッシュの内容 ===');
    Object.keys(window.skillDataCache).forEach(skillName => {
        const data = window.skillDataCache[skillName];
        if (data.occupation !== '0' || data.interest !== '0' || data.bonus !== '0') {
            console.log(`${skillName}: 職業=${data.occupation}, 趣味=${data.interest}, ボーナス=${data.bonus}, 合計=${data.total}`);
        }
    });
    
    const nonZeroCount = Object.keys(window.skillDataCache).filter(skillName => {
        const data = window.skillDataCache[skillName];
        return data.occupation !== '0' || data.interest !== '0' || data.bonus !== '0';
    }).length;
    
    console.log(`非ゼロ技能数: ${nonZeroCount}`);
}

// この関数は削除されました - キャッシュシステムの廃止に伴い不要

// ヘルプモーダル表示
function showHelpModal(title, content) {
    // 既存のモーダルを削除
    const existingModal = document.getElementById('help-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // モーダル作成
    const modal = document.createElement('div');
    modal.id = 'help-modal';
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre style="white-space: pre-wrap; font-family: inherit;">${content}</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Bootstrapモーダル表示
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // モーダルが閉じられたらDOMから削除
    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
}

// キーボードヘルプのトグル
function toggleKeyboardHelp() {
    const panel = document.getElementById('keyboard-shortcuts-panel');
    panel.classList.toggle('show');
    
    // クリックアウトサイドで閉じる
    if (panel.classList.contains('show')) {
        document.addEventListener('click', closeKeyboardHelp);
    }
}

function closeKeyboardHelp(e) {
    const panel = document.getElementById('keyboard-shortcuts-panel');
    const button = document.querySelector('.keyboard-shortcuts-toggle');
    
    if (!panel.contains(e.target) && !button.contains(e.target)) {
        panel.classList.remove('show');
        document.removeEventListener('click', closeKeyboardHelp);
    }
}

// 自動保存インジケーター表示
function showAutoSaveIndicator() {
    const indicator = document.getElementById('auto-save-indicator');
    indicator.classList.add('show');
    
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

// キーボードショートカット設定
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl+S or Cmd+S
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            saveDraftCharacter();
            showAutoSaveIndicator();
        }
        
        // Alt+Tab でセクション移動
        if (e.altKey && e.key === 'Tab') {
            e.preventDefault();
            navigateToNextSection();
        }
    });
}

// 次のセクションへ移動
function navigateToNextSection() {
    const sections = document.querySelectorAll('.section');
    const currentSection = document.activeElement.closest('.section');
    
    if (!currentSection) {
        // 現在のセクションがない場合は最初のセクションへ
        sections[0]?.querySelector('input, select, textarea')?.focus();
        return;
    }
    
    const currentIndex = Array.from(sections).indexOf(currentSection);
    const nextIndex = (currentIndex + 1) % sections.length;
    const nextSection = sections[nextIndex];
    
    if (nextSection) {
        nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        setTimeout(() => {
            nextSection.querySelector('input, select, textarea')?.focus();
        }, 300);
    }
}

// 能力値変更時の技能初期値自動更新設定
function setupAbilityValueListeners() {
    const dexInput = document.getElementById('dex');
    const eduInput = document.getElementById('edu');
    
    if (dexInput) {
        // input、change、blur イベントで確実に更新
        ['input', 'change', 'blur'].forEach(eventType => {
            dexInput.addEventListener(eventType, function() {
                console.log(`[DEBUG] DEX値が変更されました: ${this.value}`);
                setTimeout(updateSkillBaseValues, 50);
            });
        });
        console.log('[DEBUG] DEX入力フィールドにイベントリスナーを設定');
    }
    
    if (eduInput) {
        ['input', 'change', 'blur'].forEach(eventType => {
            eduInput.addEventListener(eventType, function() {
                console.log(`[DEBUG] EDU値が変更されました: ${this.value}`);
                setTimeout(updateSkillBaseValues, 50);
            });
        });
        console.log('[DEBUG] EDU入力フィールドにイベントリスナーを設定');
    }
}

// DOMロード後に初期化
document.addEventListener('DOMContentLoaded', function() {
    setupKeyboardShortcuts();
    setupAbilityValueListeners();
    
    // 技能リスト生成後に初期値を設定
    setTimeout(() => {
        updateSkillBaseValues();
    }, 1000);
});

// デバッグ用グローバル関数
window.updateSkillBaseValues = updateSkillBaseValues;
window.skillsGenerated = function() { return skillsGenerated; };
window.testSanUpdate = function() {
    console.log('=== SAN値更新テスト ===');
    console.log('POW値:', document.getElementById('pow').value);
    console.log('戦闘データのSAN値:', document.getElementById('current_san_combat').value);
    console.log('技能リスト生成済み:', skillsGenerated);
    updateSkillBaseValues();
};

// デバッグ用のフォーム送信テスト関数
window.testFormSubmit = function() {
    console.log('=== フォーム送信テスト開始 ===');
    const form = document.getElementById('character-form-6th');
    console.log('フォーム要素:', form);
    
    if (form) {
        const requiredFields = ['name', 'age', 'str_value', 'con_value', 'pow_value', 'dex_value', 'app_value', 'siz_value', 'int_value', 'edu_value'];
        console.log('必須フィールドチェック:');
        
        requiredFields.forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            const value = field ? field.value : 'フィールドなし';
            console.log(`  ${fieldName}: ${value}`);
        });
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        console.log('CSRFトークン:', csrfToken ? '存在' : '不存在');
        
        console.log('技能データ数:', document.querySelectorAll('.skill-item-wrapper').length);
    }
    
    console.log('=== フォーム送信テスト完了 ===');
};

// サイドメニューの表示/非表示（モバイル用）
function toggleSideMenu() {
    const sideMenu = document.getElementById('side-menu');
    
    if (sideMenu) {
        if (sideMenu.classList.contains('show')) {
            sideMenu.classList.remove('show');
        } else {
            sideMenu.classList.add('show');
        }
    }
}

// サイドメニューを閉じる（モバイル用）
function closeSideMenu() {
    const sideMenu = document.getElementById('side-menu');
    
    if (sideMenu) {
        sideMenu.classList.remove('show');
    }
}

// セクションにスクロール（サイドメニュー用）
function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
        
        // 戦闘セクションの場合、戦闘ステータスを再計算
        if (sectionId === 'section-combat') {
            setTimeout(() => {
                calculateDerivedStatsIfEmpty();
            }, 500);
        }
    }
    
    // サイドメニューを閉じる
    closeSideMenu();
}

// フォーム送信前に現在値を隠しフィールドに設定
function updateHiddenFields() {
    console.log('[DEBUG] 隠しフィールド更新開始');
    
    // HP現在値
    const currentHp = document.getElementById('current_hp');
    const hpHidden = document.getElementById('hit_points_current_hidden');
    if (currentHp && hpHidden) {
        hpHidden.value = currentHp.value || document.getElementById('hp')?.value || '';
        console.log('[DEBUG] HP現在値設定:', hpHidden.value);
    }
    
    // MP現在値
    const currentMp = document.getElementById('current_mp');
    const mpHidden = document.getElementById('magic_points_current_hidden');
    if (currentMp && mpHidden) {
        mpHidden.value = currentMp.value || document.getElementById('mp')?.value || '';
        console.log('[DEBUG] MP現在値設定:', mpHidden.value);
    }
    
    // SAN現在値
    const currentSan = document.getElementById('current_san');
    const sanHidden = document.getElementById('sanity_current_hidden');
    if (currentSan && sanHidden) {
        sanHidden.value = currentSan.value || document.getElementById('san')?.value || '';
        console.log('[DEBUG] SAN現在値設定:', sanHidden.value);
    }
    
    // SAN最大値
    const sanMax = document.getElementById('san');
    const sanMaxHidden = document.getElementById('sanity_max_hidden');
    if (sanMax && sanMaxHidden) {
        sanMaxHidden.value = sanMax.value || '';
        console.log('[DEBUG] SAN最大値設定:', sanMaxHidden.value);
    }
}

// DOMContentLoaded時の初期化
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] DOMContentLoaded: キャラクター作成画面初期化開始');
    
    // フォーム送信時に隠しフィールドを更新
    const form = document.getElementById('character-form-6th');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('[DEBUG] フォーム送信処理開始');
            updateHiddenFields();
            // 念のためフォーム送信を少し遅延させて、値が確実に設定されるようにする
            e.preventDefault();
            setTimeout(() => {
                console.log('[DEBUG] フォーム送信実行');
                form.submit();
            }, 100);
        });
    }
    
    // 職業技能ポイント計算式変更時のイベントリスナー
    const occupationFormula = document.getElementById('occupation-formula');
    if (occupationFormula) {
        occupationFormula.addEventListener('change', function() {
            if (typeof calculateSkillPoints === 'function') {
                calculateSkillPoints();
            } else {
                console.error('[DEBUG] calculateSkillPoints関数が定義されていません');
            }
        });
    }
    
    // 戦闘ステータスの初期計算（空の場合のみ）
    setTimeout(() => {
        calculateDerivedStatsIfEmpty();
    }, 1000);
    
    // 追加の初期化（ページ読み込み完了後）
    setTimeout(() => {
        calculateDerivedStatsIfEmpty();
    }, 2000);
    
    // 能力値入力フィールドにイベントリスナーを追加
    const abilityFields = ['str', 'con', 'pow', 'dex', 'app', 'siz', 'int', 'edu'];
    abilityFields.forEach(ability => {
        const field = document.getElementById(ability);
        if (field) {
            field.addEventListener('input', function() {
                // 入力時に戦闘ステータスを再計算（空の場合のみ）
                setTimeout(() => {
                    calculateDerivedStatsIfEmpty();
                }, 100);
            });
        }
    });
    
    // Bootstrap 5 タブの初期化
    const skillTabsElement = document.getElementById('skillTabs');
    if (skillTabsElement) {
        const skillTabButtons = skillTabsElement.querySelectorAll('[data-bs-toggle="tab"]');
        skillTabButtons.forEach(tabButton => {
            tabButton.addEventListener('shown.bs.tab', function (event) {
                const targetContainer = event.target.getAttribute('data-bs-target');
                const skillTab = event.target.getAttribute('data-skill-tab');
                console.log(`タブ切り替え: ${targetContainer} (${skillTab})`);
                
                // タブ切り替え時にカテゴリを再配置
                if (window.populateSkillCategory && skillTab) {
                    window.populateSkillCategory(skillTab);
                }
            });
        });
        console.log('[DEBUG] 技能タブイベントリスナー設定完了');
    }
    
    console.log('[DEBUG] キャラクター作成画面初期化完了');
});
</script>

<!-- モジュラーJavaScriptの読み込み -->
<script src="{% static 'js/character_sheet_fixes.js' %}"></script>
<script src="{% static 'js/character_sheet_manager.js' %}"></script>
<script src="{% static 'js/dice_settings_debug.js' %}"></script>
<script src="{% static 'js/skill_filter_simple.js' %}"></script>

{% endblock %}

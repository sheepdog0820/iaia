{% extends 'base.html' %}
{% load static %}

{% block title %}クトゥルフ神話TRPG 第6版 探索者作成 - Arkham Nexus{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-dice-d20"></i> 
                        クトゥルフ神話TRPG 第6版 探索者作成
                    </h3>
                </div>
                
                <div class="card-body">
                    <form id="character-form-6th" method="post">
                        {% csrf_token %}
                        
                        <!-- 1. 基本情報 -->
                        <div class="section mb-4">
                            <h4 class="section-title">
                                <i class="fas fa-user"></i> 基本情報
                            </h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="character_name" class="form-label">
                                            探索者名 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="character_name" 
                                               name="character_name" maxlength="100" required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="mb-3">
                                        <label for="age" class="form-label">年齢</label>
                                        <input type="number" class="form-control" id="age" name="age">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="gender" class="form-label">性別</label>
                                        <input type="text" class="form-control" id="gender" 
                                               name="gender" maxlength="50">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="occupation" class="form-label">職業</label>
                                        <input type="text" class="form-control" id="occupation" 
                                               name="occupation" maxlength="100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="birthplace" class="form-label">出身地</label>
                                        <input type="text" class="form-control" id="birthplace" 
                                               name="birthplace" maxlength="100">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="mental_disorder" class="form-label">精神的な障害</label>
                                        <textarea class="form-control" id="mental_disorder" 
                                                  name="mental_disorder" rows="2" maxlength="500"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- キャラクター立ち絵 -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="character_image" class="form-label">
                                            <i class="fas fa-image"></i> キャラクター立ち絵
                                        </label>
                                        <input type="file" class="form-control" id="character_image" 
                                               name="character_image" accept="image/*"
                                               onchange="previewCharacterImage(this)">
                                        <div class="form-text">
                                            JPG, PNG, GIF形式に対応（最大5MB）
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">プレビュー</label>
                                        <div id="image-preview-container" class="text-center">
                                            <div id="image-preview-placeholder" class="border rounded p-4" 
                                                 style="min-height: 200px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                                <div class="text-muted">
                                                    <i class="fas fa-image fa-3x mb-2"></i>
                                                    <br>画像を選択してください
                                                </div>
                                            </div>
                                            <img id="image-preview" class="img-fluid rounded" 
                                                 style="display: none; max-height: 200px; max-width: 100%;">
                                            <div id="image-preview-actions" class="mt-2" style="display: none;">
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="removeCharacterImage()">
                                                    <i class="fas fa-trash"></i> 画像を削除
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. 能力値 -->
                        <div class="section mb-4">
                            <h4 class="section-title">
                                <i class="fas fa-chart-bar"></i> 能力値
                            </h4>
                            
                            <!-- ダイス設定ボタン -->
                            <div class="mb-3">
                                <button type="button" class="btn btn-primary" onclick="toggleDiceSettings()">
                                    <i class="fas fa-dice"></i> ダイス設定
                                </button>
                                <button type="button" class="btn btn-success" onclick="rollAllAbilities()">
                                    <i class="fas fa-dice-d6"></i> すべてロール
                                </button>
                            </div>
                            
                            <!-- ダイス設定エリア（初期非表示） -->
                            <div id="dice-settings" class="dice-settings mb-3" style="display: none;">
                                <div class="card border-secondary">
                                    <div class="card-header bg-secondary text-white">
                                        <h5 class="mb-0">ダイス設定（カスタマイズ）</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="dice-preset" class="form-label">プリセット選択</label>
                                            <select class="form-select" id="dice-preset" onchange="loadDicePreset()">
                                                <option value="standard">標準6版設定</option>
                                                <option value="high">高能力値設定</option>
                                                <option value="custom">カスタム設定</option>
                                            </select>
                                        </div>
                                        
                                        <div class="row" id="custom-dice-settings">
                                            <!-- 各能力値のダイス設定 -->
                                            <div class="col-md-3 mb-3">
                                                <h6>STR (筋力)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-str-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-str-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-str-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <h6>CON (体力)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-con-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-con-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-con-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <h6>POW (意志力)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-pow-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-pow-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-pow-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <h6>DEX (敏捷性)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-dex-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-dex-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-dex-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <h6>APP (外見)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-app-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-app-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-app-bonus" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <h6>SIZ (体格)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-siz-count" value="2" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-siz-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-siz-bonus" value="6">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <h6>INT (知性)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-int-count" value="2" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-int-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-int-bonus" value="6">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <h6>EDU (教育)</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control" id="dice-edu-count" value="3" min="1">
                                                    <span class="input-group-text">D</span>
                                                    <input type="number" class="form-control" id="dice-edu-sides" value="6" min="2">
                                                    <span class="input-group-text">+</span>
                                                    <input type="number" class="form-control" id="dice-edu-bonus" value="3">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="saveCustomDiceSettings()">
                                                <i class="fas fa-save"></i> カスタム設定を保存
                                            </button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="loadCustomDiceSettings()">
                                                <i class="fas fa-folder-open"></i> カスタム設定を読み込み
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 能力値入力エリア -->
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="str" class="form-label">STR (筋力)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="str" name="str">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('str')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="con" class="form-label">CON (体力)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="con" name="con">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('con')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="pow" class="form-label">POW (意志力)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="pow" name="pow">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('pow')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="dex" class="form-label">DEX (敏捷性)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="dex" name="dex">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('dex')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="app" class="form-label">APP (外見)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="app" name="app">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('app')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="siz" class="form-label">SIZ (体格)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="siz" name="siz">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('siz')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="int" class="form-label">INT (知性)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="int" name="int">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('int')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="edu" class="form-label">EDU (教育)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control ability-input" id="edu" name="edu">
                                        <button type="button" class="btn btn-outline-secondary" onclick="rollSingleAbility('edu')">
                                            <i class="fas fa-dice"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. 副次的ステータス -->
                        <div class="section mb-4">
                            <h4 class="section-title">
                                <i class="fas fa-calculator"></i> 副次的ステータス
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label for="hp" class="form-label">HP</label>
                                    <input type="number" class="form-control bg-light" id="hp" name="hp" readonly>
                                    <small class="text-muted">(CON+SIZ)÷2</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="mp" class="form-label">MP</label>
                                    <input type="number" class="form-control bg-light" id="mp" name="mp" readonly>
                                    <small class="text-muted">POW</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="san" class="form-label">SAN</label>
                                    <input type="number" class="form-control bg-light" id="san" name="san" readonly>
                                    <small class="text-muted">POW×5</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="idea" class="form-label">アイデア</label>
                                    <input type="number" class="form-control bg-light" id="idea" name="idea" readonly>
                                    <small class="text-muted">INT×5</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="luck" class="form-label">幸運</label>
                                    <input type="number" class="form-control bg-light" id="luck" name="luck" readonly>
                                    <small class="text-muted">POW×5</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="know" class="form-label">知識</label>
                                    <input type="number" class="form-control bg-light" id="know" name="know" readonly>
                                    <small class="text-muted">EDU×5</small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="damage_bonus" class="form-label">ダメージボーナス</label>
                                    <input type="text" class="form-control bg-light" id="damage_bonus" name="damage_bonus" readonly>
                                    <small class="text-muted">STR+SIZから算出</small>
                                </div>
                            </div>
                        </div>

                        <!-- 4. 技能ポイント -->
                        <div class="section mb-4">
                            <h4 class="section-title">
                                <i class="fas fa-graduation-cap"></i> 技能ポイント
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            職業技能ポイント
                                        </div>
                                        <div class="card-body">
                                            <p>EDU×20 = <span id="occupation-points">0</span>点</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            趣味技能ポイント
                                        </div>
                                        <div class="card-body">
                                            <p>INT×10 = <span id="interest-points">0</span>点</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 5. 技能 -->
                        <div class="section mb-4">
                            <h4 class="section-title">
                                <i class="fas fa-cogs"></i> 技能
                            </h4>
                            
                            <!-- 技能タブ -->
                            <ul class="nav nav-tabs mb-3" id="skillTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="all-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#all-skills" type="button" role="tab" 
                                            aria-controls="all-skills" aria-selected="true">
                                        全て
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="combat-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#combat-skills" type="button" role="tab"
                                            aria-controls="combat-skills" aria-selected="false">
                                        戦闘技能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="search-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#search-skills" type="button" role="tab"
                                            aria-controls="search-skills" aria-selected="false">
                                        探索技能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="action-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#action-skills" type="button" role="tab"
                                            aria-controls="action-skills" aria-selected="false">
                                        行動技能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="negotiation-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#negotiation-skills" type="button" role="tab"
                                            aria-controls="negotiation-skills" aria-selected="false">
                                        交渉技能
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="knowledge-skills-tab" data-bs-toggle="tab" 
                                            data-bs-target="#knowledge-skills" type="button" role="tab"
                                            aria-controls="knowledge-skills" aria-selected="false">
                                        知識技能
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- 技能タブコンテンツ -->
                            <div class="tab-content" id="skillTabContent">
                                <div class="tab-pane fade show active" id="all-skills" role="tabpanel" aria-labelledby="all-skills-tab">
                                    <div id="all-skills-container">
                                        <!-- 全技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="combat-skills" role="tabpanel" aria-labelledby="combat-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>戦闘技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('combat')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="combat-skills-container">
                                        <!-- 戦闘技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="search-skills" role="tabpanel" aria-labelledby="search-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>探索技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('search')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="search-skills-container">
                                        <!-- 探索技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="action-skills" role="tabpanel" aria-labelledby="action-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>行動技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('action')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="action-skills-container">
                                        <!-- 行動技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="negotiation-skills" role="tabpanel" aria-labelledby="negotiation-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>交渉技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('negotiation')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="negotiation-skills-container">
                                        <!-- 交渉技能が表示される -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="knowledge-skills" role="tabpanel" aria-labelledby="knowledge-skills-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>知識技能</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="addCustomSkill('knowledge')">
                                            <i class="fas fa-plus"></i> 技能追加
                                        </button>
                                    </div>
                                    <div id="knowledge-skills-container">
                                        <!-- 知識技能が表示される -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- フォーム送信ボタンはフッターに移動 -->
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- フッター（固定表示） -->
<div class="fixed-bottom bg-white border-top shadow-sm" id="skills-footer">
    <div class="container-fluid">
        <div class="row align-items-center py-2">
            <div class="col-md-8">
                <div class="d-flex justify-content-start gap-4">
                    <div class="skill-points-display">
                        <span class="fw-bold text-primary">職業技能:</span>
                        <span id="occupation-used-total" class="badge bg-primary">0/0</span>
                    </div>
                    <div class="skill-points-display">
                        <span class="fw-bold text-success">趣味技能:</span>
                        <span id="interest-used-total" class="badge bg-success">0/0</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="saveDraft()">
                    <i class="fas fa-file-alt"></i> 下書き保存
                </button>
                <button type="submit" class="btn btn-primary btn-sm" form="character-form-6th">
                    <i class="fas fa-save"></i> 探索者を保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- メインコンテンツにパディングを追加（フッター分） -->
<style>
body {
    padding-bottom: 70px;
}
</style>
{% endblock %}

{% block extra_css %}
<style>
body {
    background-color: #f5f5f5;
}

.section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.section-title {
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.ability-input {
    font-size: 1.2em;
    font-weight: bold;
    text-align: center;
}

.dice-settings {
    transition: all 0.3s ease;
}

.skill-item {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
}

.skill-item:hover {
    background-color: #f8f9fa;
}

.form-label {
    font-weight: 600;
}

.text-danger {
    font-weight: bold;
}

/* 技能入力欄のスタイル */
.skill-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    background-color: #f8f9fa;
}

.skill-title {
    color: #495057;
    margin-bottom: 10px;
    font-size: 0.9rem;
    font-weight: 600;
}

.form-label-sm {
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 2px;
}

.skill-total {
    background-color: #e3f2fd !important;
    border-color: #2196f3 !important;
    font-weight: bold;
}

/* フッター */
#skills-footer {
    z-index: 1030;
}

.skill-points-display {
    font-size: 0.9rem;
}

/* レスポンシブデザイン */
/* タブレット (768px - 991px) */
@media (max-width: 991px) {
    .container-fluid {
        padding: 10px;
    }
    
    .section {
        padding: 15px;
    }
    
    .ability-input {
        font-size: 1em;
    }
    
    /* ダイス設定を1列表示に */
    #custom-dice-settings .col-md-3 {
        margin-bottom: 15px;
    }
    
    /* 技能入力欄の調整 */
    .skill-item {
        padding: 10px;
    }
    
    .skill-title {
        font-size: 0.85rem;
    }
}

/* モバイル (767px以下) */
@media (max-width: 767px) {
    /* コンテナの調整 */
    .container-fluid {
        padding: 5px;
    }
    
    .card {
        border-radius: 0;
        box-shadow: none;
    }
    
    .card-header {
        padding: 10px;
    }
    
    .card-header h3 {
        font-size: 1.2rem;
    }
    
    .card-body {
        padding: 10px;
    }
    
    /* セクションの調整 */
    .section {
        padding: 10px;
        margin-bottom: 15px;
    }
    
    .section-title {
        font-size: 1.1rem;
        margin-bottom: 15px;
    }
    
    /* 基本情報の調整 */
    .col-md-6, .col-md-2, .col-md-4 {
        margin-bottom: 10px;
    }
    
    /* 能力値入力の調整 */
    .ability-input {
        font-size: 0.9em;
        padding: 5px;
    }
    
    .input-group .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    /* ダイス設定の調整 */
    #dice-settings .card {
        margin-bottom: 10px;
    }
    
    #dice-settings h6 {
        font-size: 0.9rem;
    }
    
    .input-group-sm .form-control {
        font-size: 0.75rem;
        padding: 0.25rem 0.3rem;
    }
    
    /* 副次ステータスの調整 */
    .col-md-2 {
        margin-bottom: 15px;
    }
    
    /* 技能リストの調整 */
    .skill-item {
        padding: 8px;
        margin-bottom: 10px;
    }
    
    .skill-title {
        font-size: 0.8rem;
        margin-bottom: 8px;
    }
    
    .form-label-sm {
        font-size: 0.7rem;
    }
    
    .form-control-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.3rem;
    }
    
    /* フッターの調整 */
    #skills-footer .row {
        flex-direction: column;
        gap: 10px;
    }
    
    #skills-footer .col-md-8,
    #skills-footer .col-md-4 {
        text-align: center;
    }
    
    .skill-points-display {
        justify-content: center;
    }
    
    /* ボタンの調整 */
    .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        margin-bottom: 5px;
        width: 100%;
    }
    
    .btn-lg {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    
    /* フォーム送信ボタンを縦並びに */
    .mt-4 {
        text-align: center;
    }
    
    .mt-4 .btn {
        display: block;
        margin: 0 auto 10px;
        max-width: 300px;
    }
}

/* 超小型デバイス (375px以下) */
@media (max-width: 375px) {
    /* さらなる調整 */
    .card-header h3 {
        font-size: 1rem;
    }
    
    .section-title {
        font-size: 1rem;
    }
    
    .form-label {
        font-size: 0.85rem;
    }
    
    .ability-input {
        font-size: 0.8em;
    }
    
    /* 技能カテゴリタイトル */
    h5 {
        font-size: 1rem;
    }
}

/* 横向きモバイル対応 */
@media (max-width: 767px) and (orientation: landscape) {
    /* 能力値を2列表示に */
    .col-md-3.mb-3 {
        width: 50%;
        float: left;
        padding: 0 5px;
    }
    
    /* 副次ステータスも2列表示に */
    .col-md-2.mb-3 {
        width: 50%;
        float: left;
        padding: 0 5px;
    }
}

/* タッチデバイス用の調整 */
@media (hover: none) and (pointer: coarse) {
    /* タップターゲットのサイズを確保 */
    .btn {
        min-height: 44px;
        min-width: 44px;
    }
    
    .form-control, .form-select {
        min-height: 44px;
    }
    
    /* ホバー効果を無効化 */
    .skill-item:hover {
        background-color: transparent;
    }
}

/* プリント対応 */
@media print {
    .btn {
        display: none;
    }
    
    .dice-settings {
        display: none !important;
    }
    
    .section {
        page-break-inside: avoid;
        box-shadow: none;
        border: 1px solid #dee2e6;
    }
    
    body {
        background-color: white;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// グローバル定数
const ABILITIES = ['str', 'con', 'pow', 'dex', 'app', 'siz', 'int', 'edu'];

// ダイス設定の初期値（標準6版）
const DEFAULT_DICE_SETTINGS = {
    str: { count: 3, sides: 6, bonus: 0 },
    con: { count: 3, sides: 6, bonus: 0 },
    pow: { count: 3, sides: 6, bonus: 0 },
    dex: { count: 3, sides: 6, bonus: 0 },
    app: { count: 3, sides: 6, bonus: 0 },
    siz: { count: 2, sides: 6, bonus: 6 },
    int: { count: 2, sides: 6, bonus: 6 },
    edu: { count: 3, sides: 6, bonus: 3 }
};

// 高能力値設定
const HIGH_DICE_SETTINGS = {
    str: { count: 4, sides: 6, bonus: -3 },
    con: { count: 4, sides: 6, bonus: -3 },
    pow: { count: 4, sides: 6, bonus: -3 },
    dex: { count: 4, sides: 6, bonus: -3 },
    app: { count: 4, sides: 6, bonus: -3 },
    siz: { count: 3, sides: 6, bonus: 3 },
    int: { count: 3, sides: 6, bonus: 3 },
    edu: { count: 4, sides: 6, bonus: 0 }
};

// 現在のダイス設定
let currentDiceSettings = { ...DEFAULT_DICE_SETTINGS };

// カスタム技能データ
let customSkills = [];

// ダイス設定の表示切替
function toggleDiceSettings() {
    const settingsDiv = document.getElementById('dice-settings');
    if (settingsDiv.style.display === 'none') {
        settingsDiv.style.display = 'block';
    } else {
        settingsDiv.style.display = 'none';
    }
}

// プリセット読み込み
function loadDicePreset() {
    const preset = document.getElementById('dice-preset').value;
    
    if (preset === 'standard') {
        currentDiceSettings = { ...DEFAULT_DICE_SETTINGS };
    } else if (preset === 'high') {
        currentDiceSettings = { ...HIGH_DICE_SETTINGS };
    }
    // customの場合は現在の設定を維持
    
    // UIに反映
    if (preset !== 'custom') {
        ABILITIES.forEach(ability => {
            const settings = currentDiceSettings[ability];
            document.getElementById(`dice-${ability}-count`).value = settings.count;
            document.getElementById(`dice-${ability}-sides`).value = settings.sides;
            document.getElementById(`dice-${ability}-bonus`).value = settings.bonus;
        });
    }
}

// カスタムダイス設定を保存
function saveCustomDiceSettings() {
    const customSettings = {};
    ABILITIES.forEach(ability => {
        customSettings[ability] = {
            count: parseInt(document.getElementById(`dice-${ability}-count`).value),
            sides: parseInt(document.getElementById(`dice-${ability}-sides`).value),
            bonus: parseInt(document.getElementById(`dice-${ability}-bonus`).value)
        };
    });
    
    localStorage.setItem('coc6th_custom_dice_settings', JSON.stringify(customSettings));
    alert('カスタム設定を保存しました');
}

// カスタムダイス設定を読み込み
function loadCustomDiceSettings() {
    const savedSettings = localStorage.getItem('coc6th_custom_dice_settings');
    if (savedSettings) {
        currentDiceSettings = JSON.parse(savedSettings);
        ABILITIES.forEach(ability => {
            const settings = currentDiceSettings[ability];
            document.getElementById(`dice-${ability}-count`).value = settings.count;
            document.getElementById(`dice-${ability}-sides`).value = settings.sides;
            document.getElementById(`dice-${ability}-bonus`).value = settings.bonus;
        });
        document.getElementById('dice-preset').value = 'custom';
        alert('カスタム設定を読み込みました');
    } else {
        alert('保存されたカスタム設定がありません');
    }
}

// ダイスロール関数
function rollDice(count, sides, bonus) {
    let total = bonus;
    for (let i = 0; i < count; i++) {
        total += Math.floor(Math.random() * sides) + 1;
    }
    return total;
}

// 単一能力値のロール
function rollSingleAbility(ability) {
    // 現在のUI設定を読み取り
    const count = parseInt(document.getElementById(`dice-${ability}-count`).value);
    const sides = parseInt(document.getElementById(`dice-${ability}-sides`).value);
    const bonus = parseInt(document.getElementById(`dice-${ability}-bonus`).value);
    
    const result = rollDice(count, sides, bonus);
    document.getElementById(ability).value = result;
    
    // 副次ステータスを再計算
    calculateDerivedStats();
}

// すべての能力値をロール
function rollAllAbilities() {
    ABILITIES.forEach(ability => {
        rollSingleAbility(ability);
    });
}

// 副次ステータスの計算
function calculateDerivedStats() {
    const str = parseInt(document.getElementById('str').value) || 0;
    const con = parseInt(document.getElementById('con').value) || 0;
    const pow = parseInt(document.getElementById('pow').value) || 0;
    const dex = parseInt(document.getElementById('dex').value) || 0;
    const siz = parseInt(document.getElementById('siz').value) || 0;
    const int = parseInt(document.getElementById('int').value) || 0;
    const edu = parseInt(document.getElementById('edu').value) || 0;
    
    // HP計算
    document.getElementById('hp').value = Math.ceil((con + siz) / 2);
    
    // MP計算
    document.getElementById('mp').value = pow;
    
    // SAN計算
    document.getElementById('san').value = pow * 5;
    
    // アイデアロール
    document.getElementById('idea').value = int * 5;
    
    // 幸運ロール
    document.getElementById('luck').value = pow * 5;
    
    // 知識ロール
    document.getElementById('know').value = edu * 5;
    
    // ダメージボーナス計算
    const total = str + siz;
    let damageBonus = '';
    
    if (total <= 12) damageBonus = '-1D6';
    else if (total <= 16) damageBonus = '-1D4';
    else if (total <= 24) damageBonus = '+0';
    else if (total <= 32) damageBonus = '+1D4';
    else if (total <= 40) damageBonus = '+1D6';
    else if (total <= 56) damageBonus = '+2D6';
    else if (total <= 72) damageBonus = '+3D6';
    else if (total <= 88) damageBonus = '+4D6';
    else damageBonus = '+5D6';
    
    document.getElementById('damage_bonus').value = damageBonus;
    
    // 技能ポイント計算
    calculateSkillPoints();
}

// 技能ポイント計算
function calculateSkillPoints() {
    const edu = parseInt(document.getElementById('edu').value) || 0;
    const int = parseInt(document.getElementById('int').value) || 0;
    
    document.getElementById('occupation-points').textContent = edu * 20;
    document.getElementById('interest-points').textContent = int * 10;
}

// 基本技能データ
function getBaseSkills() {
    return [
        // 戦闘技能
        { name: '回避', base: 'DEX×2', category: 'combat', isCustom: false },
        { name: 'キック', base: 25, category: 'combat', isCustom: false },
        { name: '組み付き', base: 25, category: 'combat', isCustom: false },
        { name: 'こぶし（パンチ）', base: 50, category: 'combat', isCustom: false },
        { name: '頭突き', base: 10, category: 'combat', isCustom: false },
        { name: '投擲', base: 25, category: 'combat', isCustom: false },
        { name: 'マーシャルアーツ', base: 1, category: 'combat', isCustom: false },
        { name: '拳銃', base: 20, category: 'combat', isCustom: false },
        { name: 'サブマシンガン', base: 15, category: 'combat', isCustom: false },
        { name: 'ショットガン', base: 30, category: 'combat', isCustom: false },
        { name: 'マシンガン', base: 15, category: 'combat', isCustom: false },
        { name: 'ライフル', base: 25, category: 'combat', isCustom: false },
        
        // 探索技能
        { name: '応急手当', base: 30, category: 'search', isCustom: false },
        { name: '鍵開け', base: 1, category: 'search', isCustom: false },
        { name: '隠す', base: 15, category: 'search', isCustom: false },
        { name: '隠れる', base: 10, category: 'search', isCustom: false },
        { name: '聞き耳', base: 25, category: 'search', isCustom: false },
        { name: '忍び歩き', base: 10, category: 'search', isCustom: false },
        { name: '写真術', base: 10, category: 'search', isCustom: false },
        { name: '精神分析', base: 1, category: 'search', isCustom: false },
        { name: '追跡', base: 10, category: 'search', isCustom: false },
        { name: '登攀', base: 40, category: 'search', isCustom: false },
        { name: '図書館', base: 25, category: 'search', isCustom: false },
        { name: '目星', base: 25, category: 'search', isCustom: false },
        
        // 行動技能
        { name: '運転（自動車）', base: 20, category: 'action', isCustom: false },
        { name: '運転（その他）', base: 1, category: 'action', isCustom: false },
        { name: '機械修理', base: 20, category: 'action', isCustom: false },
        { name: '重機械操作', base: 1, category: 'action', isCustom: false },
        { name: '乗馬', base: 5, category: 'action', isCustom: false },
        { name: '水泳', base: 25, category: 'action', isCustom: false },
        { name: '跳躍', base: 25, category: 'action', isCustom: false },
        { name: '電気修理', base: 10, category: 'action', isCustom: false },
        { name: 'ナビゲート', base: 10, category: 'action', isCustom: false },
        { name: '変装', base: 1, category: 'action', isCustom: false },
        
        // 交渉技能
        { name: '言いくるめ', base: 5, category: 'negotiation', isCustom: false },
        { name: '信用', base: 15, category: 'negotiation', isCustom: false },
        { name: '説得', base: 15, category: 'negotiation', isCustom: false },
        { name: '値切り', base: 5, category: 'negotiation', isCustom: false },
        { name: '母国語', base: 'EDU×5', category: 'negotiation', isCustom: false },
        
        // 知識技能
        { name: '医学', base: 5, category: 'knowledge', isCustom: false },
        { name: 'オカルト', base: 5, category: 'knowledge', isCustom: false },
        { name: '化学', base: 1, category: 'knowledge', isCustom: false },
        { name: 'クトゥルフ神話', base: 0, category: 'knowledge', isCustom: false },
        { name: '芸術', base: 5, category: 'knowledge', isCustom: false },
        { name: '経理', base: 10, category: 'knowledge', isCustom: false },
        { name: '考古学', base: 1, category: 'knowledge', isCustom: false },
        { name: 'コンピューター', base: 1, category: 'knowledge', isCustom: false },
        { name: '心理学', base: 5, category: 'knowledge', isCustom: false },
        { name: '人類学', base: 1, category: 'knowledge', isCustom: false },
        { name: '生物学', base: 1, category: 'knowledge', isCustom: false },
        { name: '地質学', base: 1, category: 'knowledge', isCustom: false },
        { name: '電子工学', base: 1, category: 'knowledge', isCustom: false },
        { name: '天文学', base: 1, category: 'knowledge', isCustom: false },
        { name: '博物学', base: 10, category: 'knowledge', isCustom: false },
        { name: '物理学', base: 1, category: 'knowledge', isCustom: false },
        { name: '法律', base: 5, category: 'knowledge', isCustom: false },
        { name: '薬学', base: 1, category: 'knowledge', isCustom: false },
        { name: '歴史', base: 20, category: 'knowledge', isCustom: false },
        { name: '他の言語', base: 1, category: 'knowledge', isCustom: false }
    ];
}

// 全技能取得（基本技能 + カスタム技能）
function getAllSkills() {
    return [...getBaseSkills(), ...customSkills];
}

// 技能リスト生成
function generateSkillsList() {
    const allSkills = getAllSkills();
    
    // 全てタブ
    generateSkillCategory('all-skills-container', allSkills, false);
    
    // カテゴリー別タブ
    generateSkillCategory('combat-skills-container', allSkills.filter(s => s.category === 'combat'), true);
    generateSkillCategory('search-skills-container', allSkills.filter(s => s.category === 'search'), true);
    generateSkillCategory('action-skills-container', allSkills.filter(s => s.category === 'action'), true);
    generateSkillCategory('negotiation-skills-container', allSkills.filter(s => s.category === 'negotiation'), true);
    generateSkillCategory('knowledge-skills-container', allSkills.filter(s => s.category === 'knowledge'), true);
}

// カテゴリー別技能生成
function generateSkillCategory(containerId, skills, showDeleteButton = false) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    let html = '<div class="row">';
    
    skills.forEach(skill => {
        let baseValue = skill.base;
        if (skill.base === 'DEX×2') {
            baseValue = (parseInt(document.getElementById('dex').value) || 0) * 2;
        } else if (skill.base === 'EDU×5') {
            baseValue = (parseInt(document.getElementById('edu').value) || 0) * 5;
        }
        
        const skillId = skill.name.replace(/[^a-zA-Z0-9]/g, '_');
        const deleteButton = (skill.isCustom && showDeleteButton) ? 
            `<button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                     onclick="removeCustomSkill('${skill.name}')" title="削除">
                 <i class="fas fa-trash"></i>
             </button>` : '';
        
        html += `
            <div class="col-12 col-md-6 col-lg-4" data-skill-item="${skill.name}">
                <div class="skill-item mb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <h6 class="skill-title">${skill.name}${skill.isCustom ? ' <span class="badge bg-secondary">カスタム</span>' : ''}</h6>
                        ${deleteButton}
                    </div>
                    <div class="row g-1">
                        <div class="col-3">
                            <label class="form-label form-label-sm">初期値</label>
                            <input type="number" class="form-control form-control-sm skill-base" 
                                   name="skill_${skillId}_base" 
                                   min="0" max="90" value="${baseValue}"
                                   data-skill="${skill.name}">
                        </div>
                        <div class="col-3">
                            <label class="form-label form-label-sm">職業</label>
                            <input type="number" class="form-control form-control-sm skill-occupation" 
                                   name="skill_${skillId}_occupation" 
                                   min="0" max="90" value="0"
                                   data-skill="${skill.name}">
                        </div>
                        <div class="col-3">
                            <label class="form-label form-label-sm">趣味</label>
                            <input type="number" class="form-control form-control-sm skill-interest" 
                                   name="skill_${skillId}_interest" 
                                   min="0" max="90" value="0"
                                   data-skill="${skill.name}">
                        </div>
                        <div class="col-3">
                            <label class="form-label form-label-sm">ボーナス</label>
                            <input type="number" class="form-control form-control-sm skill-bonus" 
                                   name="skill_${skillId}_bonus" 
                                   min="0" max="50" value="0"
                                   data-skill="${skill.name}">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <label class="form-label form-label-sm fw-bold">合計</label>
                            <input type="number" class="form-control form-control-sm bg-light skill-total" 
                                   name="skill_${skillId}_total" 
                                   readonly value="${baseValue}"
                                   data-skill="${skill.name}">
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // 技能の入力欄にイベントリスナーを追加
    skills.forEach(skill => {
        updateSkillTotal(skill.name);
        addSkillEventListeners(skill.name);
    });
}

// 技能合計計算
function updateSkillTotal(skillName) {
    const skillId = skillName.replace(/[^a-zA-Z0-9]/g, '_');
    const baseInput = document.querySelector(`input[name="skill_${skillId}_base"]`);
    const occupationInput = document.querySelector(`input[name="skill_${skillId}_occupation"]`);
    const interestInput = document.querySelector(`input[name="skill_${skillId}_interest"]`);
    const bonusInput = document.querySelector(`input[name="skill_${skillId}_bonus"]`);
    const totalInput = document.querySelector(`input[name="skill_${skillId}_total"]`);
    
    if (!baseInput || !occupationInput || !interestInput || !bonusInput || !totalInput) return;
    
    const base = parseInt(baseInput.value) || 0;
    const occupation = parseInt(occupationInput.value) || 0;
    const interest = parseInt(interestInput.value) || 0;
    const bonus = parseInt(bonusInput.value) || 0;
    
    const total = Math.min(base + occupation + interest + bonus, 90);
    totalInput.value = total;
    
    // フッターの更新
    updateFooterSkillPoints();
}

// 技能入力欄のイベントリスナー追加
function addSkillEventListeners(skillName) {
    const skillId = skillName.replace(/[^a-zA-Z0-9]/g, '_');
    const inputs = [
        document.querySelector(`input[name="skill_${skillId}_base"]`),
        document.querySelector(`input[name="skill_${skillId}_occupation"]`),
        document.querySelector(`input[name="skill_${skillId}_interest"]`),
        document.querySelector(`input[name="skill_${skillId}_bonus"]`)
    ];
    
    inputs.forEach(input => {
        if (input) {
            input.addEventListener('input', () => {
                updateSkillTotal(skillName);
            });
        }
    });
}

// フッターの技能ポイント表示更新
function updateFooterSkillPoints() {
    let occupationUsed = 0;
    let interestUsed = 0;
    
    // 全ての職業技能・趣味技能の合計を計算
    document.querySelectorAll('.skill-occupation').forEach(input => {
        occupationUsed += parseInt(input.value) || 0;
    });
    
    document.querySelectorAll('.skill-interest').forEach(input => {
        interestUsed += parseInt(input.value) || 0;
    });
    
    const occupationTotal = parseInt(document.getElementById('occupation-points').textContent) || 0;
    const interestTotal = parseInt(document.getElementById('interest-points').textContent) || 0;
    
    // フッターの表示を更新
    const occupationDisplay = document.getElementById('occupation-used-total');
    const interestDisplay = document.getElementById('interest-used-total');
    
    if (occupationDisplay) {
        occupationDisplay.textContent = `${occupationUsed}/${occupationTotal}`;
        occupationDisplay.className = occupationUsed > occupationTotal ? 'badge bg-danger' : 'badge bg-primary';
    }
    
    if (interestDisplay) {
        interestDisplay.textContent = `${interestUsed}/${interestTotal}`;
        interestDisplay.className = interestUsed > interestTotal ? 'badge bg-danger' : 'badge bg-success';
    }
}

// 下書き保存
function saveDraft() {
    const formData = new FormData(document.getElementById('character-form-6th'));
    const data = {};
    
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    localStorage.setItem('coc6th_character_draft', JSON.stringify(data));
    alert('下書きを保存しました');
}

// 下書き読み込み
function loadDraft() {
    const savedData = localStorage.getItem('coc6th_character_draft');
    if (savedData) {
        const data = JSON.parse(savedData);
        Object.entries(data).forEach(([key, value]) => {
            const element = document.querySelector(`[name="${key}"]`);
            if (element) {
                element.value = value;
            }
        });
        
        // 副次ステータスを再計算
        calculateDerivedStats();
        
        // 技能リストを再生成
        generateSkillsList();
    }
}

// カスタム技能追加
function addCustomSkill(category) {
    const skillName = prompt('技能名を入力してください（最大50文字）:');
    if (!skillName || skillName.trim() === '') {
        return;
    }
    
    // 重複チェック
    const allSkills = getAllSkills();
    if (allSkills.some(skill => skill.name === skillName.trim())) {
        alert('同じ名前の技能が既に存在します。');
        return;
    }
    
    const baseValueStr = prompt('初期値を入力してください（0-90）:', '1');
    if (!baseValueStr || isNaN(baseValueStr)) {
        return;
    }
    
    const baseValue = parseInt(baseValueStr);
    if (baseValue < 0 || baseValue > 90) {
        alert('初期値は0から90の間で入力してください。');
        return;
    }
    
    const newSkill = {
        name: skillName.trim(),
        base: baseValue,
        category: category,
        isCustom: true
    };
    
    customSkills.push(newSkill);
    generateSkillsList();
    updateFooterSkillPoints();
    
    // カスタム技能をローカルストレージに保存
    localStorage.setItem('coc6th_custom_skills', JSON.stringify(customSkills));
}

// カスタム技能削除
function removeCustomSkill(skillName) {
    if (confirm(`「${skillName}」を削除してもよろしいですか？`)) {
        customSkills = customSkills.filter(skill => skill.name !== skillName);
        generateSkillsList();
        updateFooterSkillPoints();
        
        // カスタム技能をローカルストレージに保存
        localStorage.setItem('coc6th_custom_skills', JSON.stringify(customSkills));
    }
}

// CSRFトークン取得
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// スキルデータ収集
function collectSkillsData() {
    const skills = [];
    const allSkills = getAllSkills();
    
    allSkills.forEach(skill => {
        const occupationInput = document.getElementById(`skill-occupation-${skill.name}`);
        const interestInput = document.getElementById(`skill-interest-${skill.name}`);
        
        const occupationPoints = parseInt(occupationInput?.value) || 0;
        const interestPoints = parseInt(interestInput?.value) || 0;
        
        // ポイントが割り振られているスキルのみ収集
        if (occupationPoints > 0 || interestPoints > 0) {
            skills.push({
                skill_name: skill.name,
                category: skill.category || '特殊・その他',
                base_value: skill.base,
                occupation_points: occupationPoints,
                interest_points: interestPoints
            });
        }
    });
    
    return skills;
}

// キャラクター画像プレビュー
function previewCharacterImage(input) {
    const file = input.files[0];
    const preview = document.getElementById('image-preview');
    const placeholder = document.getElementById('image-preview-placeholder');
    const actions = document.getElementById('image-preview-actions');
    
    if (file) {
        // ファイルサイズチェック（5MB）
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            alert('ファイルサイズが大きすぎます。5MB以下の画像を選択してください。');
            input.value = '';
            return;
        }
        
        // ファイル形式チェック
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            alert('サポートされていないファイル形式です。JPG、PNG、GIF形式の画像を選択してください。');
            input.value = '';
            return;
        }
        
        // プレビュー表示
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
            actions.style.display = 'block';
        };
        reader.readAsDataURL(file);
        
        // 新しい画像が選択されたら削除フラグをリセット
        const deleteFlag = document.getElementById('delete_image_flag');
        if (deleteFlag) {
            deleteFlag.value = 'false';
        }
    } else {
        // ファイルが選択されていない場合
        preview.style.display = 'none';
        placeholder.style.display = 'flex';
        actions.style.display = 'none';
    }
}

// キャラクター画像削除
function removeCharacterImage() {
    const input = document.getElementById('character_image');
    const preview = document.getElementById('image-preview');
    const placeholder = document.getElementById('image-preview-placeholder');
    const actions = document.getElementById('image-preview-actions');
    
    input.value = '';
    preview.src = '';
    preview.style.display = 'none';
    placeholder.style.display = 'flex';
    actions.style.display = 'none';
    
    // 削除フラグをマークする（hidden inputを追加）
    let deleteFlag = document.getElementById('delete_image_flag');
    if (!deleteFlag) {
        deleteFlag = document.createElement('input');
        deleteFlag.type = 'hidden';
        deleteFlag.id = 'delete_image_flag';
        deleteFlag.name = 'delete_image';
        document.getElementById('character-form-6th').appendChild(deleteFlag);
    }
    deleteFlag.value = 'true';
}

// DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // カスタム技能をローカルストレージから読み込み
    const savedCustomSkills = localStorage.getItem('coc6th_custom_skills');
    if (savedCustomSkills) {
        customSkills = JSON.parse(savedCustomSkills);
    }
    
    // 能力値変更時のイベントリスナー
    ABILITIES.forEach(ability => {
        document.getElementById(ability).addEventListener('input', calculateDerivedStats);
    });
    
    // 技能リスト生成
    generateSkillsList();
    
    // 初回のフッター更新
    updateFooterSkillPoints();
    
    // 下書きがあれば読み込み
    if (localStorage.getItem('coc6th_character_draft')) {
        if (confirm('保存された下書きがあります。読み込みますか？')) {
            loadDraft();
        }
    }
    
    // フォーム送信処理
    document.getElementById('character-form-6th').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // FormDataオブジェクトを作成（画像アップロード対応）
        const formData = new FormData();
        
        // 基本情報
        formData.append('edition', '6th');
        formData.append('name', document.getElementById('character_name').value);
        formData.append('age', parseInt(document.getElementById('age').value) || 25);
        formData.append('gender', document.getElementById('gender').value || '');
        formData.append('occupation', document.getElementById('occupation').value || '');
        formData.append('birthplace', document.getElementById('birthplace').value || '');
        
        // 能力値（6版の値として送信）
        formData.append('str_value', parseInt(document.getElementById('str').value) || 10);
        formData.append('con_value', parseInt(document.getElementById('con').value) || 10);
        formData.append('pow_value', parseInt(document.getElementById('pow').value) || 10);
        formData.append('dex_value', parseInt(document.getElementById('dex').value) || 10);
        formData.append('app_value', parseInt(document.getElementById('app').value) || 10);
        formData.append('siz_value', parseInt(document.getElementById('siz').value) || 13);
        formData.append('int_value', parseInt(document.getElementById('int').value) || 13);
        formData.append('edu_value', parseInt(document.getElementById('edu').value) || 12);
        
        // 6版固有データ
        formData.append('mental_disorder', document.getElementById('mental_disorder').value || '');
        
        // キャラクター画像
        const imageInput = document.getElementById('character_image');
        if (imageInput.files.length > 0) {
            formData.append('character_image', imageInput.files[0]);
        }
        
        // 画像削除フラグ
        const deleteFlag = document.getElementById('delete_image_flag');
        if (deleteFlag && deleteFlag.value === 'true') {
            formData.append('delete_image', 'true');
        }
        
        // スキルデータをJSONとして追加
        const skillsData = collectSkillsData();
        if (skillsData && skillsData.length > 0) {
            formData.append('skills_data', JSON.stringify(skillsData));
        }
        
        try {
            // APIを呼び出して保存
            const response = await fetch('/api/accounts/character-sheets/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                    // Content-Type はFormDataの場合は自動設定される
                },
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                alert('探索者が正常に保存されました！');
                
                // 下書きをクリア
                localStorage.removeItem('coc6th_character_draft');
                
                // キャラクター詳細画面にリダイレクト
                window.location.href = `/accounts/character/${result.id}/`;
            } else {
                const error = await response.json();
                console.error('保存エラー:', error);
                alert('保存に失敗しました。入力内容を確認してください。');
            }
        } catch (error) {
            console.error('通信エラー:', error);
            alert('通信エラーが発生しました。もう一度お試しください。');
        }
    });
});
</script>
{% endblock %}
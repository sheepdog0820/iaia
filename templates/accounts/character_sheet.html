{% extends 'base.html' %}
{% load static %}

{% block title %}クトゥルフ神話TRPG 探索者作成 - Arkham Nexus{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-eye text-warning"></i> 
                        クトゥルフ神話TRPG 探索者作成
                    </h3>
                    <small class="text-muted">探索者の詳細情報を入力してください</small>
                </div>
                
                <div class="card-body">
                    <form id="character-sheet-form">
                        <!-- システム選択 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="system" class="form-label">
                                    <i class="fas fa-dice-d20"></i> クトゥルフ神話TRPG版選択
                                </label>
                                <select class="form-select" id="system" name="system" required>
                                    <option value="">版を選択...</option>
                                    <option value="cthulhu_6th">クトゥルフ神話TRPG 6版</option>
                                    <option value="cthulhu_7th">クトゥルフ神話TRPG 7版</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="character-name" class="form-label">
                                    <i class="fas fa-signature"></i> 探索者名
                                </label>
                                <input type="text" class="form-control" id="character-name" name="character_name" required>
                            </div>
                        </div>

                        <!-- 基本情報 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary">
                                    <i class="fas fa-info-circle"></i> 基本情報
                                </h5>
                                <hr>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="age" class="form-label">年齢</label>
                                <input type="number" class="form-control" id="age" name="age" min="1" max="999">
                            </div>
                            <div class="col-md-4">
                                <label for="occupation" class="form-label">職業</label>
                                <input type="text" class="form-control" id="occupation" name="occupation">
                            </div>
                            <div class="col-md-4">
                                <label for="birthplace" class="form-label">出身地</label>
                                <input type="text" class="form-control" id="birthplace" name="birthplace">
                            </div>
                        </div>

                        <!-- 能力値 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-success">
                                    <i class="fas fa-chart-bar"></i> 能力値
                                </h5>
                                <hr>
                            </div>
                            
                            <!-- クトゥルフ神話TRPG用能力値 -->
                            <div class="col-md-3">
                                <label for="str" class="form-label">STR (筋力)</label>
                                <input type="number" class="form-control ability-score" id="str" name="str" min="1" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="con" class="form-label">CON (体力)</label>
                                <input type="number" class="form-control ability-score" id="con" name="con" min="1" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="pow" class="form-label">POW (精神力)</label>
                                <input type="number" class="form-control ability-score" id="pow" name="pow" min="1" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="dex" class="form-label">DEX (敏捷性)</label>
                                <input type="number" class="form-control ability-score" id="dex" name="dex" min="1" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="app" class="form-label">APP (外見)</label>
                                <input type="number" class="form-control ability-score" id="app" name="app" min="1" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="siz" class="form-label">SIZ (体格)</label>
                                <input type="number" class="form-control ability-score" id="siz" name="siz" min="1" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="int" class="form-label">INT (知性)</label>
                                <input type="number" class="form-control ability-score" id="int" name="int" min="1" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="edu" class="form-label">EDU (教育)</label>
                                <input type="number" class="form-control ability-score" id="edu" name="edu" min="1" max="100">
                            </div>
                        </div>

                        <!-- 副能力値 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-info">
                                    <i class="fas fa-heart"></i> 副能力値
                                </h5>
                                <hr>
                            </div>
                            
                            <div class="col-md-2">
                                <label for="hp" class="form-label">HP (耐久力)</label>
                                <input type="number" class="form-control" id="hp" name="hp" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="mp" class="form-label">MP (マジックポイント)</label>
                                <input type="number" class="form-control" id="mp" name="mp" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="san" class="form-label">SAN (正気度)</label>
                                <input type="number" class="form-control" id="san" name="san" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="luck" class="form-label">幸運</label>
                                <input type="number" class="form-control" id="luck" name="luck">
                            </div>
                            
                            <!-- 7版固有の副能力値 -->
                            <div class="col-md-2" id="build-field" style="display: none;">
                                <label for="build" class="form-label">ビルド値</label>
                                <input type="number" class="form-control" id="build" name="build" readonly>
                            </div>
                            <div class="col-md-2" id="move-field" style="display: none;">
                                <label for="move" class="form-label">移動力</label>
                                <input type="number" class="form-control" id="move" name="move" readonly>
                            </div>
                            
                            <!-- 6版固有の副能力値 -->
                            <div class="col-md-2" id="idea-field" style="display: none;">
                                <label for="idea" class="form-label">アイデア</label>
                                <input type="number" class="form-control" id="idea" name="idea" readonly>
                            </div>
                            <div class="col-md-2" id="know-field" style="display: none;">
                                <label for="know" class="form-label">知識</label>
                                <input type="number" class="form-control" id="know" name="know" readonly>
                            </div>
                            <div class="col-md-2" id="damage-bonus-field" style="display: none;">
                                <label for="damage-bonus" class="form-label">ダメージボーナス</label>
                                <input type="text" class="form-control" id="damage-bonus" name="damage_bonus" readonly>
                            </div>
                        </div>

                        <!-- 技能システム -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-warning">
                                    <i class="fas fa-tools"></i> 技能一覧
                                </h5>
                                <p class="text-muted small">初期値 + 職業技能 + 趣味技能 = 合計値</p>
                                <hr>
                            </div>
                            
                            <!-- 技能タブ -->
                            <div class="col-12">
                                <ul class="nav nav-tabs" id="skillTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="basic-skills-tab" data-bs-toggle="tab" data-bs-target="#basic-skills" type="button" role="tab">
                                            <i class="fas fa-star"></i> 基本技能
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="combat-skills-tab" data-bs-toggle="tab" data-bs-target="#combat-skills" type="button" role="tab">
                                            <i class="fas fa-fist-raised"></i> 戦闘技能
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="academic-skills-tab" data-bs-toggle="tab" data-bs-target="#academic-skills" type="button" role="tab">
                                            <i class="fas fa-graduation-cap"></i> 学問技能
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="social-skills-tab" data-bs-toggle="tab" data-bs-target="#social-skills" type="button" role="tab">
                                            <i class="fas fa-users"></i> 社交技能
                                        </button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content" id="skillTabsContent">
                                    <!-- 基本技能 -->
                                    <div class="tab-pane fade show active" id="basic-skills" role="tabpanel">
                                        <div class="row mt-3" id="basic-skills-container">
                                            <!-- JavaScriptで動的生成 -->
                                        </div>
                                    </div>
                                    
                                    <!-- 戦闘技能 -->
                                    <div class="tab-pane fade" id="combat-skills" role="tabpanel">
                                        <div class="row mt-3" id="combat-skills-container">
                                            <!-- JavaScriptで動的生成 -->
                                        </div>
                                    </div>
                                    
                                    <!-- 学問技能 -->
                                    <div class="tab-pane fade" id="academic-skills" role="tabpanel">
                                        <div class="row mt-3" id="academic-skills-container">
                                            <!-- JavaScriptで動的生成 -->
                                        </div>
                                    </div>
                                    
                                    <!-- 社交技能 -->
                                    <div class="tab-pane fade" id="social-skills" role="tabpanel">
                                        <div class="row mt-3" id="social-skills-container">
                                            <!-- JavaScriptで動的生成 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- キャラクター立ち絵 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-info">
                                    <i class="fas fa-image"></i> キャラクター立ち絵
                                </h5>
                                <hr>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="character-images" class="form-label">立ち絵アップロード (複数可)</label>
                                <input type="file" class="form-control" id="character-images" name="character_images" multiple accept="image/*">
                                <small class="text-muted">推奨サイズ: 512x512px または 1024x1024px (PNG, JPG対応)</small>
                            </div>
                            
                            <div class="col-12" id="image-preview-container">
                                <!-- アップロードされた画像のプレビュー -->
                            </div>
                        </div>

                        <!-- 背景・設定 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-danger">
                                    <i class="fas fa-book"></i> 背景・設定
                                </h5>
                                <hr>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="backstory" class="form-label">背景・経歴</label>
                                <textarea class="form-control" id="backstory" name="backstory" rows="4" 
                                    placeholder="探索者の生い立ち、経歴、動機などを記入してください..."></textarea>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="traits" class="form-label">性格・特徴</label>
                                <textarea class="form-control" id="traits" name="traits" rows="3" 
                                    placeholder="探索者の性格、癖、特徴的な行動などを記入してください..."></textarea>
                            </div>

                            <div class="col-md-6">
                                <label for="ideals" class="form-label">信念・理想</label>
                                <input type="text" class="form-control" id="ideals" name="ideals" 
                                    placeholder="探索者が大切にしていること">
                            </div>
                            <div class="col-md-6">
                                <label for="bonds" class="form-label">重要な人物・場所</label>
                                <input type="text" class="form-control" id="bonds" name="bonds" 
                                    placeholder="大切な人や思い出の場所">
                            </div>
                        </div>

                        <!-- 版数管理 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-secondary">
                                    <i class="fas fa-history"></i> 版数管理
                                </h5>
                                <hr>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="version" class="form-label">バージョン</label>
                                <input type="text" class="form-control" id="version" name="version" value="1.0" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="last-updated" class="form-label">最終更新</label>
                                <input type="text" class="form-control" id="last-updated" name="last_updated" readonly>
                            </div>
                            
                            <div class="col-12 mt-3">
                                <label for="update-notes" class="form-label">更新メモ</label>
                                <textarea class="form-control" id="update-notes" name="update_notes" rows="2" 
                                    placeholder="今回の変更内容を記入..."></textarea>
                            </div>
                        </div>

                        <!-- 7版固有の詳細背景 -->
                        <div class="row mb-4" id="cthulhu-7th-details" style="display: none;">
                            <div class="col-12">
                                <h5 class="text-purple">
                                    <i class="fas fa-eye"></i> 7版固有項目
                                </h5>
                                <hr>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="ideology-beliefs" class="form-label">思想・信念</label>
                                <textarea class="form-control" id="ideology-beliefs" name="ideology_beliefs" rows="2" 
                                    placeholder="政治的思想、宗教的信念、道徳観など"></textarea>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="significant-people" class="form-label">重要な人々</label>
                                <textarea class="form-control" id="significant-people" name="significant_people" rows="2" 
                                    placeholder="家族、友人、恋人、ライバルなど"></textarea>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="meaningful-locations" class="form-label">意味のある場所</label>
                                <textarea class="form-control" id="meaningful-locations" name="meaningful_locations" rows="2" 
                                    placeholder="故郷、思い出の場所、重要な地点"></textarea>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="treasured-possessions" class="form-label">大切な所持品</label>
                                <textarea class="form-control" id="treasured-possessions" name="treasured_possessions" rows="2" 
                                    placeholder="家宝、形見、お守りなど"></textarea>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="injuries-scars" class="form-label">傷跡・負傷</label>
                                <textarea class="form-control" id="injuries-scars" name="injuries_scars" rows="2" 
                                    placeholder="古い傷、身体的特徴、障害など"></textarea>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="phobias-manias" class="form-label">恐怖症・躁病</label>
                                <textarea class="form-control" id="phobias-manias" name="phobias_manias" rows="2" 
                                    placeholder="恐怖の対象、強迫観念、躁的行動"></textarea>
                            </div>
                        </div>

                        <!-- 所持品・装備 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-secondary">
                                    <i class="fas fa-suitcase"></i> 所持品・装備
                                </h5>
                                <hr>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="equipment" class="form-label">装備・所持品</label>
                                <textarea class="form-control" id="equipment" name="equipment" rows="4" 
                                    placeholder="武器、防具、道具、その他の所持品を記入してください..."></textarea>
                            </div>
                        </div>

                        <!-- アクションボタン -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="/" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> ホームに戻る
                                    </a>
                                    
                                    <div>
                                        <button type="button" class="btn btn-info me-2" id="auto-generate-btn">
                                            <i class="fas fa-magic"></i> ランダム生成
                                        </button>
                                        <button type="button" class="btn btn-warning me-2" id="save-draft-btn">
                                            <i class="fas fa-save"></i> 下書き保存
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-check"></i> 探索者作成
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.ability-score {
    background-color: rgba(40, 167, 69, 0.1);
    border: 2px solid #28a745;
}

.skill-score {
    background-color: rgba(255, 193, 7, 0.1);
    border: 2px solid #ffc107;
}

.form-label {
    font-weight: 600;
    color: #495057;
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.text-primary { color: #007bff !important; }
.text-success { color: #28a745 !important; }
.text-info { color: #17a2b8 !important; }
.text-warning { color: #ffc107 !important; }
.text-danger { color: #dc3545 !important; }
.text-secondary { color: #6c757d !important; }
.text-purple { color: #6f42c1 !important; }

.btn-outline-warning:hover {
    color: #212529;
}

hr {
    border-top: 2px solid #dee2e6;
    margin: 0.5rem 0 1rem 0;
}

/* 技能カードスタイル */
.skill-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.skill-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.skill-card .card-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #495057;
}

.skill-card .form-control-sm {
    font-size: 0.75rem;
}

/* タブスタイル */
.nav-tabs .nav-link {
    color: #6c757d;
    border: none;
    border-bottom: 2px solid transparent;
}

.nav-tabs .nav-link.active {
    background-color: transparent;
    color: #495057;
    border-bottom: 2px solid #007bff;
    font-weight: 600;
}

.nav-tabs .nav-link:hover {
    border-bottom: 2px solid #007bff;
    color: #007bff;
}

/* ダイスロールモーダル */
.modal-lg {
    max-width: 900px;
}

/* 画像プレビュー */
.image-preview-card {
    transition: transform 0.2s ease;
}

.image-preview-card:hover {
    transform: scale(1.05);
}

/* バージョン管理 */
.version-info {
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    padding: 0.5rem;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .skill-card {
        margin-bottom: 1rem;
    }
    
    .nav-tabs {
        flex-wrap: wrap;
    }
    
    .nav-tabs .nav-link {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // システム変更時のイベント
    const systemSelect = document.getElementById('system');
    
    if (systemSelect) {
        systemSelect.addEventListener('change', function() {
            const system = this.value;
            
            if (system === 'cthulhu_6th') {
                showCthulhuFields('6th');
            } else if (system === 'cthulhu_7th') {
                showCthulhuFields('7th');
            }
            calculateDerivedStats();
            
            // 技能テーブル生成
            if (system) {
                generateSkillTables(system);
            }
        });
    }
    
    // クトゥルフ神話TRPG版固有フィールドの表示/非表示
    function showCthulhuFields(edition) {
        // 7版固有項目の表示制御
        const build = document.getElementById('build-field');
        const move = document.getElementById('move-field');
        const cthulhu7thDetails = document.getElementById('cthulhu-7th-details');
        
        // 6版固有項目の表示制御
        const idea = document.getElementById('idea-field');
        const know = document.getElementById('know-field');
        const damageBonus = document.getElementById('damage-bonus-field');
        
        if (edition === '7th') {
            // 7版項目を表示
            build.style.display = 'block';
            move.style.display = 'block';
            cthulhu7thDetails.style.display = 'block';
            
            // 6版項目を非表示
            idea.style.display = 'none';
            know.style.display = 'none';
            damageBonus.style.display = 'none';
        } else if (edition === '6th') {
            // 6版項目を表示
            idea.style.display = 'block';
            know.style.display = 'block';
            damageBonus.style.display = 'block';
            
            // 7版項目を非表示
            build.style.display = 'none';
            move.style.display = 'none';
            cthulhu7thDetails.style.display = 'none';
        }
    }
    
    function hideCthulhuFields() {
        // 全てのクトゥルフ固有項目を非表示
        document.getElementById('build-field').style.display = 'none';
        document.getElementById('move-field').style.display = 'none';
        document.getElementById('idea-field').style.display = 'none';
        document.getElementById('know-field').style.display = 'none';
        document.getElementById('damage-bonus-field').style.display = 'none';
        document.getElementById('cthulhu-7th-details').style.display = 'none';
    }
    
    // 副能力値の自動計算
    function calculateDerivedStats() {
        const system = document.getElementById('system').value;
        const str = parseInt(document.getElementById('str').value) || 0;
        const con = parseInt(document.getElementById('con').value) || 0;
        const pow = parseInt(document.getElementById('pow').value) || 0;
        const dex = parseInt(document.getElementById('dex').value) || 0;
        const int = parseInt(document.getElementById('int').value) || 0;
        const edu = parseInt(document.getElementById('edu').value) || 0;
        const siz = parseInt(document.getElementById('siz').value) || 0;
        
        // 共通の副能力値
        const hp = Math.ceil((con + siz) / 10);
        const mp = Math.floor(pow / 5);
        const san = pow;
        
        document.getElementById('hp').value = hp;
        document.getElementById('mp').value = mp;
        document.getElementById('san').value = san;
        
        // 版固有の計算
        if (system === 'cthulhu_6th') {
            calculateDerivedStats6th(str, con, pow, dex, int, edu, siz);
        } else if (system === 'cthulhu_7th') {
            calculateDerivedStats7th(str, con, pow, dex, int, edu, siz);
        }
    }
    
    // 6版固有の副能力値計算
    function calculateDerivedStats6th(str, con, pow, dex, int, edu, siz) {
        // アイデア = INT × 5
        document.getElementById('idea').value = int * 5;
        
        // 知識 = EDU × 5
        document.getElementById('know').value = edu * 5;
        
        // ダメージボーナス計算（6版）
        const total = str + siz;
        let damageBonus;
        
        if (total <= 64) damageBonus = "-1d4";
        else if (total <= 84) damageBonus = "-1d2";
        else if (total <= 124) damageBonus = "+0";
        else if (total <= 164) damageBonus = "+1d4";
        else if (total <= 204) damageBonus = "+1d6";
        else if (total <= 284) damageBonus = "+2d6";
        else if (total <= 364) damageBonus = "+3d6";
        else if (total <= 444) damageBonus = "+4d6";
        else damageBonus = "+5d6";
        
        document.getElementById('damage-bonus').value = damageBonus;
    }
    
    // 7版固有の副能力値計算
    function calculateDerivedStats7th(str, con, pow, dex, int, edu, siz) {
        // ビルド値計算（7版）
        const total = str + siz;
        let build;
        
        if (total <= 64) build = -2;
        else if (total <= 84) build = -1;
        else if (total <= 124) build = 0;
        else if (total <= 164) build = 1;
        else if (total <= 204) build = 2;
        else if (total <= 284) build = 3;
        else if (total <= 364) build = 4;
        else if (total <= 444) build = 5;
        else build = 6;
        
        document.getElementById('build').value = build;
        
        // 移動力計算（7版）- 基本は8、年齢・能力値により修正
        let moveRate = 8;
        // 簡易計算（実際は年齢や能力値により細かく修正）
        if (str < 50 || dex < 50 || siz > 80) moveRate = 7;
        if (str < 40 || dex < 40) moveRate = 6;
        
        document.getElementById('move').value = moveRate;
    }
    
    // 能力値変更時に副能力値を再計算
    function setupAbilityScoreListeners() {
        document.querySelectorAll('.ability-score').forEach(input => {
            input.addEventListener('input', calculateDerivedStats);
        });
    }
    setupAbilityScoreListeners();
    
    // ダイスボット機能
    const autoGenerateBtn = document.getElementById('auto-generate-btn');
    if (autoGenerateBtn) {
        autoGenerateBtn.addEventListener('click', function() {
            const system = document.getElementById('system').value;
            
            if (!system) {
                alert('まずクトゥルフ神話TRPGの版を選択してください。');
                return;
            }
            
            alert('ダイスボット機能は一時的に無効化されています。');
            // showDiceRollModal(system);
        });
    }
    
    // ダイスロールモーダル表示 (一時無効化)
    /* function showDiceRollModal(system) {
        const modalHtml = `
            <div class="modal fade" id="diceRollModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">
                                <i class="fas fa-dice"></i> ダイスボット - ${getSystemName(system)}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> クリックで能力値を一つずつロールできます
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="dice-buttons-container">
                                <!-- ダイスボタンが動的生成されます -->
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-history"></i> ロール履歴
                                            </h6>
                                        </div>
                                        <div class="card-body" id="roll-history" style="max-height: 200px; overflow-y: auto;">
                                            <p class="text-muted">ロールを開始してください</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                            <button type="button" class="btn btn-success" id="apply-rolls-btn">結果を適用</button>
                            <button type="button" class="btn btn-warning" id="auto-roll-all-btn">全部自動ロール</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 既存のモーダルを削除
        const existingModal = document.getElementById('diceRollModal');
        if (existingModal) existingModal.remove();
        
        // 新しいモーダルを追加
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ダイスボタン生成
        generateDiceButtons(system);
        
        // モーダル表示
        const modal = new bootstrap.Modal(document.getElementById('diceRollModal'));
        modal.show();
        
        // イベントリスナー設定
        setupDiceModalEvents(system, modal);
    } */
    
    // ダイスボタン生成 (一時無効化)
    /* function generateDiceButtons(system) {
        const container = document.getElementById('dice-buttons-container');
        const abilities = [
            {id: 'str', name: 'STR(筋力)', dice: '3D6×5'},
            {id: 'con', name: 'CON(体力)', dice: '3D6×5'},
            {id: 'pow', name: 'POW(精神力)', dice: '3D6×5'},
            {id: 'dex', name: 'DEX(敏捷性)', dice: '3D6×5'},
            {id: 'app', name: 'APP(外見)', dice: '3D6×5'},
            {id: 'siz', name: 'SIZ(体格)', dice: '(2D6+6)×5'},
            {id: 'int', name: 'INT(知性)', dice: '(2D6+6)×5'},
            {id: 'edu', name: 'EDU(教育)', dice: system === 'cthulhu_7th' ? '(2D6+6)×5' : '(3D6+3)×5'},
            {id: 'luck', name: '幸運', dice: '3D6×5'}
        ];
        
        let html = '';
        abilities.forEach(ability => {
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title">${ability.name}</h6>
                            <p class="text-muted small">${ability.dice}</p>
                            <button type="button" class="btn btn-outline-primary btn-sm mb-2" 
                                    onclick="rollSingleAbility('${ability.id}', '${system}')">
                                <i class="fas fa-dice"></i> ロール
                            </button>
                            <div class="mt-2">
                                <span class="badge bg-secondary" id="${ability.id}-result">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    } */
    
    // 各能力値のロール (一時無効化)
    /* window.rollSingleAbility = function(abilityId, system) {
        let result;
        let rollDetail;
        
        switch(abilityId) {
            case 'str':
            case 'con':
            case 'pow':
            case 'dex':
            case 'app':
            case 'luck':
                const dice3d6 = [roll1d6(), roll1d6(), roll1d6()];
                result = (dice3d6[0] + dice3d6[1] + dice3d6[2]) * 5;
                rollDetail = `3D6(${dice3d6.join('+')}) × 5 = ${result}`;
                break;
                
            case 'siz':
            case 'int':
                const dice2d6 = [roll1d6(), roll1d6()];
                result = (dice2d6[0] + dice2d6[1] + 6) * 5;
                rollDetail = `(2D6(${dice2d6.join('+')}) + 6) × 5 = ${result}`;
                break;
                
            case 'edu':
                if (system === 'cthulhu_7th') {
                    const dice2d6_edu = [roll1d6(), roll1d6()];
                    result = (dice2d6_edu[0] + dice2d6_edu[1] + 6) * 5;
                    rollDetail = `(2D6(${dice2d6_edu.join('+')}) + 6) × 5 = ${result}`;
                } else {
                    const dice3d6_edu = [roll1d6(), roll1d6(), roll1d6()];
                    result = (dice3d6_edu[0] + dice3d6_edu[1] + dice3d6_edu[2] + 3) * 5;
                    rollDetail = `(3D6(${dice3d6_edu.join('+')}) + 3) × 5 = ${result}`;
                }
                break;
        }
        
        // 結果表示更新
        document.getElementById(`${abilityId}-result`).textContent = result;
        document.getElementById(`${abilityId}-result`).className = 'badge bg-success';
        
        // 履歴追加
        addRollHistory(getAbilityName(abilityId), rollDetail, result);
        
        return result;
    }; */
    
    // ロール履歴追加 (一時無効化)
    /* function addRollHistory(abilityName, rollDetail, result) {
        const historyContainer = document.getElementById('roll-history');
        const time = new Date().toLocaleTimeString('ja-JP');
        
        const historyItem = document.createElement('div');
        historyItem.className = 'mb-2 p-2 border-bottom border-light';
        historyItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong class="text-info">${abilityName}</strong>
                    <small class="text-muted ms-2">${rollDetail}</small>
                </div>
                <div>
                    <span class="badge bg-primary">${result}</span>
                    <small class="text-muted ms-2">${time}</small>
                </div>
            </div>
        `;
        
        if (historyContainer.querySelector('.text-muted')) {
            historyContainer.innerHTML = '';
        }
        
        historyContainer.insertBefore(historyItem, historyContainer.firstChild);
    } */
    
    // 能力値名取得
    function getAbilityName(abilityId) {
        const names = {
            'str': 'STR(筋力)',
            'con': 'CON(体力)',
            'pow': 'POW(精神力)',
            'dex': 'DEX(敏捷性)',
            'app': 'APP(外見)',
            'siz': 'SIZ(体格)',
            'int': 'INT(知性)',
            'edu': 'EDU(教育)',
            'luck': '幸運'
        };
        return names[abilityId] || abilityId;
    }
    
    // ダイスモーダルイベント設定 (一時無効化)
    /* function setupDiceModalEvents(system, modal) {
        // 全部自動ロール
        document.getElementById('auto-roll-all-btn').addEventListener('click', function() {
            ['str', 'con', 'pow', 'dex', 'app', 'siz', 'int', 'edu', 'luck'].forEach(ability => {
                setTimeout(() => rollSingleAbility(ability, system), Math.random() * 500);
            });
        });
        
        // 結果適用
        document.getElementById('apply-rolls-btn').addEventListener('click', function() {
            const abilities = ['str', 'con', 'pow', 'dex', 'app', 'siz', 'int', 'edu', 'luck'];
            let appliedCount = 0;
            
            abilities.forEach(ability => {
                const resultElement = document.getElementById(`${ability}-result`);
                if (resultElement && resultElement.textContent !== '-') {
                    document.getElementById(ability).value = resultElement.textContent;
                    appliedCount++;
                }
            });
            
            // 副能力値再計算
            calculateDerivedStats();
            
            // 技能テーブル生成
            // generateSkillTables(system); // 一時的に無効化
            
            modal.hide();
            
            if (appliedCount > 0) {
                alert(`${appliedCount}個の能力値を適用しました！`);
            } else {
                alert('適用するロール結果がありません。');
            }
        });
    } */
    
    // ダイスロール関数
    function roll1d6() {
        return Math.floor(Math.random() * 6) + 1;
    }
    
    function roll2d6() {
        return roll1d6() + roll1d6();
    }
    
    function roll3d6() {
        return roll1d6() + roll1d6() + roll1d6();
    }
    
    function rollDice(sides, count = 1) {
        let total = 0;
        for (let i = 0; i < count; i++) {
            total += Math.floor(Math.random() * sides) + 1;
        }
        return total;
    }
    
    // 基本技能設定
    function setBasicSkills(system) {
        const dex = parseInt(document.getElementById('dex').value) || 0;
        const edu = parseInt(document.getElementById('edu').value) || 0;
        
        if (system === 'cthulhu_6th') {
            // 6版基本技能
            document.getElementById('dodge').value = dex * 2; // 6版では DEX * 2
            document.getElementById('fighting').value = 25;
            document.getElementById('firearms').value = 20;
            document.getElementById('spot_hidden').value = 25;
            document.getElementById('listen').value = 25;
            document.getElementById('psychology').value = 5;
            document.getElementById('first_aid').value = 30;
            document.getElementById('library_use').value = 25;
            document.getElementById('persuade').value = 15;
            document.getElementById('intimidate').value = 15;
        } else if (system === 'cthulhu_7th') {
            // 7版基本技能
            document.getElementById('dodge').value = Math.floor(dex / 2); // 7版では DEX / 2
            document.getElementById('fighting').value = 25;
            document.getElementById('firearms').value = 20;
            document.getElementById('spot_hidden').value = 25;
            document.getElementById('listen').value = 20;
            document.getElementById('psychology').value = 10;
            document.getElementById('first_aid').value = 30;
            document.getElementById('library_use').value = 20;
            document.getElementById('persuade').value = 10;
            document.getElementById('intimidate').value = 15;
    }
    
    // システム名取得
    function getSystemName(system) {
        const names = {
            'cthulhu_6th': 'クトゥルフ神話TRPG 6版',
            'cthulhu_7th': 'クトゥルフ神話TRPG 7版'
        };
        return names[system] || system;
    }
    
    // 技能テーブル生成
    function generateSkillTables(system) {
        // 技能データ定義
        const skillsData = getSkillsData(system);
        
        // 各カテゴリのコンテナを更新
        generateSkillCategory('basic-skills-container', skillsData.basic);
        generateSkillCategory('combat-skills-container', skillsData.combat);
        generateSkillCategory('academic-skills-container', skillsData.academic);
        generateSkillCategory('social-skills-container', skillsData.social);
    }
    
    // 技能カテゴリ生成
    function generateSkillCategory(containerId, skills) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        let html = '';
        
        skills.forEach(skill => {
            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card skill-card">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-2">
                                <i class="fas fa-cog text-muted me-1"></i>
                                ${skill.name}
                            </h6>
                            <div class="row g-1">
                                <div class="col-4">
                                    <label class="form-label small">初期値</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           id="${skill.id}_base" name="${skill.id}_base" 
                                           value="${skill.base}" readonly>
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">職業</label>
                                    <input type="number" class="form-control form-control-sm skill-occupation" 
                                           id="${skill.id}_occupation" name="${skill.id}_occupation" 
                                           min="0" max="90" value="0">
                                </div>
                                <div class="col-4">
                                    <label class="form-label small">趣味</label>
                                    <input type="number" class="form-control form-control-sm skill-interest" 
                                           id="${skill.id}_interest" name="${skill.id}_interest" 
                                           min="0" max="90" value="0">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="form-label small fw-bold">合計</label>
                                <input type="number" class="form-control form-control-sm bg-info text-white fw-bold" 
                                       id="${skill.id}_total" name="${skill.id}_total" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // 技能合計更新イベント追加
        skills.forEach(skill => {
            ['_occupation', '_interest'].forEach(suffix => {
                const input = document.getElementById(skill.id + suffix);
                if (input) {
                    input.addEventListener('input', () => updateSkillTotal(skill.id));
                }
            });
            // 初期値計算
            updateSkillTotal(skill.id);
        });
    }
    
    // 技能合計更新
    function updateSkillTotal(skillId) {
        const baseInput = document.getElementById(skillId + '_base');
        const occupationInput = document.getElementById(skillId + '_occupation');
        const interestInput = document.getElementById(skillId + '_interest');
        const totalInput = document.getElementById(skillId + '_total');
        
        if (!baseInput || !occupationInput || !interestInput || !totalInput) return;
        
        const base = parseInt(baseInput.value) || 0;
        const occupation = parseInt(occupationInput.value) || 0;
        const interest = parseInt(interestInput.value) || 0;
        
        const total = base + occupation + interest;
        const maxValue = document.getElementById('system').value === 'cthulhu_6th' ? 90 : 100;
        
        totalInput.value = Math.min(total, maxValue);
    }
    
    // 技能データ取得
    function getSkillsData(system) {
        return {
            basic: [
                {id: 'dodge', name: '回避', base: calculateDodgeBase(system)},
                {id: 'language_own', name: '母国語', base: calculateLanguageOwnBase()},
                {id: 'first_aid', name: '応急手当', base: 30},
                {id: 'library_use', name: '図書館', base: system === 'cthulhu_6th' ? 25 : 20},
                {id: 'listen', name: '聞き耳', base: system === 'cthulhu_6th' ? 25 : 20},
                {id: 'spot_hidden', name: '目星', base: 25},
                {id: 'jump', name: '跳躍', base: 25},
                {id: 'climb', name: '登攀', base: 40},
                {id: 'swim', name: '水泳', base: 25}
            ],
            combat: [
                {id: 'fighting_brawl', name: 'こぶし(パンチ)', base: 25},
                {id: 'fighting_grapple', name: '組みつき', base: 25},
                {id: 'fighting_head_butt', name: '頭突き', base: 10},
                {id: 'fighting_kick', name: 'キック', base: 25},
                {id: 'firearms_handgun', name: '拳銃', base: 20},
                {id: 'firearms_rifle', name: 'ライフル', base: 25},
                {id: 'firearms_shotgun', name: 'ショットガン', base: 30},
                {id: 'throw', name: '投擲', base: 25},
                {id: 'martial_arts', name: 'マーシャルアーツ', base: 1}
            ],
            academic: [
                {id: 'anthropology', name: '人類学', base: 1},
                {id: 'archaeology', name: '考古学', base: 1},
                {id: 'history', name: '歴史', base: 20},
                {id: 'medicine', name: '医学', base: 5},
                {id: 'natural_world', name: '博物学', base: 10},
                {id: 'occult', name: 'オカルト', base: 5},
                {id: 'psychology', name: '心理学', base: system === 'cthulhu_6th' ? 5 : 10},
                {id: 'biology', name: '生物学', base: 1},
                {id: 'chemistry', name: '化学', base: 1},
                {id: 'physics', name: '物理学', base: 1},
                {id: 'cthulhu_mythos', name: 'クトゥルフ神話', base: 0}
            ],
            social: [
                {id: 'persuade', name: '説得', base: system === 'cthulhu_6th' ? 15 : 10},
                {id: 'intimidate', name: '威圧', base: 15},
                {id: 'fast_talk', name: '言いくるめ', base: 5},
                {id: 'bargain', name: '値切り', base: 5},
                {id: 'credit_rating', name: '信用', base: 0},
                {id: 'law', name: '法律', base: 5},
                {id: 'accounting', name: '経理', base: 10},
                {id: 'art', name: '芸術', base: 5},
                {id: 'photography', name: '写真術', base: 10}
            ]
        };
    }
    
    // 回避初期値計算
    function calculateDodgeBase(system) {
        const dexElement = document.getElementById('dex');
        const dex = dexElement ? parseInt(dexElement.value) || 0 : 0;
        return system === 'cthulhu_6th' ? Math.min(dex * 2, 100) : Math.min(Math.floor(dex / 2), 100);
    }
    
    // 母国語初期値計算
    function calculateLanguageOwnBase() {
        const eduElement = document.getElementById('edu');
        const edu = eduElement ? parseInt(eduElement.value) || 0 : 0;
        return Math.min(edu, 100);
    }
    
    // キャラクター立ち絵機能
    const imageInput = document.getElementById('character-images');
    let uploadedImages = [];
    
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            name: file.name,
                            data: e.target.result,
                            size: file.size,
                            type: file.type
                        };
                        
                        uploadedImages.push(imageData);
                        updateImagePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
    }
    
    // 画像プレビュー更新
    function updateImagePreview() {
        const container = document.getElementById('image-preview-container');
        if (!container) return;
        
        let html = '<div class="row">';
        
        uploadedImages.forEach((image, index) => {
            html += `
                <div class="col-md-3 mb-3">
                    <div class="card">
                        <img src="${image.data}" class="card-img-top" style="height: 200px; object-fit: contain; background-color: #f8f9fa;" alt="${image.name}">
                        <div class="card-body p-2">
                            <small class="text-muted">${image.name}</small>
                            <button type="button" class="btn btn-sm btn-danger w-100 mt-1" 
                                    onclick="removeImage(${index})">
                                <i class="fas fa-trash"></i> 削除
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // 画像削除
    window.removeImage = function(index) {
        uploadedImages.splice(index, 1);
        updateImagePreview();
    };
    
    // バージョン管理
    function updateVersion() {
        const now = new Date();
        const lastUpdatedElement = document.getElementById('last-updated');
        if (lastUpdatedElement) {
            lastUpdatedElement.value = now.toLocaleString('ja-JP');
        }
    }
    
    // 下書き保存機能
    const saveDraftBtn = document.getElementById('save-draft-btn');
    if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', function() {
        const formData = new FormData(document.getElementById('character-sheet-form'));
        const data = Object.fromEntries(formData);
        
        // 画像データを追加
        data.character_images = uploadedImages;
        
        // LocalStorageに保存
        localStorage.setItem('investigator_sheet_draft', JSON.stringify(data));
        
        // 保存完了通知
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> 保存完了';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-warning');
        }, 2000);
        
            updateVersion();
        });
    }
    
    // ページ読み込み時の初期化
    const savedDraft = localStorage.getItem('investigator_sheet_draft');
    if (savedDraft) {
        const data = JSON.parse(savedDraft);
        Object.keys(data).forEach(key => {
            if (key === 'character_images' && data[key]) {
                uploadedImages = data[key];
                updateImagePreview();
            } else {
                const element = document.getElementById(key);
                if (element) {
                    element.value = data[key];
                }
            }
        });
        calculateDerivedStats();
        
        // 保存されたシステムで技能テーブル生成
        const system = document.getElementById('system').value;
        if (system) {
            // generateSkillTables(system); // 一時的に無効化
        }
    }
    
    // 初期バージョン設定
    if (document.getElementById('last-updated')) {
        updateVersion();
    }
    
    // フォーム送信処理
    const characterForm = document.getElementById('character-sheet-form');
    if (characterForm) {
        characterForm.addEventListener('submit', function(e) {
            e.preventDefault();
        
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // バリデーション
            if (!data.character_name || !data.system) {
                alert('探索者名とクトゥルフ神話TRPGの版は必須です。');
                return;
            }
            
            // バージョン更新
            const currentVersion = parseFloat(document.getElementById('version').value) || 1.0;
            data.version = (currentVersion + 0.1).toFixed(1);
            data.last_updated = new Date().toLocaleString('ja-JP');
            data.character_images = uploadedImages;
            
            // 保存処理（ここではJSONをダウンロード）
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.character_name}_investigator_v${data.version}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // 下書きクリア
            localStorage.removeItem('investigator_sheet_draft');
            
            alert(`${data.character_name}の探索者シートを作成しました！`);
        });
    }
});
</script>
{% endblock %}
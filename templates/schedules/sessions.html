{% extends 'base.html' %}
{% load static %}

{% block title %}R'lyeh Log - セッション記録{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4 eldritch-font text-center">
                <i class="fas fa-scroll"></i> R'lyeh Log
                <small class="d-block text-muted fs-6 mt-2">深淵に沈む都市より浮かび上がる、探索の記録</small>
            </h1>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> フィルター</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">ステータス</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">すべて</option>
                            <option value="planned">予定</option>
                            <option value="ongoing">進行中</option>
                            <option value="completed">完了</option>
                            <option value="cancelled">キャンセル</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">期間</label>
                        <select class="form-select" id="periodFilter">
                            <option value="future" selected>今後の予定</option>
                            <option value="">すべて</option>
                            <option value="past7">過去7日間</option>
                            <option value="past30">過去30日間</option>
                            <option value="past90">過去90日間</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">参加形式</label>
                        <select class="form-select" id="roleFilter">
                            <option value="">すべて</option>
                            <option value="gm">GMとして</option>
                            <option value="player">PLとして</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary w-100" id="applyFilter">
                        <i class="fas fa-search"></i> フィルター適用
                    </button>
                </div>
            </div>

            <div class="card mt-3" id="sessionInvitationsCard" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-envelope-open-text"></i> セッション招待</h5>
                </div>
                <div class="card-body" id="sessionInvitationsContainer">
                    <div class="text-center py-2">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> 統計情報</h5>
                </div>
                <div class="card-body" id="statsContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <!-- タブナビゲーション -->
            <ul class="nav nav-tabs mb-3" id="sessionsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="my-sessions-tab" data-bs-toggle="tab" data-bs-target="#my-sessions-pane" type="button" role="tab">
                        <i class="fas fa-user-check"></i> 参加予定
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-sessions-tab" data-bs-toggle="tab" data-bs-target="#all-sessions-pane" type="button" role="tab">
                        <i class="fas fa-list"></i> すべて
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="sessionsTabContent">
                <!-- 参加予定タブ -->
                <div class="tab-pane fade show active" id="my-sessions-pane" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="text-muted" id="mySessionsCount"></span>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newSessionModal">
                            <i class="fas fa-plus"></i> 新規セッション
                        </button>
                    </div>
                    <div id="mySessionsList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center" id="mySessionsPagination"></ul>
                    </nav>
                </div>

                <!-- すべてのセッションタブ -->
                <div class="tab-pane fade" id="all-sessions-pane" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="text-muted" id="allSessionsCount"></span>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newSessionModal">
                            <i class="fas fa-plus"></i> 新規セッション
                        </button>
                    </div>
                    <div id="sessionsList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- セッション編集モーダル -->
<div class="modal fade" id="editSessionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">セッション編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSessionForm">
                    <input type="hidden" id="editSessionId">
                    <div class="mb-3">
                        <label for="editSessionTitle" class="form-label">セッションタイトル</label>
                        <input type="text" class="form-control" id="editSessionTitle" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editSessionDate" class="form-label">日時</label>
                            <input type="datetime-local" class="form-control" id="editSessionDate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editSessionDuration" class="form-label">実施時間（分）</label>
                            <input type="number" class="form-control" id="editSessionDuration" min="0" step="30">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editSessionStatus" class="form-label">ステータス</label>
                        <select class="form-select" id="editSessionStatus">
                            <option value="planned">予定</option>
                            <option value="ongoing">進行中</option>
                            <option value="completed">完了</option>
                            <option value="cancelled">キャンセル</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editSessionLocation" class="form-label">場所</label>
                        <input type="text" class="form-control" id="editSessionLocation">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editSessionYoutube" class="form-label">YouTube配信URL</label>
                        <input type="url" class="form-control" id="editSessionYoutube">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editSessionDescription" class="form-label">説明・メモ</label>
                        <textarea class="form-control" id="editSessionDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="updateSessionBtn">
                    <i class="fas fa-save"></i> 更新
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 参加者管理モーダル -->
<div class="modal fade" id="participantsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">参加者管理</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="participantsList">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.session-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.session-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(220, 38, 127, 0.2);
}

.session-card.status-planned {
    border-left-color: #39d0d8;
}

.session-card.status-ongoing {
    border-left-color: #ffc107;
}

.session-card.status-completed {
    border-left-color: #3fb950;
}

.session-card.status-cancelled {
    border-left-color: #f85149;
}

.participant-item {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    background-color: rgba(255, 255, 255, 0.05);
}

.character-sheet-link {
    color: #58a6ff;
    text-decoration: none;
}

.character-sheet-link:hover {
    text-decoration: underline;
}

.stats-item {
    padding: 15px;
    border-radius: 8px;
    background-color: rgba(255, 255, 255, 0.05);
    margin-bottom: 10px;
}

.stats-number {
    font-size: 2rem;
    font-weight: bold;
    color: #dc2670;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let mySessionsPage = 1;
    let currentFilters = {};
    let currentSessionId = null;
    const userId = {{ user.id }};

    // 参加予定セッション読み込み（ISSUE-030）
    async function loadMySessions(page = 1) {
        const container = document.getElementById('mySessionsList');
        const countEl = document.getElementById('mySessionsCount');

        try {
            const params = new URLSearchParams({
                page: page,
                page_size: 20,
                ...currentFilters
            });

            const response = await axios.get(`/api/schedules/sessions/my-sessions/?${params}`);
            const data = response.data;
            const sessions = data.results || [];

            countEl.textContent = `${data.count}件の参加予定セッション`;

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        参加予定のセッションはありません
                    </div>
                `;
                updateMySessionsPagination(0, 20, 1);
                return;
            }

            container.innerHTML = sessions.map(session => renderSessionCard(session, true)).join('');
            updateMySessionsPagination(data.count, data.page_size, page);

        } catch (error) {
            console.error('Error loading my sessions:', error);
            container.innerHTML = '<div class="alert alert-danger">参加予定セッションの読み込みに失敗しました</div>';
        }
    }

    // すべてのセッション読み込み
    async function loadSessions(page = 1) {
        const container = document.getElementById('sessionsList');
        const countEl = document.getElementById('allSessionsCount');

        try {
            const params = new URLSearchParams({
                page: page,
                ...currentFilters
            });

            const response = await axios.get(`/api/schedules/sessions/?${params}`);
            const sessions = response.data.results || response.data;

            if (countEl) {
                countEl.textContent = `${response.data.count || sessions.length}件のセッション`;
            }

            if (sessions.length === 0) {
                container.innerHTML = '<div class="alert alert-info">セッションが見つかりませんでした</div>';
                return;
            }

            container.innerHTML = sessions.map(session => renderSessionCard(session, false)).join('');
            updatePagination(response.data.count || sessions.length, response.data.page_size || 10, page);

        } catch (error) {
            console.error('Error loading sessions:', error);
            container.innerHTML = '<div class="alert alert-danger">セッションの読み込みに失敗しました</div>';
        }
    }

    // セッションカードのレンダリング
    function renderSessionCard(session, showRole = false) {
        const gmNickname = session.gm_detail?.nickname || session.gm_detail?.username || 'GM';
        const isGm = session.gm === userId || session.my_role === 'gm';
        const roleLabel = showRole && session.my_role
            ? `<span class="badge ${session.my_role === 'gm' ? 'bg-primary' : 'bg-secondary'} me-2">${session.my_role === 'gm' ? 'GM' : 'PL'}</span>`
            : '';

        return `
            <div class="card session-card status-${session.status} mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">
                                ${roleLabel}${escapeHtml(session.title)}
                            </h5>
                            <p class="text-muted mb-2">
                                <i class="fas fa-calendar"></i> ${session.date ? new Date(session.date).toLocaleString('ja-JP') : '未定'}
                                ${session.duration_minutes > 0 ? `<span class="ms-3"><i class="fas fa-clock"></i> ${session.duration_minutes}分</span>` : ''}
                            </p>
                            <p class="mb-2">
                                <i class="fas fa-user"></i> GM: ${escapeHtml(gmNickname)}
                                <span class="ms-3"><i class="fas fa-users"></i> 参加者: ${session.participant_count || 0}人</span>
                            </p>
                            ${session.location ? `<p class="mb-1"><i class="fas fa-map-marker-alt"></i> ${escapeHtml(session.location)}</p>` : ''}
                            ${session.youtube_url ? `<p class="mb-1"><i class="fab fa-youtube"></i> <a href="${escapeHtml(session.youtube_url)}" target="_blank">配信を見る</a></p>` : ''}
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-${getStatusColor(session.status)} mb-2">${getStatusLabel(session.status)}</span>
                            <div>
                                ${isGm ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="editSession(${session.id})">
                                        <i class="fas fa-edit"></i> 編集
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="manageParticipants(${session.id})">
                                        <i class="fas fa-users-cog"></i> 参加者
                                    </button>
                                ` : ''}
                                ${showRole && !session.date ? `
                                    <a class="btn btn-sm btn-outline-warning me-1" href="/api/schedules/sessions/${session.id}/detail/#datePollCard">
                                        <i class="fas fa-poll"></i> 日程投票
                                    </a>
                                ` : ''}
                                <a class="btn btn-sm btn-outline-secondary" href="/api/schedules/sessions/${session.id}/detail/">
                                    <i class="fas fa-eye"></i> 詳細
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ステータスの色を取得
    function getStatusColor(status) {
        const colors = {
            planned: 'info',
            ongoing: 'warning',
            completed: 'success',
            cancelled: 'danger'
        };
        return colors[status] || 'secondary';
    }

    // ステータスのラベルを取得
    function getStatusLabel(status) {
        const labels = {
            planned: '予定',
            ongoing: '進行中',
            completed: '完了',
            cancelled: 'キャンセル'
        };
        return labels[status] || status;
    }

    // 統計情報読み込み
    async function loadStatistics() {
        try {
            const year = new Date().getFullYear();
            const response = await axios.get(`/api/schedules/sessions/statistics/?year=${year}`);
            const stats = response.data;
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stats-item">
                    <div class="stats-number">${stats.session_count}</div>
                    <div class="text-muted">今年のセッション数</div>
                </div>
                <div class="stats-item">
                    <div class="stats-number">${stats.total_hours}h</div>
                    <div class="text-muted">総プレイ時間</div>
                </div>
                <div class="stats-item">
                    <div class="stats-number">${stats.average_session_hours}h</div>
                    <div class="text-muted">平均セッション時間</div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading statistics:', error);
        }
    }

    // セッション招待読み込み
    async function loadSessionInvitations() {
        const card = document.getElementById('sessionInvitationsCard');
        const container = document.getElementById('sessionInvitationsContainer');

        try {
            const response = await axios.get('/api/schedules/session-invitations/?status=pending');
            const invitations = response.data.results || response.data;

            if (!Array.isArray(invitations) || invitations.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';
            container.innerHTML = invitations.map(inv => `
                <div class="mb-3">
                    <div class="fw-bold">${inv.session_title}</div>
                    <div class="text-muted small">
                        <i class="fas fa-calendar"></i> ${new Date(inv.session_date).toLocaleString('ja-JP')}
                        <span class="ms-2"><i class="fas fa-user"></i> ${inv.inviter?.nickname || inv.inviter?.username || ''}</span>
                    </div>
                    ${inv.message ? `<div class="small mt-1">${escapeHtml(inv.message)}</div>` : ''}
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-primary" onclick="acceptSessionInvitation(${inv.id}, ${inv.session_id})">承認して参加</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="declineSessionInvitation(${inv.id})">辞退</button>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading session invitations:', error);
            card.style.display = 'none';
        }
    }

    window.acceptSessionInvitation = async function(invitationId, sessionId) {
        if (!confirm('この招待を承認してセッションに参加しますか？')) return;
        try {
            await axios.post(`/api/schedules/session-invitations/${invitationId}/accept/`);
            await loadSessionInvitations();
            loadSessions(currentPage);
            window.location.href = `/api/schedules/sessions/${sessionId}/detail/`;
        } catch (error) {
            alert('承認に失敗しました: ' + (error.response?.data?.error || error.response?.data?.detail || error.message));
        }
    };

    window.declineSessionInvitation = async function(invitationId) {
        if (!confirm('この招待を辞退しますか？')) return;
        try {
            await axios.post(`/api/schedules/session-invitations/${invitationId}/decline/`);
            await loadSessionInvitations();
        } catch (error) {
            alert('辞退に失敗しました: ' + (error.response?.data?.error || error.response?.data?.detail || error.message));
        }
    };

    function escapeHtml(str) {
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    // セッション編集
    window.editSession = async function(sessionId) {
        currentSessionId = sessionId;
        try {
            const response = await axios.get(`/api/schedules/sessions/${sessionId}/`);
            const session = response.data;
            
            document.getElementById('editSessionId').value = session.id;
            document.getElementById('editSessionTitle').value = session.title;
            document.getElementById('editSessionDate').value = session.date ? session.date.slice(0, 16) : '';
            document.getElementById('editSessionDuration').value = session.duration_minutes;
            document.getElementById('editSessionStatus').value = session.status;
            document.getElementById('editSessionLocation').value = session.location || '';
            document.getElementById('editSessionYoutube').value = session.youtube_url || '';
            document.getElementById('editSessionDescription').value = session.description || '';
            
            new bootstrap.Modal(document.getElementById('editSessionModal')).show();
        } catch (error) {
            alert('セッション情報の読み込みに失敗しました');
        }
    };

    // セッション更新
    document.getElementById('updateSessionBtn').addEventListener('click', async function() {
        const data = {
            title: document.getElementById('editSessionTitle').value,
            date: document.getElementById('editSessionDate').value || null,
            duration_minutes: document.getElementById('editSessionDuration').value,
            status: document.getElementById('editSessionStatus').value,
            location: document.getElementById('editSessionLocation').value,
            youtube_url: document.getElementById('editSessionYoutube').value,
            description: document.getElementById('editSessionDescription').value
        };

        try {
            await axios.patch(`/api/schedules/sessions/${currentSessionId}/`, data);
            alert('セッションを更新しました');
            bootstrap.Modal.getInstance(document.getElementById('editSessionModal')).hide();
            loadSessions(currentPage);
        } catch (error) {
            alert('更新に失敗しました: ' + (error.response?.data?.detail || error.message));
        }
    });

    // 参加者管理
    window.manageParticipants = async function(sessionId) {
        currentSessionId = sessionId;
        const modal = new bootstrap.Modal(document.getElementById('participantsModal'));
        
        try {
            const response = await axios.get(`/api/schedules/sessions/${sessionId}/`);
            const session = response.data;
            
            const container = document.getElementById('participantsList');
            container.innerHTML = `
                <h6 class="mb-3">参加者一覧 (${session.participants_detail.length}人)</h6>
                ${session.participants_detail.map(p => `
                    <div class="participant-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${p.user_detail.nickname}</strong>
                                ${p.role === 'gm' ? '<span class="badge bg-primary ms-2">GM</span>' : ''}
                                ${p.character_name ? `<br><small class="text-muted">キャラクター: ${p.character_name}</small>` : ''}
                                ${p.character_sheet_url ? `<br><a href="${p.character_sheet_url}" target="_blank" class="character-sheet-link"><i class="fas fa-file-alt"></i> キャラクターシート</a>` : ''}
                            </div>
                            <div>
                                ${p.role !== 'gm' ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeParticipant(${sessionId}, ${p.id})">
                                        <i class="fas fa-user-minus"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
            
            modal.show();
        } catch (error) {
            alert('参加者情報の読み込みに失敗しました');
        }
    };

    // フィルター適用
    document.getElementById('applyFilter').addEventListener('click', function() {
        currentFilters = {
            status: document.getElementById('statusFilter').value,
            period: document.getElementById('periodFilter').value,
            role: document.getElementById('roleFilter').value
        };
        currentPage = 1;
        mySessionsPage = 1;

        // 現在アクティブなタブに応じてリロード
        const activeTab = document.querySelector('#sessionsTab .nav-link.active');
        if (activeTab && activeTab.id === 'my-sessions-tab') {
            loadMySessions(1);
        } else {
            loadSessions(1);
        }
    });

    // ページネーション更新（すべてのセッション用）
    function updatePagination(total, pageSize, page) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById('pagination');

        let html = '';

        if (totalPages > 1) {
            html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${page - 1}); return false;">前へ</a>
            </li>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || Math.abs(i - page) <= 2) {
                    html += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>`;
                }
            }

            html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${page + 1}); return false;">次へ</a>
            </li>`;
        }

        pagination.innerHTML = html;
    }

    // ページネーション更新（参加予定セッション用）
    function updateMySessionsPagination(total, pageSize, page) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById('mySessionsPagination');

        let html = '';

        if (totalPages > 1) {
            html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changeMySessionsPage(${page - 1}); return false;">前へ</a>
            </li>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || Math.abs(i - page) <= 2) {
                    html += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeMySessionsPage(${i}); return false;">${i}</a>
                    </li>`;
                }
            }

            html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changeMySessionsPage(${page + 1}); return false;">次へ</a>
            </li>`;
        }

        pagination.innerHTML = html;
    }

    // ページ変更（すべてのセッション用）
    window.changePage = function(page) {
        currentPage = page;
        loadSessions(page);
        window.scrollTo(0, 0);
    };

    // ページ変更（参加予定セッション用）
    window.changeMySessionsPage = function(page) {
        mySessionsPage = page;
        loadMySessions(page);
        window.scrollTo(0, 0);
    };

    // タブ切り替え時のイベント
    document.querySelectorAll('#sessionsTab .nav-link').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            if (event.target.id === 'my-sessions-tab') {
                loadMySessions(mySessionsPage);
            } else if (event.target.id === 'all-sessions-tab') {
                loadSessions(currentPage);
            }
        });
    });

    // 初期化 - 参加予定タブを最初に読み込み
    loadMySessions();
    loadSessionInvitations();
    loadStatistics();
});
</script>
{% endblock %}

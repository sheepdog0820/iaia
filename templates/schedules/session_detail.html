{% extends 'base.html' %}
{% load static %}

{% block title %}{{ session.title }} - セッション詳細{% endblock %}

{% block content %}
<div class="container">
    <!-- ヘッダー部分 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/">
                                    <i class="fas fa-home"></i> ホーム
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="/api/schedules/sessions/view/">
                                    <i class="fas fa-scroll"></i> セッション一覧
                                </a>
                            </li>
                            <li class="breadcrumb-item active">
                                <i class="fas fa-eye"></i> {{ session.title }}
                            </li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <button class="btn btn-outline-secondary"
                            type="button"
                            id="copyPublicSessionLinkBtn"
                            data-share-url="{{ public_session_url }}">
                        <i class="fas fa-link"></i> リンクをコピー
                    </button>
                    {% if session.scenario %}
                        {% if is_participant or can_join or is_gm %}
                            <button class="btn btn-outline-success"
                                    id="createCharacterFromScenario"
                                    data-scenario-id="{{ session.scenario.id }}"
                                    data-scenario-title="{{ session.scenario.title }}"
                                    data-scenario-system="{{ session.scenario.game_system }}"
                                    data-session-id="{{ session.id }}">
                                <i class="fas fa-user-plus"></i> 探索者作成
                            </button>
                        {% endif %}
                    {% endif %}
                    {% if can_invite and not is_public_view %}
                        <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#inviteMembersModal">
                            <i class="fas fa-user-plus"></i> 招待
                        </button>
                    {% endif %}
                    {% if can_edit %}
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editSessionModal">
                            <i class="fas fa-edit"></i> セッション編集
                        </button>
                    {% endif %}
                    {% if can_join %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#joinSessionModal">
                            <i class="fas fa-user-plus"></i> 参加申請
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- メイン情報 -->
        <div class="col-lg-8">
            <!-- セッション基本情報 -->
            <div class="card mb-4">
                <div class="card-header bg-primary">
                    <h3 class="mb-0 eldritch-font">
                        <i class="fas fa-scroll"></i> {{ session.title }}
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar"></i> 開催日程</h6>
                            {% if occurrences %}
                                <div class="mb-3" id="occurrencesList">
                                    {% for occ in occurrences %}
                                        <div class="border rounded p-2 mb-2" style="background-color: var(--secondary-bg);">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <span class="fw-semibold">{{ occ.start_at|date:"Y年m月d日 H:i" }}</span>
                                                    {% if occ.is_primary %}
                                                        <span class="badge bg-secondary ms-2">代表</span>
                                                    {% endif %}
                                                </div>
                                                {% if can_edit and not is_public_view %}
                                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="openOccurrenceModal({{ occ.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                            <div class="mt-1 small">
                                                <span class="text-muted">参加者:</span>
                                                {% if occ.participants.all %}
                                                    {% for attendee in occ.participants.all %}
                                                        <span class="badge bg-dark me-1">{{ attendee.nickname|default:attendee.username }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="text-muted">未設定</span>
                                                {% endif %}
                                            </div>
                                            <div class="mt-1 small">
                                                <span class="text-muted">内容:</span>
                                                {% if occ.content %}
                                                    {{ occ.content|linebreaksbr }}
                                                {% else %}
                                                    <span class="text-muted">なし</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {% if session.date %}
                                    <p class="mb-3">{{ session.date|date:"Y年m月d日 H:i" }}</p>
                                {% else %}
                                    <p class="mb-3"><span class="text-muted">未定</span></p>
                                {% endif %}
                            {% endif %}
                            {% if not is_public_view %}
                                {% if can_edit %}
                                    <div class="d-flex gap-2 flex-wrap mb-3">
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="openOccurrenceModal(null)">
                                            <i class="fas fa-plus"></i> 日程を追加
                                        </button>
                                        {% if not session.date %}
                                            <a class="btn btn-sm btn-outline-warning" href="/api/schedules/sessions/{{ session.id }}/date-poll/">
                                                <i class="fas fa-poll"></i> 日程募集
                                            </a>
                                            {% if open_date_poll %}
                                                <span class="badge bg-success align-self-center" data-testid="openDatePollBadge">募集中</span>
                                                <span class="text-muted small align-self-center">候補日: {{ open_date_poll.options.count }}</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                {% elif not session.date %}
                                    <div class="d-flex gap-2 flex-wrap align-items-center mb-3">
                                        <a class="btn btn-sm btn-outline-warning" href="/api/schedules/sessions/{{ session.id }}/date-poll/">
                                            <i class="fas fa-poll"></i> 日程募集
                                        </a>
                                        {% if open_date_poll %}
                                            <span class="badge bg-success" data-testid="openDatePollBadge">募集中</span>
                                            <span class="text-muted small">候補日: {{ open_date_poll.options.count }}</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endif %}

                            <h6><i class="fas fa-map-marker-alt"></i> 場所</h6>
                            <p class="mb-3">{{ session.location|default:"未設定" }}</p>

                            <h6><i class="fas fa-clock"></i> セッション時間</h6>
                            <p class="mb-3">
                                {% if session.duration_minutes %}
                                    {{ session.duration_minutes }}分
                                    {% if session.duration_minutes >= 60 %}
                                        (約{% widthratio session.duration_minutes 60 1 %}時間)
                                    {% endif %}
                                {% else %}
                                    未設定
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> GM</h6>
                            <p class="mb-3">
                                {% if session.gm.profile_image %}
                                    <img src="{{ session.gm.profile_image.url }}" alt="GM" 
                                         class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                {% else %}
                                    <i class="fas fa-user-circle me-2"></i>
                                {% endif %}
                                {{ session.gm.nickname|default:session.gm.username }}
                            </p>

                            <h6><i class="fas fa-flag"></i> ステータス</h6>
                            <p class="mb-3">
                                {% if session.status == 'planned' %}
                                    <span class="badge bg-primary fs-6"><i class="fas fa-clock"></i> 予定</span>
                                {% elif session.status == 'ongoing' %}
                                    <span class="badge bg-warning fs-6"><i class="fas fa-play"></i> 進行中</span>
                                {% elif session.status == 'completed' %}
                                    <span class="badge bg-success fs-6"><i class="fas fa-check"></i> 完了</span>
                                {% elif session.status == 'cancelled' %}
                                    <span class="badge bg-danger fs-6"><i class="fas fa-times"></i> キャンセル</span>
                                {% endif %}
                            </p>

                            <h6><i class="fas fa-eye"></i> 公開設定</h6>
                            <p class="mb-3">
                                {% if session.visibility == 'private' %}
                                    <span class="badge bg-secondary"><i class="fas fa-lock"></i> プライベート</span>
                                {% elif session.visibility == 'group' %}
                                    <span class="badge bg-info"><i class="fas fa-users"></i> グループ内</span>
                                {% elif session.visibility == 'public' %}
                                    <span class="badge bg-success"><i class="fas fa-globe"></i> 公開</span>
                                {% endif %}
                            </p>

                            {% if session.scenario %}
                            <h6><i class="fas fa-book"></i> シナリオ</h6>
                            <p class="mb-2">
                                <span class="fw-semibold">{{ session.scenario.title }}</span>
                                <span class="badge bg-secondary ms-2">{{ session.scenario.get_game_system_display }}</span>
                            </p>
                            <div class="border rounded p-2 mb-2" style="background-color: var(--secondary-bg);">
                                <div class="small text-muted mb-1"><i class="fas fa-align-left"></i> あらすじ</div>
                                {% if session.scenario.summary %}
                                    <div>{{ session.scenario.summary|linebreaks }}</div>
                                {% else %}
                                    <div class="text-muted small">未設定</div>
                                {% endif %}
                            </div>
                            <div class="small">
                                <div class="fw-semibold"><i class="fas fa-star"></i> 推奨技能</div>
                                <div class="text-muted">
                                    {% if session.scenario.recommended_skills %}
                                        {{ session.scenario.recommended_skills|linebreaksbr }}
                                    {% else %}
                                        未設定
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if session.youtube_url %}
                    <hr>
                    <h6><i class="fab fa-youtube"></i> YouTube配信</h6>
                    <p>
                        <a href="{{ session.youtube_url }}" target="_blank" class="btn btn-outline-danger">
                            <i class="fab fa-youtube"></i> 配信を見る
                        </a>
                    </p>
                    {% endif %}

                    {% if session.description %}
                    <hr>
                    <h6><i class="fas fa-scroll"></i> セッション概要</h6>
                    <div class="border rounded p-3" style="background-color: var(--secondary-bg);">
                        {{ session.description|linebreaks }}
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if is_participant or is_gm %}
            <!-- セッション画像（添付画像） -->
            <div class="card mb-4" id="sessionImagesCard">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-images"></i> セッション画像
                        <small class="ms-2 text-white-50">複数枚アップロード可</small>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                        <input type="file"
                               class="form-control"
                               id="sessionImagesInput"
                               accept="image/*"
                               multiple
                               style="max-width: 420px;">
                        <button type="button" class="btn btn-info text-white" id="uploadSessionImagesBtn">
                            <i class="fas fa-upload"></i> アップロード
                        </button>
                        <div class="text-muted small">最大10枚/1回</div>
                    </div>

                    <div class="row g-3" id="sessionImagesGrid">
                        {% for image in session.images.all %}
                            <div class="col-6 col-md-4">
                                <div class="session-image-tile">
                                    <a href="{{ image.image.url }}" target="_blank" rel="noopener noreferrer" class="d-block">
                                        <img src="{{ image.image.url }}"
                                             alt="{{ image.title|default:'セッション画像' }}"
                                             class="img-fluid rounded session-image-thumb"
                                             loading="lazy">
                                    </a>
                                    <div class="d-flex justify-content-between align-items-center gap-2 mt-2">
                                        <small class="text-muted text-truncate" title="{{ image.title|default:image.image.name }}">
                                            {{ image.title|default:image.image.name }}
                                        </small>
                                        {% if is_gm or image.uploaded_by_id == user.id %}
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger"
                                                    onclick="deleteSessionImage({{ image.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="col-12">
                                <p class="text-muted text-center mb-0">画像がありません</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- YouTube動画リンク（複数） -->
            <div class="card mb-4" id="youtubeLinksCard">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fab fa-youtube"></i> YouTube動画リンク
                        <small class="ms-2 text-white-50" id="youtubeLinksHeaderSummary"></small>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="youtubeLinksMessages"></div>

                    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                        <div class="badge bg-secondary" id="youtubeLinksCountBadge">読み込み中...</div>
                        <div class="badge bg-dark" id="youtubeLinksTotalDurationBadge"></div>
                    </div>

                    <div id="youtubeLinksContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border text-danger" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="accordion" id="youtubeLinksAddAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="youtubeLinksAddHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#youtubeLinksAddCollapse" aria-expanded="false" aria-controls="youtubeLinksAddCollapse">
                                    <i class="fas fa-plus me-2"></i> YouTubeリンクを追加
                                </button>
                            </h2>
                            <div id="youtubeLinksAddCollapse" class="accordion-collapse collapse" aria-labelledby="youtubeLinksAddHeading" data-bs-parent="#youtubeLinksAddAccordion">
                                <div class="accordion-body">
                                    <form id="youtubeLinkAddForm" class="mb-4">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="youtube_link_perspective" class="form-label">視点（任意）</label>
                                                <input type="text" class="form-control" id="youtube_link_perspective" placeholder="例: GM視点 / PL1視点 / 全体">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="youtube_link_part_number" class="form-label">パート番号（任意）</label>
                                                <input type="number" class="form-control" id="youtube_link_part_number" min="1" step="1" placeholder="例: 1">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="youtube_link_url" class="form-label">YouTube URL</label>
                                            <input type="url" class="form-control" id="youtube_link_url" required placeholder="https://www.youtube.com/watch?v=...">
                                        </div>
                                        <div class="mb-3">
                                            <label for="youtube_link_description" class="form-label">備考（任意）</label>
                                            <textarea class="form-control" id="youtube_link_description" rows="2" placeholder="この動画についてのメモ"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-danger" id="youtubeLinkAddBtn">
                                            <i class="fas fa-save"></i> 追加
                                        </button>
                                    </form>

                                    <h6 class="mb-3"><i class="fas fa-layer-group"></i> 分割動画をまとめて追加</h6>
                                    <form id="youtubeLinkBulkAddForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="youtube_bulk_perspective" class="form-label">視点（任意）</label>
                                                <input type="text" class="form-control" id="youtube_bulk_perspective" placeholder="例: GM視点 / PL1視点 / 全体">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="youtube_bulk_start_part" class="form-label">開始パート番号（任意）</label>
                                                <input type="number" class="form-control" id="youtube_bulk_start_part" min="1" step="1" placeholder="例: 1">
                                                <div class="form-text">指定すると、上から順にパート番号を自動で付与します</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="youtube_bulk_urls" class="form-label">YouTube URL（複数可）</label>
                                            <textarea class="form-control" id="youtube_bulk_urls" rows="4" placeholder="1行に1URL（または空白区切りでもOK）" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="youtube_bulk_description" class="form-label">備考（任意）</label>
                                            <textarea class="form-control" id="youtube_bulk_description" rows="2" placeholder="全ての動画に同じ備考を付けます（必要なら後で編集）"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-outline-danger" id="youtubeLinkBulkAddBtn">
                                            <i class="fas fa-upload"></i> まとめて追加
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- セッションノート / ログ（ISSUE-014） -->
            <div class="card mb-4" id="sessionNotesLogsCard">
                <div class="card-header bg-secondary text-white">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                        <h5 class="mb-0">
                            <i class="fas fa-sticky-note"></i> セッションノート / ログ
                        </h5>
                        <div class="d-flex align-items-center gap-2 small">
                            <span class="badge bg-dark" id="sessionNotesCountBadge">Notes: -</span>
                            <span class="badge bg-dark" id="sessionLogsCountBadge">Logs: -</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="notesLogsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="session-notes-tab" data-bs-toggle="tab" data-bs-target="#session-notes-pane" type="button" role="tab">
                                <i class="fas fa-sticky-note"></i> ノート
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="session-logs-tab" data-bs-toggle="tab" data-bs-target="#session-logs-pane" type="button" role="tab">
                                <i class="fas fa-stream"></i> ログ
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content pt-3" id="notesLogsTabContent">
                        <!-- Notes -->
                        <div class="tab-pane fade show active" id="session-notes-pane" role="tabpanel" aria-labelledby="session-notes-tab">
                            <div id="sessionNotesMessages"></div>

                            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                <div class="btn-group btn-group-sm" role="group" id="sessionNoteTypeFilters">
                                    <button type="button" class="btn btn-outline-primary active" data-note-type="all">全て</button>
                                    {% if is_gm %}
                                        <button type="button" class="btn btn-outline-primary" data-note-type="gm_private">GMプライベート</button>
                                        <button type="button" class="btn btn-outline-primary" data-note-type="public_summary">公開サマリー</button>
                                        <button type="button" class="btn btn-outline-primary" data-note-type="handover">引き継ぎ</button>
                                        <button type="button" class="btn btn-outline-primary" data-note-type="npc_memo">NPCメモ</button>
                                        <button type="button" class="btn btn-outline-primary" data-note-type="player_note">プレイヤーノート</button>
                                    {% else %}
                                        <button type="button" class="btn btn-outline-primary" data-note-type="public_summary">公開サマリー</button>
                                        <button type="button" class="btn btn-outline-primary" data-note-type="handover">引き継ぎ</button>
                                        <button type="button" class="btn btn-outline-primary" data-note-type="player_note">自分のノート</button>
                                    {% endif %}
                                </div>

                                <div class="ms-auto d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="reloadSessionNotesBtn">
                                        <i class="fas fa-sync"></i> 再読み込み
                                    </button>
                                    <button type="button" class="btn btn-primary btn-sm" id="openSessionNoteModalBtn">
                                        <i class="fas fa-plus"></i> ノート追加
                                    </button>
                                </div>
                            </div>

                            <div class="small text-muted mb-2" id="sessionNotesSummary"></div>

                            <div id="sessionNotesContainer">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Logs -->
                        <div class="tab-pane fade" id="session-logs-pane" role="tabpanel" aria-labelledby="session-logs-tab">
                            <div id="sessionLogsMessages"></div>

                            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                <div class="small text-muted" id="sessionLogsSummary"></div>
                                <div class="ms-auto d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="reloadSessionLogsBtn">
                                        <i class="fas fa-sync"></i> 再読み込み
                                    </button>
                                    <button type="button" class="btn btn-success btn-sm" id="openSessionLogModalBtn">
                                        <i class="fas fa-plus"></i> ログ追加
                                    </button>
                                </div>
                            </div>

                            <div id="sessionLogsContainer">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 参加者一覧 -->
            {% if is_public_view %}
            <div class="card mb-4">
                <div class="card-header bg-info">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> 参加者 ({{ participants.count }}人)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="badge bg-primary">GM</span>
                        <span class="ms-2">{{ session.gm.nickname|default:session.gm.username }}</span>
                    </div>

                    <div class="small text-muted mb-2">PL</div>
                    {% if participants %}
                        <div class="d-flex flex-wrap gap-2">
                            {% for participant in participants %}
                                {% if participant.role != 'gm' %}
                                    <span class="badge bg-secondary">{{ participant.user.nickname|default:participant.user.username }}</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">参加者がいません</p>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="card mb-4">
                <div class="card-header bg-info">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> 参加者一覧 ({{ participants.count }}人)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for participant in participants %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        {% if participant.user.profile_image %}
                                            <img src="{{ participant.user.profile_image.url }}" alt="プロフィール" 
                                                 class="rounded-circle me-3" style="width: 48px; height: 48px; object-fit: cover;">
                                        {% else %}
                                            <i class="fas fa-user-circle fa-3x me-3"></i>
                                        {% endif %}
                                        <div>
                                            <h6 class="mb-1">{{ participant.user.nickname|default:participant.user.username }}</h6>
                                            {% if participant.role == 'gm' %}
                                                <span class="badge bg-primary">GM</span>
                                            {% else %}
                                                <span class="badge bg-secondary">PL</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    {% if participant.character_name %}
                                    <p class="mb-2">
                                        <i class="fas fa-mask"></i> <strong>キャラクター:</strong> {{ participant.character_name }}
                                    </p>
                                    {% elif participant.character_sheet %}
                                    <p class="mb-2">
                                        <i class="fas fa-mask"></i> <strong>キャラクター:</strong> {{ participant.character_sheet.name }}
                                    </p>
                                    {% endif %}
                                    
                                    {% if participant.character_sheet %}
                                        <p class="mb-2 d-flex gap-2">
                                            <a href="{% url 'character_detail_6th' participant.character_sheet.id %}" class="btn btn-sm btn-outline-info flex-grow-1">
                                                <i class="fas fa-file-alt"></i> キャラクターシート
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                    onclick="copyUrl('{% url 'character_detail_6th' participant.character_sheet.id %}', 'キャラクターURL')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </p>
                                    {% elif participant.character_sheet_url %}
                                        <p class="mb-2 d-flex gap-2">
                                            <a href="{{ participant.character_sheet_url }}" target="_blank" class="btn btn-sm btn-outline-info flex-grow-1">
                                                <i class="fas fa-file-alt"></i> キャラクターシート
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                    onclick="copyUrl('{{ participant.character_sheet_url|escapejs }}', 'キャラクターURL')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </p>
                                    {% endif %}
                                    
                                    {% if is_gm and participant.role != 'gm' %}
                                    <div class="mt-2 d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="openCharacterLinkModal({{ participant.id }}, {{ participant.user.id }}, {{ participant.character_sheet_id|default:'null' }})">
                                            <i class="fas fa-link"></i> キャラクター設定
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="removeParticipant({{ participant.id }})">
                                            <i class="fas fa-user-minus"></i> 除名
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <p class="text-muted text-center">参加者がいません</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- サイドバー -->
        <div class="col-lg-4">
            <!-- グループ情報 -->
            <div class="card mb-4">
                <div class="card-header bg-secondary">
                    <h6 class="mb-0"><i class="fas fa-users"></i> グループ情報</h6>
                </div>
                <div class="card-body">
                    <h6>{{ session.group.name }}</h6>
                    {% if not is_public_view %}
                        {% if session.group.description %}
                            <p class="text-muted small">{{ session.group.description|truncatechars:100 }}</p>
                        {% endif %}
                    {% endif %}
                    <p class="mb-0">
                        <i class="fas fa-user"></i> メンバー: {{ session.group.members.count }}人
                    </p>
                </div>
            </div>

            <!-- ハンドアウト情報 -->
            {% if handouts or is_gm %}
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-scroll"></i> ハンドアウト情報
                        </h6>
                        {% if is_gm %}
                        <div class="btn-group btn-group-sm">
                            <a href="/api/schedules/sessions/{{ session.id }}/handouts/manage/" 
                               class="btn btn-outline-light">
                                <i class="fas fa-cogs"></i> 管理画面
                            </a>
                            <button class="btn btn-outline-light" 
                                    data-bs-toggle="modal" data-bs-target="#createHandoutModal">
                                <i class="fas fa-plus"></i> 作成
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if handouts %}
                        {% for handout in handouts %}
                        <div class="border rounded p-3 mb-3" style="background-color: var(--secondary-bg);">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1">
                                    {{ handout.title }}
                                    {% if handout.is_secret %}
                                        <i class="fas fa-eye-slash text-warning ms-1" title="秘匿情報"></i>
                                    {% endif %}
                                </h6>
                                {% if is_gm %}
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editHandout({{ handout.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteHandout({{ handout.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% if is_gm %}
                                <p class="small text-muted mb-2">
                                    <i class="fas fa-user"></i> {{ handout.participant.user.nickname|default:handout.participant.user.username }}
                                </p>
                            {% endif %}
                            {% if handout.recommended_skills %}
                                <p class="small text-muted mb-2">
                                    <strong>推奨技能:</strong>
                                    {{ handout.recommended_skills|linebreaksbr }}
                                </p>
                            {% endif %}
                            <div class="small">
                                {{ handout.content|linebreaks }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">ハンドアウトはありません</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- 管理メニュー -->
            {% if is_participant %}
            <div class="card">
                <div class="card-header bg-success">
                    <h6 class="mb-0"><i class="fas fa-cog"></i> 管理メニュー</h6>
                </div>
                <div class="card-body">
                    {% if user_participant %}
                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" 
                                data-bs-toggle="modal" data-bs-target="#editParticipantModal">
                            <i class="fas fa-edit"></i> 参加情報編集
                        </button>
                    {% endif %}
                    
                    {% if not is_gm %}
                        <button class="btn btn-outline-danger btn-sm w-100" 
                                onclick="leaveSession()">
                            <i class="fas fa-sign-out-alt"></i> セッション脱退
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- セッション編集モーダル -->
{% if can_edit %}
<div class="modal fade" id="editSessionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">セッション編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSessionForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="title" class="form-label">セッションタイトル</label>
                            <input type="text" class="form-control" id="title" value="{{ session.title }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="status" class="form-label">ステータス</label>
                            <select class="form-select" id="status">
                                <option value="planned" {% if session.status == 'planned' %}selected{% endif %}>予定</option>
                                <option value="ongoing" {% if session.status == 'ongoing' %}selected{% endif %}>進行中</option>
                                <option value="completed" {% if session.status == 'completed' %}selected{% endif %}>完了</option>
                                <option value="cancelled" {% if session.status == 'cancelled' %}selected{% endif %}>キャンセル</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">開催日時</label>
                            <input type="datetime-local" class="form-control" id="date" 
                                   value="{{ session.date|date:'Y-m-d\TH:i' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="duration_minutes" class="form-label">セッション時間（分）</label>
                            <input type="number" class="form-control" id="duration_minutes" 
                                   value="{{ session.duration_minutes }}" min="0" step="30">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="location" class="form-label">場所</label>
                            <input type="text" class="form-control" id="location" value="{{ session.location }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="visibility" class="form-label">公開設定</label>
                            <select class="form-select" id="visibility">
                                <option value="private" {% if session.visibility == 'private' %}selected{% endif %}>プライベート</option>
                                <option value="group" {% if session.visibility == 'group' %}selected{% endif %}>グループ内</option>
                                <option value="public" {% if session.visibility == 'public' %}selected{% endif %}>公開</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="youtube_url" class="form-label">YouTube配信URL</label>
                        <input type="url" class="form-control" id="youtube_url" value="{{ session.youtube_url }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">セッション概要</label>
                        <textarea class="form-control" id="description" rows="4">{{ session.description }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="updateSession()">
                    <i class="fas fa-save"></i> 更新
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if can_edit and not is_public_view %}
<div class="modal fade" id="occurrenceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">日程</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="occurrenceId">

                <div class="mb-3">
                    <label for="occurrenceStartAt" class="form-label">日時</label>
                    <input type="datetime-local" class="form-control" id="occurrenceStartAt" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">参加者</label>
                    <div id="occurrenceParticipants" class="border rounded p-2" style="min-height: 80px;">
                        <span class="text-muted small">読み込み中...</span>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="occurrenceContent" class="form-label">内容（任意）</label>
                    <textarea class="form-control" id="occurrenceContent" rows="4" placeholder="内容は空でも登録できます"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveOccurrence()">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 参加申請モーダル -->
{% if can_join %}
<div class="modal fade" id="joinSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">セッション参加申請</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="joinSessionForm">
                    <div class="mb-3">
                        <label for="character_name" class="form-label">キャラクター名</label>
                        <input type="text" class="form-control" id="character_name" 
                               placeholder="使用するキャラクター名を入力してください">
                    </div>
                    <div class="mb-3">
                        <label for="character_sheet_id" class="form-label">キャラクターシート（内部）</label>
                        <select class="form-select" id="character_sheet_id">
                            <option value="">選択しない</option>
                        </select>
                        <div class="form-text">登録済みのキャラクターから選択できます</div>
                    </div>
                    <div class="mb-3">
                        <label for="character_sheet_url" class="form-label">キャラクターシートURL</label>
                        <input type="url" class="form-control" id="character_sheet_url" 
                               placeholder="キャラクターシートのURLを入力してください">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="joinSession()">
                    <i class="fas fa-user-plus"></i> 参加申請
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 参加者招待モーダル -->
{% if can_invite and not is_public_view %}
<div class="modal fade" id="inviteMembersModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">参加者を招待</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">メンバー検索</label>
                    <input type="text" class="form-control" id="inviteMemberSearch" placeholder="ニックネーム/ユーザー名">
                </div>
                <div class="d-flex gap-2 mb-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllInviteCandidates(true)">全選択</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllInviteCandidates(false)">全解除</button>
                </div>
                <div id="inviteMembersList" class="border rounded p-2" style="max-height: 320px; overflow: auto;">
                    <span class="text-muted small">読み込み中...</span>
                </div>
                <div class="mt-3">
                    <label class="form-label">メッセージ（任意）</label>
                    <textarea class="form-control" id="inviteMessage" rows="2" placeholder="招待メッセージ"></textarea>
                </div>
                <div class="mt-3" id="inviteResults"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-primary" id="sendInvitesBtn" onclick="sendSessionInvitations()">
                    <i class="fas fa-paper-plane"></i> 招待を送信
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 参加情報編集モーダル -->
{% if user_participant %}
<div class="modal fade" id="editParticipantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">参加情報編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editParticipantForm">
                    <div class="mb-3">
                        <label for="edit_character_name" class="form-label">キャラクター名</label>
                        <input type="text" class="form-control" id="edit_character_name" 
                               value="{{ user_participant.character_name }}">
                    </div>
                    <div class="mb-3">
                        <label for="edit_character_sheet_id" class="form-label">キャラクターシート（内部）</label>
                        <select class="form-select" id="edit_character_sheet_id" data-selected="{{ user_participant.character_sheet_id|default:'' }}">
                            <option value="">選択しない</option>
                        </select>
                        <div class="form-text">登録済みのキャラクターから選択できます</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_character_sheet_url" class="form-label">キャラクターシートURL</label>
                        <input type="url" class="form-control" id="edit_character_sheet_url" 
                               value="{{ user_participant.character_sheet_url }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="updateParticipant()">
                    <i class="fas fa-save"></i> 更新
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if is_gm %}
<div class="modal fade" id="linkCharacterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">キャラクター設定</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="linkParticipantId">
                <input type="hidden" id="linkParticipantUserId">
                <div class="mb-3">
                    <label for="linkCharacterSelect" class="form-label">キャラクターシート</label>
                    <select class="form-select" id="linkCharacterSelect">
                        <option value="">選択してください</option>
                    </select>
                    <div class="form-text">公開キャラクターのみ選択可能です</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveLinkedCharacter()">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ハンドアウト作成モーダル -->
{% if is_gm %}
<div class="modal fade" id="createHandoutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ハンドアウト作成</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createHandoutForm">
                    <div class="mb-3">
                        <label for="handout_participant" class="form-label">対象参加者</label>
                        <select class="form-select" id="handout_participant" required>
                            <option value="">参加者を選択してください</option>
                            {% for participant in participants %}
                            <option value="{{ participant.id }}">{{ participant.user.nickname|default:participant.user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="handout_title" class="form-label">タイトル</label>
                        <input type="text" class="form-control" id="handout_title" required>
                    </div>
                    <div class="mb-3">
                        <label for="handout_content" class="form-label">内容</label>
                        <textarea class="form-control" id="handout_content" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="handout_recommended_skills" class="form-label">推奨技能</label>
                        <textarea class="form-control" id="handout_recommended_skills" rows="2" placeholder="例: 目星, 図書館"></textarea>
                        <small class="text-muted">カンマ/改行区切りで入力できます</small>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="handout_is_secret" checked>
                        <label class="form-check-label" for="handout_is_secret">
                            秘匿ハンドアウト（対象者のみ閲覧可能）
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="createHandout()">
                    <i class="fas fa-save"></i> 作成
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if is_participant or is_gm %}
<!-- セッションノート / ログ モーダル（ISSUE-014） -->
<div class="modal fade" id="sessionNoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sessionNoteModalTitle">
                    <i class="fas fa-sticky-note"></i> ノート
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="sessionNoteModalMessages"></div>
                <input type="hidden" id="sessionNoteId">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="sessionNoteType" class="form-label">種別</label>
                        <select class="form-select" id="sessionNoteType" {% if not is_gm %}disabled{% endif %}>
                            {% if is_gm %}
                                <option value="gm_private">GMプライベート</option>
                                <option value="public_summary">公開サマリー</option>
                                <option value="handover">引き継ぎ事項</option>
                                <option value="npc_memo">NPCメモ</option>
                                <option value="player_note">プレイヤーノート</option>
                            {% else %}
                                <option value="player_note">プレイヤーノート</option>
                            {% endif %}
                        </select>
                        {% if not is_gm %}
                            <div class="form-text">プレイヤーノートのみ作成できます（公開サマリー等はGMのみ）</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="sessionNoteTitle" class="form-label">タイトル（任意）</label>
                        <input type="text" class="form-control" id="sessionNoteTitle" maxlength="200" placeholder="例: 今回の要点 / 次回への宿題">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="sessionNoteContent" class="form-label">内容 *</label>
                    <textarea class="form-control" id="sessionNoteContent" rows="8" placeholder="ここにノートを書きます" required></textarea>
                </div>

                {% if is_gm %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sessionNotePinned">
                    <label class="form-check-label" for="sessionNotePinned">
                        ピン留め（上部に固定）
                    </label>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="saveSessionNoteBtn">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="sessionLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sessionLogModalTitle">
                    <i class="fas fa-stream"></i> ログ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="sessionLogModalMessages"></div>
                <input type="hidden" id="sessionLogId">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="sessionLogTimestamp" class="form-label">日時</label>
                        <input type="datetime-local" class="form-control" id="sessionLogTimestamp" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="sessionLogEventType" class="form-label">種別</label>
                        <input type="text" class="form-control" id="sessionLogEventType" list="sessionLogEventTypeOptions" placeholder="general / battle / clue ...">
                        <datalist id="sessionLogEventTypeOptions">
                            <option value="general"></option>
                            <option value="battle"></option>
                            <option value="clue"></option>
                            <option value="npc"></option>
                            <option value="scene"></option>
                            <option value="san"></option>
                            <option value="hp"></option>
                            <option value="mp"></option>
                        </datalist>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="sessionLogRelatedCharacter" class="form-label">関連キャラクター（任意）</label>
                    <select class="form-select" id="sessionLogRelatedCharacter">
                        <option value="">なし</option>
                        {% for participant in participants %}
                            {% if participant.character_sheet %}
                                <option value="{{ participant.character_sheet.id }}">
                                    {{ participant.character_sheet.name }}（{{ participant.user.nickname|default:participant.user.username }}）
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <div class="form-text">セッション参加者として紐付いているキャラクターのみ選択できます</div>
                </div>

                <div class="mb-3">
                    <label for="sessionLogDescription" class="form-label">内容 *</label>
                    <textarea class="form-control" id="sessionLogDescription" rows="8" placeholder="例: 目星に成功して手がかりを発見 / SANチェック(1/1d6)" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-success" id="saveSessionLogBtn">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- YouTubeリンク編集モーダル -->
<div class="modal fade" id="editYouTubeLinkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fab fa-youtube"></i> YouTubeリンク編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_youtube_link_id">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="edit_youtube_link_perspective" class="form-label">視点（任意）</label>
                        <input type="text" class="form-control" id="edit_youtube_link_perspective" placeholder="例: GM視点 / PL1視点 / 全体">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="edit_youtube_link_part_number" class="form-label">パート番号（任意）</label>
                        <input type="number" class="form-control" id="edit_youtube_link_part_number" min="1" step="1" placeholder="例: 1">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="edit_youtube_link_description" class="form-label">備考（任意）</label>
                    <textarea class="form-control" id="edit_youtube_link_description" rows="3"></textarea>
                </div>

                <div class="form-text">
                    タイトル/時間/サムネはYouTubeから自動取得されます。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="saveYouTubeLinkBtn" onclick="saveYouTubeLinkEdits()">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.card-header.bg-primary {
    background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%) !important;
    color: white !important;
}

.card-header.bg-info {
    background: linear-gradient(135deg, var(--accent-info) 0%, #0891b2 100%) !important;
    color: white !important;
}

.card-header.bg-secondary {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
    color: white !important;
}

.card-header.bg-warning {
    background: linear-gradient(135deg, var(--accent-warning) 0%, #d97706 100%) !important;
    color: white !important;
}

.card-header.bg-success {
    background: linear-gradient(135deg, var(--accent-success) 0%, #059669 100%) !important;
    color: white !important;
}

.card-header.bg-danger {
    background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%) !important;
    color: white !important;
}

.badge.fs-6 {
    font-size: 1rem !important;
    padding: 0.5em 0.75em;
}

.youtube-link-item {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
}

.youtube-link-thumb {
    width: 140px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
}

.youtube-link-description {
    white-space: pre-wrap;
}

.session-image-tile {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 0.5rem;
}

.session-image-thumb {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border: 1px solid var(--border-color);
    background-color: var(--secondary-bg);
}

.session-image-tile a:hover .session-image-thumb {
    filter: brightness(0.95);
}

.breadcrumb {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 0.75rem 1rem;
}

.breadcrumb-item a {
    color: var(--accent-primary);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
    color: var(--accent-secondary);
}

.breadcrumb-item.active {
    color: var(--text-primary);
}

.breadcrumb-item + .breadcrumb-item::before {
    color: var(--text-muted);
}

/* 背景と文字色のコントラスト修正 */
.modal-content {
    background: var(--card-bg) !important;
    color: var(--text-primary) !important;
}

.modal-header {
    background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%) !important;
    color: white !important;
    border-bottom: 1px solid var(--border-color);
}

.modal-footer {
    background: var(--secondary-bg) !important;
    border-top: 1px solid var(--border-color);
}

.form-control, .form-select {
    background-color: var(--secondary-bg) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-primary) !important;
}

.form-control:focus, .form-select:focus {
    background-color: var(--card-bg) !important;
    border-color: var(--accent-primary) !important;
    color: var(--text-primary) !important;
    box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
}

.form-control::placeholder {
    color: var(--text-muted) !important;
}

.form-label {
    color: var(--text-primary) !important;
    font-weight: 500;
}

.form-check-input {
    background-color: var(--secondary-bg);
    border-color: var(--border-color);
}

.form-check-input:checked {
    background-color: var(--accent-primary);
    border-color: var(--accent-primary);
}

.form-check-label {
    color: var(--text-primary);
}

/* テーブル要素の修正 */
.table-dark {
    --bs-table-bg: var(--secondary-bg);
    --bs-table-border-color: var(--border-color);
    --bs-table-color: var(--text-primary);
}

/* ボタンのコントラスト改善 */
.btn-outline-primary {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
    background: transparent;
}

.btn-outline-primary:hover {
    background-color: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
}

.btn-outline-secondary {
    border-color: var(--border-color);
    color: var(--text-secondary);
    background: transparent;
}

.btn-outline-secondary:hover {
    background-color: var(--border-color);
    border-color: var(--border-color);
    color: var(--text-primary);
}

.btn-outline-danger {
    border-color: var(--accent-danger);
    color: var(--accent-danger);
    background: transparent;
}

.btn-outline-danger:hover {
    background-color: var(--accent-danger);
    border-color: var(--accent-danger);
    color: white;
}

.btn-outline-info {
    border-color: var(--accent-info);
    color: var(--accent-info);
    background: transparent;
}

.btn-outline-info:hover {
    background-color: var(--accent-info);
    border-color: var(--accent-info);
    color: white;
}

/* アラートスタイル */
.alert-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--accent-success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.alert-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--accent-danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.alert-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--accent-warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.alert-info {
    background: rgba(6, 182, 212, 0.1);
    color: var(--accent-info);
    border: 1px solid rgba(6, 182, 212, 0.3);
}

/* バッジのコントラスト改善 */
.badge.bg-info {
    background: var(--accent-info) !important;
    color: white !important;
}

.badge.bg-primary {
    background: var(--accent-primary) !important;
    color: white !important;
}

.badge.bg-success {
    background: var(--accent-success) !important;
    color: white !important;
}

.badge.bg-warning {
    background: var(--accent-warning) !important;
    color: white !important;
}

.badge.bg-danger {
    background: var(--accent-danger) !important;
    color: white !important;
}

.badge.bg-secondary {
    background: #6b7280 !important;
    color: white !important;
}

/* カード内の要素のコントラスト */
.card-body h6 {
    color: var(--text-primary);
    font-weight: 600;
}

.card-body p {
    color: var(--text-primary);
}

.card-body .text-muted {
    color: var(--text-muted) !important;
}

.card-body .small {
    color: var(--text-secondary);
}

/* リンクのコントラスト */
a {
    color: var(--accent-primary);
}

a:hover {
    color: var(--accent-secondary);
}

.text-decoration-none {
    text-decoration: none !important;
}

.text-decoration-none:hover {
    text-decoration: underline !important;
}

</style>
{% endblock %}

{% block extra_js %}
<script>
let characterSheets = [];
const characterSheetMap = new Map();
let groupMemberCharacters = new Map();
let groupMemberNames = new Map();
const SESSION_ID = {{ session.id }};
const GROUP_ID = {{ session.group.id }};
const IS_GM = {% if is_gm %}true{% else %}false{% endif %};
const CAN_INVITE = {% if can_invite %}true{% else %}false{% endif %};
const IS_PARTICIPANT = {% if is_participant %}true{% else %}false{% endif %};
const IS_PUBLIC_VIEW = {% if is_public_view %}true{% else %}false{% endif %};
const PUBLIC_SESSION_URL = "{{ public_session_url|escapejs }}";
const youtubeLinkMap = new Map();

const SESSION_EXISTING_MEMBER_IDS = new Set([
    {{ session.gm.id }},
    {% for participant in participants %}{{ participant.user.id }},{% endfor %}
]);

function formatPollDateTime(value) {
    if (!value) return '';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return String(value);
    return date.toLocaleString('ja-JP');
}

function getMyPollVote(option) {
    const currentUserId = window.CURRENT_USER?.id;
    if (!currentUserId || !option?.votes) return null;
    return option.votes.find(vote => vote.user === currentUserId) || null;
}

function renderDatePollCreateForm() {
    if (!IS_GM) {
        return '<span class="text-muted small">GMが日程募集を開始するまでお待ちください。</span>';
    }

    return `
        <div class="mb-3">
            <label class="form-label">タイトル</label>
            <input type="text" class="form-control" id="datePollCreateTitle" value="日程募集" required>
        </div>
        <div class="mb-3">
            <label class="form-label">説明</label>
            <textarea class="form-control" id="datePollCreateDescription" rows="2" placeholder="任意"></textarea>
        </div>
        <div class="mb-2 d-flex justify-content-between align-items-center">
            <span class="fw-bold">候補日</span>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addDatePollCreateOptionRow()">
                <i class="fas fa-plus"></i> 追加
            </button>
        </div>
        <div id="datePollCreateOptions" class="mb-3"></div>
        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-sm btn-primary" onclick="createDatePollForSession()">
                <i class="fas fa-save"></i> 日程募集を作成
            </button>
        </div>
    `;
}

function addDatePollCreateOptionRow(initial = {}) {
    const container = document.getElementById('datePollCreateOptions');
    if (!container) return;
    const row = document.createElement('div');
    row.className = 'row g-2 mb-2 date-poll-option-row';
    row.innerHTML = `
        <div class="col-md-6">
            <input type="datetime-local" class="form-control form-control-sm date-poll-option-datetime" value="${escapeHtml(initial.datetime || '')}" required>
        </div>
        <div class="col-md-5">
            <input type="text" class="form-control form-control-sm date-poll-option-note" value="${escapeHtml(initial.note || '')}" placeholder="備考（任意）">
        </div>
        <div class="col-md-1 d-grid">
            <button type="button" class="btn btn-sm btn-outline-danger" title="削除" onclick="this.closest('.date-poll-option-row')?.remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    container.appendChild(row);
}

async function loadDatePollSection() {
    const container = document.getElementById('datePollContainer');
    if (!container || IS_PUBLIC_VIEW) return;

    container.innerHTML = '<span class="text-muted small">読み込み中...</span>';

    try {
        const response = await axios.get('/api/schedules/date-polls/', {
            params: { session_id: SESSION_ID },
        });

        const polls = Array.isArray(response.data) ? response.data : [];
        const poll = polls.find(p => !p.is_closed) || polls[0] || null;

        if (!poll) {
            container.innerHTML = renderDatePollCreateForm();
            addDatePollCreateOptionRow();
            return;
        }

        const statusBadgeClass = (status) => {
            if (status === 'available') return 'bg-success';
            if (status === 'maybe') return 'bg-warning text-dark';
            if (status === 'unavailable') return 'bg-danger';
            return 'bg-secondary';
        };

        const getVoterName = (vote) => vote?.user_detail?.nickname || vote?.user_detail?.username || '';

        const renderVoteDetails = (option) => {
            const votes = Array.isArray(option?.votes) ? option.votes : [];
            if (votes.length === 0) return '';

            const byStatus = {
                available: [],
                maybe: [],
                unavailable: [],
            };

            for (const vote of votes) {
                if (!vote?.status || !(vote.status in byStatus)) continue;
                const name = getVoterName(vote);
                if (name) byStatus[vote.status].push(name);
            }

            const renderLine = (status, label, badgeClass) => {
                const names = byStatus[status] || [];
                const namesHtml = names.length
                    ? names.map(n => `<span class="badge bg-secondary me-1">${escapeHtml(n)}</span>`).join('')
                    : '<span class="text-muted small">なし</span>';
                return `<div class="mb-1"><span class="badge ${badgeClass} me-2">${label}</span>${namesHtml}</div>`;
            };

            return `
                <details class="mt-2">
                    <summary class="small text-muted">投票詳細</summary>
                    <div class="small mt-2">
                        ${renderLine('available', '◯', 'bg-success')}
                        ${renderLine('maybe', '△', 'bg-warning text-dark')}
                        ${renderLine('unavailable', '✕', 'bg-danger')}
                    </div>
                </details>
            `;
        };

        const options = Array.isArray(poll.options) ? poll.options : [];
        const rowsHtml = options.map(option => {
            const myVote = getMyPollVote(option);
            const myStatus = myVote?.status || '';

            const voteButton = (status, label, btnClass) => {
                const active = myStatus === status ? '' : '-outline';
                const disabled = poll.is_closed ? 'disabled' : '';
                return `
                    <button type="button" class="btn btn${active}-${btnClass}" ${disabled} onclick="voteDatePollOption(${poll.id}, ${option.id}, '${status}')">
                        ${label}
                    </button>
                `;
            };

            const isSelected = poll.selected_date
                ? new Date(option.datetime).getTime() === new Date(poll.selected_date).getTime()
                : false;

            const myVoteHtml = myVote
                ? `<span class="badge ${statusBadgeClass(myVote.status)}">${escapeHtml(myVote.status_display)}</span>`
                : '<span class="text-muted small">未投票</span>';

            return `
                <tr>
                    <td>
                        <div class="fw-semibold">
                            ${formatPollDateTime(option.datetime)}
                            ${isSelected ? '<span class="badge bg-success ms-2">確定</span>' : ''}
                        </div>
                        ${option.note ? `<div class="text-muted small">${escapeHtml(option.note)}</div>` : ''}
                    </td>
                    <td>
                        <div class="mb-1">
                            <span class="badge bg-success me-1">◯ ${option.available_count}</span>
                            <span class="badge bg-warning text-dark me-1">△ ${option.maybe_count}</span>
                            <span class="badge bg-danger">✕ ${option.unavailable_count}</span>
                        </div>
                        <div class="small">あなた: ${myVoteHtml}</div>
                        ${renderVoteDetails(option)}
                    </td>
                    <td class="text-end">
                        <div class="d-flex justify-content-end gap-2 flex-wrap">
                            <div class="btn-group btn-group-sm" role="group" aria-label="vote">
                                ${voteButton('available', '◯', 'success')}
                                ${voteButton('maybe', '△', 'warning')}
                                ${voteButton('unavailable', '✕', 'danger')}
                            </div>
                            ${IS_GM && !poll.is_closed ? `
                                <button type="button" class="btn btn-sm btn-primary" onclick="confirmDatePollOption(${poll.id}, ${option.id})">
                                    <i class="fas fa-check"></i> 確定
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        const optionsHtml = options.length ? `
            <div class="table-responsive">
                <table class="table table-dark table-striped table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="min-width: 220px;">候補日</th>
                            <th style="min-width: 220px;">投票状況</th>
                            <th class="text-end" style="min-width: 220px;">投票</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsHtml}
                    </tbody>
                </table>
            </div>
        ` : '<div class="text-muted small">候補日がありません。追加してください。</div>';

        const addOptionHtml = poll.is_closed ? '' : `
            <div class="mt-3 border-top pt-3">
                <div class="mb-2 fw-bold">候補日を追加</div>
                <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label small mb-1">日時</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="datePollAddDatetime">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small mb-1">備考（任意）</label>
                        <input type="text" class="form-control form-control-sm" id="datePollAddNote">
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addDatePollOption(${poll.id})">
                            <i class="fas fa-plus"></i> 追加
                        </button>
                    </div>
                </div>
            </div>
        `;

        const pollStateBadge = poll.is_closed
            ? '<span class="badge bg-secondary ms-2">締切</span>'
            : '<span class="badge bg-success ms-2">募集中</span>';

        const deadlineHtml = poll.deadline
            ? `<div class="text-muted small">締切: ${formatPollDateTime(poll.deadline)}</div>`
            : '';

        const closedHtml = poll.is_closed ? `
            <div class="alert alert-info py-2 mt-3 mb-0">
                確定日: <strong>${poll.selected_date ? formatPollDateTime(poll.selected_date) : '未設定'}</strong>
            </div>
        ` : '';

        container.innerHTML = `
            <div class="mb-2">
                <div class="fw-bold">${escapeHtml(poll.title || '日程募集')}${pollStateBadge}</div>
                ${poll.description ? `<div class="text-muted small">${escapeHtml(poll.description)}</div>` : ''}
                ${deadlineHtml}
            </div>
            ${optionsHtml}
            ${addOptionHtml}
            ${closedHtml}
        `;
    } catch (error) {
        container.innerHTML = '<span class="text-danger small">日程募集の読み込みに失敗しました。</span>';
        console.error('Failed to load date poll:', error);
    }
}

window.createDatePollForSession = async function() {
    if (!IS_GM) return;
    const title = document.getElementById('datePollCreateTitle')?.value?.trim() || '日程募集';
    const description = document.getElementById('datePollCreateDescription')?.value || '';
    const optionRows = Array.from(document.querySelectorAll('#datePollCreateOptions .date-poll-option-row'));
    const options = optionRows.map(row => {
        const datetime = row.querySelector('.date-poll-option-datetime')?.value;
        const note = row.querySelector('.date-poll-option-note')?.value || '';
        return { datetime, note };
    }).filter(opt => opt.datetime);

    if (options.length === 0) {
        alert('候補日を1つ以上入力してください');
        return;
    }

    const payload = {
        title,
        description,
        group: GROUP_ID,
        session: SESSION_ID,
        create_session_on_confirm: false,
        options,
    };

    try {
        await axios.post('/api/schedules/date-polls/', payload, { headers: { 'Content-Type': 'application/json' } });
        await loadDatePollSection();
    } catch (error) {
        alert('日程募集の作成に失敗しました: ' + (error.response?.data?.detail || error.response?.data?.session || error.response?.data?.group || error.message));
    }
};

window.addDatePollOption = async function(pollId) {
    const datetime = document.getElementById('datePollAddDatetime')?.value;
    const note = document.getElementById('datePollAddNote')?.value || '';
    if (!datetime) {
        alert('日時を入力してください');
        return;
    }
    try {
        await axios.post(`/api/schedules/date-polls/${encodeURIComponent(pollId)}/add_option/`, { datetime, note });
        await loadDatePollSection();
    } catch (error) {
        alert('候補日の追加に失敗しました: ' + (error.response?.data?.detail || error.response?.data?.datetime || error.message));
    }
};

window.voteDatePollOption = async function(pollId, optionId, status) {
    try {
        await axios.post(
            `/api/schedules/date-polls/${encodeURIComponent(pollId)}/vote/`,
            { votes: [{ option_id: optionId, status, comment: '' }] },
            { headers: { 'Content-Type': 'application/json' } },
        );
        await loadDatePollSection();
    } catch (error) {
        alert('投票に失敗しました: ' + (error.response?.data?.detail || error.response?.data?.error || error.message));
    }
};

window.confirmDatePollOption = async function(pollId, optionId) {
    if (!IS_GM) return;
    if (!confirm('この候補日で確定しますか？')) return;
    try {
        await axios.post(
            `/api/schedules/date-polls/${encodeURIComponent(pollId)}/confirm/`,
            { option_id: optionId },
            { headers: { 'Content-Type': 'application/json' } },
        );
        location.reload();
    } catch (error) {
        alert('確定に失敗しました: ' + (error.response?.data?.detail || error.response?.data?.error || error.message));
    }
};

let sessionNotes = [];
const sessionNoteMap = new Map();
let sessionLogs = [];
const sessionLogMap = new Map();
let currentSessionNoteFilter = 'all';

function toAbsoluteUrl(url) {
    if (!url) return '';
    if (url.startsWith('http://') || url.startsWith('https://')) return url;
    return window.location.origin + url;
}

async function copyTextToClipboard(text) {
    if (!text) return;
    if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
        return;
    }

    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.setAttribute('readonly', '');
    textarea.style.position = 'absolute';
    textarea.style.left = '-9999px';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
}

async function copyUrl(url, label = 'リンク') {
    const resolvedUrl = toAbsoluteUrl(url);
    try {
        await copyTextToClipboard(resolvedUrl);
        alert(`${label}をコピーしました`);
    } catch (error) {
        alert(`コピーに失敗しました。手動でコピーしてください: ${resolvedUrl}`);
    }
}

window.copyUrl = copyUrl;

let occurrenceGroupMembersLoaded = false;
let occurrenceGroupMembers = [];

function toDateTimeLocalValue(value) {
    const date = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(date.getTime())) return '';
    const pad = (num) => String(num).padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}` +
        `T${pad(date.getHours())}:${pad(date.getMinutes())}`;
}

async function ensureOccurrenceGroupMembers() {
    if (occurrenceGroupMembersLoaded) return;
    if (IS_PUBLIC_VIEW) return;

    const container = document.getElementById('occurrenceParticipants');
    if (container) {
        container.innerHTML = '<span class="text-muted small">読み込み中...</span>';
    }

    try {
        const response = await axios.get(`/api/accounts/groups/${GROUP_ID}/members/`);
        occurrenceGroupMembers = response.data || [];
        occurrenceGroupMembersLoaded = true;
    } catch (error) {
        console.error('Failed to load group members:', error);
        if (container) {
            container.innerHTML = '<span class="text-muted small">参加者の取得に失敗しました</span>';
        }
    }
}

function renderOccurrenceParticipants(selectedIds) {
    const container = document.getElementById('occurrenceParticipants');
    if (!container) return;

    const selected = new Set((selectedIds || []).map(id => parseInt(id, 10)));
    const html = occurrenceGroupMembers.map(member => {
        const userId = parseInt(member.user, 10);
        const name = member.user_detail?.nickname || member.user_detail?.username || String(userId);
        const checked = selected.has(userId) ? 'checked' : '';
        return `
            <label class="d-flex align-items-center gap-2 mb-1">
                <input type="checkbox" class="form-check-input" value="${userId}" ${checked}>
                <span>${name}</span>
            </label>
        `;
    }).join('');

    container.innerHTML = html || '<span class="text-muted small">参加可能なメンバーがいません</span>';
}

async function openOccurrenceModal(occurrenceId) {
    if (IS_PUBLIC_VIEW || !IS_GM) return;

    const modalEl = document.getElementById('occurrenceModal');
    if (!modalEl) return;

    const idInput = document.getElementById('occurrenceId');
    const startInput = document.getElementById('occurrenceStartAt');
    const contentInput = document.getElementById('occurrenceContent');

    if (!idInput || !startInput || !contentInput) return;

    idInput.value = occurrenceId ? String(occurrenceId) : '';
    contentInput.value = '';

    await ensureOccurrenceGroupMembers();

    let selectedParticipants = [];
    if (occurrenceId) {
        try {
            const response = await axios.get(`/api/schedules/occurrences/${encodeURIComponent(occurrenceId)}/`);
            const occurrence = response.data;
            startInput.value = toDateTimeLocalValue(occurrence.start_at);
            contentInput.value = occurrence.content || '';
            selectedParticipants = occurrence.participants || [];
        } catch (error) {
            alert('日程の取得に失敗しました: ' + (error.response?.data?.detail || error.message));
            return;
        }
    } else {
        startInput.value = toDateTimeLocalValue(new Date());
    }

    renderOccurrenceParticipants(selectedParticipants);

    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

window.openOccurrenceModal = openOccurrenceModal;

async function saveOccurrence() {
    if (IS_PUBLIC_VIEW || !IS_GM) return;

    const id = document.getElementById('occurrenceId')?.value?.trim();
    const startAt = document.getElementById('occurrenceStartAt')?.value;
    const content = document.getElementById('occurrenceContent')?.value || '';
    const participantIds = Array.from(document.querySelectorAll('#occurrenceParticipants input[type=\"checkbox\"]:checked'))
        .map(input => parseInt(input.value, 10))
        .filter(idValue => Number.isFinite(idValue));

    if (!startAt) {
        alert('日時を入力してください');
        return;
    }

    const payload = {
        session: SESSION_ID,
        start_at: startAt,
        content,
        participants: participantIds,
    };

    try {
        if (id) {
            await axios.patch(`/api/schedules/occurrences/${encodeURIComponent(id)}/`, payload);
        } else {
            await axios.post('/api/schedules/occurrences/', payload);
        }
        location.reload();
    } catch (error) {
        alert('日程の保存に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

window.saveOccurrence = saveOccurrence;

function setupCopyPublicSessionLinkButton() {
    const button = document.getElementById('copyPublicSessionLinkBtn');
    if (!button) return;

    button.addEventListener('click', async () => {
        const shareUrl = button.dataset.shareUrl || PUBLIC_SESSION_URL;
        if (!shareUrl) return;

        await copyUrl(shareUrl, 'リンク');
    });
}

function safeSetScenarioStorage(key, value) {
    try {
        localStorage.setItem(key, value);
    } catch (_) {
        // ignore storage errors
    }
}

const createCharacterBtn = document.getElementById('createCharacterFromScenario');
if (createCharacterBtn) {
    createCharacterBtn.addEventListener('click', () => {
        const scenarioId = createCharacterBtn.dataset.scenarioId || '';
        const scenarioTitle = createCharacterBtn.dataset.scenarioTitle || '';
        const scenarioSystem = createCharacterBtn.dataset.scenarioSystem || '';
        const sessionId = createCharacterBtn.dataset.sessionId || '';
        if (!scenarioId) {
            alert('シナリオ情報が取得できませんでした。');
            return;
        }

        safeSetScenarioStorage('scenario_recommended_skills_id', scenarioId);
        safeSetScenarioStorage('scenario_recommended_skills_title', scenarioTitle);
        safeSetScenarioStorage('scenario_recommended_skills_system', scenarioSystem);

        const params = new URLSearchParams({
            scenario_id: scenarioId,
            scenario_title: scenarioTitle,
            game_system: scenarioSystem,
            session_id: sessionId
        });
        window.location.href = `/accounts/character/create/6th/?${params.toString()}`;
    });
}

async function loadCharacterSheets() {
    try {
        const response = await axios.get('/api/accounts/character-sheets/');
        characterSheets = response.data || [];
        characterSheetMap.clear();
        characterSheets.forEach(sheet => {
            characterSheetMap.set(String(sheet.id), sheet);
        });

        populateCharacterSelect('character_sheet_id');
        populateCharacterSelect('edit_character_sheet_id');
        bindCharacterNameAutoFill('character_sheet_id', 'character_name');
        bindCharacterNameAutoFill('edit_character_sheet_id', 'edit_character_name');
    } catch (error) {
        console.error('キャラクターシートの取得に失敗しました:', error);
    }
}

function populateCharacterSelect(selectId) {
    const selectEl = document.getElementById(selectId);
    if (!selectEl) return;

    const selected = selectEl.dataset.selected || '';
    selectEl.innerHTML = '<option value="">選択しない</option>' +
        characterSheets.map(sheet => (
            `<option value="${sheet.id}">${sheet.name}</option>`
        )).join('');

    if (selected) {
        selectEl.value = selected;
    }
}

function bindCharacterNameAutoFill(selectId, inputId) {
    const selectEl = document.getElementById(selectId);
    const inputEl = document.getElementById(inputId);
    if (!selectEl || !inputEl) return;

    selectEl.addEventListener('change', () => {
        if (inputEl.value.trim()) return;
        const sheet = characterSheetMap.get(selectEl.value);
        if (sheet && sheet.name) {
            inputEl.value = sheet.name;
        }
    });
}

async function loadGroupMemberCharacters() {
    {% if is_gm %}
    try {
        const response = await axios.get('/api/accounts/groups/{{ session.group.id }}/member_characters/');
        const data = response.data || [];
        groupMemberCharacters = new Map();
        groupMemberNames = new Map();

        data.forEach(member => {
            groupMemberNames.set(String(member.user_id), member.nickname || member.username);
            groupMemberCharacters.set(String(member.user_id), member.characters || []);
        });
    } catch (error) {
        console.error('グループメンバーのキャラクター取得に失敗しました:', error);
    }
    {% endif %}
}

// セッション更新
async function updateSession() {
    const data = {
        title: document.getElementById('title').value,
        date: document.getElementById('date').value || null,
        duration_minutes: document.getElementById('duration_minutes').value,
        location: document.getElementById('location').value,
        visibility: document.getElementById('visibility').value,
        youtube_url: document.getElementById('youtube_url').value,
        description: document.getElementById('description').value,
        status: document.getElementById('status').value
    };

    try {
        const response = await axios.patch(`/api/schedules/sessions/{{ session.id }}/`, data);
        alert('セッション情報を更新しました');
        location.reload();
    } catch (error) {
        alert('更新に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

// セッション画像アップロード（複数）
async function uploadSessionImages() {
    const inputEl = document.getElementById('sessionImagesInput');
    const uploadBtn = document.getElementById('uploadSessionImagesBtn');
    if (!inputEl || !uploadBtn) return;

    const files = Array.from(inputEl.files || []);
    if (files.length === 0) {
        alert('アップロードする画像を選択してください');
        return;
    }
    if (files.length > 10) {
        alert('一度にアップロードできるのは最大10枚です');
        return;
    }

    const formData = new FormData();
    formData.append('session_id', String(SESSION_ID));
    for (const file of files) {
        if (!file?.type?.startsWith('image/')) {
            alert(`画像以外のファイルが含まれています: ${file?.name || 'unknown'}`);
            return;
        }
        formData.append('images', file);
    }

    const originalHtml = uploadBtn.innerHTML;
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>アップロード中...';
    try {
        await axios.post('/api/schedules/session-images/bulk_upload/', formData);
        alert('画像をアップロードしました');
        location.reload();
    } catch (error) {
        alert('アップロードに失敗しました: ' + (error.response?.data?.error || error.response?.data?.detail || error.message));
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = originalHtml;
        inputEl.value = '';
    }
}

// セッション画像削除
async function deleteSessionImage(imageId) {
    if (!confirm('この画像を削除しますか？')) return;

    try {
        await axios.delete(`/api/schedules/session-images/${encodeURIComponent(imageId)}/`);
        alert('画像を削除しました');
        location.reload();
    } catch (error) {
        alert('削除に失敗しました: ' + (error.response?.data?.error || error.response?.data?.detail || error.message));
    }
}

function escapeHtml(value) {
    if (value === null || value === undefined) return '';
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function formatDurationSeconds(seconds) {
    const total = Number(seconds) || 0;
    const hours = Math.floor(total / 3600);
    const minutes = Math.floor((total % 3600) / 60);
    const secs = total % 60;

    if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    return `${minutes}:${String(secs).padStart(2, '0')}`;
}

function showYouTubeLinksMessage(message, type = 'info') {
    const container = document.getElementById('youtubeLinksMessages');
    if (!container) return;
    const safeMessage = escapeHtml(message);
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${safeMessage}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function buildYouTubeGroupKey(link) {
    const perspective = (link?.perspective || '').trim();
    return perspective || '（視点未設定）';
}

function canManageYouTubeLink(link) {
    const currentUserId = window.CURRENT_USER?.id;
    if (IS_GM) return true;
    if (!currentUserId) return false;
    return Number(link?.added_by) === Number(currentUserId);
}

function renderYouTubeLinks(links) {
    const container = document.getElementById('youtubeLinksContainer');
    if (!container) return;

    youtubeLinkMap.clear();
    (links || []).forEach(link => {
        if (link?.id !== undefined && link?.id !== null) {
            youtubeLinkMap.set(String(link.id), link);
        }
    });

    if (!links || links.length === 0) {
        container.innerHTML = '<p class="text-muted text-center mb-0">YouTubeリンクがありません</p>';
        return;
    }

    // グループ順: 最小order順（なければ作成順）
    const groupsMap = new Map();
    for (const link of links) {
        const key = buildYouTubeGroupKey(link);
        if (!groupsMap.has(key)) {
            groupsMap.set(key, []);
        }
        groupsMap.get(key).push(link);
    }

    const groups = Array.from(groupsMap.entries()).map(([key, groupLinks]) => {
        const minOrder = Math.min(...groupLinks.map(l => Number(l.order) || Number.MAX_SAFE_INTEGER));
        const totalDuration = groupLinks.reduce((sum, l) => sum + (Number(l.duration_seconds) || 0), 0);
        return { key, links: groupLinks, minOrder, totalDuration };
    }).sort((a, b) => (a.minOrder - b.minOrder) || a.key.localeCompare(b.key, 'ja'));

    const html = groups.map(group => {
        const sortedLinks = [...group.links].sort((a, b) => {
            const partA = a.part_number === null || a.part_number === undefined ? Number.MAX_SAFE_INTEGER : Number(a.part_number);
            const partB = b.part_number === null || b.part_number === undefined ? Number.MAX_SAFE_INTEGER : Number(b.part_number);
            if (partA !== partB) return partA - partB;
            const orderA = Number(a.order) || Number.MAX_SAFE_INTEGER;
            const orderB = Number(b.order) || Number.MAX_SAFE_INTEGER;
            if (orderA !== orderB) return orderA - orderB;
            return Number(a.id) - Number(b.id);
        });

        const groupTitle = escapeHtml(group.key);
        const groupMeta = `${sortedLinks.length}本 / 合計 ${formatDurationSeconds(group.totalDuration)}`;

        const items = sortedLinks.map(link => {
            const safeTitle = escapeHtml(link.title || '(タイトル未取得)');
            const safeUrl = escapeHtml(link.youtube_url || '#');
            const safeChannel = escapeHtml(link.channel_name || '');
            const duration = escapeHtml(link.duration_display || formatDurationSeconds(link.duration_seconds));
            const safeDescription = escapeHtml(link.description || '');
            const safePerspective = escapeHtml((link.perspective || '').trim());
            const partBadge = link.part_number ? `<span class="badge bg-dark">Part ${escapeHtml(link.part_number)}</span>` : '';
            const perspectiveBadge = safePerspective ? `<span class="badge bg-secondary">${safePerspective}</span>` : '';

            const thumbnailUrl = link.thumbnail_url || (link.video_id ? `https://i.ytimg.com/vi/${encodeURIComponent(link.video_id)}/hqdefault.jpg` : '');
            const thumbnailHtml = thumbnailUrl
                ? `<img src="${escapeHtml(thumbnailUrl)}" alt="thumbnail" class="youtube-link-thumb" loading="lazy">`
                : `<div class="youtube-link-thumb" style="background-color: var(--card-bg);"></div>`;

            const addedBy = link.added_by_detail?.nickname || link.added_by_detail?.username || '';
            const safeAddedBy = escapeHtml(addedBy);

            const manageButtons = canManageYouTubeLink(link) ? `
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="openEditYouTubeLinkModal(${link.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteYouTubeLink(${link.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            ` : '';

            return `
                <div class="youtube-link-item rounded p-2 mb-2">
                    <div class="d-flex gap-3 align-items-start">
                        <a href="${safeUrl}" target="_blank" rel="noopener noreferrer">
                            ${thumbnailHtml}
                        </a>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between gap-2">
                                <div>
                                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="fw-bold text-decoration-none">
                                        ${safeTitle}
                                    </a>
                                    <div class="text-muted small mt-1">
                                        ${safeChannel ? `${safeChannel} / ` : ''}${duration}
                                        ${safeAddedBy ? ` / 追加: ${safeAddedBy}` : ''}
                                    </div>
                                    <div class="mt-2 d-flex flex-wrap gap-2">
                                        ${perspectiveBadge}
                                        ${partBadge}
                                    </div>
                                </div>
                                <div>
                                    ${manageButtons}
                                </div>
                            </div>
                            ${safeDescription ? `<div class="youtube-link-description small mt-2">${safeDescription}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="fas fa-video"></i> ${groupTitle}
                    <small class="text-muted ms-2">${escapeHtml(groupMeta)}</small>
                </h6>
                ${items}
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

async function loadYouTubeLinks() {
    const container = document.getElementById('youtubeLinksContainer');
    if (!container) return;

    try {
        const response = await axios.get(`/api/schedules/sessions/${SESSION_ID}/youtube-links/`);
        renderYouTubeLinks(response.data || []);
    } catch (error) {
        console.error('YouTubeリンクの取得に失敗しました:', error);
        container.innerHTML = '<p class="text-muted text-center mb-0">YouTubeリンクの取得に失敗しました</p>';
    }
}

async function loadYouTubeLinkStatistics() {
    const countBadge = document.getElementById('youtubeLinksCountBadge');
    const totalBadge = document.getElementById('youtubeLinksTotalDurationBadge');
    const headerSummary = document.getElementById('youtubeLinksHeaderSummary');
    if (!countBadge || !totalBadge || !headerSummary) return;

    try {
        const response = await axios.get(`/api/schedules/sessions/${SESSION_ID}/youtube-links/statistics/`);
        const stats = response.data || {};
        const count = Number(stats.video_count) || 0;
        const totalDisplay = stats.total_duration_display || formatDurationSeconds(stats.total_duration_seconds);

        countBadge.textContent = `${count}本`;
        totalBadge.textContent = `合計 ${totalDisplay}`;
        headerSummary.textContent = `(${count}本 / ${totalDisplay})`;
    } catch (error) {
        totalBadge.textContent = '';
        headerSummary.textContent = '';
        countBadge.textContent = '統計取得失敗';
    }
}

async function addYouTubeLink(event) {
    event.preventDefault();

    const addBtn = document.getElementById('youtubeLinkAddBtn');
    const urlEl = document.getElementById('youtube_link_url');
    const perspectiveEl = document.getElementById('youtube_link_perspective');
    const partEl = document.getElementById('youtube_link_part_number');
    const descriptionEl = document.getElementById('youtube_link_description');

    const youtubeUrl = (urlEl?.value || '').trim();
    const perspective = (perspectiveEl?.value || '').trim();
    const partValue = (partEl?.value || '').trim();
    const description = (descriptionEl?.value || '').trim();

    if (!youtubeUrl) {
        showYouTubeLinksMessage('YouTube URLを入力してください', 'warning');
        return;
    }

    const payload = { youtube_url: youtubeUrl };
    if (perspective) payload.perspective = perspective;
    if (description) payload.description = description;
    if (partValue) payload.part_number = Number(partValue);

    try {
        if (addBtn) addBtn.disabled = true;
        await axios.post(`/api/schedules/sessions/${SESSION_ID}/youtube-links/`, payload);
        showYouTubeLinksMessage('YouTubeリンクを追加しました', 'success');

        if (urlEl) urlEl.value = '';
        if (partEl) partEl.value = '';
        if (descriptionEl) descriptionEl.value = '';

        await loadYouTubeLinks();
        await loadYouTubeLinkStatistics();
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showYouTubeLinksMessage(`追加に失敗しました: ${message}`, 'danger');
    } finally {
        if (addBtn) addBtn.disabled = false;
    }
}

function parseBulkUrls(text) {
    return (text || '')
        .split(/\s+/)
        .map(v => v.trim())
        .filter(Boolean);
}

async function bulkAddYouTubeLinks(event) {
    event.preventDefault();

    const bulkBtn = document.getElementById('youtubeLinkBulkAddBtn');
    const urlsEl = document.getElementById('youtube_bulk_urls');
    const perspectiveEl = document.getElementById('youtube_bulk_perspective');
    const startPartEl = document.getElementById('youtube_bulk_start_part');
    const descriptionEl = document.getElementById('youtube_bulk_description');

    const urls = parseBulkUrls(urlsEl?.value || '');
    const perspective = (perspectiveEl?.value || '').trim();
    const startPartValue = (startPartEl?.value || '').trim();
    const description = (descriptionEl?.value || '').trim();

    if (urls.length === 0) {
        showYouTubeLinksMessage('YouTube URLを1つ以上入力してください', 'warning');
        return;
    }

    const startPart = startPartValue ? Number(startPartValue) : null;
    if (startPartValue && (!Number.isInteger(startPart) || startPart < 1)) {
        showYouTubeLinksMessage('開始パート番号は1以上の整数で入力してください', 'warning');
        return;
    }

    let successCount = 0;
    const errors = [];

    try {
        if (bulkBtn) bulkBtn.disabled = true;

        for (let i = 0; i < urls.length; i += 1) {
            const payload = { youtube_url: urls[i] };
            if (perspective) payload.perspective = perspective;
            if (description) payload.description = description;
            if (startPart) payload.part_number = startPart + i;

            try {
                await axios.post(`/api/schedules/sessions/${SESSION_ID}/youtube-links/`, payload);
                successCount += 1;
            } catch (error) {
                const message = error.response?.data?.error || error.response?.data?.detail || error.message;
                errors.push(`${urls[i]}: ${message}`);
            }
        }

        if (successCount > 0) {
            showYouTubeLinksMessage(`追加しました: ${successCount}件`, errors.length ? 'warning' : 'success');
        } else {
            showYouTubeLinksMessage('追加できませんでした', 'danger');
        }

        if (errors.length) {
            console.warn('YouTubeリンク追加エラー:', errors);
        }

        if (urlsEl) urlsEl.value = '';
        if (startPartEl) startPartEl.value = '';
        if (descriptionEl) descriptionEl.value = '';

        await loadYouTubeLinks();
        await loadYouTubeLinkStatistics();
    } finally {
        if (bulkBtn) bulkBtn.disabled = false;
    }
}

function openEditYouTubeLinkModal(linkId) {
    const link = youtubeLinkMap.get(String(linkId));
    if (!link) return;

    const idEl = document.getElementById('edit_youtube_link_id');
    const perspectiveEl = document.getElementById('edit_youtube_link_perspective');
    const partEl = document.getElementById('edit_youtube_link_part_number');
    const descriptionEl = document.getElementById('edit_youtube_link_description');

    if (idEl) idEl.value = link.id;
    if (perspectiveEl) perspectiveEl.value = link.perspective || '';
    if (partEl) partEl.value = link.part_number || '';
    if (descriptionEl) descriptionEl.value = link.description || '';

    const modalEl = document.getElementById('editYouTubeLinkModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

async function saveYouTubeLinkEdits() {
    const id = document.getElementById('edit_youtube_link_id')?.value;
    if (!id) return;

    const saveBtn = document.getElementById('saveYouTubeLinkBtn');
    const perspective = (document.getElementById('edit_youtube_link_perspective')?.value || '').trim();
    const partValue = (document.getElementById('edit_youtube_link_part_number')?.value || '').trim();
    const description = (document.getElementById('edit_youtube_link_description')?.value || '').trim();

    const payload = {
        perspective: perspective,
        description: description,
        part_number: partValue ? Number(partValue) : null
    };

    try {
        if (saveBtn) saveBtn.disabled = true;
        await axios.patch(`/api/schedules/youtube-links/${id}/`, payload);

        const modalEl = document.getElementById('editYouTubeLinkModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        showYouTubeLinksMessage('YouTubeリンクを更新しました', 'success');
        await loadYouTubeLinks();
        await loadYouTubeLinkStatistics();
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showYouTubeLinksMessage(`更新に失敗しました: ${message}`, 'danger');
    } finally {
        if (saveBtn) saveBtn.disabled = false;
    }
}

async function deleteYouTubeLink(linkId) {
    if (!confirm('このYouTubeリンクを削除しますか？')) return;

    try {
        await axios.delete(`/api/schedules/youtube-links/${linkId}/`);
        showYouTubeLinksMessage('YouTubeリンクを削除しました', 'success');
        await loadYouTubeLinks();
        await loadYouTubeLinkStatistics();
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showYouTubeLinksMessage(`削除に失敗しました: ${message}`, 'danger');
    }
}

// セッションノート / ログ（ISSUE-014）
const SESSION_NOTE_TYPE_LABELS = {
    gm_private: 'GMプライベート',
    public_summary: '公開サマリー',
    player_note: 'プレイヤーノート',
    npc_memo: 'NPCメモ',
    handover: '引き継ぎ',
};

function formatDateTimeDisplay(value) {
    if (!value) return '';
    const date = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(date.getTime())) return '';
    return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
    });
}

function nl2br(value) {
    return escapeHtml(value).replace(/\r?\n/g, '<br>');
}

function showSessionNotesMessage(message, type = 'info') {
    const container = document.getElementById('sessionNotesMessages');
    if (!container) return;
    const safe = escapeHtml(message);
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${safe}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function showSessionLogsMessage(message, type = 'info') {
    const container = document.getElementById('sessionLogsMessages');
    if (!container) return;
    const safe = escapeHtml(message);
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${safe}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function showSessionNoteModalMessage(message, type = 'danger') {
    const container = document.getElementById('sessionNoteModalMessages');
    if (!container) return;
    const safe = escapeHtml(message);
    container.innerHTML = `<div class="alert alert-${type} mb-0" role="alert">${safe}</div>`;
}

function showSessionLogModalMessage(message, type = 'danger') {
    const container = document.getElementById('sessionLogModalMessages');
    if (!container) return;
    const safe = escapeHtml(message);
    container.innerHTML = `<div class="alert alert-${type} mb-0" role="alert">${safe}</div>`;
}

function clearSessionNoteModalMessage() {
    const container = document.getElementById('sessionNoteModalMessages');
    if (container) container.innerHTML = '';
}

function clearSessionLogModalMessage() {
    const container = document.getElementById('sessionLogModalMessages');
    if (container) container.innerHTML = '';
}

function canEditSessionNote(note) {
    const currentUserId = window.CURRENT_USER?.id;
    if (!currentUserId) return false;
    if (IS_GM) return true;
    return note?.note_type === 'player_note' && Number(note?.author) === Number(currentUserId);
}

function canEditSessionLog(log) {
    const currentUserId = window.CURRENT_USER?.id;
    if (!currentUserId) return false;
    if (IS_GM) return true;
    return Number(log?.created_by) === Number(currentUserId);
}

function updateNotesLogsCountBadges() {
    const notesBadge = document.getElementById('sessionNotesCountBadge');
    const logsBadge = document.getElementById('sessionLogsCountBadge');
    if (notesBadge) notesBadge.textContent = `Notes: ${sessionNotes.length}`;
    if (logsBadge) logsBadge.textContent = `Logs: ${sessionLogs.length}`;
}

function buildNotesSummaryText(notes) {
    if (!notes || notes.length === 0) return 'ノートがありません';
    const pinnedCount = notes.filter(n => !!n.is_pinned).length;
    const summary = [];
    if (pinnedCount > 0) summary.push(`ピン留め: ${pinnedCount}`);
    summary.push(`合計: ${notes.length}`);
    return summary.join(' / ');
}

function buildLogsSummaryText(logs) {
    if (!logs || logs.length === 0) return 'ログがありません';
    return `合計: ${logs.length}`;
}

function getSessionNoteTypeLabel(noteType) {
    return SESSION_NOTE_TYPE_LABELS[noteType] || noteType || '';
}

function renderSessionNotes() {
    const container = document.getElementById('sessionNotesContainer');
    if (!container) return;

    const summaryEl = document.getElementById('sessionNotesSummary');
    if (summaryEl) summaryEl.textContent = buildNotesSummaryText(sessionNotes);

    const filterType = currentSessionNoteFilter || 'all';
    const filtered = filterType === 'all'
        ? sessionNotes
        : sessionNotes.filter(note => note.note_type === filterType);

    if (!filtered || filtered.length === 0) {
        container.innerHTML = '<p class="text-muted text-center mb-0">表示できるノートがありません</p>';
        return;
    }

    const html = filtered.map(note => {
        const title = (note.title || '').trim();
        const typeLabel = getSessionNoteTypeLabel(note.note_type);
        const safeTitle = escapeHtml(title || typeLabel || 'ノート');
        const safeType = escapeHtml(typeLabel);
        const safeAuthor = escapeHtml(note.author_detail?.nickname || note.author_detail?.username || '');
        const updatedAt = formatDateTimeDisplay(note.updated_at || note.created_at);
        const canEdit = canEditSessionNote(note);
        const pinBtn = IS_GM
            ? `
                <button type="button"
                        class="btn btn-sm btn-outline-${note.is_pinned ? 'warning' : 'secondary'}"
                        onclick="togglePinSessionNote(${note.id})">
                    <i class="fas fa-thumbtack"></i>
                </button>
            `
            : '';
        const editBtn = canEdit
            ? `
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openSessionNoteModal(${note.id})">
                    <i class="fas fa-edit"></i>
                </button>
            `
            : '';
        const deleteBtn = canEdit
            ? `
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteSessionNote(${note.id})">
                    <i class="fas fa-trash"></i>
                </button>
            `
            : '';

        const badgeClasses = note.is_pinned ? 'bg-warning text-dark' : 'bg-primary';
        const pinnedBadge = note.is_pinned ? '<span class="badge bg-warning text-dark ms-1"><i class="fas fa-thumbtack"></i> ピン</span>' : '';
        const typeBadge = safeType ? `<span class="badge ${badgeClasses}">${safeType}</span>` : '';

        return `
            <div class="border rounded p-3 mb-2 session-note-item">
                <div class="d-flex justify-content-between align-items-start gap-2">
                    <div class="flex-grow-1">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            ${typeBadge}
                            ${pinnedBadge}
                            <span class="fw-semibold">${safeTitle}</span>
                        </div>
                        <div class="small text-muted mt-1">
                            ${safeAuthor ? `${safeAuthor} / ` : ''}更新: ${escapeHtml(updatedAt)}
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        ${pinBtn}
                        ${editBtn}
                        ${deleteBtn}
                    </div>
                </div>
                <div class="mt-2 session-note-content">${nl2br(note.content || '')}</div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

function renderSessionLogs() {
    const container = document.getElementById('sessionLogsContainer');
    if (!container) return;

    const summaryEl = document.getElementById('sessionLogsSummary');
    if (summaryEl) summaryEl.textContent = buildLogsSummaryText(sessionLogs);

    if (!sessionLogs || sessionLogs.length === 0) {
        container.innerHTML = '<p class="text-muted text-center mb-0">ログがありません</p>';
        return;
    }

    const html = sessionLogs.map(log => {
        const timestamp = formatDateTimeDisplay(log.timestamp || log.created_at);
        const safeTimestamp = escapeHtml(timestamp);
        const safeType = escapeHtml((log.event_type || 'general').trim() || 'general');
        const safeCreator = escapeHtml(log.created_by_detail?.nickname || log.created_by_detail?.username || '');
        const safeRelated = escapeHtml((log.related_character_name || '').trim());
        const canEdit = canEditSessionLog(log);

        const relatedBadge = safeRelated
            ? `<span class="badge bg-dark ms-1"><i class="fas fa-user-ninja"></i> ${safeRelated}</span>`
            : '';

        const editBtn = canEdit
            ? `
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openSessionLogModal(${log.id})">
                    <i class="fas fa-edit"></i>
                </button>
            `
            : '';
        const deleteBtn = canEdit
            ? `
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteSessionLog(${log.id})">
                    <i class="fas fa-trash"></i>
                </button>
            `
            : '';

        return `
            <div class="border rounded p-3 mb-2 session-log-item">
                <div class="d-flex justify-content-between align-items-start gap-2">
                    <div class="flex-grow-1">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <span class="fw-semibold">${safeTimestamp}</span>
                            <span class="badge bg-success">${safeType}</span>
                            ${relatedBadge}
                        </div>
                        <div class="small text-muted mt-1">
                            ${safeCreator ? `${safeCreator}` : ''}
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        ${editBtn}
                        ${deleteBtn}
                    </div>
                </div>
                <div class="mt-2 session-log-content">${nl2br(log.description || '')}</div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

function setSessionNoteFilter(filterType) {
    currentSessionNoteFilter = filterType || 'all';
    const group = document.getElementById('sessionNoteTypeFilters');
    if (group) {
        group.querySelectorAll('button[data-note-type]').forEach(btn => {
            const active = btn.dataset.noteType === currentSessionNoteFilter;
            btn.classList.toggle('active', active);
        });
    }
    renderSessionNotes();
}

async function loadSessionNotes() {
    const container = document.getElementById('sessionNotesContainer');
    if (!container) return;

    container.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;

    try {
        const response = await axios.get(`/api/schedules/sessions/${SESSION_ID}/notes/`);
        sessionNotes = response.data || [];
        sessionNoteMap.clear();
        for (const note of sessionNotes) {
            if (note?.id !== undefined && note?.id !== null) {
                sessionNoteMap.set(String(note.id), note);
            }
        }
        updateNotesLogsCountBadges();
        renderSessionNotes();
    } catch (error) {
        sessionNotes = [];
        sessionNoteMap.clear();
        updateNotesLogsCountBadges();
        container.innerHTML = '<p class="text-muted text-center mb-0">ノートの読み込みに失敗しました</p>';
        showSessionNotesMessage(error.response?.data?.detail || error.message || 'ノートの読み込みに失敗しました', 'danger');
    }
}

async function loadSessionLogs() {
    const container = document.getElementById('sessionLogsContainer');
    if (!container) return;

    container.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;

    try {
        const response = await axios.get(`/api/schedules/sessions/${SESSION_ID}/logs/`);
        sessionLogs = response.data || [];
        sessionLogMap.clear();
        for (const log of sessionLogs) {
            if (log?.id !== undefined && log?.id !== null) {
                sessionLogMap.set(String(log.id), log);
            }
        }
        updateNotesLogsCountBadges();
        renderSessionLogs();
    } catch (error) {
        sessionLogs = [];
        sessionLogMap.clear();
        updateNotesLogsCountBadges();
        container.innerHTML = '<p class="text-muted text-center mb-0">ログの読み込みに失敗しました</p>';
        showSessionLogsMessage(error.response?.data?.detail || error.message || 'ログの読み込みに失敗しました', 'danger');
    }
}

function openSessionNoteModal(noteId = null) {
    if (IS_PUBLIC_VIEW || (!IS_GM && !IS_PARTICIPANT)) return;

    clearSessionNoteModalMessage();

    const modalEl = document.getElementById('sessionNoteModal');
    if (!modalEl) return;

    const idEl = document.getElementById('sessionNoteId');
    const typeEl = document.getElementById('sessionNoteType');
    const titleEl = document.getElementById('sessionNoteTitle');
    const contentEl = document.getElementById('sessionNoteContent');
    const pinnedEl = document.getElementById('sessionNotePinned');
    const titleLabelEl = document.getElementById('sessionNoteModalTitle');

    if (!idEl || !typeEl || !titleEl || !contentEl) return;

    const isEdit = noteId !== null && noteId !== undefined;
    if (isEdit) {
        const note = sessionNoteMap.get(String(noteId));
        if (!note) return;

        if (!canEditSessionNote(note)) {
            showSessionNotesMessage('このノートを編集する権限がありません', 'warning');
            return;
        }

        idEl.value = String(note.id);
        if (titleLabelEl) titleLabelEl.innerHTML = '<i class="fas fa-sticky-note"></i> ノート編集';
        titleEl.value = note.title || '';
        contentEl.value = note.content || '';
        if (typeEl) typeEl.value = note.note_type || 'player_note';
        if (pinnedEl) pinnedEl.checked = !!note.is_pinned;
    } else {
        idEl.value = '';
        if (titleLabelEl) titleLabelEl.innerHTML = '<i class="fas fa-sticky-note"></i> ノート追加';
        titleEl.value = '';
        contentEl.value = '';
        const initialType = IS_GM && currentSessionNoteFilter !== 'all'
            ? currentSessionNoteFilter
            : 'player_note';
        typeEl.value = initialType;
        if (pinnedEl) pinnedEl.checked = false;
    }

    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

async function saveSessionNote() {
    clearSessionNoteModalMessage();

    const idEl = document.getElementById('sessionNoteId');
    const typeEl = document.getElementById('sessionNoteType');
    const titleEl = document.getElementById('sessionNoteTitle');
    const contentEl = document.getElementById('sessionNoteContent');
    const pinnedEl = document.getElementById('sessionNotePinned');
    const saveBtn = document.getElementById('saveSessionNoteBtn');

    if (!idEl || !typeEl || !titleEl || !contentEl) return;

    const noteId = (idEl.value || '').trim();
    const noteType = (typeEl.value || 'player_note').trim();
    const title = (titleEl.value || '').trim();
    const content = (contentEl.value || '').trim();
    const isPinned = pinnedEl ? !!pinnedEl.checked : false;

    if (!content) {
        showSessionNoteModalMessage('内容を入力してください', 'warning');
        return;
    }

    const payload = {
        title,
        content,
    };

    if (IS_GM) {
        payload.note_type = noteType;
        payload.is_pinned = isPinned;
    }

    try {
        if (saveBtn) saveBtn.disabled = true;
        if (noteId) {
            await axios.patch(`/api/schedules/notes/${encodeURIComponent(noteId)}/`, payload);
        } else {
            const createPayload = { ...payload };
            if (IS_GM) {
                createPayload.note_type = noteType;
                createPayload.is_pinned = isPinned;
            } else {
                createPayload.note_type = 'player_note';
            }
            await axios.post(`/api/schedules/sessions/${SESSION_ID}/notes/`, createPayload);
        }

        const modalEl = document.getElementById('sessionNoteModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        await loadSessionNotes();
        showSessionNotesMessage('ノートを保存しました', 'success');
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showSessionNoteModalMessage(`保存に失敗しました: ${message}`, 'danger');
    } finally {
        if (saveBtn) saveBtn.disabled = false;
    }
}

async function togglePinSessionNote(noteId) {
    if (!IS_GM) return;
    const note = sessionNoteMap.get(String(noteId));
    if (!note) return;

    try {
        await axios.patch(`/api/schedules/notes/${encodeURIComponent(noteId)}/`, {
            is_pinned: !note.is_pinned,
        });
        await loadSessionNotes();
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showSessionNotesMessage(`ピン留めの更新に失敗しました: ${message}`, 'danger');
    }
}

async function deleteSessionNote(noteId) {
    const note = sessionNoteMap.get(String(noteId));
    if (!note) return;
    if (!canEditSessionNote(note)) {
        showSessionNotesMessage('このノートを削除する権限がありません', 'warning');
        return;
    }
    if (!confirm('このノートを削除しますか？')) return;

    try {
        await axios.delete(`/api/schedules/notes/${encodeURIComponent(noteId)}/`);
        await loadSessionNotes();
        showSessionNotesMessage('ノートを削除しました', 'success');
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showSessionNotesMessage(`削除に失敗しました: ${message}`, 'danger');
    }
}

function openSessionLogModal(logId = null) {
    if (IS_PUBLIC_VIEW || (!IS_GM && !IS_PARTICIPANT)) return;

    clearSessionLogModalMessage();

    const modalEl = document.getElementById('sessionLogModal');
    if (!modalEl) return;

    const idEl = document.getElementById('sessionLogId');
    const timestampEl = document.getElementById('sessionLogTimestamp');
    const typeEl = document.getElementById('sessionLogEventType');
    const relatedEl = document.getElementById('sessionLogRelatedCharacter');
    const descEl = document.getElementById('sessionLogDescription');
    const titleLabelEl = document.getElementById('sessionLogModalTitle');

    if (!idEl || !timestampEl || !typeEl || !relatedEl || !descEl) return;

    const isEdit = logId !== null && logId !== undefined;
    if (isEdit) {
        const log = sessionLogMap.get(String(logId));
        if (!log) return;
        if (!canEditSessionLog(log)) {
            showSessionLogsMessage('このログを編集する権限がありません', 'warning');
            return;
        }
        idEl.value = String(log.id);
        if (titleLabelEl) titleLabelEl.innerHTML = '<i class="fas fa-stream"></i> ログ編集';
        timestampEl.value = toDateTimeLocalValue(log.timestamp || log.created_at);
        typeEl.value = (log.event_type || 'general').trim();
        relatedEl.value = log.related_character ? String(log.related_character) : '';
        descEl.value = log.description || '';
    } else {
        idEl.value = '';
        if (titleLabelEl) titleLabelEl.innerHTML = '<i class="fas fa-stream"></i> ログ追加';
        timestampEl.value = toDateTimeLocalValue(new Date());
        typeEl.value = 'general';
        relatedEl.value = '';
        descEl.value = '';
    }

    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

async function saveSessionLog() {
    clearSessionLogModalMessage();

    const idEl = document.getElementById('sessionLogId');
    const timestampEl = document.getElementById('sessionLogTimestamp');
    const typeEl = document.getElementById('sessionLogEventType');
    const relatedEl = document.getElementById('sessionLogRelatedCharacter');
    const descEl = document.getElementById('sessionLogDescription');
    const saveBtn = document.getElementById('saveSessionLogBtn');

    if (!idEl || !timestampEl || !typeEl || !relatedEl || !descEl) return;

    const logId = (idEl.value || '').trim();
    const timestamp = (timestampEl.value || '').trim();
    const eventType = (typeEl.value || 'general').trim() || 'general';
    const relatedCharacterValue = (relatedEl.value || '').trim();
    const description = (descEl.value || '').trim();

    if (!timestamp) {
        showSessionLogModalMessage('日時を入力してください', 'warning');
        return;
    }
    if (!description) {
        showSessionLogModalMessage('内容を入力してください', 'warning');
        return;
    }

    const payload = {
        timestamp,
        event_type: eventType,
        description,
        related_character: relatedCharacterValue ? Number(relatedCharacterValue) : null,
    };

    try {
        if (saveBtn) saveBtn.disabled = true;
        if (logId) {
            await axios.patch(`/api/schedules/logs/${encodeURIComponent(logId)}/`, payload);
        } else {
            await axios.post(`/api/schedules/sessions/${SESSION_ID}/logs/`, payload);
        }

        const modalEl = document.getElementById('sessionLogModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        await loadSessionLogs();
        showSessionLogsMessage('ログを保存しました', 'success');
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showSessionLogModalMessage(`保存に失敗しました: ${message}`, 'danger');
    } finally {
        if (saveBtn) saveBtn.disabled = false;
    }
}

async function deleteSessionLog(logId) {
    const log = sessionLogMap.get(String(logId));
    if (!log) return;
    if (!canEditSessionLog(log)) {
        showSessionLogsMessage('このログを削除する権限がありません', 'warning');
        return;
    }
    if (!confirm('このログを削除しますか？')) return;

    try {
        await axios.delete(`/api/schedules/logs/${encodeURIComponent(logId)}/`);
        await loadSessionLogs();
        showSessionLogsMessage('ログを削除しました', 'success');
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showSessionLogsMessage(`削除に失敗しました: ${message}`, 'danger');
    }
}

function setupSessionNotesLogsUi() {
    const noteFilters = document.getElementById('sessionNoteTypeFilters');
    if (noteFilters) {
        noteFilters.addEventListener('click', (event) => {
            const btn = event.target?.closest('button[data-note-type]');
            if (!btn) return;
            setSessionNoteFilter(btn.dataset.noteType || 'all');
        });
    }

    const openNoteBtn = document.getElementById('openSessionNoteModalBtn');
    if (openNoteBtn) openNoteBtn.addEventListener('click', () => openSessionNoteModal(null));

    const openLogBtn = document.getElementById('openSessionLogModalBtn');
    if (openLogBtn) openLogBtn.addEventListener('click', () => openSessionLogModal(null));

    const saveNoteBtn = document.getElementById('saveSessionNoteBtn');
    if (saveNoteBtn) saveNoteBtn.addEventListener('click', saveSessionNote);

    const saveLogBtn = document.getElementById('saveSessionLogBtn');
    if (saveLogBtn) saveLogBtn.addEventListener('click', saveSessionLog);

    const reloadNotesBtn = document.getElementById('reloadSessionNotesBtn');
    if (reloadNotesBtn) reloadNotesBtn.addEventListener('click', loadSessionNotes);

    const reloadLogsBtn = document.getElementById('reloadSessionLogsBtn');
    if (reloadLogsBtn) reloadLogsBtn.addEventListener('click', loadSessionLogs);
}

// セッション参加
async function joinSession() {
    const characterSheetId = document.getElementById('character_sheet_id').value;
    const data = {
        character_name: document.getElementById('character_name').value,
        character_sheet_url: document.getElementById('character_sheet_url').value
    };
    if (characterSheetId) {
        data.character_sheet_id = characterSheetId;
    }

    try {
        const response = await axios.post(`/api/schedules/sessions/{{ session.id }}/join/`, data);
        alert('セッションに参加しました');
        location.reload();
    } catch (error) {
        alert('参加に失敗しました: ' + (error.response?.data?.error || error.message));
    }
}

// 参加情報更新
async function updateParticipant() {
    const characterSheetId = document.getElementById('edit_character_sheet_id').value;
    const data = {
        character_name: document.getElementById('edit_character_name').value,
        character_sheet_url: document.getElementById('edit_character_sheet_url').value
    };
    if (characterSheetId) {
        data.character_sheet_id = characterSheetId;
    } else {
        data.character_sheet_id = '';
    }

    try {
        {% if user_participant %}
        const response = await axios.patch(`/api/schedules/participants/{{ user_participant.id }}/`, data);
        {% else %}
        throw new Error('参加情報が見つかりません');
        {% endif %}
        alert('参加情報を更新しました');
        location.reload();
    } catch (error) {
        alert('更新に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

// GM: 参加者キャラクター設定
function openCharacterLinkModal(participantId, userId, currentCharacterId) {
    const modalEl = document.getElementById('linkCharacterModal');
    const modal = new bootstrap.Modal(modalEl);
    const selectEl = document.getElementById('linkCharacterSelect');

    document.getElementById('linkParticipantId').value = participantId;
    document.getElementById('linkParticipantUserId').value = userId;

    const characters = groupMemberCharacters.get(String(userId)) || [];
    if (characters.length === 0) {
        selectEl.innerHTML = '<option value="">選択可能なキャラクターがありません</option>';
    } else {
        selectEl.innerHTML = '<option value="">選択してください</option>' + characters.map(char => (
            `<option value="${char.id}">${char.name}</option>`
        )).join('');
    }

    if (currentCharacterId) {
        selectEl.value = String(currentCharacterId);
    }

    modal.show();
}

async function saveLinkedCharacter() {
    const participantId = document.getElementById('linkParticipantId').value;
    const userId = document.getElementById('linkParticipantUserId').value;
    const characterId = document.getElementById('linkCharacterSelect').value;

    if (!participantId) return;

    const characters = groupMemberCharacters.get(String(userId)) || [];
    const selected = characters.find(char => String(char.id) === String(characterId));

    const data = {
        character_sheet_id: characterId || ''
    };

    if (selected && selected.name) {
        data.character_name = selected.name;
    }

    try {
        await axios.patch(`/api/schedules/participants/${participantId}/`, data);
        alert('キャラクターを更新しました');
        location.reload();
    } catch (error) {
        alert('更新に失敗しました: ' + (error.response?.data?.error || error.message));
    }
}

// セッション脱退
async function leaveSession() {
    if (!confirm('本当にセッションから脱退しますか？')) return;

    try {
        const response = await axios.delete(`/api/schedules/sessions/{{ session.id }}/leave/`);
        alert('セッションから脱退しました');
        window.location.href = '/api/schedules/sessions/view/';
    } catch (error) {
        alert('脱退に失敗しました: ' + (error.response?.data?.error || error.message));
    }
}

// ハンドアウト作成
async function createHandout() {
    const data = {
        session: {{ session.id }},
        participant: document.getElementById('handout_participant').value,
        title: document.getElementById('handout_title').value,
        content: document.getElementById('handout_content').value,
        recommended_skills: document.getElementById('handout_recommended_skills').value,
        is_secret: document.getElementById('handout_is_secret').checked
    };

    try {
        const response = await axios.post('/api/schedules/handouts/', data);
        alert('ハンドアウトを作成しました');
        location.reload();
    } catch (error) {
        alert('作成に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

// ハンドアウト削除
async function deleteHandout(handoutId) {
    if (!confirm('本当にこのハンドアウトを削除しますか？')) return;

    try {
        await axios.delete(`/api/schedules/handouts/${handoutId}/`);
        alert('ハンドアウトを削除しました');
        location.reload();
    } catch (error) {
        alert('削除に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

// 参加者除名
async function removeParticipant(participantId) {
    if (!confirm('本当にこの参加者を除名しますか？')) return;

    try {
        await axios.delete(`/api/schedules/participants/${participantId}/`);
        alert('参加者を除名しました');
        location.reload();
    } catch (error) {
        alert('除名に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

async function loadInviteMembersList() {
    const container = document.getElementById('inviteMembersList');
    if (!container) return;
    if (!CAN_INVITE || IS_PUBLIC_VIEW) return;

    container.innerHTML = '<span class="text-muted small">読み込み中...</span>';

    await ensureOccurrenceGroupMembers();
    renderInviteMembersList(document.getElementById('inviteMemberSearch')?.value || '');
}

function renderInviteMembersList(filterText = '') {
    const container = document.getElementById('inviteMembersList');
    if (!container) return;
    if (!CAN_INVITE || IS_PUBLIC_VIEW) return;

    const normalizedFilter = String(filterText || '').trim().toLowerCase();
    const candidates = (occurrenceGroupMembers || []).map(member => {
        const userId = parseInt(member.user, 10);
        const nickname = member.user_detail?.nickname || '';
        const username = member.user_detail?.username || '';
        const name = nickname || username || String(userId);
        return {
            userId,
            name,
            nickname,
            username,
        };
    }).filter(c => Number.isFinite(c.userId) && !SESSION_EXISTING_MEMBER_IDS.has(c.userId));

    const filtered = normalizedFilter
        ? candidates.filter(c => `${c.nickname} ${c.username} ${c.name}`.toLowerCase().includes(normalizedFilter))
        : candidates;

    if (filtered.length === 0) {
        container.innerHTML = '<span class="text-muted small">招待できるメンバーがいません</span>';
        return;
    }

    const rowsHtml = filtered.map(c => `
        <label class="d-flex align-items-center gap-2 mb-1">
            <input type="checkbox" class="form-check-input invite-member-checkbox" value="${c.userId}">
            <span>${escapeHtml(c.name)}</span>
        </label>
    `).join('');

    container.innerHTML = `
        <div class="small text-muted mb-2">招待候補: ${filtered.length}人</div>
        ${rowsHtml}
    `;
}

window.selectAllInviteCandidates = function(selectAll) {
    const container = document.getElementById('inviteMembersList');
    if (!container) return;
    container.querySelectorAll('input.invite-member-checkbox').forEach(cb => {
        cb.checked = Boolean(selectAll);
    });
};

window.sendSessionInvitations = async function() {
    if (!CAN_INVITE || IS_PUBLIC_VIEW) return;

    const listContainer = document.getElementById('inviteMembersList');
    const message = document.getElementById('inviteMessage')?.value || '';
    const resultsEl = document.getElementById('inviteResults');
    const sendBtn = document.getElementById('sendInvitesBtn');

    const selected = Array.from(listContainer?.querySelectorAll('input.invite-member-checkbox:checked') || [])
        .map(el => parseInt(el.value, 10))
        .filter(id => Number.isFinite(id));

    if (selected.length === 0) {
        alert('招待するメンバーを選択してください');
        return;
    }

    if (sendBtn) sendBtn.disabled = true;
    if (resultsEl) resultsEl.innerHTML = '<span class="text-muted small">送信中...</span>';

    let successCount = 0;
    const errors = [];

    for (let index = 0; index < selected.length; index += 1) {
        const userId = selected[index];
        try {
            await axios.post(
                `/api/schedules/sessions/${encodeURIComponent(SESSION_ID)}/invite/`,
                { user_id: userId, message },
                { headers: { 'Content-Type': 'application/json' } },
            );
            successCount += 1;
        } catch (error) {
            errors.push({
                userId,
                message: error.response?.data?.error || error.response?.data?.detail || error.message,
            });
        }

        if (resultsEl) {
            resultsEl.innerHTML = `<span class="text-muted small">送信中... (${index + 1}/${selected.length})</span>`;
        }
    }

    if (sendBtn) sendBtn.disabled = false;

    if (resultsEl) {
        const errorHtml = errors.length ? `
            <div class="alert alert-warning py-2 mt-2 mb-0">
                <div class="fw-bold mb-1">一部送信に失敗しました</div>
                <ul class="mb-0">
                    ${errors.map(e => `<li>${escapeHtml(String(e.userId))}: ${escapeHtml(e.message)}</li>`).join('')}
                </ul>
            </div>
        ` : '';

        resultsEl.innerHTML = `
            <div class="alert alert-${errors.length ? 'warning' : 'success'} py-2 mb-0">
                送信完了: ${successCount}/${selected.length}
            </div>
            ${errorHtml}
        `;
    }

    await loadInviteMembersList();
};

document.addEventListener('DOMContentLoaded', () => {
    setupCopyPublicSessionLinkButton();

    if (IS_PUBLIC_VIEW) return;

    const datePollContainer = document.getElementById('datePollContainer');
    if (datePollContainer) {
        loadDatePollSection();
    }

    const uploadImagesBtn = document.getElementById('uploadSessionImagesBtn');
    if (uploadImagesBtn) uploadImagesBtn.addEventListener('click', uploadSessionImages);

    const notesLogsCard = document.getElementById('sessionNotesLogsCard');
    if (notesLogsCard) {
        setupSessionNotesLogsUi();
        loadSessionNotes();
        loadSessionLogs();
    }

    loadCharacterSheets();
    loadGroupMemberCharacters();

    const youtubeContainer = document.getElementById('youtubeLinksContainer');
    if (youtubeContainer) {
        const addForm = document.getElementById('youtubeLinkAddForm');
        if (addForm) addForm.addEventListener('submit', addYouTubeLink);

        const bulkForm = document.getElementById('youtubeLinkBulkAddForm');
        if (bulkForm) bulkForm.addEventListener('submit', bulkAddYouTubeLinks);

        loadYouTubeLinks();
        loadYouTubeLinkStatistics();
    }

    const inviteModalEl = document.getElementById('inviteMembersModal');
    if (inviteModalEl) {
        inviteModalEl.addEventListener('shown.bs.modal', async () => {
            const searchEl = document.getElementById('inviteMemberSearch');
            const resultsEl = document.getElementById('inviteResults');
            const messageEl = document.getElementById('inviteMessage');
            if (searchEl) searchEl.value = '';
            if (messageEl) messageEl.value = '';
            if (resultsEl) resultsEl.innerHTML = '';
            await loadInviteMembersList();
        });
    }

    const inviteSearchEl = document.getElementById('inviteMemberSearch');
    if (inviteSearchEl) {
        inviteSearchEl.addEventListener('input', () => {
            renderInviteMembersList(inviteSearchEl.value);
        });
    }
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}{{ session.title }} - セッション詳細{% endblock %}

{% block content %}
<div class="container">
    <!-- ヘッダー部分 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/">
                                    <i class="fas fa-home"></i> ホーム
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="/api/schedules/sessions/view/">
                                    <i class="fas fa-scroll"></i> セッション一覧
                                </a>
                            </li>
                            <li class="breadcrumb-item active">
                                <i class="fas fa-eye"></i> {{ session.title }}
                            </li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <button class="btn btn-outline-secondary"
                            type="button"
                            id="copyPublicSessionLinkBtn"
                            data-share-url="{{ public_session_url }}">
                        <i class="fas fa-link"></i> リンクをコピー
                    </button>
                    {% if session.scenario %}
                        {% if is_participant or can_join or is_gm %}
                            <button class="btn btn-outline-success"
                                    id="createCharacterFromScenario"
                                    data-scenario-id="{{ session.scenario.id }}"
                                    data-scenario-title="{{ session.scenario.title }}"
                                    data-scenario-system="{{ session.scenario.game_system }}"
                                    data-session-id="{{ session.id }}">
                                <i class="fas fa-user-plus"></i> 探索者作成
                            </button>
                        {% endif %}
                    {% endif %}
                    {% if can_edit %}
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editSessionModal">
                            <i class="fas fa-edit"></i> セッション編集
                        </button>
                    {% endif %}
                    {% if can_join %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#joinSessionModal">
                            <i class="fas fa-user-plus"></i> 参加申請
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- メイン情報 -->
        <div class="col-lg-8">
            <!-- セッション基本情報 -->
            <div class="card mb-4">
                <div class="card-header bg-primary">
                    <h3 class="mb-0 eldritch-font">
                        <i class="fas fa-scroll"></i> {{ session.title }}
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar"></i> 開催日時</h6>
                            <p class="mb-3">{{ session.date|date:"Y年m月d日 H:i" }}</p>

                            <h6><i class="fas fa-map-marker-alt"></i> 場所</h6>
                            <p class="mb-3">{{ session.location|default:"未設定" }}</p>

                            <h6><i class="fas fa-clock"></i> セッション時間</h6>
                            <p class="mb-3">
                                {% if session.duration_minutes %}
                                    {{ session.duration_minutes }}分
                                    {% if session.duration_minutes >= 60 %}
                                        (約{% widthratio session.duration_minutes 60 1 %}時間)
                                    {% endif %}
                                {% else %}
                                    未設定
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> GM</h6>
                            <p class="mb-3">
                                {% if session.gm.profile_image %}
                                    <img src="{{ session.gm.profile_image.url }}" alt="GM" 
                                         class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                {% else %}
                                    <i class="fas fa-user-circle me-2"></i>
                                {% endif %}
                                {{ session.gm.nickname|default:session.gm.username }}
                            </p>

                            <h6><i class="fas fa-flag"></i> ステータス</h6>
                            <p class="mb-3">
                                {% if session.status == 'planned' %}
                                    <span class="badge bg-primary fs-6"><i class="fas fa-clock"></i> 予定</span>
                                {% elif session.status == 'ongoing' %}
                                    <span class="badge bg-warning fs-6"><i class="fas fa-play"></i> 進行中</span>
                                {% elif session.status == 'completed' %}
                                    <span class="badge bg-success fs-6"><i class="fas fa-check"></i> 完了</span>
                                {% elif session.status == 'cancelled' %}
                                    <span class="badge bg-danger fs-6"><i class="fas fa-times"></i> キャンセル</span>
                                {% endif %}
                            </p>

                            <h6><i class="fas fa-eye"></i> 公開設定</h6>
                            <p class="mb-3">
                                {% if session.visibility == 'private' %}
                                    <span class="badge bg-secondary"><i class="fas fa-lock"></i> プライベート</span>
                                {% elif session.visibility == 'group' %}
                                    <span class="badge bg-info"><i class="fas fa-users"></i> グループ内</span>
                                {% elif session.visibility == 'public' %}
                                    <span class="badge bg-success"><i class="fas fa-globe"></i> 公開</span>
                                {% endif %}
                            </p>

                            {% if session.scenario %}
                            <h6><i class="fas fa-book"></i> シナリオ</h6>
                            <p class="mb-3">
                                {{ session.scenario.title }}
                                <span class="badge bg-secondary ms-2">{{ session.scenario.get_game_system_display }}</span>
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    {% if session.youtube_url %}
                    <hr>
                    <h6><i class="fab fa-youtube"></i> YouTube配信</h6>
                    <p>
                        <a href="{{ session.youtube_url }}" target="_blank" class="btn btn-outline-danger">
                            <i class="fab fa-youtube"></i> 配信を見る
                        </a>
                    </p>
                    {% endif %}

                    {% if session.description %}
                    <hr>
                    <h6><i class="fas fa-scroll"></i> セッション概要</h6>
                    <div class="border rounded p-3" style="background-color: var(--secondary-bg);">
                        {{ session.description|linebreaks }}
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if is_participant or is_gm %}
            <!-- YouTube動画リンク（複数） -->
            <div class="card mb-4" id="youtubeLinksCard">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fab fa-youtube"></i> YouTube動画リンク
                        <small class="ms-2 text-white-50" id="youtubeLinksHeaderSummary"></small>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="youtubeLinksMessages"></div>

                    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                        <div class="badge bg-secondary" id="youtubeLinksCountBadge">読み込み中...</div>
                        <div class="badge bg-dark" id="youtubeLinksTotalDurationBadge"></div>
                    </div>

                    <div id="youtubeLinksContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border text-danger" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="accordion" id="youtubeLinksAddAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="youtubeLinksAddHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#youtubeLinksAddCollapse" aria-expanded="false" aria-controls="youtubeLinksAddCollapse">
                                    <i class="fas fa-plus me-2"></i> YouTubeリンクを追加
                                </button>
                            </h2>
                            <div id="youtubeLinksAddCollapse" class="accordion-collapse collapse" aria-labelledby="youtubeLinksAddHeading" data-bs-parent="#youtubeLinksAddAccordion">
                                <div class="accordion-body">
                                    <form id="youtubeLinkAddForm" class="mb-4">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="youtube_link_perspective" class="form-label">視点（任意）</label>
                                                <input type="text" class="form-control" id="youtube_link_perspective" placeholder="例: GM視点 / PL1視点 / 全体">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="youtube_link_part_number" class="form-label">パート番号（任意）</label>
                                                <input type="number" class="form-control" id="youtube_link_part_number" min="1" step="1" placeholder="例: 1">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="youtube_link_url" class="form-label">YouTube URL</label>
                                            <input type="url" class="form-control" id="youtube_link_url" required placeholder="https://www.youtube.com/watch?v=...">
                                        </div>
                                        <div class="mb-3">
                                            <label for="youtube_link_description" class="form-label">備考（任意）</label>
                                            <textarea class="form-control" id="youtube_link_description" rows="2" placeholder="この動画についてのメモ"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-danger" id="youtubeLinkAddBtn">
                                            <i class="fas fa-save"></i> 追加
                                        </button>
                                    </form>

                                    <h6 class="mb-3"><i class="fas fa-layer-group"></i> 分割動画をまとめて追加</h6>
                                    <form id="youtubeLinkBulkAddForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="youtube_bulk_perspective" class="form-label">視点（任意）</label>
                                                <input type="text" class="form-control" id="youtube_bulk_perspective" placeholder="例: GM視点 / PL1視点 / 全体">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="youtube_bulk_start_part" class="form-label">開始パート番号（任意）</label>
                                                <input type="number" class="form-control" id="youtube_bulk_start_part" min="1" step="1" placeholder="例: 1">
                                                <div class="form-text">指定すると、上から順にパート番号を自動で付与します</div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="youtube_bulk_urls" class="form-label">YouTube URL（複数可）</label>
                                            <textarea class="form-control" id="youtube_bulk_urls" rows="4" placeholder="1行に1URL（または空白区切りでもOK）" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="youtube_bulk_description" class="form-label">備考（任意）</label>
                                            <textarea class="form-control" id="youtube_bulk_description" rows="2" placeholder="全ての動画に同じ備考を付けます（必要なら後で編集）"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-outline-danger" id="youtubeLinkBulkAddBtn">
                                            <i class="fas fa-upload"></i> まとめて追加
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 参加者一覧 -->
            {% if is_public_view %}
            <div class="card mb-4">
                <div class="card-header bg-info">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> 参加者 ({{ participants.count }}人)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="badge bg-primary">GM</span>
                        <span class="ms-2">{{ session.gm.nickname|default:session.gm.username }}</span>
                    </div>

                    <div class="small text-muted mb-2">PL</div>
                    {% if participants %}
                        <div class="d-flex flex-wrap gap-2">
                            {% for participant in participants %}
                                {% if participant.role != 'gm' %}
                                    <span class="badge bg-secondary">{{ participant.user.nickname|default:participant.user.username }}</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">参加者がいません</p>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="card mb-4">
                <div class="card-header bg-info">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> 参加者一覧 ({{ participants.count }}人)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for participant in participants %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        {% if participant.user.profile_image %}
                                            <img src="{{ participant.user.profile_image.url }}" alt="プロフィール" 
                                                 class="rounded-circle me-3" style="width: 48px; height: 48px; object-fit: cover;">
                                        {% else %}
                                            <i class="fas fa-user-circle fa-3x me-3"></i>
                                        {% endif %}
                                        <div>
                                            <h6 class="mb-1">{{ participant.user.nickname|default:participant.user.username }}</h6>
                                            {% if participant.role == 'gm' %}
                                                <span class="badge bg-primary">GM</span>
                                            {% else %}
                                                <span class="badge bg-secondary">PL</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    {% if participant.character_name %}
                                    <p class="mb-2">
                                        <i class="fas fa-mask"></i> <strong>キャラクター:</strong> {{ participant.character_name }}
                                    </p>
                                    {% elif participant.character_sheet %}
                                    <p class="mb-2">
                                        <i class="fas fa-mask"></i> <strong>キャラクター:</strong> {{ participant.character_sheet.name }}
                                    </p>
                                    {% endif %}
                                    
                                    {% if participant.character_sheet %}
                                    <p class="mb-2">
                                        <a href="{% url 'character_detail' participant.character_sheet.id %}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-file-alt"></i> キャラクターシート
                                        </a>
                                    </p>
                                    {% elif participant.character_sheet_url %}
                                    <p class="mb-2">
                                        <a href="{{ participant.character_sheet_url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-file-alt"></i> キャラクターシート
                                        </a>
                                    </p>
                                    {% endif %}
                                    
                                    {% if is_gm and participant.role != 'gm' %}
                                    <div class="mt-2 d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="openCharacterLinkModal({{ participant.id }}, {{ participant.user.id }}, {{ participant.character_sheet_id|default:'null' }})">
                                            <i class="fas fa-link"></i> キャラクター設定
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="removeParticipant({{ participant.id }})">
                                            <i class="fas fa-user-minus"></i> 除名
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <p class="text-muted text-center">参加者がいません</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if is_participant or is_gm %}
            <!-- キャラクターステータス（参照のみ） -->
            <div class="card mb-4" id="characterStatusCard">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat"></i> キャラクターステータス（参照）
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        ココフォリアで管理するため、キャラクターシートの現在値を参照のみ表示します。HP/MP/SANはKPのみ閲覧できます。
                    </p>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped align-middle">
                            <thead>
                                <tr>
                                    <th>参加者</th>
                                    <th>キャラクター</th>
                                    <th>HP</th>
                                    <th>MP</th>
                                    <th>SAN</th>
                                    <th>最終更新</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for participant in participants %}
                                <tr>
                                    <td>
                                        <div class="fw-semibold">{{ participant.user.nickname|default:participant.user.username }}</div>
                                        <span class="badge {% if participant.role == 'gm' %}bg-primary{% else %}bg-secondary{% endif %}">
                                            {% if participant.role == 'gm' %}GM{% else %}PL{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if participant.character_name %}
                                            {{ participant.character_name }}
                                        {% elif participant.character_sheet %}
                                            {{ participant.character_sheet.name }}
                                        {% else %}
                                            <span class="text-muted">未設定</span>
                                        {% endif %}
                                    </td>
                                    {% if is_gm %}
                                        {% if participant.character_sheet %}
                                            <td>
                                                {{ participant.character_sheet.hit_points_current|default_if_none:"-" }} / {{ participant.character_sheet.hit_points_max|default_if_none:"-" }}
                                            </td>
                                            <td>
                                                {{ participant.character_sheet.magic_points_current|default_if_none:"-" }} / {{ participant.character_sheet.magic_points_max|default_if_none:"-" }}
                                            </td>
                                            <td>
                                                {{ participant.character_sheet.sanity_current|default_if_none:"-" }} / {{ participant.character_sheet.sanity_max|default_if_none:"-" }}
                                            </td>
                                            <td class="small text-muted">
                                                {{ participant.character_sheet.updated_at|date:"Y/m/d H:i" }}
                                            </td>
                                        {% else %}
                                            <td class="text-muted">-</td>
                                            <td class="text-muted">-</td>
                                            <td class="text-muted">-</td>
                                            <td class="text-muted">-</td>
                                        {% endif %}
                                    {% else %}
                                        <td class="text-muted">非公開</td>
                                        <td class="text-muted">非公開</td>
                                        <td class="text-muted">非公開</td>
                                        <td class="text-muted">-</td>
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">参加者がいません</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- サイドバー -->
        <div class="col-lg-4">
            <!-- グループ情報 -->
            <div class="card mb-4">
                <div class="card-header bg-secondary">
                    <h6 class="mb-0"><i class="fas fa-users"></i> グループ情報</h6>
                </div>
                <div class="card-body">
                    <h6>{{ session.group.name }}</h6>
                    {% if not is_public_view %}
                        {% if session.group.description %}
                            <p class="text-muted small">{{ session.group.description|truncatechars:100 }}</p>
                        {% endif %}
                    {% endif %}
                    <p class="mb-0">
                        <i class="fas fa-user"></i> メンバー: {{ session.group.members.count }}人
                    </p>
                </div>
            </div>

            <!-- ハンドアウト情報 -->
            {% if handouts or is_gm %}
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-scroll"></i> ハンドアウト情報
                        </h6>
                        {% if is_gm %}
                        <div class="btn-group btn-group-sm">
                            <a href="/api/schedules/sessions/{{ session.id }}/handouts/manage/" 
                               class="btn btn-outline-light">
                                <i class="fas fa-cogs"></i> 管理画面
                            </a>
                            <button class="btn btn-outline-light" 
                                    data-bs-toggle="modal" data-bs-target="#createHandoutModal">
                                <i class="fas fa-plus"></i> 作成
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if handouts %}
                        {% for handout in handouts %}
                        <div class="border rounded p-3 mb-3" style="background-color: var(--secondary-bg);">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1">
                                    {{ handout.title }}
                                    {% if handout.is_secret %}
                                        <i class="fas fa-eye-slash text-warning ms-1" title="秘匿情報"></i>
                                    {% endif %}
                                </h6>
                                {% if is_gm %}
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editHandout({{ handout.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteHandout({{ handout.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% if is_gm %}
                                <p class="small text-muted mb-2">
                                    <i class="fas fa-user"></i> {{ handout.participant.user.nickname|default:handout.participant.user.username }}
                                </p>
                            {% endif %}
                            {% if handout.recommended_skills %}
                                <p class="small text-muted mb-2">
                                    <strong>推奨技能:</strong>
                                    {{ handout.recommended_skills|linebreaksbr }}
                                </p>
                            {% endif %}
                            <div class="small">
                                {{ handout.content|linebreaks }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">ハンドアウトはありません</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- 管理メニュー -->
            {% if is_participant %}
            <div class="card">
                <div class="card-header bg-success">
                    <h6 class="mb-0"><i class="fas fa-cog"></i> 管理メニュー</h6>
                </div>
                <div class="card-body">
                    {% if user_participant %}
                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" 
                                data-bs-toggle="modal" data-bs-target="#editParticipantModal">
                            <i class="fas fa-edit"></i> 参加情報編集
                        </button>
                    {% endif %}
                    
                    {% if not is_gm %}
                        <button class="btn btn-outline-danger btn-sm w-100" 
                                onclick="leaveSession()">
                            <i class="fas fa-sign-out-alt"></i> セッション脱退
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- セッション編集モーダル -->
{% if can_edit %}
<div class="modal fade" id="editSessionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">セッション編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSessionForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="title" class="form-label">セッションタイトル</label>
                            <input type="text" class="form-control" id="title" value="{{ session.title }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="status" class="form-label">ステータス</label>
                            <select class="form-select" id="status">
                                <option value="planned" {% if session.status == 'planned' %}selected{% endif %}>予定</option>
                                <option value="ongoing" {% if session.status == 'ongoing' %}selected{% endif %}>進行中</option>
                                <option value="completed" {% if session.status == 'completed' %}selected{% endif %}>完了</option>
                                <option value="cancelled" {% if session.status == 'cancelled' %}selected{% endif %}>キャンセル</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">開催日時</label>
                            <input type="datetime-local" class="form-control" id="date" 
                                   value="{{ session.date|date:'Y-m-d\TH:i' }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="duration_minutes" class="form-label">セッション時間（分）</label>
                            <input type="number" class="form-control" id="duration_minutes" 
                                   value="{{ session.duration_minutes }}" min="0" step="30">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="location" class="form-label">場所</label>
                            <input type="text" class="form-control" id="location" value="{{ session.location }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="visibility" class="form-label">公開設定</label>
                            <select class="form-select" id="visibility">
                                <option value="private" {% if session.visibility == 'private' %}selected{% endif %}>プライベート</option>
                                <option value="group" {% if session.visibility == 'group' %}selected{% endif %}>グループ内</option>
                                <option value="public" {% if session.visibility == 'public' %}selected{% endif %}>公開</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="youtube_url" class="form-label">YouTube配信URL</label>
                        <input type="url" class="form-control" id="youtube_url" value="{{ session.youtube_url }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">セッション概要</label>
                        <textarea class="form-control" id="description" rows="4">{{ session.description }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="updateSession()">
                    <i class="fas fa-save"></i> 更新
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 参加申請モーダル -->
{% if can_join %}
<div class="modal fade" id="joinSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">セッション参加申請</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="joinSessionForm">
                    <div class="mb-3">
                        <label for="character_name" class="form-label">キャラクター名</label>
                        <input type="text" class="form-control" id="character_name" 
                               placeholder="使用するキャラクター名を入力してください">
                    </div>
                    <div class="mb-3">
                        <label for="character_sheet_id" class="form-label">キャラクターシート（内部）</label>
                        <select class="form-select" id="character_sheet_id">
                            <option value="">選択しない</option>
                        </select>
                        <div class="form-text">登録済みのキャラクターから選択できます</div>
                    </div>
                    <div class="mb-3">
                        <label for="character_sheet_url" class="form-label">キャラクターシートURL</label>
                        <input type="url" class="form-control" id="character_sheet_url" 
                               placeholder="キャラクターシートのURLを入力してください">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="joinSession()">
                    <i class="fas fa-user-plus"></i> 参加申請
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 参加情報編集モーダル -->
{% if user_participant %}
<div class="modal fade" id="editParticipantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">参加情報編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editParticipantForm">
                    <div class="mb-3">
                        <label for="edit_character_name" class="form-label">キャラクター名</label>
                        <input type="text" class="form-control" id="edit_character_name" 
                               value="{{ user_participant.character_name }}">
                    </div>
                    <div class="mb-3">
                        <label for="edit_character_sheet_id" class="form-label">キャラクターシート（内部）</label>
                        <select class="form-select" id="edit_character_sheet_id" data-selected="{{ user_participant.character_sheet_id|default:'' }}">
                            <option value="">選択しない</option>
                        </select>
                        <div class="form-text">登録済みのキャラクターから選択できます</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_character_sheet_url" class="form-label">キャラクターシートURL</label>
                        <input type="url" class="form-control" id="edit_character_sheet_url" 
                               value="{{ user_participant.character_sheet_url }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="updateParticipant()">
                    <i class="fas fa-save"></i> 更新
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if is_gm %}
<div class="modal fade" id="linkCharacterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">キャラクター設定</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="linkParticipantId">
                <input type="hidden" id="linkParticipantUserId">
                <div class="mb-3">
                    <label for="linkCharacterSelect" class="form-label">キャラクターシート</label>
                    <select class="form-select" id="linkCharacterSelect">
                        <option value="">選択してください</option>
                    </select>
                    <div class="form-text">公開キャラクターのみ選択可能です</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveLinkedCharacter()">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ハンドアウト作成モーダル -->
{% if is_gm %}
<div class="modal fade" id="createHandoutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ハンドアウト作成</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createHandoutForm">
                    <div class="mb-3">
                        <label for="handout_participant" class="form-label">対象参加者</label>
                        <select class="form-select" id="handout_participant" required>
                            <option value="">参加者を選択してください</option>
                            {% for participant in participants %}
                            <option value="{{ participant.id }}">{{ participant.user.nickname|default:participant.user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="handout_title" class="form-label">タイトル</label>
                        <input type="text" class="form-control" id="handout_title" required>
                    </div>
                    <div class="mb-3">
                        <label for="handout_content" class="form-label">内容</label>
                        <textarea class="form-control" id="handout_content" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="handout_recommended_skills" class="form-label">推奨技能</label>
                        <textarea class="form-control" id="handout_recommended_skills" rows="2" placeholder="例: 目星, 図書館"></textarea>
                        <small class="text-muted">カンマ/改行区切りで入力できます</small>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="handout_is_secret" checked>
                        <label class="form-check-label" for="handout_is_secret">
                            秘匿ハンドアウト（対象者のみ閲覧可能）
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="createHandout()">
                    <i class="fas fa-save"></i> 作成
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if is_participant or is_gm %}
<!-- YouTubeリンク編集モーダル -->
<div class="modal fade" id="editYouTubeLinkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fab fa-youtube"></i> YouTubeリンク編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_youtube_link_id">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="edit_youtube_link_perspective" class="form-label">視点（任意）</label>
                        <input type="text" class="form-control" id="edit_youtube_link_perspective" placeholder="例: GM視点 / PL1視点 / 全体">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="edit_youtube_link_part_number" class="form-label">パート番号（任意）</label>
                        <input type="number" class="form-control" id="edit_youtube_link_part_number" min="1" step="1" placeholder="例: 1">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="edit_youtube_link_description" class="form-label">備考（任意）</label>
                    <textarea class="form-control" id="edit_youtube_link_description" rows="3"></textarea>
                </div>

                <div class="form-text">
                    タイトル/時間/サムネはYouTubeから自動取得されます。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="saveYouTubeLinkBtn" onclick="saveYouTubeLinkEdits()">
                    <i class="fas fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.card-header.bg-primary {
    background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%) !important;
    color: white !important;
}

.card-header.bg-info {
    background: linear-gradient(135deg, var(--accent-info) 0%, #0891b2 100%) !important;
    color: white !important;
}

.card-header.bg-secondary {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
    color: white !important;
}

.card-header.bg-warning {
    background: linear-gradient(135deg, var(--accent-warning) 0%, #d97706 100%) !important;
    color: white !important;
}

.card-header.bg-success {
    background: linear-gradient(135deg, var(--accent-success) 0%, #059669 100%) !important;
    color: white !important;
}

.card-header.bg-danger {
    background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%) !important;
    color: white !important;
}

.badge.fs-6 {
    font-size: 1rem !important;
    padding: 0.5em 0.75em;
}

.youtube-link-item {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
}

.youtube-link-thumb {
    width: 140px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
}

.youtube-link-description {
    white-space: pre-wrap;
}

.breadcrumb {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    padding: 0.75rem 1rem;
}

.breadcrumb-item a {
    color: var(--accent-primary);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
    color: var(--accent-secondary);
}

.breadcrumb-item.active {
    color: var(--text-primary);
}

.breadcrumb-item + .breadcrumb-item::before {
    color: var(--text-muted);
}

/* 背景と文字色のコントラスト修正 */
.modal-content {
    background: var(--card-bg) !important;
    color: var(--text-primary) !important;
}

.modal-header {
    background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%) !important;
    color: white !important;
    border-bottom: 1px solid var(--border-color);
}

.modal-footer {
    background: var(--secondary-bg) !important;
    border-top: 1px solid var(--border-color);
}

.form-control, .form-select {
    background-color: var(--secondary-bg) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-primary) !important;
}

.form-control:focus, .form-select:focus {
    background-color: var(--card-bg) !important;
    border-color: var(--accent-primary) !important;
    color: var(--text-primary) !important;
    box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
}

.form-control::placeholder {
    color: var(--text-muted) !important;
}

.form-label {
    color: var(--text-primary) !important;
    font-weight: 500;
}

.form-check-input {
    background-color: var(--secondary-bg);
    border-color: var(--border-color);
}

.form-check-input:checked {
    background-color: var(--accent-primary);
    border-color: var(--accent-primary);
}

.form-check-label {
    color: var(--text-primary);
}

/* テーブル要素の修正 */
.table-dark {
    --bs-table-bg: var(--secondary-bg);
    --bs-table-border-color: var(--border-color);
    --bs-table-color: var(--text-primary);
}

/* ボタンのコントラスト改善 */
.btn-outline-primary {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
    background: transparent;
}

.btn-outline-primary:hover {
    background-color: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
}

.btn-outline-secondary {
    border-color: var(--border-color);
    color: var(--text-secondary);
    background: transparent;
}

.btn-outline-secondary:hover {
    background-color: var(--border-color);
    border-color: var(--border-color);
    color: var(--text-primary);
}

.btn-outline-danger {
    border-color: var(--accent-danger);
    color: var(--accent-danger);
    background: transparent;
}

.btn-outline-danger:hover {
    background-color: var(--accent-danger);
    border-color: var(--accent-danger);
    color: white;
}

.btn-outline-info {
    border-color: var(--accent-info);
    color: var(--accent-info);
    background: transparent;
}

.btn-outline-info:hover {
    background-color: var(--accent-info);
    border-color: var(--accent-info);
    color: white;
}

/* アラートスタイル */
.alert-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--accent-success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.alert-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--accent-danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.alert-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--accent-warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.alert-info {
    background: rgba(6, 182, 212, 0.1);
    color: var(--accent-info);
    border: 1px solid rgba(6, 182, 212, 0.3);
}

/* バッジのコントラスト改善 */
.badge.bg-info {
    background: var(--accent-info) !important;
    color: white !important;
}

.badge.bg-primary {
    background: var(--accent-primary) !important;
    color: white !important;
}

.badge.bg-success {
    background: var(--accent-success) !important;
    color: white !important;
}

.badge.bg-warning {
    background: var(--accent-warning) !important;
    color: white !important;
}

.badge.bg-danger {
    background: var(--accent-danger) !important;
    color: white !important;
}

.badge.bg-secondary {
    background: #6b7280 !important;
    color: white !important;
}

/* カード内の要素のコントラスト */
.card-body h6 {
    color: var(--text-primary);
    font-weight: 600;
}

.card-body p {
    color: var(--text-primary);
}

.card-body .text-muted {
    color: var(--text-muted) !important;
}

.card-body .small {
    color: var(--text-secondary);
}

/* リンクのコントラスト */
a {
    color: var(--accent-primary);
}

a:hover {
    color: var(--accent-secondary);
}

.text-decoration-none {
    text-decoration: none !important;
}

.text-decoration-none:hover {
    text-decoration: underline !important;
}

</style>
{% endblock %}

{% block extra_js %}
<script>
let characterSheets = [];
const characterSheetMap = new Map();
let groupMemberCharacters = new Map();
let groupMemberNames = new Map();
const SESSION_ID = {{ session.id }};
const IS_GM = {% if is_gm %}true{% else %}false{% endif %};
const IS_PUBLIC_VIEW = {% if is_public_view %}true{% else %}false{% endif %};
const PUBLIC_SESSION_URL = "{{ public_session_url|escapejs }}";
const youtubeLinkMap = new Map();

function setupCopyPublicSessionLinkButton() {
    const button = document.getElementById('copyPublicSessionLinkBtn');
    if (!button) return;

    button.addEventListener('click', async () => {
        const shareUrl = button.dataset.shareUrl || PUBLIC_SESSION_URL;
        if (!shareUrl) return;

        try {
            if (navigator.clipboard?.writeText) {
                await navigator.clipboard.writeText(shareUrl);
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = shareUrl;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }

            alert('リンクをコピーしました');
        } catch (error) {
            alert('コピーに失敗しました。手動でコピーしてください: ' + shareUrl);
        }
    });
}

function safeSetScenarioStorage(key, value) {
    try {
        localStorage.setItem(key, value);
    } catch (_) {
        // ignore storage errors
    }
}

const createCharacterBtn = document.getElementById('createCharacterFromScenario');
if (createCharacterBtn) {
    createCharacterBtn.addEventListener('click', () => {
        const scenarioId = createCharacterBtn.dataset.scenarioId || '';
        const scenarioTitle = createCharacterBtn.dataset.scenarioTitle || '';
        const scenarioSystem = createCharacterBtn.dataset.scenarioSystem || '';
        const sessionId = createCharacterBtn.dataset.sessionId || '';
        if (!scenarioId) {
            alert('シナリオ情報が取得できませんでした。');
            return;
        }

        safeSetScenarioStorage('scenario_recommended_skills_id', scenarioId);
        safeSetScenarioStorage('scenario_recommended_skills_title', scenarioTitle);
        safeSetScenarioStorage('scenario_recommended_skills_system', scenarioSystem);

        const params = new URLSearchParams({
            scenario_id: scenarioId,
            scenario_title: scenarioTitle,
            game_system: scenarioSystem,
            session_id: sessionId
        });
        window.location.href = `/accounts/character/create/6th/?${params.toString()}`;
    });
}

async function loadCharacterSheets() {
    try {
        const response = await axios.get('/api/accounts/character-sheets/');
        characterSheets = response.data || [];
        characterSheetMap.clear();
        characterSheets.forEach(sheet => {
            characterSheetMap.set(String(sheet.id), sheet);
        });

        populateCharacterSelect('character_sheet_id');
        populateCharacterSelect('edit_character_sheet_id');
        bindCharacterNameAutoFill('character_sheet_id', 'character_name');
        bindCharacterNameAutoFill('edit_character_sheet_id', 'edit_character_name');
    } catch (error) {
        console.error('キャラクターシートの取得に失敗しました:', error);
    }
}

function populateCharacterSelect(selectId) {
    const selectEl = document.getElementById(selectId);
    if (!selectEl) return;

    const selected = selectEl.dataset.selected || '';
    selectEl.innerHTML = '<option value="">選択しない</option>' +
        characterSheets.map(sheet => (
            `<option value="${sheet.id}">${sheet.name}</option>`
        )).join('');

    if (selected) {
        selectEl.value = selected;
    }
}

function bindCharacterNameAutoFill(selectId, inputId) {
    const selectEl = document.getElementById(selectId);
    const inputEl = document.getElementById(inputId);
    if (!selectEl || !inputEl) return;

    selectEl.addEventListener('change', () => {
        if (inputEl.value.trim()) return;
        const sheet = characterSheetMap.get(selectEl.value);
        if (sheet && sheet.name) {
            inputEl.value = sheet.name;
        }
    });
}

async function loadGroupMemberCharacters() {
    {% if is_gm %}
    try {
        const response = await axios.get('/api/accounts/groups/{{ session.group.id }}/member_characters/');
        const data = response.data || [];
        groupMemberCharacters = new Map();
        groupMemberNames = new Map();

        data.forEach(member => {
            groupMemberNames.set(String(member.user_id), member.nickname || member.username);
            groupMemberCharacters.set(String(member.user_id), member.characters || []);
        });
    } catch (error) {
        console.error('グループメンバーのキャラクター取得に失敗しました:', error);
    }
    {% endif %}
}

// セッション更新
async function updateSession() {
    const data = {
        title: document.getElementById('title').value,
        date: document.getElementById('date').value,
        duration_minutes: document.getElementById('duration_minutes').value,
        location: document.getElementById('location').value,
        visibility: document.getElementById('visibility').value,
        youtube_url: document.getElementById('youtube_url').value,
        description: document.getElementById('description').value,
        status: document.getElementById('status').value
    };

    try {
        const response = await axios.patch(`/api/schedules/sessions/{{ session.id }}/`, data);
        alert('セッション情報を更新しました');
        location.reload();
    } catch (error) {
        alert('更新に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

function escapeHtml(value) {
    if (value === null || value === undefined) return '';
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function formatDurationSeconds(seconds) {
    const total = Number(seconds) || 0;
    const hours = Math.floor(total / 3600);
    const minutes = Math.floor((total % 3600) / 60);
    const secs = total % 60;

    if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    return `${minutes}:${String(secs).padStart(2, '0')}`;
}

function showYouTubeLinksMessage(message, type = 'info') {
    const container = document.getElementById('youtubeLinksMessages');
    if (!container) return;
    const safeMessage = escapeHtml(message);
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${safeMessage}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function buildYouTubeGroupKey(link) {
    const perspective = (link?.perspective || '').trim();
    return perspective || '（視点未設定）';
}

function canManageYouTubeLink(link) {
    const currentUserId = window.CURRENT_USER?.id;
    if (IS_GM) return true;
    if (!currentUserId) return false;
    return Number(link?.added_by) === Number(currentUserId);
}

function renderYouTubeLinks(links) {
    const container = document.getElementById('youtubeLinksContainer');
    if (!container) return;

    youtubeLinkMap.clear();
    (links || []).forEach(link => {
        if (link?.id !== undefined && link?.id !== null) {
            youtubeLinkMap.set(String(link.id), link);
        }
    });

    if (!links || links.length === 0) {
        container.innerHTML = '<p class="text-muted text-center mb-0">YouTubeリンクがありません</p>';
        return;
    }

    // グループ順: 最小order順（なければ作成順）
    const groupsMap = new Map();
    for (const link of links) {
        const key = buildYouTubeGroupKey(link);
        if (!groupsMap.has(key)) {
            groupsMap.set(key, []);
        }
        groupsMap.get(key).push(link);
    }

    const groups = Array.from(groupsMap.entries()).map(([key, groupLinks]) => {
        const minOrder = Math.min(...groupLinks.map(l => Number(l.order) || Number.MAX_SAFE_INTEGER));
        const totalDuration = groupLinks.reduce((sum, l) => sum + (Number(l.duration_seconds) || 0), 0);
        return { key, links: groupLinks, minOrder, totalDuration };
    }).sort((a, b) => (a.minOrder - b.minOrder) || a.key.localeCompare(b.key, 'ja'));

    const html = groups.map(group => {
        const sortedLinks = [...group.links].sort((a, b) => {
            const partA = a.part_number === null || a.part_number === undefined ? Number.MAX_SAFE_INTEGER : Number(a.part_number);
            const partB = b.part_number === null || b.part_number === undefined ? Number.MAX_SAFE_INTEGER : Number(b.part_number);
            if (partA !== partB) return partA - partB;
            const orderA = Number(a.order) || Number.MAX_SAFE_INTEGER;
            const orderB = Number(b.order) || Number.MAX_SAFE_INTEGER;
            if (orderA !== orderB) return orderA - orderB;
            return Number(a.id) - Number(b.id);
        });

        const groupTitle = escapeHtml(group.key);
        const groupMeta = `${sortedLinks.length}本 / 合計 ${formatDurationSeconds(group.totalDuration)}`;

        const items = sortedLinks.map(link => {
            const safeTitle = escapeHtml(link.title || '(タイトル未取得)');
            const safeUrl = escapeHtml(link.youtube_url || '#');
            const safeChannel = escapeHtml(link.channel_name || '');
            const duration = escapeHtml(link.duration_display || formatDurationSeconds(link.duration_seconds));
            const safeDescription = escapeHtml(link.description || '');
            const safePerspective = escapeHtml((link.perspective || '').trim());
            const partBadge = link.part_number ? `<span class="badge bg-dark">Part ${escapeHtml(link.part_number)}</span>` : '';
            const perspectiveBadge = safePerspective ? `<span class="badge bg-secondary">${safePerspective}</span>` : '';

            const thumbnailUrl = link.thumbnail_url || (link.video_id ? `https://i.ytimg.com/vi/${encodeURIComponent(link.video_id)}/hqdefault.jpg` : '');
            const thumbnailHtml = thumbnailUrl
                ? `<img src="${escapeHtml(thumbnailUrl)}" alt="thumbnail" class="youtube-link-thumb" loading="lazy">`
                : `<div class="youtube-link-thumb" style="background-color: var(--card-bg);"></div>`;

            const addedBy = link.added_by_detail?.nickname || link.added_by_detail?.username || '';
            const safeAddedBy = escapeHtml(addedBy);

            const manageButtons = canManageYouTubeLink(link) ? `
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="openEditYouTubeLinkModal(${link.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteYouTubeLink(${link.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            ` : '';

            return `
                <div class="youtube-link-item rounded p-2 mb-2">
                    <div class="d-flex gap-3 align-items-start">
                        <a href="${safeUrl}" target="_blank" rel="noopener noreferrer">
                            ${thumbnailHtml}
                        </a>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between gap-2">
                                <div>
                                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="fw-bold text-decoration-none">
                                        ${safeTitle}
                                    </a>
                                    <div class="text-muted small mt-1">
                                        ${safeChannel ? `${safeChannel} / ` : ''}${duration}
                                        ${safeAddedBy ? ` / 追加: ${safeAddedBy}` : ''}
                                    </div>
                                    <div class="mt-2 d-flex flex-wrap gap-2">
                                        ${perspectiveBadge}
                                        ${partBadge}
                                    </div>
                                </div>
                                <div>
                                    ${manageButtons}
                                </div>
                            </div>
                            ${safeDescription ? `<div class="youtube-link-description small mt-2">${safeDescription}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="fas fa-video"></i> ${groupTitle}
                    <small class="text-muted ms-2">${escapeHtml(groupMeta)}</small>
                </h6>
                ${items}
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

async function loadYouTubeLinks() {
    const container = document.getElementById('youtubeLinksContainer');
    if (!container) return;

    try {
        const response = await axios.get(`/api/schedules/sessions/${SESSION_ID}/youtube-links/`);
        renderYouTubeLinks(response.data || []);
    } catch (error) {
        console.error('YouTubeリンクの取得に失敗しました:', error);
        container.innerHTML = '<p class="text-muted text-center mb-0">YouTubeリンクの取得に失敗しました</p>';
    }
}

async function loadYouTubeLinkStatistics() {
    const countBadge = document.getElementById('youtubeLinksCountBadge');
    const totalBadge = document.getElementById('youtubeLinksTotalDurationBadge');
    const headerSummary = document.getElementById('youtubeLinksHeaderSummary');
    if (!countBadge || !totalBadge || !headerSummary) return;

    try {
        const response = await axios.get(`/api/schedules/sessions/${SESSION_ID}/youtube-links/statistics/`);
        const stats = response.data || {};
        const count = Number(stats.video_count) || 0;
        const totalDisplay = stats.total_duration_display || formatDurationSeconds(stats.total_duration_seconds);

        countBadge.textContent = `${count}本`;
        totalBadge.textContent = `合計 ${totalDisplay}`;
        headerSummary.textContent = `(${count}本 / ${totalDisplay})`;
    } catch (error) {
        totalBadge.textContent = '';
        headerSummary.textContent = '';
        countBadge.textContent = '統計取得失敗';
    }
}

async function addYouTubeLink(event) {
    event.preventDefault();

    const addBtn = document.getElementById('youtubeLinkAddBtn');
    const urlEl = document.getElementById('youtube_link_url');
    const perspectiveEl = document.getElementById('youtube_link_perspective');
    const partEl = document.getElementById('youtube_link_part_number');
    const descriptionEl = document.getElementById('youtube_link_description');

    const youtubeUrl = (urlEl?.value || '').trim();
    const perspective = (perspectiveEl?.value || '').trim();
    const partValue = (partEl?.value || '').trim();
    const description = (descriptionEl?.value || '').trim();

    if (!youtubeUrl) {
        showYouTubeLinksMessage('YouTube URLを入力してください', 'warning');
        return;
    }

    const payload = { youtube_url: youtubeUrl };
    if (perspective) payload.perspective = perspective;
    if (description) payload.description = description;
    if (partValue) payload.part_number = Number(partValue);

    try {
        if (addBtn) addBtn.disabled = true;
        await axios.post(`/api/schedules/sessions/${SESSION_ID}/youtube-links/`, payload);
        showYouTubeLinksMessage('YouTubeリンクを追加しました', 'success');

        if (urlEl) urlEl.value = '';
        if (partEl) partEl.value = '';
        if (descriptionEl) descriptionEl.value = '';

        await loadYouTubeLinks();
        await loadYouTubeLinkStatistics();
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showYouTubeLinksMessage(`追加に失敗しました: ${message}`, 'danger');
    } finally {
        if (addBtn) addBtn.disabled = false;
    }
}

function parseBulkUrls(text) {
    return (text || '')
        .split(/\s+/)
        .map(v => v.trim())
        .filter(Boolean);
}

async function bulkAddYouTubeLinks(event) {
    event.preventDefault();

    const bulkBtn = document.getElementById('youtubeLinkBulkAddBtn');
    const urlsEl = document.getElementById('youtube_bulk_urls');
    const perspectiveEl = document.getElementById('youtube_bulk_perspective');
    const startPartEl = document.getElementById('youtube_bulk_start_part');
    const descriptionEl = document.getElementById('youtube_bulk_description');

    const urls = parseBulkUrls(urlsEl?.value || '');
    const perspective = (perspectiveEl?.value || '').trim();
    const startPartValue = (startPartEl?.value || '').trim();
    const description = (descriptionEl?.value || '').trim();

    if (urls.length === 0) {
        showYouTubeLinksMessage('YouTube URLを1つ以上入力してください', 'warning');
        return;
    }

    const startPart = startPartValue ? Number(startPartValue) : null;
    if (startPartValue && (!Number.isInteger(startPart) || startPart < 1)) {
        showYouTubeLinksMessage('開始パート番号は1以上の整数で入力してください', 'warning');
        return;
    }

    let successCount = 0;
    const errors = [];

    try {
        if (bulkBtn) bulkBtn.disabled = true;

        for (let i = 0; i < urls.length; i += 1) {
            const payload = { youtube_url: urls[i] };
            if (perspective) payload.perspective = perspective;
            if (description) payload.description = description;
            if (startPart) payload.part_number = startPart + i;

            try {
                await axios.post(`/api/schedules/sessions/${SESSION_ID}/youtube-links/`, payload);
                successCount += 1;
            } catch (error) {
                const message = error.response?.data?.error || error.response?.data?.detail || error.message;
                errors.push(`${urls[i]}: ${message}`);
            }
        }

        if (successCount > 0) {
            showYouTubeLinksMessage(`追加しました: ${successCount}件`, errors.length ? 'warning' : 'success');
        } else {
            showYouTubeLinksMessage('追加できませんでした', 'danger');
        }

        if (errors.length) {
            console.warn('YouTubeリンク追加エラー:', errors);
        }

        if (urlsEl) urlsEl.value = '';
        if (startPartEl) startPartEl.value = '';
        if (descriptionEl) descriptionEl.value = '';

        await loadYouTubeLinks();
        await loadYouTubeLinkStatistics();
    } finally {
        if (bulkBtn) bulkBtn.disabled = false;
    }
}

function openEditYouTubeLinkModal(linkId) {
    const link = youtubeLinkMap.get(String(linkId));
    if (!link) return;

    const idEl = document.getElementById('edit_youtube_link_id');
    const perspectiveEl = document.getElementById('edit_youtube_link_perspective');
    const partEl = document.getElementById('edit_youtube_link_part_number');
    const descriptionEl = document.getElementById('edit_youtube_link_description');

    if (idEl) idEl.value = link.id;
    if (perspectiveEl) perspectiveEl.value = link.perspective || '';
    if (partEl) partEl.value = link.part_number || '';
    if (descriptionEl) descriptionEl.value = link.description || '';

    const modalEl = document.getElementById('editYouTubeLinkModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

async function saveYouTubeLinkEdits() {
    const id = document.getElementById('edit_youtube_link_id')?.value;
    if (!id) return;

    const saveBtn = document.getElementById('saveYouTubeLinkBtn');
    const perspective = (document.getElementById('edit_youtube_link_perspective')?.value || '').trim();
    const partValue = (document.getElementById('edit_youtube_link_part_number')?.value || '').trim();
    const description = (document.getElementById('edit_youtube_link_description')?.value || '').trim();

    const payload = {
        perspective: perspective,
        description: description,
        part_number: partValue ? Number(partValue) : null
    };

    try {
        if (saveBtn) saveBtn.disabled = true;
        await axios.patch(`/api/schedules/youtube-links/${id}/`, payload);

        const modalEl = document.getElementById('editYouTubeLinkModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        showYouTubeLinksMessage('YouTubeリンクを更新しました', 'success');
        await loadYouTubeLinks();
        await loadYouTubeLinkStatistics();
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showYouTubeLinksMessage(`更新に失敗しました: ${message}`, 'danger');
    } finally {
        if (saveBtn) saveBtn.disabled = false;
    }
}

async function deleteYouTubeLink(linkId) {
    if (!confirm('このYouTubeリンクを削除しますか？')) return;

    try {
        await axios.delete(`/api/schedules/youtube-links/${linkId}/`);
        showYouTubeLinksMessage('YouTubeリンクを削除しました', 'success');
        await loadYouTubeLinks();
        await loadYouTubeLinkStatistics();
    } catch (error) {
        const message = error.response?.data?.error || error.response?.data?.detail || error.message;
        showYouTubeLinksMessage(`削除に失敗しました: ${message}`, 'danger');
    }
}

// セッション参加
async function joinSession() {
    const characterSheetId = document.getElementById('character_sheet_id').value;
    const data = {
        character_name: document.getElementById('character_name').value,
        character_sheet_url: document.getElementById('character_sheet_url').value
    };
    if (characterSheetId) {
        data.character_sheet_id = characterSheetId;
    }

    try {
        const response = await axios.post(`/api/schedules/sessions/{{ session.id }}/join/`, data);
        alert('セッションに参加しました');
        location.reload();
    } catch (error) {
        alert('参加に失敗しました: ' + (error.response?.data?.error || error.message));
    }
}

// 参加情報更新
async function updateParticipant() {
    const characterSheetId = document.getElementById('edit_character_sheet_id').value;
    const data = {
        character_name: document.getElementById('edit_character_name').value,
        character_sheet_url: document.getElementById('edit_character_sheet_url').value
    };
    if (characterSheetId) {
        data.character_sheet_id = characterSheetId;
    } else {
        data.character_sheet_id = '';
    }

    try {
        {% if user_participant %}
        const response = await axios.patch(`/api/schedules/participants/{{ user_participant.id }}/`, data);
        {% else %}
        throw new Error('参加情報が見つかりません');
        {% endif %}
        alert('参加情報を更新しました');
        location.reload();
    } catch (error) {
        alert('更新に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

// GM: 参加者キャラクター設定
function openCharacterLinkModal(participantId, userId, currentCharacterId) {
    const modalEl = document.getElementById('linkCharacterModal');
    const modal = new bootstrap.Modal(modalEl);
    const selectEl = document.getElementById('linkCharacterSelect');

    document.getElementById('linkParticipantId').value = participantId;
    document.getElementById('linkParticipantUserId').value = userId;

    const characters = groupMemberCharacters.get(String(userId)) || [];
    if (characters.length === 0) {
        selectEl.innerHTML = '<option value="">選択可能なキャラクターがありません</option>';
    } else {
        selectEl.innerHTML = '<option value="">選択してください</option>' + characters.map(char => (
            `<option value="${char.id}">${char.name}</option>`
        )).join('');
    }

    if (currentCharacterId) {
        selectEl.value = String(currentCharacterId);
    }

    modal.show();
}

async function saveLinkedCharacter() {
    const participantId = document.getElementById('linkParticipantId').value;
    const userId = document.getElementById('linkParticipantUserId').value;
    const characterId = document.getElementById('linkCharacterSelect').value;

    if (!participantId) return;

    const characters = groupMemberCharacters.get(String(userId)) || [];
    const selected = characters.find(char => String(char.id) === String(characterId));

    const data = {
        character_sheet_id: characterId || ''
    };

    if (selected && selected.name) {
        data.character_name = selected.name;
    }

    try {
        await axios.patch(`/api/schedules/participants/${participantId}/`, data);
        alert('キャラクターを更新しました');
        location.reload();
    } catch (error) {
        alert('更新に失敗しました: ' + (error.response?.data?.error || error.message));
    }
}

// セッション脱退
async function leaveSession() {
    if (!confirm('本当にセッションから脱退しますか？')) return;

    try {
        const response = await axios.delete(`/api/schedules/sessions/{{ session.id }}/leave/`);
        alert('セッションから脱退しました');
        window.location.href = '/api/schedules/sessions/view/';
    } catch (error) {
        alert('脱退に失敗しました: ' + (error.response?.data?.error || error.message));
    }
}

// ハンドアウト作成
async function createHandout() {
    const data = {
        session: {{ session.id }},
        participant: document.getElementById('handout_participant').value,
        title: document.getElementById('handout_title').value,
        content: document.getElementById('handout_content').value,
        recommended_skills: document.getElementById('handout_recommended_skills').value,
        is_secret: document.getElementById('handout_is_secret').checked
    };

    try {
        const response = await axios.post('/api/schedules/handouts/', data);
        alert('ハンドアウトを作成しました');
        location.reload();
    } catch (error) {
        alert('作成に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

// ハンドアウト削除
async function deleteHandout(handoutId) {
    if (!confirm('本当にこのハンドアウトを削除しますか？')) return;

    try {
        await axios.delete(`/api/schedules/handouts/${handoutId}/`);
        alert('ハンドアウトを削除しました');
        location.reload();
    } catch (error) {
        alert('削除に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

// 参加者除名
async function removeParticipant(participantId) {
    if (!confirm('本当にこの参加者を除名しますか？')) return;

    try {
        await axios.delete(`/api/schedules/participants/${participantId}/`);
        alert('参加者を除名しました');
        location.reload();
    } catch (error) {
        alert('除名に失敗しました: ' + (error.response?.data?.detail || error.message));
    }
}

document.addEventListener('DOMContentLoaded', () => {
    setupCopyPublicSessionLinkButton();

    if (IS_PUBLIC_VIEW) return;

    loadCharacterSheets();
    loadGroupMemberCharacters();

    const youtubeContainer = document.getElementById('youtubeLinksContainer');
    if (youtubeContainer) {
        const addForm = document.getElementById('youtubeLinkAddForm');
        if (addForm) addForm.addEventListener('submit', addYouTubeLink);

        const bulkForm = document.getElementById('youtubeLinkBulkAddForm');
        if (bulkForm) bulkForm.addEventListener('submit', bulkAddYouTubeLinks);

        loadYouTubeLinks();
        loadYouTubeLinkStatistics();
    }
});
</script>
{% endblock %}

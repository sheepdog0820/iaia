# クトゥルフ神話TRPG 第6版 キャラクター作成画面 仕様書

## 📋 概要

### 基本情報
- **システム**: クトゥルフ神話TRPG 第6版専用
- **URL**: `/accounts/character/create/6th/`
- **テンプレート**: `templates/accounts/character_sheet_6th.html`
- **Django View**: `Character6thCreateView` (FormView)
- **フォーム**: `CharacterSheet6thForm`

### 設計思想
- **段階的入力**: 7つのセクションによる構造化された入力フロー
- **リアルタイム計算**: 能力値変更時の自動副次ステータス更新
- **ルール準拠**: クトゥルフ神話TRPG 6版公式ルールの完全実装
- **ユーザビリティ**: 初心者からベテランまで対応する操作性

---

## 🏗️ 画面構造

### レイアウト設計
- **ヘッダー**: ページタイトル・進捗表示・操作ボタン
- **メインコンテンツ**: 7セクションのカード型レイアウト
- **フッター**: 技能ポイント状況・保存アクション（固定配置）

### セクション構成
```
1. 基本情報    [必須] - 探索者名、年齢、職業等
2. 能力値      [必須] - 8つの基本能力値とダイス機能
3. 技能        [必須] - 技能ポイント配分
4. 戦闘データ  [任意] - HP、武器、装甲
5. 所持品      [任意] - 装備とアイテム
6. 背景情報    [任意] - キャラクターの詳細設定
7. 成長記録    [任意] - 経験値と技能向上履歴
```

---

## 📝 セクション別詳細仕様

### 1. 基本情報セクション (`#section-basic`)

#### 必須フィールド
| フィールド | タイプ | 制限 | 説明 |
|-----------|--------|------|------|
| 探索者名 | text | 必須・最大100文字 | キャラクター名 |
| 年齢 | number | 必須・15-90歳 | 探索者の年齢 |

#### 任意フィールド
| フィールド | タイプ | 制限 | 説明 |
|-----------|--------|------|------|
| 性別 | text | 最大50文字 | 性別情報 |
| 職業 | text | 最大100文字 | 探索者の職業 |
| 出身地 | text | 最大100文字 | 生まれた場所 |
| 現住所 | text | 最大100文字 | 現在の居住地 |
| 精神的障害 | textarea | 最大500文字 | メンタル状態 |

#### 画像機能
- **対応形式**: JPG, PNG, GIF
- **最大サイズ**: 5MB
- **プレビュー**: リアルタイム表示
- **削除機能**: アップロード後の画像削除可能

### 2. 能力値セクション (`#section-abilities`)

#### 8つの基本能力値
| 能力値 | 略称 | 範囲 | 初期値計算 |
|--------|------|------|------------|
| 筋力 | STR | 1-999 | 3D6 |
| 体力 | CON | 1-999 | 3D6 |
| 精神力 | POW | 1-999 | 3D6 |
| 敏捷性 | DEX | 1-999 | 3D6 |
| 外見 | APP | 1-999 | 3D6 |
| 体格 | SIZ | 1-999 | 2D6+6 |
| 知性 | INT | 1-999 | 2D6+6 |
| 教育 | EDU | 1-999 | 3D6+3 |

#### ダイス機能
**プリセット設定**:
1. **標準6版**: 公式ルール通りのダイス設定
2. **高能力値**: より高い値が出やすい設定
3. **カスタム**: ユーザー定義のダイス設定

**ダイス操作**:
- **個別ロール**: 各能力値の単独ダイスロール
- **一括ロール**: 全能力値の同時ダイスロール
- **手動入力**: ダイスを使わない直接入力

#### 副次ステータス（自動計算）
| ステータス | 計算式 | 説明 |
|------------|--------|------|
| HP | (CON+SIZ)÷2 | ヒットポイント |
| MP | POW | マジックポイント |
| SAN | POW×5 | 正気度 |
| アイデア | INT×5 | アイデアロール |
| 幸運 | POW×5 | 幸運ロール |
| 知識 | EDU×5 | 知識ロール |
| 回避 | DEX×2 | 回避技能初期値 |
| ダメージボーナス | STR+SIZ計算 | 近接攻撃ボーナス |

### 3. 技能セクション (`#section-skills`)

#### 技能カテゴリ
1. **全技能**: 全ての利用可能技能
2. **戦闘技能**: 武器・格闘・回避など
3. **探索技能**: 目星・聞き耳・図書館など
4. **知識技能**: 学術・専門知識
5. **その他**: 芸術・社交技能など

#### 技能ポイント管理
**職業技能ポイント**:
- **計算式**: EDU × 職業倍率（デフォルト20）
- **用途**: 職業に関連する技能の向上

**趣味技能ポイント**:
- **計算式**: INT × 10
- **用途**: 個人的な興味・趣味の技能

#### 技能データ構造
| 項目 | 説明 | 管理方法 |
|------|------|----------|
| 技能名 | 技能の名称 | 固定リスト+カスタム |
| 基本値 | 技能の初期値 | システム定義 |
| 職業ポイント | 職業技能ポイントの配分 | ユーザー入力 |
| 趣味ポイント | 趣味技能ポイントの配分 | ユーザー入力 |
| 合計値 | 基本値+職業+趣味 | 自動計算 |

#### カスタム技能機能
- **動的追加**: カテゴリ別のカスタム技能追加
- **削除機能**: 不要なカスタム技能の削除
- **設定自由度**: 基本値・ポイント配分の自由設定

---

## 🎲 ダイス機能詳細

### ダイス設定システム

#### 標準6版設定
```javascript
STR/CON/POW/DEX/APP: 3D6+0 (3-18)
SIZ/INT: 2D6+6 (8-18)
EDU: 3D6+3 (6-21)
```

#### 高能力値設定
```javascript
STR/CON/POW/DEX/APP: 4D6-3 (上位3個)
SIZ/INT: 3D6+3 (6-21)
EDU: 4D6+0 (4-24)
```

#### カスタム設定
- **ダイス個数**: 1-10個
- **ダイス面数**: 4/6/8/10/12/20面
- **ボーナス値**: -10～+10

### JavaScript関数
```javascript
// 主要ダイス関数
rollSingleAbility(ability)    // 単一能力値ロール
rollAllAbilities()            // 全能力値ロール
rollDice(count, sides, bonus) // 基本ダイス関数
```

---

## 💾 データ管理

### フォーム構造
```html
<form id="character-form-6th" method="post" 
      action="{% url 'character_create_6th' %}">
    {% csrf_token %}
    <!-- フォームフィールド -->
</form>
```

### バリデーション

#### フロントエンド
- **HTML5バリデーション**: required, min/max属性
- **JavaScript検証**: リアルタイム入力チェック
- **ポイント制限**: 技能ポイントの上限監視

#### バックエンド
- **Django Form**: `CharacterSheet6thForm`
- **Model制約**: データベースレベルでの制約
- **カスタムバリデーション**: ビジネスルールチェック

### 保存機能
1. **下書き保存**: LocalStorageによる一時保存
2. **最終保存**: サーバーへのデータ送信
3. **自動保存**: 定期的な下書き更新（準備済み）

---

## 🔧 JavaScript機能

### グローバル変数
```javascript
const ABILITIES = ['str', 'con', 'pow', 'dex', 'app', 'siz', 'int', 'edu'];
const DEFAULT_DICE_SETTINGS = { /* 標準設定 */ };
let currentDiceSettings = { /* 現在の設定 */ };
let customSkills = []; // カスタム技能
```

### 主要関数群

#### 計算関数
- `calculateDerivedStats()`: 副次ステータス計算
- `calculateSkillPoints()`: 技能ポイント計算
- `updateSkillPointsUsage()`: ポイント使用状況更新

#### UI管理関数
- `toggleDiceSettings()`: ダイス設定表示切替
- `previewCharacterImage()`: 画像プレビュー
- `showNotification()`: 通知表示

#### 技能管理関数
- `generateSkillsList()`: 技能リスト生成
- `addCustomSkill()`: カスタム技能追加
- `removeCustomSkill()`: カスタム技能削除

---

## 🎨 UI/UX仕様

### デザインシステム
- **カラースキーム**: Bootstrap 5 + カスタムCSSによる統一感
- **タイポグラフィ**: 視認性重視のフォント設定
- **アイコン**: Font Awesome 使用

### レスポンシブ対応
```css
/* モバイル最適化 */
@media (max-width: 768px) {
    .skill-item { margin-bottom: 15px; }
    .floating-save-container { position: fixed; }
}

/* デスクトップ最適化 */
@media (min-width: 1200px) {
    .col-lg-4 { /* 3列レイアウト */ }
}
```

### アニメーション
- **ダイスロール**: 回転アニメーション
- **トランジション**: スムーズな画面遷移
- **フィードバック**: 操作に対する視覚的反応

---

## 🔌 技術統合

### CSS構成
| ファイル | 用途 |
|----------|------|
| `character_sheet_improvements.css` | UI改善スタイル |
| `character_sheet_modules.css` | モジュール別スタイル |
| `dice_settings_fix.css` | ダイス設定修正 |
| `skill_filter.css` | 技能フィルター |

### Django統合
- **View**: `Character6thCreateView` (FormView)
- **Form**: `CharacterSheet6thForm`
- **Model**: `CharacterSheet`, `CharacterSkill`
- **Serializer**: `CharacterSheetCreateSerializer`

### セキュリティ
- **CSRF保護**: Django標準のCSRF機能
- **入力検証**: 複数層でのバリデーション
- **権限制御**: ログインユーザーのみアクセス可能

---

## 📊 パフォーマンス最適化

### フロントエンド最適化
- **遅延初期化**: 技能リストの一度のみ生成
- **効率的DOM操作**: 必要時のみ再計算
- **キャッシュ活用**: LocalStorageによるデータ保持

### バックエンド最適化
- **クエリ最適化**: select_related, prefetch_related使用
- **画像処理**: 自動リサイズとフォーマット最適化
- **メモリ管理**: 効率的なオブジェクト生成

---

## 🚨 エラーハンドリング

### エラー種別
1. **入力エラー**: 必須フィールド未入力、範囲外値
2. **計算エラー**: 数値計算の例外処理
3. **通信エラー**: サーバーとの通信失敗
4. **システムエラー**: 予期しない例外

### エラー表示
- **視覚的フィードバック**: 赤色ハイライト
- **詳細メッセージ**: 具体的なエラー内容
- **修正ガイド**: 解決方法の提示

---

## 🎯 ユーザー操作フロー

### 標準的な作成フロー
```
1. ページアクセス
   ↓
2. 基本情報入力（探索者名・年齢等）
   ↓
3. 能力値決定（ダイスロールまたは手動）
   ↓
4. 副次ステータス確認（自動計算）
   ↓
5. 技能ポイント配分
   ↓
6. その他情報入力（任意）
   ↓
7. 最終確認と保存
```

### キーボードショートカット
- **Ctrl+S**: 下書き保存
- **Tab/Shift+Tab**: フィールド間移動
- **Enter**: 次のセクションへ

---

## 📈 今後の拡張予定

### 機能拡張
1. **リアルタイム共有**: 複数ユーザーでの同時編集
2. **テンプレート機能**: 職業別キャラクターテンプレート
3. **インポート/エクスポート**: 他ツールとの連携

### UI/UX改善
1. **ダークモード**: 夜間作業用のダークテーマ
2. **アクセシビリティ**: 視覚障害者向け対応
3. **モバイル最適化**: タッチ操作の改善

---

## 🏷️ 技術仕様まとめ

| 項目 | 仕様 |
|------|------|
| フレームワーク | Django 5.2 + Bootstrap 5 |
| データベース | SQLite (開発) / PostgreSQL (本番) |
| 認証 | Django標準認証 + django-allauth |
| フロントエンド | Vanilla JavaScript + Axios |
| CSS | Bootstrap 5 + カスタムCSS |
| 画像処理 | Pillow (Python) |
| API | Django REST Framework |

この仕様書により、クトゥルフ神話TRPG第6版キャラクター作成画面の全体像と詳細実装が明確に定義されています。
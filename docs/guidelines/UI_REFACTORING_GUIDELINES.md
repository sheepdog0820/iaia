# 画面リファクタリング・大規模変更ガイドライン

## 🚨 画面リファクタリング時の必須ルール

**UI/UXの大幅な変更や画面構造の変更時は、以下のルールを厳格に遵守してください**

## ❌ 禁止事項：大規模変更の一括実行
- **アコーディオン・タブ構造の一括変換禁止**: HTMLの基本構造を大幅に変更する際は段階的に実行
- **複数セクションの同時変換禁止**: カード→アコーディオンなどの変換は1セクションずつ実行
- **テンプレートファイルの完全書き換え禁止**: 既存の動作するコードを一度に大量変更しない
- **git restore なしでの強行禁止**: バックアップなしでの大規模変更は禁止

## ✅ 推奨事項：段階的改善アプローチ
1. **最小限改善ファースト**: フッター余白、必須マーカーなど小さな改善から開始
2. **動作確認必須**: 各変更後に必ず画面表示とJavaScript動作を確認
3. **git commit 分割**: 機能ごとに細かくcommitし、問題時に部分的restore可能にする
4. **バックアップ作成**: 大規模変更前に必ずgit branchまたは手動バックアップを作成
5. **段階的実装**: 1つのセクション変更→動作確認→次のセクション変更

## 🔄 画面リファクタリングの正しい手順
```bash
# STEP 1: バックアップ作成
git branch backup-before-refactor
git add . && git commit -m "リファクタリング開始前のバックアップ"

# STEP 2: 最小限改善から開始
# フッター余白、必須マーカー、レスポンシブ調整など

# STEP 3: 動作確認
# ブラウザで画面表示とJavaScript動作を確認

# STEP 4: 段階的変更
# 1セクションずつアコーディオン化やUI変更

# STEP 5: 各段階でcommit
git add . && git commit -m "セクション1: アコーディオン化完了"

# STEP 6: 問題発生時の即座復旧
git restore <problematic-file>  # または
git reset --hard backup-before-refactor
```

## 🚫 失敗パターンと回避策

### 失敗パターン1: HTMLの完全書き換え
```html
<!-- ❌ 悪い例: 既存の複雑な構造を一括変換 -->
<!-- 全てのカードを一度にアコーディオンに変換 -->
```
**回避策**: 1つのカードをアコーディオンに変換→動作確認→次のカード変換

### 失敗パターン2: JavaScript構造の大幅変更
```javascript
// ❌ 悪い例: 既存のイベントリスナーを大量削除・変更
// onclick属性を一括でaddEventListenerに変換
```
**回避策**: 既存のJavaScriptが動作する状態を維持し、段階的に改善

### 失敗パターン3: CSS構造の完全刷新
```css
/* ❌ 悪い例: 既存のスタイルを大量削除・変更 */
/* Bootstrap classを独自CSSで完全置換 */
```
**回避策**: 既存スタイルを保持し、追加・改善のみ実行

## 🛡️ 緊急復旧手順
画面が表示されない・JavaScript エラーが発生した場合：

```bash
# 1. 即座に元のファイルを復元
git restore <broken-file>

# 2. サーバー再起動
python3 manage.py runserver

# 3. 動作確認
# ブラウザで画面表示を確認

# 4. 最小限の改善のみ再実装
# フッター余白、必須マーカーなど安全な変更のみ

# 5. 段階的再挑戦
# 1セクションずつ慎重に変更
```

## 📋 画面リファクタリング チェックリスト

### 変更前チェック
- [ ] git状態確認（未コミット変更の有無）
- [ ] バックアップブランチ作成
- [ ] 現在の画面表示・JavaScript動作確認
- [ ] 変更対象セクションの明確化（1セクションのみ）

### 変更中チェック
- [ ] HTMLタグの開始・終了の整合性確認
- [ ] JavaScript関数の重複・削除の有無確認
- [ ] CSSクラスの衝突・削除の有無確認
- [ ] 各変更後の動作確認実行

### 変更後チェック
- [ ] ブラウザでの画面表示確認
- [ ] JavaScript console エラーの有無確認
- [ ] モバイル・デスクトップでの表示確認
- [ ] 全機能の動作確認（ダイスロール、フォーム送信等）
- [ ] git commit で変更を保存

## 🎯 成功のポイント
1. **保守的アプローチ**: 「動作するものを壊さない」を最優先
2. **段階的改善**: 小さな改善の積み重ねで大きな改善を実現
3. **即座の動作確認**: 各変更後すぐにブラウザで確認
4. **git活用**: 問題時に即座に復旧できる体制維持
5. **ユーザー体験優先**: 見た目より動作の安定性を優先

## 📐 レスポンシブデザインの考慮事項

### ブレークポイント
- **Mobile**: < 768px
- **Tablet**: 768px - 1024px
- **Desktop**: > 1024px

### 確認項目
- [ ] モバイルでの表示・操作性
- [ ] タブレットでの表示・操作性
- [ ] デスクトップでの表示・操作性
- [ ] 横向き・縦向きでの表示確認

## 🎨 UIコンポーネントの変更指針

### Bootstrap 5 の活用
- 既存のBootstrap classを最大限活用
- カスタムCSSは最小限に留める
- Bootstrap Utilityクラスで対応可能な場合は優先

### アクセシビリティ
- [ ] キーボード操作の確認
- [ ] スクリーンリーダー対応の確認
- [ ] コントラスト比の確認
- [ ] フォーカス表示の確認

## 🔧 デバッグツールの活用

### ブラウザ開発者ツール
```javascript
// 変更前後でのDOM構造確認
console.log(document.querySelector('.target-element'));

// イベントリスナーの確認
getEventListeners(document.querySelector('.target-element'));

// スタイルの確認
window.getComputedStyle(document.querySelector('.target-element'));
```

### パフォーマンス確認
- [ ] ページロード時間の測定
- [ ] JavaScript実行時間の測定
- [ ] レンダリング性能の確認